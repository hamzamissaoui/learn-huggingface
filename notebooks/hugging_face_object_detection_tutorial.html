<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Learn how to create a custom object detection model with Hugging Face Transformers.">

<title>[Work in Progress] Object Detection with Hugging Face Transformers Tutorial â€“ Learn Hugging Face ðŸ¤—</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/learn-hf-favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-a185852c63625fd9ffbdc57047c9a77e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-8a3ccdb72ee29426a807766126cb5921.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="[Work in Progress] Object Detection with Hugging Face Transformers Tutorial â€“ Learn Hugging Face ðŸ¤—">
<meta property="og:description" content="Learn how to create a custom object detection model with Hugging Face Transformers.">
<meta property="og:image" content="https://www.learnhuggingface.com/notebooks/hugging_face_object_detection_tutorial_files/figure-html/cell-11-output-1.png">
<meta property="og:site_name" content="Learn Hugging Face ðŸ¤—">
<meta property="og:image:height" content="89">
<meta property="og:image:width" content="790">
<meta name="twitter:title" content="[Work in Progress] Object Detection with Hugging Face Transformers Tutorial â€“ Learn Hugging Face ðŸ¤—">
<meta name="twitter:description" content="Learn how to create a custom object detection model with Hugging Face Transformers.">
<meta name="twitter:image" content="https://www.learnhuggingface.com/notebooks/hugging_face_object_detection_tutorial_files/figure-html/cell-11-output-1.png">
<meta name="twitter:image-height" content="89">
<meta name="twitter:image-width" content="790">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Learn Hugging Face ðŸ¤—</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../extras/setup.html"> 
<span class="menu-text">Setup</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../extras/glossary.html"> 
<span class="menu-text">Glossary</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mrdbourke/learn-huggingface" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/hugging_face_object_detection_tutorial.html">Computer Vision</a></li><li class="breadcrumb-item"><a href="../notebooks/hugging_face_object_detection_tutorial.html">(Work in progress) Build a custom object detection model and demo</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Natural Language Processing (NLP)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/hugging_face_text_classification_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Build a custom text classification model and demo</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Computer Vision</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/hugging_face_object_detection_tutorial.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">(Work in progress) Build a custom object detection model and demo</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#tk---overview" id="toc-tk---overview" class="nav-link active" data-scroll-target="#tk---overview"><span class="header-section-number">1</span> TK - Overview</a>
  <ul class="collapse">
  <li><a href="#tk---what-were-going-to-build" id="toc-tk---what-were-going-to-build" class="nav-link" data-scroll-target="#tk---what-were-going-to-build"><span class="header-section-number">1.1</span> TK - What weâ€™re going to build</a></li>
  <li><a href="#tk---what-is-object-detection" id="toc-tk---what-is-object-detection" class="nav-link" data-scroll-target="#tk---what-is-object-detection"><span class="header-section-number">1.2</span> TK - What is object detection?</a></li>
  <li><a href="#tk---why-train-your-own-object-detection-models" id="toc-tk---why-train-your-own-object-detection-models" class="nav-link" data-scroll-target="#tk---why-train-your-own-object-detection-models"><span class="header-section-number">1.3</span> TK - Why train your own object detection models?</a></li>
  <li><a href="#tk---workflow-were-going-to-follow" id="toc-tk---workflow-were-going-to-follow" class="nav-link" data-scroll-target="#tk---workflow-were-going-to-follow"><span class="header-section-number">1.4</span> TK - Workflow weâ€™re going to follow</a></li>
  </ul></li>
  <li><a href="#tk---importing-necessary-libraries" id="toc-tk---importing-necessary-libraries" class="nav-link" data-scroll-target="#tk---importing-necessary-libraries"><span class="header-section-number">2</span> TK - Importing necessary libraries</a></li>
  <li><a href="#getting-a-dataset" id="toc-getting-a-dataset" class="nav-link" data-scroll-target="#getting-a-dataset"><span class="header-section-number">3</span> Getting a dataset</a>
  <ul class="collapse">
  <li><a href="#loading-the-dataset" id="toc-loading-the-dataset" class="nav-link" data-scroll-target="#loading-the-dataset"><span class="header-section-number">3.1</span> Loading the dataset</a></li>
  <li><a href="#viewing-a-single-sample-from-our-data" id="toc-viewing-a-single-sample-from-our-data" class="nav-link" data-scroll-target="#viewing-a-single-sample-from-our-data"><span class="header-section-number">3.2</span> Viewing a single sample from our data</a></li>
  <li><a href="#extracting-the-category-names-from-our-data" id="toc-extracting-the-category-names-from-our-data" class="nav-link" data-scroll-target="#extracting-the-category-names-from-our-data"><span class="header-section-number">3.3</span> Extracting the category names from our data</a></li>
  <li><a href="#creating-a-mapping-from-numbers-to-labels" id="toc-creating-a-mapping-from-numbers-to-labels" class="nav-link" data-scroll-target="#creating-a-mapping-from-numbers-to-labels"><span class="header-section-number">3.4</span> Creating a mapping from numbers to labels</a></li>
  <li><a href="#creating-a-colour-palette" id="toc-creating-a-colour-palette" class="nav-link" data-scroll-target="#creating-a-colour-palette"><span class="header-section-number">3.5</span> Creating a colour palette</a></li>
  </ul></li>
  <li><a href="#tk---plotting-a-single-image-and-visualizing-the-boxes" id="toc-tk---plotting-a-single-image-and-visualizing-the-boxes" class="nav-link" data-scroll-target="#tk---plotting-a-single-image-and-visualizing-the-boxes"><span class="header-section-number">4</span> TK - Plotting a single image and visualizing the boxes</a></li>
  <li><a href="#different-bounding-box-formats" id="toc-different-bounding-box-formats" class="nav-link" data-scroll-target="#different-bounding-box-formats"><span class="header-section-number">5</span> Different bounding box formats</a>
  <ul class="collapse">
  <li><a href="#absolute-or-normalized-format" id="toc-absolute-or-normalized-format" class="nav-link" data-scroll-target="#absolute-or-normalized-format"><span class="header-section-number">5.1</span> Absolute or normalized format?</a></li>
  <li><a href="#which-bounding-box-format-should-you-use" id="toc-which-bounding-box-format-should-you-use" class="nav-link" data-scroll-target="#which-bounding-box-format-should-you-use"><span class="header-section-number">5.2</span> Which bounding box format should you use?</a></li>
  </ul></li>
  <li><a href="#getting-an-object-detection-model" id="toc-getting-an-object-detection-model" class="nav-link" data-scroll-target="#getting-an-object-detection-model"><span class="header-section-number">6</span> Getting an object detection model</a>
  <ul class="collapse">
  <li><a href="#places-to-get-object-detection-models" id="toc-places-to-get-object-detection-models" class="nav-link" data-scroll-target="#places-to-get-object-detection-models"><span class="header-section-number">6.1</span> Places to get object detection models</a></li>
  <li><a href="#downloading-our-model-from-hugging-face" id="toc-downloading-our-model-from-hugging-face" class="nav-link" data-scroll-target="#downloading-our-model-from-hugging-face"><span class="header-section-number">6.2</span> Downloading our model from Hugging Face</a></li>
  <li><a href="#inspecting-our-models-layers" id="toc-inspecting-our-models-layers" class="nav-link" data-scroll-target="#inspecting-our-models-layers"><span class="header-section-number">6.3</span> Inspecting our modelâ€™s layers</a></li>
  <li><a href="#counting-the-number-of-parameters-in-our-model" id="toc-counting-the-number-of-parameters-in-our-model" class="nav-link" data-scroll-target="#counting-the-number-of-parameters-in-our-model"><span class="header-section-number">6.4</span> Counting the number of parameters in our model</a></li>
  <li><a href="#creating-a-function-to-build-our-model" id="toc-creating-a-function-to-build-our-model" class="nav-link" data-scroll-target="#creating-a-function-to-build-our-model"><span class="header-section-number">6.5</span> Creating a function to build our model</a></li>
  <li><a href="#trying-to-pass-a-single-sample-through-our-model-part-1" id="toc-trying-to-pass-a-single-sample-through-our-model-part-1" class="nav-link" data-scroll-target="#trying-to-pass-a-single-sample-through-our-model-part-1"><span class="header-section-number">6.6</span> Trying to pass a single sample through our model (part 1)</a></li>
  </ul></li>
  <li><a href="#aside-processor-to-model-pattern" id="toc-aside-processor-to-model-pattern" class="nav-link" data-scroll-target="#aside-processor-to-model-pattern"><span class="header-section-number">7</span> Aside: Processor to Model Pattern</a></li>
  <li><a href="#loading-our-models-processor" id="toc-loading-our-models-processor" class="nav-link" data-scroll-target="#loading-our-models-processor"><span class="header-section-number">8</span> Loading our modelâ€™s processor</a>
  <ul class="collapse">
  <li><a href="#preprocessing-a-single-image" id="toc-preprocessing-a-single-image" class="nav-link" data-scroll-target="#preprocessing-a-single-image"><span class="header-section-number">8.1</span> Preprocessing a single image</a></li>
  <li><a href="#trying-to-pass-a-single-sample-through-our-model-part-2" id="toc-trying-to-pass-a-single-sample-through-our-model-part-2" class="nav-link" data-scroll-target="#trying-to-pass-a-single-sample-through-our-model-part-2"><span class="header-section-number">8.2</span> Trying to pass a single sample through our model (part 2)</a></li>
  </ul></li>
  <li><a href="#preprocessing-our-annotations" id="toc-preprocessing-our-annotations" class="nav-link" data-scroll-target="#preprocessing-our-annotations"><span class="header-section-number">9</span> Preprocessing our annotations</a>
  <ul class="collapse">
  <li><a href="#trying-to-preprocess-a-single-annotation" id="toc-trying-to-preprocess-a-single-annotation" class="nav-link" data-scroll-target="#trying-to-preprocess-a-single-annotation"><span class="header-section-number">9.1</span> Trying to preprocess a single annotation</a></li>
  <li><a href="#discussing-the-format-our-annotations-need-to-be-in" id="toc-discussing-the-format-our-annotations-need-to-be-in" class="nav-link" data-scroll-target="#discussing-the-format-our-annotations-need-to-be-in"><span class="header-section-number">9.2</span> Discussing the format our annotations need to be in</a></li>
  <li><a href="#creating-dataclasses-to-represent-the-coco-bounding-box-format" id="toc-creating-dataclasses-to-represent-the-coco-bounding-box-format" class="nav-link" data-scroll-target="#creating-dataclasses-to-represent-the-coco-bounding-box-format"><span class="header-section-number">9.3</span> Creating dataclasses to represent the COCO bounding box format</a></li>
  <li><a href="#creating-a-function-to-format-our-annotations-as-coco-format" id="toc-creating-a-function-to-format-our-annotations-as-coco-format" class="nav-link" data-scroll-target="#creating-a-function-to-format-our-annotations-as-coco-format"><span class="header-section-number">9.4</span> Creating a function to format our annotations as COCO format</a></li>
  <li><a href="#preprocess-a-single-image-and-set-of-coco-format-annotations" id="toc-preprocess-a-single-image-and-set-of-coco-format-annotations" class="nav-link" data-scroll-target="#preprocess-a-single-image-and-set-of-coco-format-annotations"><span class="header-section-number">9.5</span> Preprocess a single image and set of COCO format annotations</a></li>
  </ul></li>
  <li><a href="#postprocessing-a-single-output" id="toc-postprocessing-a-single-output" class="nav-link" data-scroll-target="#postprocessing-a-single-output"><span class="header-section-number">10</span> Postprocessing a single output</a></li>
  <li><a href="#going-end-to-end-on-a-single-sample" id="toc-going-end-to-end-on-a-single-sample" class="nav-link" data-scroll-target="#going-end-to-end-on-a-single-sample"><span class="header-section-number">11</span> Going end-to-end on a single sample</a></li>
  <li><a href="#reproducing-our-postprocessed-box-scores-by-hand" id="toc-reproducing-our-postprocessed-box-scores-by-hand" class="nav-link" data-scroll-target="#reproducing-our-postprocessed-box-scores-by-hand"><span class="header-section-number">11.1</span> Reproducing our postprocessed box scores by hand</a></li>
  <li><a href="#reproducing-our-postprocessed-box-labels-by-hand" id="toc-reproducing-our-postprocessed-box-labels-by-hand" class="nav-link" data-scroll-target="#reproducing-our-postprocessed-box-labels-by-hand"><span class="header-section-number">11.2</span> Reproducing our postprocessed box labels by hand</a></li>
  <li><a href="#reproducing-our-postprocessed-box-coordinates-by-hand" id="toc-reproducing-our-postprocessed-box-coordinates-by-hand" class="nav-link" data-scroll-target="#reproducing-our-postprocessed-box-coordinates-by-hand"><span class="header-section-number">11.3</span> Reproducing our postprocessed box coordinates by hand</a></li>
  <li><a href="#plotting-our-models-first-box-predictions-on-an-image" id="toc-plotting-our-models-first-box-predictions-on-an-image" class="nav-link" data-scroll-target="#plotting-our-models-first-box-predictions-on-an-image"><span class="header-section-number">11.4</span> Plotting our modelâ€™s first box predictions on an image</a></li>
  <li><a href="#aside-bounding-box-formats-in-and-out-of-our-model" id="toc-aside-bounding-box-formats-in-and-out-of-our-model" class="nav-link" data-scroll-target="#aside-bounding-box-formats-in-and-out-of-our-model"><span class="header-section-number">12</span> Aside: Bounding box formats in and out of our model</a></li>
  <li><a href="#tk---preparing-data-at-scale" id="toc-tk---preparing-data-at-scale" class="nav-link" data-scroll-target="#tk---preparing-data-at-scale"><span class="header-section-number">13</span> TK - Preparing data at scale</a>
  <ul class="collapse">
  <li><a href="#splitting-the-data-into-training-and-test-sets" id="toc-splitting-the-data-into-training-and-test-sets" class="nav-link" data-scroll-target="#splitting-the-data-into-training-and-test-sets"><span class="header-section-number">13.1</span> Splitting the data into training and test sets</a></li>
  <li><a href="#tk---writing-a-function-for-preprocessing-multiple-samples-at-a-time" id="toc-tk---writing-a-function-for-preprocessing-multiple-samples-at-a-time" class="nav-link" data-scroll-target="#tk---writing-a-function-for-preprocessing-multiple-samples-at-a-time"><span class="header-section-number">13.2</span> TK - Writing a function for preprocessing multiple samples at a time</a></li>
  <li><a href="#applying-our-preprocessing-function-to-each-data-split" id="toc-applying-our-preprocessing-function-to-each-data-split" class="nav-link" data-scroll-target="#applying-our-preprocessing-function-to-each-data-split"><span class="header-section-number">13.3</span> Applying our preprocessing function to each data split</a></li>
  <li><a href="#creating-a-collation-function" id="toc-creating-a-collation-function" class="nav-link" data-scroll-target="#creating-a-collation-function"><span class="header-section-number">13.4</span> Creating a collation function</a></li>
  </ul></li>
  <li><a href="#tk---setting-up-trainingarguments-and-a-trainer-instance-to-train-our-model" id="toc-tk---setting-up-trainingarguments-and-a-trainer-instance-to-train-our-model" class="nav-link" data-scroll-target="#tk---setting-up-trainingarguments-and-a-trainer-instance-to-train-our-model"><span class="header-section-number">14</span> TK - Setting up TrainingArguments and a Trainer instance to train our model</a>
  <ul class="collapse">
  <li><a href="#setting-up-our-trainingarguments" id="toc-setting-up-our-trainingarguments" class="nav-link" data-scroll-target="#setting-up-our-trainingarguments"><span class="header-section-number">14.1</span> Setting up our TrainingArguments</a></li>
  </ul></li>
  <li><a href="#tk---making-predictions-on-the-test-dataset" id="toc-tk---making-predictions-on-the-test-dataset" class="nav-link" data-scroll-target="#tk---making-predictions-on-the-test-dataset"><span class="header-section-number">15</span> TK - Making predictions on the test dataset</a>
  <ul class="collapse">
  <li><a href="#tk---predict-on-image-from-filepath" id="toc-tk---predict-on-image-from-filepath" class="nav-link" data-scroll-target="#tk---predict-on-image-from-filepath"><span class="header-section-number">15.1</span> TK - Predict on image from filepath</a></li>
  </ul></li>
  <li><a href="#tk---upload-our-trained-model-to-hugging-face-hub" id="toc-tk---upload-our-trained-model-to-hugging-face-hub" class="nav-link" data-scroll-target="#tk---upload-our-trained-model-to-hugging-face-hub"><span class="header-section-number">16</span> TK - Upload our trained model to Hugging Face Hub</a></li>
  <li><a href="#creating-a-demo-of-our-model-with-gradio" id="toc-creating-a-demo-of-our-model-with-gradio" class="nav-link" data-scroll-target="#creating-a-demo-of-our-model-with-gradio"><span class="header-section-number">17</span> Creating a demo of our model with Gradio</a>
  <ul class="collapse">
  <li><a href="#tk---upload-demo-to-hugging-face-spaces-to-get-it-live" id="toc-tk---upload-demo-to-hugging-face-spaces-to-get-it-live" class="nav-link" data-scroll-target="#tk---upload-demo-to-hugging-face-spaces-to-get-it-live"><span class="header-section-number">17.1</span> TK - Upload demo to Hugging Face Spaces to get it live</a></li>
  <li><a href="#tk---testing-the-hosted-demo" id="toc-tk---testing-the-hosted-demo" class="nav-link" data-scroll-target="#tk---testing-the-hosted-demo"><span class="header-section-number">17.2</span> TK - Testing the hosted demo</a></li>
  </ul></li>
  <li><a href="#tk---improve-our-model-with-data-augmentation" id="toc-tk---improve-our-model-with-data-augmentation" class="nav-link" data-scroll-target="#tk---improve-our-model-with-data-augmentation"><span class="header-section-number">18</span> TK - Improve our model with data augmentation</a>
  <ul class="collapse">
  <li><a href="#load-dataset" id="toc-load-dataset" class="nav-link" data-scroll-target="#load-dataset"><span class="header-section-number">18.1</span> Load dataset</a></li>
  <li><a href="#setup-model" id="toc-setup-model" class="nav-link" data-scroll-target="#setup-model"><span class="header-section-number">18.2</span> Setup model</a></li>
  <li><a href="#tk---setup-and-visualize-transforms-augmentations" id="toc-tk---setup-and-visualize-transforms-augmentations" class="nav-link" data-scroll-target="#tk---setup-and-visualize-transforms-augmentations"><span class="header-section-number">18.3</span> tk - Setup and visualize transforms (augmentations)</a></li>
  <li><a href="#tk---visualize-transforms" id="toc-tk---visualize-transforms" class="nav-link" data-scroll-target="#tk---visualize-transforms"><span class="header-section-number">18.4</span> TK - Visualize transforms</a></li>
  <li><a href="#tk---create-function-to-preprocess-and-transform-batch-of-examples" id="toc-tk---create-function-to-preprocess-and-transform-batch-of-examples" class="nav-link" data-scroll-target="#tk---create-function-to-preprocess-and-transform-batch-of-examples"><span class="header-section-number">18.5</span> TK - Create function to preprocess and transform batch of examples</a></li>
  <li><a href="#tk---save-the-trained-model" id="toc-tk---save-the-trained-model" class="nav-link" data-scroll-target="#tk---save-the-trained-model"><span class="header-section-number">18.6</span> TK - Save the trained model</a></li>
  </ul></li>
  <li><a href="#tk---upload-augmentation-model-to-hugging-face-hub" id="toc-tk---upload-augmentation-model-to-hugging-face-hub" class="nav-link" data-scroll-target="#tk---upload-augmentation-model-to-hugging-face-hub"><span class="header-section-number">19</span> TK - Upload Augmentation Model to Hugging Face Hub</a></li>
  <li><a href="#tk---compare-results-of-different-models" id="toc-tk---compare-results-of-different-models" class="nav-link" data-scroll-target="#tk---compare-results-of-different-models"><span class="header-section-number">20</span> TK - Compare results of different models</a></li>
  <li><a href="#tk---create-demo-with-augmentation-model" id="toc-tk---create-demo-with-augmentation-model" class="nav-link" data-scroll-target="#tk---create-demo-with-augmentation-model"><span class="header-section-number">21</span> TK - Create demo with Augmentation Model</a>
  <ul class="collapse">
  <li><a href="#tk---make-a-prediction-on-a-random-test-sample-with-model-using-data-aug-model" id="toc-tk---make-a-prediction-on-a-random-test-sample-with-model-using-data-aug-model" class="nav-link" data-scroll-target="#tk---make-a-prediction-on-a-random-test-sample-with-model-using-data-aug-model"><span class="header-section-number">21.1</span> TK - Make a prediction on a random test sample with model using data aug model</a></li>
  </ul></li>
  <li><a href="#tk---model-v3---cleaning-up-predictions-with-nms-non-max-suppression" id="toc-tk---model-v3---cleaning-up-predictions-with-nms-non-max-suppression" class="nav-link" data-scroll-target="#tk---model-v3---cleaning-up-predictions-with-nms-non-max-suppression"><span class="header-section-number">22</span> TK - Model V3 - Cleaning up predictions with NMS (Non-max Suppression)</a>
  <ul class="collapse">
  <li><a href="#tk---nms-filtering-logic-to-do" id="toc-tk---nms-filtering-logic-to-do" class="nav-link" data-scroll-target="#tk---nms-filtering-logic-to-do"><span class="header-section-number">22.1</span> TK - NMS filtering logic to do</a></li>
  <li><a href="#tk---simple-nms---keep-only-highest-scoring-class-per-prediction" id="toc-tk---simple-nms---keep-only-highest-scoring-class-per-prediction" class="nav-link" data-scroll-target="#tk---simple-nms---keep-only-highest-scoring-class-per-prediction"><span class="header-section-number">22.2</span> TK - Simple NMS - Keep only highest scoring class per prediction</a></li>
  <li><a href="#tk---greedy-iou-filtering---intersection-over-union---if-a-pair-of-boxes-have-an-iou-over-a-certain-threshold-keep-the-box-with-the-higher-score" id="toc-tk---greedy-iou-filtering---intersection-over-union---if-a-pair-of-boxes-have-an-iou-over-a-certain-threshold-keep-the-box-with-the-higher-score" class="nav-link" data-scroll-target="#tk---greedy-iou-filtering---intersection-over-union---if-a-pair-of-boxes-have-an-iou-over-a-certain-threshold-keep-the-box-with-the-higher-score"><span class="header-section-number">22.3</span> TK - Greedy IoU Filtering - Intersection over Union - If a pair of boxes have an IoU over a certain threshold, keep the box with the higher score</a></li>
  </ul></li>
  <li><a href="#tk---create-a-demo-with-simple-nms-filtering-only-keep-the-highest-scoring-boxes-per-image" id="toc-tk---create-a-demo-with-simple-nms-filtering-only-keep-the-highest-scoring-boxes-per-image" class="nav-link" data-scroll-target="#tk---create-a-demo-with-simple-nms-filtering-only-keep-the-highest-scoring-boxes-per-image"><span class="header-section-number">23</span> TK - Create a Demo with Simple NMS Filtering (only keep the highest scoring boxes per image)</a>
  <ul class="collapse">
  <li><a href="#tk---upload-our-demo-to-the-hugging-face-hub" id="toc-tk---upload-our-demo-to-the-hugging-face-hub" class="nav-link" data-scroll-target="#tk---upload-our-demo-to-the-hugging-face-hub"><span class="header-section-number">23.1</span> TK - Upload our demo to the Hugging Face Hub</a></li>
  <li><a href="#tk---embed-the-space-to-test-the-model" id="toc-tk---embed-the-space-to-test-the-model" class="nav-link" data-scroll-target="#tk---embed-the-space-to-test-the-model"><span class="header-section-number">23.2</span> tK - Embed the Space to Test the Model</a></li>
  </ul></li>
  <li><a href="#extensions-extra-curriculum" id="toc-extensions-extra-curriculum" class="nav-link" data-scroll-target="#extensions-extra-curriculum"><span class="header-section-number">24</span> Extensions + Extra-Curriculum</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">25</span> Summary</a></li>
  <li><a href="#extra-resources" id="toc-extra-resources" class="nav-link" data-scroll-target="#extra-resources"><span class="header-section-number">26</span> Extra resources</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mrdbourke/learn-huggingface/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/hugging_face_object_detection_tutorial.html">Computer Vision</a></li><li class="breadcrumb-item"><a href="../notebooks/hugging_face_object_detection_tutorial.html">(Work in progress) Build a custom object detection model and demo</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">[Work in Progress] Object Detection with Hugging Face Transformers Tutorial</h1>
</div>

<div>
  <div class="description">
    Learn how to create a custom object detection model with Hugging Face Transformers.
  </div>
</div>


<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<p>Details:</p>
<ul>
<li><strong>Goal:</strong> build several custom object detection models + deploy them as demos</li>
<li><strong>Status:</strong> Work in progress (code works but the annotations are in need of work)</li>
<li>See example finished project demo: <a href="https://huggingface.co/spaces/mrdbourke/trashify_demo_v3">https://huggingface.co/spaces/mrdbourke/trashify_demo_v3</a></li>
</ul>
<p>In progress:</p>
<ul>
<li>Going through and adding headings/annotations to each different section
<ul>
<li>Start with overview + introduction + getting started, then go from there (e.g.&nbsp;intro the project and show where weâ€™re going to end up) âœ…</li>
</ul></li>
</ul>
<p>Later:</p>
<ul>
<li>Record video version of the materials</li>
</ul>
<p><a target="_blank" href="https://colab.research.google.com/github/mrdbourke/learn-huggingface/blob/main/notebooks/hugging_face_object_detection_tutorial.ipynb"> <img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"> </a></p>
<p><a href="https://github.com/mrdbourke/learn-huggingface/blob/main/notebooks/hugging_face_object_detection_tutorial.ipynb">Source code on GitHub</a> | <a href="https://www.learnhuggingface.com/notebooks/hugging_face_object_detection_tutorial">Online book version</a> | <a href="https://www.learnhuggingface.com/extras/setup">Setup guide</a> | Video Course (coming soon)</p>
<section id="tk---overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="tk---overview"><span class="header-section-number">1</span> TK - Overview</h2>
<p>TK - Make an intro about being on the Trashify ðŸš® team with a mission to make the world a cleaner place, trashify = using ML to incentivize people to pick up trash in their local area</p>
<p>Welcome to the Learn Hugging Face Object Detection project!</p>
<p>Inside this project, weâ€™ll learn bits and pieces about the Hugging Face ecosystem as well as how to build our own custom object detection model.</p>
<p>Weâ€™ll start with a collection of images with bounding box files as our dataset, fine-tune an existing computer vision model to detect items in an image and then share our model as a demo others can use.</p>
TK image - update cover image for object detection <!-- <figure style="text-align: center;">
    <!-- figtemplate --> <img src="https://huggingface.co/datasets/mrdbourke/learn-hf-images/resolve/main/learn-hf-text-classification/00-project-food-not-food-overview.png" alt="
Project overview image for 'Food Not Food' classification at Nutrify, a food app. The project involves building and deploying a binary text classification model to identify food-related text using Hugging Face Datasets, Transformers, and deploying with Hugging Face Hub/Spaces and Gradio. Examples include labels for 'A photo of sushi rolls on a white plate' (food), 'A serving of chicken curry in a blue bowl' (food), and 'A yellow tractor driving over a grassy hill' (not food). The process is visually depicted from data collection to model training and demo deployment." style="width: 100%; max-width: 900px; height: auto;">
<figcaption>
Weâ€™re going to put on our internship hats and build a food not food text classification model using tools from the Hugging Face ecosystem.
</figcaption>

<p>â€“&gt;</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Feel to keep reading through the notebook but if youâ€™d like to run the code yourself, be sure to go through the <a href="https://www.learnhuggingface.com/extras/setup">setup guide</a> first.</p>
</div>
</div>
<section id="tk---what-were-going-to-build" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="tk---what-were-going-to-build"><span class="header-section-number">1.1</span> TK - What weâ€™re going to build</h3>
<p>Weâ€™re going to be bulding Trashify ðŸš®, an <strong>object detection model</strong> which incentivises people to pick up trash in their local area by detecting <code>bin</code>, <code>trash</code>, <code>hand</code>.</p>
<p>If all three items are detected, a person gets +1 point!</p>
<p>For example, say you were going for a walk around your neighbourhood and took a photo of yourself picking up a piece (with your <strong>hand</strong> or <strong>trash arm</strong>) of <strong>trash</strong> and putting it in the <strong>bin</strong>, you would get a point.</p>
<p>With this object detection model, you could deploy it to an application which would automatically detect the target classes and then save the result to an online leaderboard.</p>
<p>The incentive would be to score the most points, in turn, picking up the most piecces of trash, in a given area.</p>
<p>More specifically, weâ€™re going to follow the following steps:</p>
<ol type="1">
<li><strong><a href="https://huggingface.co/datasets/mrdbourke/trashify_manual_labelled_images">Data</a>: Problem defintion and dataset preparation</strong> - Getting a dataset/setting up the problem space.</li>
<li><strong><a href="https://huggingface.co/docs/transformers/en/model_doc/conditional_detr">Model</a>: Finding, training and evaluating a model</strong> - Finding an object detection model suitable for our problem on Hugging Face and customizing it to our own dataset.</li>
<li><strong><a href="https://huggingface.co/spaces/mrdbourke/trashify_demo_v3">Demo</a>: Creating a demo and put our model into the real world</strong> - Sharing our trained model in a way others can access and use.</li>
</ol>
<p>By the end of this project, youâ€™ll have a trained model and <a href="https://huggingface.co/spaces/mrdbourke/trashify_demo_v3">demo on Hugging Face</a> you can share with others:</p>
<div id="cell-5" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>HTML(<span class="st">"""</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;iframe</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">    src="https://mrdbourke-trashify-demo-v3.hf.space"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">    frameborder="0"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">    width="850"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">    height="850"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">&gt;&lt;/iframe&gt;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">

<iframe src="https://mrdbourke-trashify-demo-v3.hf.space" frameborder="0" width="850" height="850"></iframe>
</div>
</div>
</section>
<section id="tk---what-is-object-detection" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="tk---what-is-object-detection"><span class="header-section-number">1.2</span> TK - What is object detection?</h3>
<p>Object detection is the process of identifying and locating an item in an image.</p>
<p>Where <em>item</em> can mean almost anything.</p>
<p>For example:</p>
<ul>
<li>Detecting car <strong>licence plates</strong> in a video feed (videos are a series of images) for a parking lot entrance.</li>
<li>Detecting <strong>delivery people</strong> walking towards your front door on a security camera.</li>
<li>Detecting <strong>defects</strong> on a manufacturing line.</li>
<li>Detecting <a href="https://ieeexplore.ieee.org/abstract/document/9968423"><strong>pot holes</strong> in the road</a> so repair works can automatically be scheduled.</li>
<li>Detecting <strong>small pests (Varroa Mite)</strong> on the bodies of bees.</li>
<li>Detecting <a href="https://ai.meta.com/blog/pytorch-drives-next-gen-intelligent-farming-machines/"><strong>weeds</strong> in a field</a> so you know what to remove and what to keep.</li>
</ul>
<p>â€“</p>
<p>TK - add examples of actual trash identification projects, see:</p>
<ul>
<li>Google using machine learning for trash identification â€” <a href="https://sustainability.google/operating-sustainably/stories/circular-economy-marketplace/">https://sustainability.google/operating-sustainably/stories/circular-economy-marketplace/</a></li>
<li>Trashify website for identifying trash â€” <a href="https://www.trashify.tech/">https://www.trashify.tech/</a></li>
<li>Waste management with deep learning â€” <a href="https://www.sciencedirect.com/science/article/abs/pii/S0956053X23001915">https://www.sciencedirect.com/science/article/abs/pii/S0956053X23001915</a></li>
<li>Label Studio being used for labelling a trash dataset â€” <a href="https://labelstud.io/blog/ameru-labeling-for-a-greener-world/">https://labelstud.io/blog/ameru-labeling-for-a-greener-world/</a></li>
</ul>
<p>â€“</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Note:</strong> Object detection is also sometimes referred to as <em>image localization</em> or <em>object localization</em>. For consistency, I will use the term object detection, however, either of these terms could substitute.</p>
</div>
</div>
<table class="caption-top table">
<tbody>
<tr class="odd">
<td>* TK image - examples of where object detection is used</td>
</tr>
</tbody>
</table>
<p><strong>Image classification</strong> deals with classifying an image as a whole into a single <code>class</code>, object detection endeavours to find the specific target item and <em>where</em> it is in an image.</p>
<p>One of the most common ways of showing where an item is in an image is by displaying a <strong>bounding box</strong> (a rectangle-like box around the target item).</p>
<p>An object detection model will often take an input image tensor in the shape <code>[3, 640, 640]</code> (<code>[colour_channels, height, width]</code>) and output a tensor in the form <code>[class_name, x_min, y_min, x_max, y_max]</code> or <code>[class_name, x1, y1, x2, y2]</code> (this is two ways to write the same example format, there are more formats, weâ€™ll see these below in <a href="#tbl-bbox-formats" class="quarto-xref">Table&nbsp;1</a>).</p>
<p>Where:</p>
<ul>
<li><code>class_name</code> = The classification of the target item (e.g.&nbsp;<code>"car"</code>, <code>"person"</code>, <code>"banana"</code>, <code>"piece_of_trash"</code>, this could be almost anything).</li>
<li><code>x_min</code> = The <code>x</code> value of the top left corner of the box.</li>
<li><code>y_min</code> = The <code>y</code> value of the top left corner of the box.</li>
<li><code>x_max</code> = The <code>x</code> value of the bottom right corner of the box.</li>
<li><code>y_max</code> = The <code>y</code> value of the bottom right corner of the box.</li>
</ul>
<p>â€“ TK image â€“ example of a bounding box on an image</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Object detection bounding box formats
</div>
</div>
<div class="callout-body-container callout-body">
<p>When you get into the world of object detection, you will find that there are several different bounding box formats.</p>
<p>There are three major formats you should be familiar with: <code>XYXY</code>, <code>XYWH</code>, <code>CXCYWH</code> (there are more but these are the most common).</p>
<p>Knowing which bounding box format youâ€™re working with can be the difference between a good model and a <em>very</em> poor model (wrong bounding boxes = wrong outcome).</p>
<p>Weâ€™ll get hands-on with a couple of these in this project.</p>
<p>But for an in-depth example of all three, I created a <a href="https://www.learnml.io/posts/a-guide-to-bounding-box-formats/">guide on different bounding box formats and how to draw them</a>, reading this should give a good intuition behind each style of bounding box.</p>
</div>
</div>
</section>
<section id="tk---why-train-your-own-object-detection-models" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="tk---why-train-your-own-object-detection-models"><span class="header-section-number">1.3</span> TK - Why train your own object detection models?</h3>
<p>You can customize <strong>pre-trained models</strong> for object detection as well as API-powered models and LLMs such as <a href="https://ai.google.dev/gemini-api/docs/vision?lang=python#bbox">Gemini</a>, <a href="https://landing.ai/agentic-object-detection">LandingAI</a> and <a href="https://github.com/IDEA-Research/DINO-X-API">DINO-X</a>.</p>
<p>Depending on your requirements, there are several pros and cons for using your own model versus using an API.</p>
<p>Training/fine-tuning your own model:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Pros</th>
<th style="text-align: left;">Cons</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Control:</strong> Full control over model lifecycle.</td>
<td style="text-align: left;">Can be complex to get setup.</td>
</tr>
<tr class="even">
<td style="text-align: left;">No usage limits (aside from compute constraints).</td>
<td style="text-align: left;">Requires dedicated compute resources for training/inference.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Can train once and deploy everywhere/whenever you want (for example, Tesla deploying a model to all self-driving cars).</td>
<td style="text-align: left;">Requires maintenance over time to ensure performance remains up to par.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Privacy:</strong> Data can be kept in-house/app and doesnâ€™t need to go to a third party.</td>
<td style="text-align: left;">Can require longer development cycles compared to using existing APIs.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Speed:</strong> Customizing a small model for a specific use case often means it runs much faster on local hardware, for example, modern object detection models can achieve 70-100+ FPS (frames per second) on modern GPU hardware.</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>Using a pre-built model API:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Pros</th>
<th style="text-align: left;">Cons</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Ease of use:</strong> often can be setup within a few lines of code.</td>
<td style="text-align: left;">If the model API goes down, your service goes down.</td>
</tr>
<tr class="even">
<td style="text-align: left;">No maintenance of compute resources.</td>
<td style="text-align: left;">Data is required to be sent to a third-party for processing.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Access to the most advanced models.</td>
<td style="text-align: left;">The API may have usage limits per day/time period.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Can scale if usage increases.</td>
<td style="text-align: left;">Can be much slower than using dedicated models due to requiring an API call.</td>
</tr>
</tbody>
</table>
<p>For this project, weâ€™re going to focus on fine-tuning our own model.</p>
</section>
<section id="tk---workflow-were-going-to-follow" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="tk---workflow-were-going-to-follow"><span class="header-section-number">1.4</span> TK - Workflow weâ€™re going to follow</h3>
<p>The good news for us is that the Hugging Face ecosystem makes working on custom machine learning projects an absolute blast.</p>
<p>And workflow is reproducible across several kinds of projects.</p>
<p>Start with data (or skip this step and go straight to a model) -&gt; get/customize a model -&gt; build and share a demo.</p>
<p>With this in mind, our motto is <em>data, model, demo!</em></p>
<p>More specifically, weâ€™re going to follow the rough workflow of:</p>
<ol type="1">
<li>Create, preprocess and load data using <a href="https://huggingface.co/docs/datasets/index">Hugging Face Datasets</a>.</li>
<li>Define the model weâ€™d like use with <a href="https://huggingface.co/docs/transformers/en/model_doc/auto#transformers.AutoModelForObjectDetection"><code>transformers.AutoModelForObjectDetection</code></a> (or another similar model class).</li>
<li>Define training arguments (these are hyperparameters for our model) with <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer#transformers.TrainingArguments"><code>transformers.TrainingArguments</code></a>.</li>
<li>Pass <code>TrainingArguments</code> from 3 and target datasets to an instance of <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer"><code>transformers.Trainer</code></a>.</li>
<li>Train the model by calling <a href="https://huggingface.co/docs/transformers/v4.40.2/en/main_classes/trainer#transformers.Trainer.train"><code>Trainer.train()</code></a>.</li>
<li>Save the model (to our local machine or to the Hugging Face Hub).</li>
<li>Evaluate the trained model by making and inspecting predctions on the test data.</li>
<li>Turn the model into a shareable demo.</li>
</ol>
<p>I say rough because machine learning projects are often non-linear in nature.</p>
<p>As in, because machine learning projects involve many experiments, they can kind of be all over the place.</p>
<p>But this worfklow will give us some good guidelines to follow.</p>
<figure style="text-align: center; display: inline-block;" class="figure">
<!-- figtemplate -->
<img src="https://huggingface.co/datasets/mrdbourke/learn-hf-images/resolve/main/learn-hf-text-classification/01-hugging-face-workflow.png" alt="The diagram shows the Hugging Face model development workflow, which includes the following steps: start with an idea or problem, get data ready (turn into tensors/create data splits), pick a pretrained model (to suit your problem), train/fine-tune the model on your custom data, evaluate the model, improve through experimentation, save and upload the fine-tuned model to the Hugging Face Hub, and turn your model into a shareable demo. Tools used in this workflow are Datasets/Tokenizers, Transformers/PEFT/Accelerate/timm, Hub/Spaces/Gradio, and Evaluate." style="width: 100%; max-width: 900px; height: auto;" class="figure-img">
<figcaption style="width: 100%; box-sizing: border-box;">
A general Hugging Face workflow from idea to shared model and demo using tools from the Hugging Face ecosystem. Youâ€™ll notice some of the steps donâ€™t match with our workflow outline above. This is because the text-based workflow outline above breaks some of the steps down for educational purposes. These kind of workflows are not set in stone and are more of guide than specific directions. See information on each of the tools in the <a href="https://huggingface.co">Hugging Face documentation</a>.
</figcaption>
</figure>
</section>
</section>
<section id="tk---importing-necessary-libraries" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="tk---importing-necessary-libraries"><span class="header-section-number">2</span> TK - Importing necessary libraries</h2>
<p>Letâ€™s get started!</p>
<p>First, weâ€™ll import the required libraries.</p>
<p>If youâ€™re running on your local computer, be sure to check out the getting <a href="https://www.learnhuggingface.com/extras/setup">setup guide</a> to make sure you have everything you need.</p>
<p>If youâ€™re using Google Colab, many of them the following libraries will be installed by default.</p>
<p>However, weâ€™ll have to install a few extras to get everything working.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If youâ€™re running on Google Colab, this notebook will work best with access to a GPU. To enable a GPU, go to <code>Runtime</code> âž¡ï¸ <code>Change runtime type</code> âž¡ï¸ <code>Hardware accelerator</code> âž¡ï¸ <code>GPU</code>.</p>
</div>
</div>
<p>Weâ€™ll need to install the following libraries from the Hugging Face ecosystem:</p>
<ul>
<li><a href="https://huggingface.co/docs/transformers/en/installation"><code>transformers</code></a> - comes pre-installed on Google Colab but if youâ€™re running on your local machine, you can install it via <code>pip install transformers</code>.</li>
<li><a href="https://huggingface.co/docs/datasets/installation"><code>datasets</code></a> - a library for accessing and manipulating datasets on and off the Hugging Face Hub, you can install it via <code>pip install datasets</code>.</li>
<li><a href="https://huggingface.co/docs/evaluate/installation"><code>evaluate</code></a> - a library for evaluating machine learning model performance with various metrics, you can install it via <code>pip install evaluate</code>.</li>
<li><a href="https://huggingface.co/docs/accelerate/basic_tutorials/install"><code>accelerate</code></a> - a library for training machine learning models faster, you can install it via <code>pip install accelerate</code>.</li>
<li><a href="https://www.gradio.app/guides/quickstart#installation"><code>gradio</code></a> - a library for creating interactive demos of machine learning models, you can install it via <code>pip install gradio</code>.</li>
</ul>
<p>And the following library is not part of the Hugging Face ecosystem but it is helpful for evaluating our models:</p>
<ul>
<li><a href="https://lightning.ai/docs/torchmetrics/stable/"><code>torchmetrics</code></a> - a library containing many evaluation metrics compatible with PyTorch/Transformers, you can install it via <code>pip install torchmetrics</code>.</li>
</ul>
<p>We can also check the versions of our software with <code>package_name.__version__</code>.</p>
<div id="cell-10" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install/import dependencies (this is mostly for Google Colab, as the other dependences are available by default in Colab)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> datasets, evaluate, accelerate</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ModuleNotFoundError</span>:</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">!</span>pip install <span class="op">-</span>U datasets evaluate accelerate gradio <span class="co"># -U stands for "upgrade" so we'll get the latest version by default</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> datasets, evaluate, accelerate</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> transformers</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Required for evaluation</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Can install with !pip install torchmetrics[detection]</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchmetrics</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pycocotools</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Check versions (as long as you've got the following versions or higher, you should be good)</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using transformers version: </span><span class="sc">{</span>transformers<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using datasets version: </span><span class="sc">{</span>datasets<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using torch version: </span><span class="sc">{</span>torch<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using torchmetrics version: </span><span class="sc">{</span>torchmetrics<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using transformers version: 4.48.3
Using datasets version: 3.1.0
Using torch version: 2.6.0+cu124
Using torchmetrics version: 1.4.1</code></pre>
</div>
</div>
<p>Wonderful, as long as your versions are the same or higher to the versions above, you should be able to run the code below.</p>
</section>
<section id="getting-a-dataset" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="getting-a-dataset"><span class="header-section-number">3</span> Getting a dataset</h2>
<p>Okay, now weâ€™re got the required libraries, letâ€™s get a dataset.</p>
<p>Getting a dataset is one of the most important things a machine learning project.</p>
<p>The dataset you often determines the type of model you use as well as the quality of the outputs of that model.</p>
<p>Meaning, if you have a high quality dataset, chances are, your future model could also have high quality outputs.</p>
<p>It also means if your dataset is of poor quality, your model will likely also have poor quality outputs.</p>
<p>For an object detection problem, your dataset will likely come in the form of a group of images as well as a file with annotations belonging to those images.</p>
<p>For example, you might have the following setup:</p>
<pre><code>folder_of_images/
    image_1.jpeg
    image_2.jpeg
    image_3.jpeg
annotations.json</code></pre>
<p>Where the <code>annotations.json</code> contains details about the contains of each image:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>annotations.json</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="annotations.json"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="er">'image_path'</span><span class="fu">:</span> <span class="er">'image_</span><span class="dv">1</span><span class="er">.jpeg'</span><span class="fu">,</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="er">'image_id'</span><span class="fu">:</span> <span class="dv">42</span><span class="fu">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="er">'annotations'</span><span class="fu">:</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">{</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                <span class="er">'file_name'</span><span class="fu">:</span> <span class="ot">[</span><span class="er">'image_</span><span class="dv">1</span><span class="er">.jpeg'</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                <span class="er">'image_id'</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">42</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                <span class="er">'category_id'</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">1</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                <span class="er">'bbox'</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                            <span class="ot">[</span><span class="fl">360.20001220703125</span><span class="ot">,</span> <span class="fl">528.5</span><span class="ot">,</span> <span class="fl">177.1999969482422</span><span class="ot">,</span> <span class="fl">261.79998779296875</span><span class="ot">],</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                <span class="er">'area'</span><span class="fu">:</span> <span class="ot">[</span><span class="fl">46390.9609375</span><span class="ot">]</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">},</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="er">'label_source'</span><span class="fu">:</span> <span class="er">'manual_prodigy_label'</span><span class="fu">,</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="er">'image_source'</span><span class="fu">:</span> <span class="er">'manual_taken_photo'</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="er">...(more</span> <span class="er">labels</span> <span class="er">down</span> <span class="er">here)</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Donâ€™t worry too much about the exact meaning of everything in the above <code>annotations.json</code> file for now (this is only one example, there are many different ways object detection information could be displayed).</p>
<p>The main point is that each target image is paired with an assosciated label.</p>
<p>Now like all good machine learning cooking shows, Iâ€™ve prepared a dataset from earlier.</p>
<p>TK image - dataset on Hugging Face</p>
<p>Itâ€™s stored on Hugging Face Datasets (also called the Hugging Face Hub) under the name <a href="https://huggingface.co/datasets/mrdbourke/trashify_manual_labelled_images"><code>mrdbourke/trashify_manual_labelled_images</code></a>.</p>
<p>This is a dataset Iâ€™ve collected manually by hand (yes, by picking up 1000+ pieces of trash and photographing it) as well as labelled by hand (by drawing boxes on each image with a labelling tool called <a href="https://prodi.gy/features/computer-vision">Prodigy</a>).</p>
<section id="loading-the-dataset" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="loading-the-dataset"><span class="header-section-number">3.1</span> Loading the dataset</h3>
<p>To load a dataset stored on the Hugging Face Hub we can use the <a href="https://huggingface.co/docs/datasets/en/package_reference/loading_methods#datasets.load_dataset"><code>datasets.load_dataset(path=NAME_OR_PATH_OF_DATASET)</code></a> function and pass it the name/path of the dataset we want to load.</p>
<p>In our case, our dataset name is <code>mrdbourke/trashify_manual_labelled_images</code> (you can also change this for your own dataset).</p>
<p>And since our dataset is hosted on Hugging Face, when we run the following code for the first time, it will download it.</p>
<p>If your target dataset is quite large, this download may take a while.</p>
<p>However, once the dataset is downloaded, subsequent reloads will be mush faster.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Getting information about a function/method">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Getting information about a function/method
</div>
</div>
<div class="callout-body-container callout-body">
<p>One way to find out what a function or method does is to lookup the documentation.</p>
<p>Another way is to write the function/method name with a question mark afterwards.</p>
<p>For example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>load_dataset?</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Give it a try.</p>
<p>You should see some helpful information about what inputs the method takes and how they are used.</p>
</div>
</div>
<p>Letâ€™s load our dataset and check it out.</p>
<div id="cell-14" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load our Trashify dataset</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> load_dataset(path<span class="op">=</span><span class="st">"mrdbourke/trashify_manual_labelled_images"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['image', 'image_id', 'annotations', 'label_source', 'image_source'],
        num_rows: 1128
    })
})</code></pre>
</div>
</div>
<p>Beautiful!</p>
<p>We can see that there is a <code>train</code> split of the dataset already which currently contains all of the samples (<code>1128</code> in total).</p>
<p>There are also some <code>features</code> that come with our dataset which are related to our object detection goal.</p>
<div id="cell-16" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Length of original dataset: </span><span class="sc">{</span><span class="bu">len</span>(dataset[<span class="st">'train'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Dataset features:"</span>) </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>pprint(dataset[<span class="st">'train'</span>].features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Length of original dataset: 1128
[INFO] Dataset features:
{'annotations': Sequence(feature={'area': Value(dtype='float32', id=None),
                                  'bbox': Sequence(feature=Value(dtype='float32',
                                                                 id=None),
                                                   length=4,
                                                   id=None),
                                  'category_id': ClassLabel(names=['bin',
                                                                   'hand',
                                                                   'not_bin',
                                                                   'not_hand',
                                                                   'not_trash',
                                                                   'trash',
                                                                   'trash_arm'],
                                                            id=None),
                                  'file_name': Value(dtype='string', id=None),
                                  'image_id': Value(dtype='int64', id=None),
                                  'iscrowd': Value(dtype='int64', id=None)},
                         length=-1,
                         id=None),
 'image': Image(mode=None, decode=True, id=None),
 'image_id': Value(dtype='int64', id=None),
 'image_source': Value(dtype='string', id=None),
 'label_source': Value(dtype='string', id=None)}</code></pre>
</div>
</div>
<p>Nice!</p>
<p>We can see our dataset <code>features</code> contain the following fields:</p>
<ul>
<li><code>annotations</code> - A sequence of values including a <code>bbox</code> field (short for bounding box) as well as <code>category_id</code> field which contains the target objects weâ€™d like to identify in our images (<code>['bin', 'hand', 'not_bin', 'not_hand', 'not_trash', 'trash', 'trash_arm']</code>).</li>
<li><code>image</code> - This contains the target image assosciated with a given set of <code>annotations</code> (in our case, images and annotations have been uploaded to the Hugging Face Hub together).</li>
<li><code>image_id</code> - A unique ID assigned to a given sample.</li>
<li><code>image_source</code> - Where the image came from (all of our images have been manually collected).</li>
<li><code>label_source</code> - Where the image label came from (all of our images have been manually labelled).</li>
</ul>
</section>
<section id="viewing-a-single-sample-from-our-data" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="viewing-a-single-sample-from-our-data"><span class="header-section-number">3.2</span> Viewing a single sample from our data</h3>
<p>Now weâ€™ve seen the features, letâ€™s check out a single sample from our dataset.</p>
<p>We can index on a single sample of the <code>"train"</code> set just like indexing on a Python list.</p>
<div id="cell-19" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View a single sample of the dataset</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>dataset[<span class="st">"train"</span>][<span class="dv">42</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>{'image': &lt;PIL.Image.Image image mode=RGB size=960x1280&gt;,
 'image_id': 745,
 'annotations': {'file_name': ['094f4f41-dc07-4704-96d7-8d5e82c9edb9.jpeg',
   '094f4f41-dc07-4704-96d7-8d5e82c9edb9.jpeg',
   '094f4f41-dc07-4704-96d7-8d5e82c9edb9.jpeg'],
  'image_id': [745, 745, 745],
  'category_id': [5, 1, 0],
  'bbox': [[333.1000061035156,
    611.2000122070312,
    244.89999389648438,
    321.29998779296875],
   [504.0, 612.9000244140625, 451.29998779296875, 650.7999877929688],
   [202.8000030517578,
    366.20001220703125,
    532.9000244140625,
    555.4000244140625]],
  'iscrowd': [0, 0, 0],
  'area': [78686.3671875, 293706.03125, 295972.65625]},
 'label_source': 'manual_prodigy_label',
 'image_source': 'manual_taken_photo'}</code></pre>
</div>
</div>
<p>We see a few more details here compared to just looking at the features.</p>
<p>We notice the <code>image</code> is a <a href="https://pillow.readthedocs.io/en/stable/reference/Image.html"><code>PIL.Image</code></a> with size <code>960x1280</code> (width x height).</p>
<p>And the <code>file_name</code> is a UUID (Universially Unique Identifier, made with <a href="https://docs.python.org/3/library/uuid.html#uuid.uuid4"><code>uuid.uuid4()</code></a>).</p>
<p>The <code>bbox</code> field in the <code>annotations</code> key contains a list of bounding boxes assosciated with the image.</p>
<p>In this case, there are 3 different bounding boxes.</p>
<p>With the <code>category_id</code> values of <code>5</code>, <code>1</code>, <code>0</code> (weâ€™ll map these to class names shortly).</p>
<p>Letâ€™s inspect a single bounding box.</p>
<div id="cell-21" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dataset[<span class="st">"train"</span>][<span class="dv">42</span>][<span class="st">"annotations"</span>][<span class="st">"bbox"</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>[333.1000061035156, 611.2000122070312, 244.89999389648438, 321.29998779296875]</code></pre>
</div>
</div>
<p>This array gives us the coordinates of a single bounding box in the format <code>XYWH</code>.</p>
<p>Where:</p>
<ul>
<li><code>X</code> is the x-coordinate of the top left corner of the box (<code>333.1</code>).</li>
<li><code>Y</code> is the y-coordinate of the top left corner of the box (<code>611.2</code>).</li>
<li><code>W</code> is the width of the box (<code>244.9</code>).</li>
<li><code>H</code> is the height of the box (<code>321.3</code>).</li>
</ul>
<p>All of these values are in absolute pixel values (meaning an x-coordinate of <code>333.1</code> is <code>333.1</code> pixels across on the x-axis).</p>
<p>How do I know this?</p>
<p>I know this because I created the box labels and this is the default value Prodigy (the labelling tool I used) outputs boxes.</p>
<p>However, if you were to come across another bouding box dataset, one of the first steps would be to <strong>figure out what format your bounding boxes are in</strong>.</p>
<p>Weâ€™ll see more on bounding box formats shortly.</p>
</section>
<section id="extracting-the-category-names-from-our-data" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="extracting-the-category-names-from-our-data"><span class="header-section-number">3.3</span> Extracting the category names from our data</h3>
<p>Before we start to visualize our sample image and bounding boxes, letâ€™s extract the category names from our dataset.</p>
<p>We can do so by accessing the <code>features</code> attribute our of <code>dataset</code> and then following it through to find the <code>category_id</code> feature, this contains a list of our text-based class names.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When working with different categories, itâ€™s good practice to get a list or mapping (e.g.&nbsp;a Python dictionary) from category name to ID and vice versa.</p>
<p>For example:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Category to ID</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>{<span class="st">"class_name"</span>: <span class="dv">0</span>}</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ID to Category</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>{<span class="dv">0</span>: <span class="st">"class_name"</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Not all datasets will have this implemented in an easy to access way, so it might take a bit of research to get it created.</p>
</div>
</div>
<p>Letâ€™s access the class names in our dataset and save them to a variable <code>categories</code>.</p>
<div id="cell-24" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the categories from the dataset</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: This requires the dataset to have been uploaded with this information setup, not all datasets will have this available.</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>categories <span class="op">=</span> dataset[<span class="st">"train"</span>].features[<span class="st">"annotations"</span>].feature[<span class="st">"category_id"</span>]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the names attribute</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>categories.names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>['bin', 'hand', 'not_bin', 'not_hand', 'not_trash', 'trash', 'trash_arm']</code></pre>
</div>
</div>
<p>Beautiful!</p>
<p>We get the following class names:</p>
<ul>
<li><code>bin</code> - A rubbish bin or trash can.</li>
<li><code>hand</code> - A personâ€™s hand.</li>
<li><code>not_bin</code> - Negative version of <code>bin</code> for items that look like a <code>bin</code> but shouldnâ€™t be identified as one.</li>
<li><code>not_hand</code> - Negative version of <code>hand</code> for items that look like a <code>hand</code> but shouldnâ€™t be identified as one.</li>
<li><code>not_trash</code> - Negative version of <code>trash</code> for items that look like <code>trash</code> but shouldnâ€™t be identified as it.</li>
<li><code>trash</code> - An item of trash you might find on a walk such as an old plastic bottle, food wrapper, cigarette butt or used coffee cup.</li>
<li><code>trash_arm</code> - A mechanical arm used for picking up trash.</li>
</ul>
<p>The goal of our computer vision model will be: given an image, detect items belonging to these target classes if they are present.</p>
</section>
<section id="creating-a-mapping-from-numbers-to-labels" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="creating-a-mapping-from-numbers-to-labels"><span class="header-section-number">3.4</span> Creating a mapping from numbers to labels</h3>
<p>Now weâ€™ve got our text-based class names, letâ€™s create a mapping from label to ID and ID to label.</p>
<p>For each of these, Hugging Face use the terminology <code>label2id</code> and <code>id2label</code> respectively.</p>
<div id="cell-27" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map ID's to class names and vice versa</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>id2label <span class="op">=</span> {i: class_name <span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(categories.names)}</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>label2id <span class="op">=</span> {value: key <span class="cf">for</span> key, value <span class="kw">in</span> id2label.items()}</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Label to ID mapping:</span><span class="ch">\n</span><span class="sc">{</span>label2id<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"ID to label mapping:</span><span class="ch">\n</span><span class="sc">{</span>id2label<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># id2label, label2id</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label to ID mapping:
{'bin': 0, 'hand': 1, 'not_bin': 2, 'not_hand': 3, 'not_trash': 4, 'trash': 5, 'trash_arm': 6}

ID to label mapping:
{0: 'bin', 1: 'hand', 2: 'not_bin', 3: 'not_hand', 4: 'not_trash', 5: 'trash', 6: 'trash_arm'}</code></pre>
</div>
</div>
</section>
<section id="creating-a-colour-palette" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="creating-a-colour-palette"><span class="header-section-number">3.5</span> Creating a colour palette</h3>
<p>Ok we know which class name matches to which ID, now letâ€™s create a dictionary of different colours we can use to display our bounding boxes.</p>
<p>Itâ€™s one thing to plot bounding boxes, itâ€™s another thing to make them look nice.</p>
<p>And we always want our plots looking nice!</p>
<p>Weâ€™ll colour the positive classes <code>bin</code>, <code>hand</code>, <code>trash</code>, <code>trash_arm</code> in nice bright colours.</p>
<p>And the negative classes <code>not_bin</code>, <code>not_hand</code>, <code>not_trash</code> in a light red colour to indicate theyâ€™re the negative versions.</p>
<p>Our colour dictionary will map <code>class_name</code> -&gt; <code>(red, green, blue)</code> (or <a href="https://en.wikipedia.org/wiki/RGB_color_model">RGB</a>) colour values.</p>
<div id="cell-29" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make colour dictionary</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>colour_palette <span class="op">=</span> {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bin'</span>: (<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">224</span>),         <span class="co"># Bright Blue (High contrast with greenery) in format (red, green, blue)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'not_bin'</span>: (<span class="dv">255</span>, <span class="dv">80</span>, <span class="dv">80</span>),   <span class="co"># Light Red to indicate negative class</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'hand'</span>: (<span class="dv">148</span>, <span class="dv">0</span>, <span class="dv">211</span>),      <span class="co"># Dark Purple (Contrasts well with skin tones)</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'not_hand'</span>: (<span class="dv">255</span>, <span class="dv">80</span>, <span class="dv">80</span>),  <span class="co"># Light Red to indicate negative class</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trash'</span>: (<span class="dv">0</span>, <span class="dv">255</span>, <span class="dv">0</span>),       <span class="co"># Bright Green (For trash-related items)</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'not_trash'</span>: (<span class="dv">255</span>, <span class="dv">80</span>, <span class="dv">80</span>), <span class="co"># Light Red to indicate negative class</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trash_arm'</span>: (<span class="dv">255</span>, <span class="dv">140</span>, <span class="dv">0</span>), <span class="co"># Deep Orange (Highly visible)</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Letâ€™s check out what these colours look like!</p>
<p>Itâ€™s the ABV motto: <em>Always Be Visualizing!</em></p>
<p>We can plot our colours with <code>matplotlib</code>.</p>
<p>Weâ€™ll just have to write a small function to normalize our colour values from <code>[0, 255]</code> to <code>[0, 1]</code> (<code>matplotlib</code> expects our colour values to be between 0 and 1).</p>
<div id="cell-31" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize RGB values to 0-1 range</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_rgb(rgb_tuple):</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">tuple</span>(x<span class="op">/</span><span class="dv">255</span> <span class="cf">for</span> x <span class="kw">in</span> rgb_tuple)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn colors into normalized RGB values for matplotlib</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>colors_and_labels_rgb <span class="op">=</span> [(key, normalize_rgb(value)) <span class="cf">for</span> key, value <span class="kw">in</span> colour_palette.items()]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create figure and axis</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">7</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">1</span>))</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten the axis array for easier iteration</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> ax.flatten()</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot each color square</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, (label, color) <span class="kw">in</span> <span class="bu">enumerate</span>(colors_and_labels_rgb):</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    ax[idx].add_patch(plt.Rectangle(xy<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>), </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                                    width<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                                    height<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>                                    facecolor<span class="op">=</span>color))</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    ax[idx].set_title(label)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    ax[idx].set_xlim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    ax[idx].set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    ax[idx].axis(<span class="st">'off'</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Sensational!</p>
<p>Now we know what colours to look out for when we visualize our bounding boxes.</p>
</section>
</section>
<section id="tk---plotting-a-single-image-and-visualizing-the-boxes" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="tk---plotting-a-single-image-and-visualizing-the-boxes"><span class="header-section-number">4</span> TK - Plotting a single image and visualizing the boxes</h2>
<p>Okay, okay, finally time to plot an image!</p>
<p>Letâ€™s take a random sample from our <code>dataset</code> and plot the image as well as the box on it.</p>
<p>To save some space in our notebook (plotting many images can increase the size of our notebook dramatically), weâ€™ll create two small helper functions:</p>
<ol type="1">
<li><code>half_image</code> - Halves the size of a given image.</li>
<li><code>half_boxes</code> - Divides the input coordinates of a given input box by 2.</li>
</ol>
<p>These functions arenâ€™t 100% necessary in our workflow.</p>
<p>Theyâ€™re just to make the images slightly smaller so they fit better in the notebook.</p>
<div id="cell-34" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> PIL</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> half_image(image: PIL.Image) <span class="op">-&gt;</span> PIL.Image:</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Resizes a given input image by half and returns the smaller version.</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image.resize(size<span class="op">=</span>(image.size[<span class="dv">0</span>] <span class="op">//</span> <span class="dv">2</span>, image.size[<span class="dv">1</span>] <span class="op">//</span> <span class="dv">2</span>))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> half_boxes(boxes):</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Halves an array/tensor of input boxes and returns them. Necessary for plotting them on a half-sized image.</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    For example:</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">    boxes = [100, 100, 100, 100]</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">    half_boxes = half_boxes(boxes)</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">    print(half_boxes)</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; [50, 50, 50, 50]</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(boxes, <span class="bu">list</span>):</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If boxes are list of lists, then we have multiple boxes</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> box <span class="kw">in</span> boxes:</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(box, <span class="bu">list</span>):</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> [[coordinate <span class="op">//</span> <span class="dv">2</span> <span class="cf">for</span> coordinate <span class="kw">in</span> box] <span class="cf">for</span> box <span class="kw">in</span> boxes]</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> [coordinate <span class="op">//</span> <span class="dv">2</span> <span class="cf">for</span> coordinate <span class="kw">in</span> boxes]         </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(boxes, np.ndarray):</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (boxes <span class="op">//</span> <span class="dv">2</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(boxes, torch.Tensor):</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (boxes <span class="op">//</span> <span class="dv">2</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the functions </span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>image_test <span class="op">=</span> dataset[<span class="st">"train"</span>][<span class="dv">42</span>][<span class="st">"image"</span>]</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>image_test_half <span class="op">=</span> half_image(image_test)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Original image size: </span><span class="sc">{</span>image_test<span class="sc">.</span>size<span class="sc">}</span><span class="ss"> | Half image size: </span><span class="sc">{</span>image_test_half<span class="sc">.</span>size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>boxes_test_list <span class="op">=</span> [<span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>]</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Original boxes: </span><span class="sc">{</span>boxes_test_list<span class="sc">}</span><span class="ss"> | Half boxes: </span><span class="sc">{</span>half_boxes(boxes_test_list)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>boxes_test_torch <span class="op">=</span> torch.tensor([<span class="fl">100.0</span>, <span class="fl">100.0</span>, <span class="fl">100.0</span>, <span class="fl">100.0</span>])</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Original boxes: </span><span class="sc">{</span>boxes_test_torch<span class="sc">}</span><span class="ss"> | Half boxes: </span><span class="sc">{</span>half_boxes(boxes_test_torch)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Original image size: (960, 1280) | Half image size: (480, 640)
[INFO] Original boxes: [100, 100, 100, 100] | Half boxes: [50, 50, 50, 50]
[INFO] Original boxes: tensor([100., 100., 100., 100.]) | Half boxes: tensor([50., 50., 50., 50.])</code></pre>
</div>
</div>
<p>To plot an image and its assosciated boxes, weâ€™ll do the following steps:</p>
<ol type="1">
<li>Select a random sample from the <code>dataset</code>.</li>
<li>Extract the <code>"image"</code> (our image is in <code>PIL</code> format) and <code>"bbox"</code> keys from the random sample.
<ul>
<li>We can also <em>optionally</em> halve the size of our image/boxes to save space. In our case, we will halve our image and boxes.</li>
</ul></li>
<li>Turn the box coordinates into a <code>torch.tensor</code> (weâ€™ll be using <code>torchvision</code> utilities to plot the image and boxes).</li>
<li>Convert the box format from <code>XYXY</code> to <code>XYWH</code> using <a href="https://pytorch.org/vision/main/generated/torchvision.ops.box_convert.html"><code>torchvision.ops.box_convert</code></a> (we do this because <code>torchvision.utils.draw_bounding_boxes</code> requires <code>XYXY</code> format as input).</li>
<li>Get a list of label names (e.g.&nbsp;<code>"bin", "trash"</code>, etc) assosciated with each of the boxes as well as a list of colours to match (these will be from our <code>colour_palette</code>).</li>
<li>Draw the boxes on the target image by:
<ul>
<li>Turning the image into a tensor with <a href="https://pytorch.org/vision/main/generated/torchvision.transforms.functional.pil_to_tensor.html"><code>torchvision.transforms.functional.pil_to_tensor</code></a>.</li>
<li>Draw the bounding boxes on our image tensor with <a href="https://pytorch.org/vision/main/generated/torchvision.utils.draw_bounding_boxes.html"><code>torchvision.utils.draw_bounding_boxes</code></a>.</li>
<li>Turn the image and bounding box tensors back into a <code>PIL</code> image with <a href="https://pytorch.org/vision/main/generated/torchvision.transforms.functional.pil_to_tensor.html"><code>torchvision.transforms.functional.pil_to_tensor</code></a>.</li>
</ul></li>
</ol>
<p>Phew!</p>
<p>A fair few stepsâ€¦</p>
<p>But weâ€™ve got this!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If the terms <code>XYXY</code> or <code>XYWH</code> or all of the drawing methods sound a bit confusing or intimidating, donâ€™t worry, thereâ€™s a fair bit going on here.</p>
<p>Weâ€™ll cover bounding box formats, such as <code>XYXY</code> shortly.</p>
<p>In the meantime, if you want to learn more about different bounding box formats and how to draw them, I wrote <a href="https://www.learnml.io/posts/a-guide-to-bounding-box-formats/"><em>A Guide to Bounding Box Formats and How to Draw Them</em></a> which you might find helpful.</p>
</div>
</div>
<div id="cell-36" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting a bounding box on a single image</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.ops <span class="im">import</span> box_convert</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.utils <span class="im">import</span> draw_bounding_boxes</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms.functional <span class="im">import</span> pil_to_tensor, to_pil_image </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Select a random sample from our dataset</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>random_index <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="bu">len</span>(dataset[<span class="st">"train"</span>]))</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Showing training sample from index: </span><span class="sc">{</span>random_index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>random_sample <span class="op">=</span> dataset[<span class="st">"train"</span>][random_index]</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get image and boxes from random sample</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>random_sample_image <span class="op">=</span> random_sample[<span class="st">"image"</span>]</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>random_sample_boxes <span class="op">=</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"bbox"</span>]</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Half the image and boxes for space saving (all of the following code will work with/without half size images)</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>half_random_sample_image <span class="op">=</span> half_image(random_sample_image)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>half_random_sample_boxes <span class="op">=</span> half_boxes(random_sample_boxes)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Turn box coordinates in a tensor</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>boxes_xywh <span class="op">=</span> torch.tensor(half_random_sample_boxes)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Boxes in XYWH format: </span><span class="sc">{</span>boxes_xywh<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Convert boxes from XYWH -&gt; XYXY </span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="co"># torchvision.utils.draw_bounding_boxes requires input boxes in XYXY format (X_min, y_min, X_max, y_max)</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>boxes_xyxy <span class="op">=</span> box_convert(boxes<span class="op">=</span>boxes_xywh,</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>                         in_fmt<span class="op">=</span><span class="st">"xywh"</span>,</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>                         out_fmt<span class="op">=</span><span class="st">"xyxy"</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Boxes XYXY: </span><span class="sc">{</span>boxes_xyxy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Get label names of target boxes and colours to match</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>random_sample_label_names <span class="op">=</span> [categories.int2str(x) <span class="cf">for</span> x <span class="kw">in</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"category_id"</span>]]</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>random_sample_colours <span class="op">=</span> [colour_palette[label_name] <span class="cf">for</span> label_name <span class="kw">in</span> random_sample_label_names]</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Label names: </span><span class="sc">{</span>random_sample_label_names<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Colour names: </span><span class="sc">{</span>random_sample_colours<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Draw the boxes on the image as a tensor and then turn it into a PIL image</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>to_pil_image(</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>half_random_sample_image),</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>boxes_xyxy,</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>        colors<span class="op">=</span>random_sample_colours,</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_sample_label_names,</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>        label_colors<span class="op">=</span>random_sample_colours</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Showing training sample from index: 1031
Boxes in XYWH format: tensor([[255., 550., 133.,  88.],
        [234., 357.,  98., 246.],
        [124., 191., 210., 297.]])
Boxes XYXY: tensor([[255., 550., 388., 638.],
        [234., 357., 332., 603.],
        [124., 191., 334., 488.]])
Label names: ['hand', 'trash', 'bin']
Colour names: [(148, 0, 211), (0, 255, 0), (0, 0, 224)]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Outstanding!</p>
<p>Our first official bounding boxes plotted on an image!</p>
<p>Now the idea of Trashify ðŸš® is coming to life.</p>
<p>Depending on the random sample youâ€™re looking at, you should see some combination of <code>['bin', 'hand', 'not_bin', 'not_hand', 'not_trash', 'trash', 'trash_arm']</code>.</p>
<p>Our goal will be to build an object detection model to replicate these boxes on a given image.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Getting familiar with a dataset: viewing 100 random samples
</div>
</div>
<div class="callout-body-container callout-body">
<p>Whenever working with a new dataset, I find it good practice to view 100+ random samples of the data.</p>
<p>In our case, this would mean viewing 100 random images with their bounding boxes drawn on them.</p>
<p>Doing so starts to build your own intuition of the data.</p>
<p>Using this intuition, along with evaluation metrics, you can start to get a better idea of how your model might be performing later on.</p>
<p>Keep this in mind for any new dataset or problem space youâ€™re working on.</p>
<p>Start by looking at 100+ random samples.</p>
<p>And yes, generally more is better.</p>
<p>So you can practice by running the code cell above a number of times to see the different kinds of images and boxes in the dataset.</p>
<p>Can you think of any scenarios which the dataset might be missing?</p>
</div>
</div>
</section>
<section id="different-bounding-box-formats" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="different-bounding-box-formats"><span class="header-section-number">5</span> Different bounding box formats</h2>
<p>When drawing our bounding box, we discussed the terms <code>XYXY</code> and <code>XYWH</code>.</p>
<p>Well, we didnâ€™t really discuss these at allâ€¦</p>
<p>But thatâ€™s why weâ€™re here.</p>
<p>One of the most confusing things in the world of object detection is the different formats bounding boxes come in.</p>
<p>Are your boxes in <code>XYXY</code>, <code>XYWH</code> or <code>CXCYWH</code>?</p>
<p>Are they in absolute format?</p>
<p>Or normalized format?</p>
<p>Perhaps a table will help us.</p>
<p>The following table contains a non-exhaustive list of some of the most common bounding box formats youâ€™ll come across in the wild.</p>
<div id="tbl-bbox-formats" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-bbox-formats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Different bounding box formats
</figcaption>
<div aria-describedby="tbl-bbox-formats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Box format</strong></th>
<th><strong>Description</strong></th>
<th><strong>Absolute Example</strong></th>
<th><strong>Normalized Example</strong></th>
<th><strong>Source</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>XYXY</td>
<td>Describes the top left corner coordinates <code>(x1, y1)</code> as well as the bottom right corner coordinates of a box. <br> Also referred to as: <br> <code>[x1, y1, x2, y2]</code> <br> or <br> <code>[x_min, y_min, x_max, y_max]</code></td>
<td><code>[8.9, 275.3, 867.5, 964.0]</code></td>
<td><code>[0.009, 0.215, 0.904, 0.753]</code></td>
<td><a href="http://host.robots.ox.ac.uk/pascal/VOC/voc2012/htmldoc/devkit_doc.html#SECTION00053000000000000000">PASCAL VOC Dataset</a> uses the absolute version of this format, <a href="https://pytorch.org/vision/main/generated/torchvision.utils.draw_bounding_boxes.html#draw-bounding-boxes"><code>torchvision.utils.draw_bounding_boxes</code></a> defaults to the absolute version of this format.</td>
</tr>
<tr class="even">
<td>XYWH</td>
<td>Describes the top left corner coordinates <code>(x1, y1)</code> as well as the width (<code>box_width</code>) and height (<code>box_height</code>) of the target box. The bottom right corners <code>(x2, y2)</code> are found by adding the width and height to the top left corner coordinates <code>(x1 + box_width, y1 + box_height)</code>. <br> Also referred to as: <br> <code>[x1, y1, box_width, box_height]</code> <br> or <br> <code>[x_min, y_min, box_width, box_height]</code></td>
<td><code>[8.9, 275.3, 858.6, 688.7]</code></td>
<td><code>[0.009, 0.215, 0.894, 0.538]</code></td>
<td>The <a href="https://cocodataset.org/#format-data">COCO (Common Objects in Context) dataset</a> uses the absolute version of this format, see the section under â€œbboxâ€.</td>
</tr>
<tr class="odd">
<td>CXCYWH</td>
<td>Describes the center coordinates of the bounding box <code>(center_x, center_y)</code> as well as the width (<code>box_width</code>) and height (<code>box_height</code>) of the target box. <br> Also referred to as: <br> <code>[center_x, center_y, box_width, box_height]</code></td>
<td><code>[438.2, 619.65, 858.6, 688.7]</code></td>
<td><code>[0.456, 0.484, 0.894, 0.538]</code></td>
<td>Normalized version introduced in the <a href="https://arxiv.org/abs/1804.02767">YOLOv3 (You Only Look Once) paper</a> and is used by many later forms of YOLO.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<section id="absolute-or-normalized-format" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="absolute-or-normalized-format"><span class="header-section-number">5.1</span> Absolute or normalized format?</h3>
<p>In <strong>absolute</strong> coordinate form, bounding box values are in the same format as the width and height dimensions (e.g.&nbsp;our image is <code>960x1280</code> pixels).</p>
<p>For example in <code>XYXY</code> format: <code>["bin", 8.9, 275.3, 867.5, 964.0]</code></p>
<p>An <code>(x1, y1)</code> (or <code>(x_min, y_min)</code>) coordinate of <code>(8.9, 275.3)</code> means the top left corner is <code>8.9</code> pixels in on the x-axis, and <code>275.3</code> pixels down on the y-axis.</p>
<p>In <strong>normalized</strong> coordinate form, values are between <code>[0, 1]</code> and are proportions of the image width and height.</p>
<p>For example in <code>XYXY</code> format: <code>["bin", 0.009, 0.215, 0.904, 0.753]</code></p>
<p>A normalized <code>(x1, y1)</code> (or <code>(x_min, y_min)</code>) coordinate of <code>(0.009, 0.215)</code> means the top left corner is <code>0.009 * image_width</code> pixels in on the x-axis and <code>0.215 * image_height</code> down on the y-axis.</p>
<p>To convert absolute coordinates to normalized, you can divide x-axis values by the image width and y-axis values by the image height.</p>
<p><span class="math display">\[
x_{\text{normalized}} = \frac{x_{\text{absolute}}}{\text{image\_width}} \quad y_{\text{normalized}} = \frac{y_{\text{absolute}}}{\text{image\_height}}
\]</span></p>
</section>
<section id="which-bounding-box-format-should-you-use" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="which-bounding-box-format-should-you-use"><span class="header-section-number">5.2</span> Which bounding box format should you use?</h3>
<p>The bounding box format you use will depend on the framework, model and existing data youâ€™re trying to use.</p>
<p>For example, the take the following frameworks:</p>
<ul>
<li><strong>PyTorch</strong> - If youâ€™re using PyTorch pre-trained models, for example, <a href="https://pytorch.org/vision/main/models/generated/torchvision.models.detection.fasterrcnn_resnet50_fpn.html#torchvision.models.detection.fasterrcnn_resnet50_fpn"><code>torchvision.models.detection.fasterrcnn_resnet50_fpn</code></a>, youâ€™ll want <strong>absolute</strong> <code>XYXY</code> (<code>[x1, y1, x2, y2]</code>) format.</li>
<li><strong>Hugging Face Transformers</strong> - If youâ€™re using a Hugging Face Transformers model such as <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr">Conditional DETR</a>, youâ€™ll want to take note that <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrForObjectDetection.forward">outputs from the model can be of one type</a> (e.g.&nbsp;<code>CXCYWH</code>) but they can be <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrFeatureExtractor.post_process_object_detection">post-processed into another type</a> (e.g.&nbsp;<strong>absolute</strong> <code>XYXY</code>).</li>
<li><strong>Ultralytics YOLO</strong> - If youâ€™re using a YOLO-like model such as <a href="https://docs.ultralytics.com/datasets/detect/#ultralytics-yolo-format">Ultralytics YOLO</a>, youâ€™ll want <strong>normalized</strong> <code>CXCYWH</code> (<code>[center_x, center_y, width, height]</code>) format.</li>
<li><strong>Google Gemini</strong> - If youâ€™re using <a href="https://ai.google.dev/gemini-api/docs/vision?lang=python#bbox">Google Gemini to predict bounding boxes on your images</a>, then youâ€™ll want to pay attention to the special <code>[y_min, x_min, y_max, x_max]</code> (<code>YXYX</code>) normalized coordinates.</li>
</ul>
<p>Or if you note that someone has said their model is pre-trained on the COCO dataset, chances are the data has been formatted in <code>XYWH</code> format (see <a href="#tbl-bbox-formats" class="quarto-xref">Table&nbsp;1</a>).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For more on different bounding box formats and how to draw them, see <a href="https://www.learnml.io/posts/a-guide-to-bounding-box-formats/"><em>A Guide to Bounding Box Formats and How to Draw Them</em></a>.</p>
</div>
</div>
<div id="cell-41" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TK - should I functionize the plotting of boxes and image so we can do input/output with tensors + data augmentations on that (E.g. original: image, augmented: image),</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - is this needed?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="getting-an-object-detection-model" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="getting-an-object-detection-model"><span class="header-section-number">6</span> Getting an object detection model</h2>
<p>There are two main ways of getting an object detection model:</p>
<ol type="1">
<li><strong>Building it yourself.</strong> For example, constructing it layer by layer, testing it and training it on your target problem.</li>
<li><strong>Using an existing one.</strong> For example, find an existing model on a problem space similar to your own and then adapt it via <strong>transfer learning</strong> (TK - add link to glossary) to your own task.</li>
</ol>
<p>In our case, weâ€™re going to focus on the latter.</p>
<p>Weâ€™ll be taking a pre-trained object detection model and fine-tuning it on our Trashify ðŸš® dataset so it outputs the boxes and labels weâ€™re after.</p>
<section id="places-to-get-object-detection-models" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="places-to-get-object-detection-models"><span class="header-section-number">6.1</span> Places to get object detection models</h3>
<p>Instead of building your own machine learning model from scratch, itâ€™s common practice to take an existing model that works on similar problem space to yours and then <strong>fine-tune</strong> (TK - add link to glossary) it to your own use case.</p>
<p>There are several places to get object detection models:</p>
<div id="tbl-detection-models" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-detection-models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Places to get pre-trained object detection models
</figcaption>
<div aria-describedby="tbl-detection-models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Location</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="https://huggingface.co/models?pipeline_tag=object-detection&amp;sort=trending">Hugging Face Hub</a></td>
<td>One the best places on the internet to find open-source machine learning models of nearly any kind. You can find pre-trained object detection models here such as <a href="https://huggingface.co/facebook/detr-resnet-50"><code>facebook/detr-resnet-50</code></a>, a model from Facebook (Meta) and <a href="https://huggingface.co/microsoft/conditional-detr-resnet-50"><code>microsoft/conditional-detr-resnet-50</code></a>, a model from Microsoft and the model weâ€™re going to use as our base model. Many of the models are permissively licensed, meaning you can use them for your own projects.</td>
</tr>
<tr class="even">
<td><a href="https://pytorch.org/vision/stable/models.html"><code>torchvision</code></a></td>
<td>PyTorchâ€™s built-in domain library for computer vision has several <a href="https://pytorch.org/vision/stable/models.html#object-detection-instance-segmentation-and-person-keypoint-detection">pre-trained object detection models</a> which you can use in your own workflows.</td>
</tr>
<tr class="odd">
<td><a href="https://paperswithcode.com/task/object-detection">paperswithcode.com/task/object-detection</a></td>
<td>Whilst not a direct place to download object detection models from, paperswithcode contains benchmarks for many machine learning tasks (including object detection) which shows the current state of the art (best performing) models and usually includes links to where to get the code.</td>
</tr>
<tr class="even">
<td><a href="https://github.com/facebookresearch/detectron2">Detectron2</a></td>
<td>Detectron2 is an open-source library to help with many of the tasks in detecting items in images. Inside youâ€™ll find several pre-trained and adaptable models as well as utilities such as data loaders for object detection and segmentation tasks.</td>
</tr>
<tr class="odd">
<td>YOLO Series</td>
<td>A running series of <a href="https://arxiv.org/abs/1506.02640">â€œYou Only Look Onceâ€ models</a>. Usually, the higher the number, the better performing. For example, <a href="https://github.com/ultralytics/ultralytics"><code>YOLOv11</code></a> by Ultralytics should outperform <a href="https://github.com/THU-MIG/yolov10"><code>YOLOv10</code></a>, however, this often requires testing on your own dataset. Beware of the license, it is under the <a href="https://en.wikipedia.org/wiki/GNU_Affero_General_Public_License">AGPL-3.0 license</a> which may cause issues in some organizations.</td>
</tr>
<tr class="even">
<td><a href="https://github.com/open-mmlab/mmdetection"><code>mmdetection</code> library</a></td>
<td>An open-source library from the OpenMMLab which contains many different open-source models as well as detection-specific utilties.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>When you find a pre-trained object detection model, youâ€™ll often see statements such as:</p>
<blockquote class="blockquote">
<p><em>Conditional DEtection TRansformer (DETR) model trained end-to-end on COCO 2017 object detection (118k annotated images).</em></p>
<p>Source: <a href="https://huggingface.co/microsoft/conditional-detr-resnet-50">https://huggingface.co/microsoft/conditional-detr-resnet-50</a></p>
</blockquote>
<p>This means the model has already been trained on the <a href="https://cocodataset.org/#home">COCO object detection dataset</a> which contains 118,000 images and <a href="https://cocodataset.org/#explore">80 classes</a> such as <code>["cake", "person", "skateboard"...]</code>.</p>
<p>This is a good thing.</p>
<p>It means that the model should have a fairly good starting point when we try to adapt it to our own project.</p>
</section>
<section id="downloading-our-model-from-hugging-face" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="downloading-our-model-from-hugging-face"><span class="header-section-number">6.2</span> Downloading our model from Hugging Face</h3>
<p>For our Trashify ðŸš® project weâ€™re going to be using the pre-trained object detection model <a href="https://huggingface.co/microsoft/conditional-detr-resnet-50"><code>microsoft/conditional-detr-resnet-50</code></a> which was originally introduced in the paper <a href="https://arxiv.org/abs/2108.06152"><em>Conditional DETR for Fast Training Convergence</em></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The term â€œDETRâ€ stands for â€œDEtection TRansformerâ€.</p>
<p>Where â€œTransformerâ€ refers to the <a href="https://en.wikipedia.org/wiki/Transformer_(deep_learning_architecture)">Transformer neural network architecture</a>, specifically the <a href="https://en.wikipedia.org/wiki/Vision_transformer">Vision Transformer</a> (or ViT) rather than the Hugging Face <code>transformers</code> library (quite confusing, yes).</p>
<p>So DETR means â€œperforming detection with the Transformer architectureâ€.</p>
<p>And the â€œResNetâ€ part stands for â€œ<a href="https://en.wikipedia.org/wiki/Residual_neural_network">Residual Neural Network</a>â€ which is a common computer vision backbone. The â€œ50â€ refers to the number of layers in the network. Saying â€œResNet-50â€ means the 50 layer version of ResNet. ResNet-101 and ResNet-18 are two other larger and smaller variants.</p>
</div>
</div>
<p>To use this model, there are some helpful documentation resources we should be aware of:</p>
<div id="tbl-model-docs" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-model-docs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Model documentation resources
</figcaption>
<div aria-describedby="tbl-model-docs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Resource</strong></th>
<th style="text-align: left;"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#conditional-detr">Conditional DETR documentation</a></td>
<td style="text-align: left;">Contains detailed information on each of the <code>transformers.ConditionalDetr</code> classes.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrConfig"><code>transformers.ConditionalDetrConfig</code></a></td>
<td style="text-align: left;">Contains the configuration settings for our model such as number of layers and other hyperparameters.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor"><code>transformers.ConditionalDetrImageProcessor</code></a></td>
<td style="text-align: left;">Contains several preprocessing on post processing functions and settings for data going into and out of our model. Here we can set values such as <code>size</code> in the <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.preprocess"><code>preprocess</code></a> method which will resize our images to a certain size. We can also use the <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.post_process_object_detection"><code>post_process_object_detection</code></a> method to process the raw outputs of our model into a more usable format.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrForObjectDetection"><code>transformers.ConditionalDetrModelForObjectdetection</code></a></td>
<td style="text-align: left;">This will enable us to load the Conditional DETR model weights and enable to pass data through them via the <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrForObjectDetection.forward"><code>forward</code></a> method.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><a href="https://huggingface.co/docs/transformers/en/model_doc/auto#transformers.AutoImageProcessor"><code>transformers.AutoImageProcessor</code></a></td>
<td style="text-align: left;">This will enable us to create an instance of <code>transformers.ConditionalDetrImageProcessor</code> by passing the model name <code>microsoft/conditional-detr-resnet-50</code> to the <code>from_pretrained</code> method. Hugging Face Transformers uses several <a href="https://huggingface.co/docs/transformers/en/model_doc/auto#transformers.AutoModelForObjectDetection">Auto Classes</a> for various problem spaces and models.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><a href="https://huggingface.co/docs/transformers/en/model_doc/auto#transformers.AutoModelForObjectDetection"><code>transformers.AutoModelForObjectDetection</code></a></td>
<td style="text-align: left;">Enables us to load the model architecture and weights for the Conditional DETR architecture by passing the model name <code>microsoft/conditional-detr-resnet-50</code> to the <a href="https://huggingface.co/docs/transformers/en/model_doc/auto#transformers.AutoModelForObjectDetection.from_pretrained"><code>from_pretrained</code> method</a>.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>Weâ€™ll get hands-on which each of these throughout the project.</p>
<p>For now, if youâ€™d like to read up more on each, Iâ€™d highly recommend it.</p>
<p>Knowing how to navigate and read through a frameworkâ€™s documentation is a very helpful skill to have.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are other object detection models we could try on the Hugging Face Hub such as <a href="https://huggingface.co/facebook/detr-resnet-50"><code>facebook/detr-resnet-50</code></a> or <a href="https://huggingface.co/IDEA-Research/dab-detr-resnet-50-dc5-pat3"><code>IDEA-Research/dab-detr-resnet-50-dc5-pat3</code></a>.</p>
<p>For now, weâ€™ll stick with <code>microsoft/conditional-detr-resnet-50</code>.</p>
<p>Itâ€™s easy to get stuck figuring out which model to use instead of just trying one and seeing how it goes.</p>
<p>Best to get something small working with one model and try another one later as part of a series of experiments to try and improve your results.</p>
</div>
</div>
<p>We can load our model with <a href="https://huggingface.co/docs/transformers/en/model_doc/auto#transformers.AutoModelForObjectDetection.from_pretrained"><code>transformers.AutoModelForObjectDetection.from_pretrained</code></a> and passing in the following parameters:</p>
<ul>
<li><code>pretrained_model_name_or_path</code> - Our target model, which can be a local path or Hugging Face model name (e.g.&nbsp;<code>microsoft/conditional-detr-resnet-50</code>).</li>
<li><code>label2id</code> - A dictionary mapping our class names/labels to their numerical ID, this is so our model will know how many classes to output.</li>
<li><code>id2label</code> - A dictionary mapping numerical IDs to our class names/labels, so our model will know how many classes weâ€™re working with and what their IDs are.</li>
<li><code>ignore_mismatched_sizes=True</code> (default) - Weâ€™ll set this to <code>True</code> so that our model can be instatiated with a varying number of classes compared to what it may have been trained on (e.g.&nbsp;if our model was trained on the 91 classes from COCO, we only need 7).</li>
<li><code>backbone="resnet50"</code> (default) - Weâ€™ll tell our model what kind of computer vision backbone to use for extracting features from our images.</li>
</ul>
<p>See the <a href="https://huggingface.co/docs/transformers/en/model_doc/auto#transformers.AutoModelForObjectDetection.from_pretrained">full documentation</a> for a full list of parameters we can use.</p>
<p>Letâ€™s create a model!</p>
<div id="cell-45" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForObjectDetection</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>MODEL_NAME <span class="op">=</span> <span class="st">"microsoft/conditional-detr-resnet-50"</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForObjectDetection.from_pretrained(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    pretrained_model_name_or_path<span class="op">=</span>MODEL_NAME,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    label2id<span class="op">=</span>label2id,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    id2label<span class="op">=</span>id2label,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Original model was trained with a different number of output classes to ours</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># So we'll ignore any mismatched sizes (e.g. 91 vs. 7)</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try turning this to False and see what happens</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    ignore_mismatched_sizes<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    backbone<span class="op">=</span><span class="st">"resnet50"</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment to see full model archietecture</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co"># model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of ConditionalDetrForObjectDetection were not initialized from the model checkpoint at microsoft/conditional-detr-resnet-50 and are newly initialized because the shapes did not match:
- class_labels_classifier.bias: found shape torch.Size([91]) in the checkpoint and torch.Size([7]) in the model instantiated
- class_labels_classifier.weight: found shape torch.Size([91, 256]) in the checkpoint and torch.Size([7, 256]) in the model instantiated
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</code></pre>
</div>
</div>
<p>Beautiful!</p>
<p>Weâ€™ve got a model ready.</p>
<p>You mightâ€™ve noticed a warning about the model needing to be trained on a down-stream task:</p>
<blockquote class="blockquote">
<p>Some weights of ConditionalDetrForObjectDetection were not initialized from the model checkpoint at microsoft/conditional-detr-resnet-50 and are newly initialized because the shapes did not match: - class_labels_classifier.bias: found shape torch.Size([91]) in the checkpoint and torch.Size([7]) in the model instantiated - class_labels_classifier.weight: found shape torch.Size([91, 256]) in the checkpoint and torch.Size([7, 256]) in the model instantiated You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p>
</blockquote>
<p>This is because our model has a different number of target classes (7 in total) comapred to the original model (91 in total, from the COCO dataset).</p>
<p>So in order to get this pretrained model to work on our dataset, weâ€™ll need to <strong>fine-tune</strong> it.</p>
<p>You might also notice that if you set <code>ignore_mismatched_sizes=False</code>, youâ€™ll get an error:</p>
<blockquote class="blockquote">
<p>RuntimeError: Error(s) in loading state_dict for ConditionalDetrForObjectDetection: size mismatch for class_labels_classifier.weight: copying a param with shape torch.Size([91, 256]) from checkpoint, the shape in current model is torch.Size([7, 256]). size mismatch for class_labels_classifier.bias: copying a param with shape torch.Size([91]) from checkpoint, the shape in current model is torch.Size([7]). You may consider adding <code>ignore_mismatched_sizes=True</code> in the model <code>from_pretrained</code> method.</p>
</blockquote>
<p>This is a similar warning to the one above.</p>
<p>Keep this is mind for when youâ€™re working with pretrained models.</p>
<p>If you are using data slightly different to what the model was trained on, you may need to alter the setup hyperparameters as well as fine-tune it on your own data.</p>
</section>
<section id="inspecting-our-models-layers" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="inspecting-our-models-layers"><span class="header-section-number">6.3</span> Inspecting our modelâ€™s layers</h3>
<p>We can inspect the full model architecture by running <code>print(model)</code> (Iâ€™ve commented this out for brevity).</p>
<p>And if you do so, youâ€™ll see a large list of layers which combine to contribute to make the overall model.</p>
<p>The following subset of layers has been truncated for brevity.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shortened version of the model architecture, print the full model to see all layers</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ConditionalDetrForObjectDetection(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  (model): ConditionalDetrModel(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    (backbone): ConditionalDetrConvModel(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>      (conv_encoder): ConditionalDetrConvEncoder(</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        (model): FeatureListNet(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>          (conv1): Conv2d(<span class="dv">3</span>, <span class="dv">64</span>, kernel_size<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>), stride<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">2</span>), padding<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>), bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>          (bn1): ConditionalDetrFrozenBatchNorm2d()</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>              ...</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>          (layer1): Sequential(</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>            (<span class="dv">0</span>): Bottleneck(</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>              (conv1): Conv2d(<span class="dv">64</span>, <span class="dv">64</span>, kernel_size<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>), stride<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>), bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>              (bn1): ConditionalDetrFrozenBatchNorm2d())))</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>            ...</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>      (position_embedding): ConditionalDetrSinePositionEmbedding()</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    (input_projection): Conv2d(<span class="dv">2048</span>, <span class="dv">256</span>, kernel_size<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>), stride<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    (query_position_embeddings): Embedding(<span class="dv">300</span>, <span class="dv">256</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    (encoder): ConditionalDetrEncoder(</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>      (layers): ModuleList(</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">0</span><span class="op">-</span><span class="dv">5</span>): <span class="dv">6</span> x ConditionalDetrEncoderLayer(</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>          (self_attn): DetrAttention(</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>              ...</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>          (self_attn_layer_norm): LayerNorm((<span class="dv">256</span>,), eps<span class="op">=</span><span class="fl">1e-05</span>, elementwise_affine<span class="op">=</span><span class="va">True</span>))))</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    (decoder): ConditionalDetrDecoder(</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>      (layers): ModuleList(</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">0</span>): ConditionalDetrDecoderLayer(...)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>      (layernorm): LayerNorm((<span class="dv">256</span>,), eps<span class="op">=</span><span class="fl">1e-05</span>, elementwise_affine<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>      (query_scale): MLP(</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        (layers): ModuleList(</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>          (<span class="dv">0</span><span class="op">-</span><span class="dv">1</span>): <span class="dv">2</span> x Linear(in_features<span class="op">=</span><span class="dv">256</span>, out_features<span class="op">=</span><span class="dv">256</span>, bias<span class="op">=</span><span class="va">True</span>)))</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>      (ref_point_head): MLP(</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>      ))))</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  (class_labels_classifier): Linear(in_features<span class="op">=</span><span class="dv">256</span>, out_features<span class="op">=</span><span class="dv">7</span>, bias<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>  (bbox_predictor): ConditionalDetrMLPPredictionHead(</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    (layers): ModuleList(</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>      (<span class="dv">0</span><span class="op">-</span><span class="dv">1</span>): <span class="dv">2</span> x Linear(in_features<span class="op">=</span><span class="dv">256</span>, out_features<span class="op">=</span><span class="dv">256</span>, bias<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>      (<span class="dv">2</span>): Linear(in_features<span class="op">=</span><span class="dv">256</span>, out_features<span class="op">=</span><span class="dv">4</span>, bias<span class="op">=</span><span class="va">True</span>)))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we check out a few of our modelâ€™s layers, we can see that it is a combination of <a href="https://pytorch.org/docs/stable/generated/torch.nn.Conv2d.html">convolutional</a>, <a href="https://pytorch.org/docs/stable/generated/torch.nn.MultiheadAttention.html">attention</a>, <a href="https://en.wikipedia.org/wiki/Multilayer_perceptron">MLP (multi-layer perceptron)</a> and <a href="https://pytorch.org/docs/stable/generated/torch.nn.Linear.html">linear</a> layers.</p>
<p>Iâ€™ll leave exploring each of these layer types for extra-curriculum.</p>
<p>For now, think of them as progressively pattern extractors.</p>
<p>Weâ€™ll feed our input image into our model and layer by layer it will manipulate the pixel values to try and extract patterns in a way so that its internal parameters matches the image to its input annotations.</p>
<p>More specifically, if we dive into the final two layer sections:</p>
<ol type="1">
<li><code>class_labels_classifier</code> = classification head with <code>out_features=7</code> (one for each of our labels, <code>'bin', 'hand', 'not_bin', 'not_hand', 'not_trash', 'trash', 'trash_arm']</code>).</li>
<li><code>bbox_predictor</code> = regression head with <code>out_features=4</code> (one for each of our bbox coordinates, e.g.&nbsp;<code>[center_x, center_y, width, height]</code>).</li>
</ol>
<div id="cell-48" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Final classification layer: </span><span class="sc">{</span>model<span class="sc">.</span>class_labels_classifier<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Final box regression layer: </span><span class="sc">{</span>model<span class="sc">.</span>bbox_predictor<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Final classification layer: Linear(in_features=256, out_features=7, bias=True)

[INFO] Final box regression layer: ConditionalDetrMLPPredictionHead(
  (layers): ModuleList(
    (0-1): 2 x Linear(in_features=256, out_features=256, bias=True)
    (2): Linear(in_features=256, out_features=4, bias=True)
  )
)</code></pre>
</div>
</div>
<p>These two layers are what are going to output the final predictions of our model in structure similar to our annotations.</p>
<p>The <code>class_labels_classifier</code> will output the predicted class label of a given bounding box output from <code>bbox_predictor</code>.</p>
<p>In essence, we are trying to get all of the pretrained patterns (also called <strong>parameters</strong>/<strong>weights &amp; biases</strong>) of the previous layers to conform to the ideal outputs weâ€™d like at the end.</p>
</section>
<section id="counting-the-number-of-parameters-in-our-model" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="counting-the-number-of-parameters-in-our-model"><span class="header-section-number">6.4</span> Counting the number of parameters in our model</h3>
<p><strong>Parameters</strong> are individual values which contribute to a modelâ€™s final output.</p>
<p>Parameters are also referred to as weights and biases.</p>
<p>You can think of these individual weights as small pushes and pulls on the input data to get it to match the input annotations.</p>
<p>If our weights were perfect, we could input an image and always get back the correct bounding boxes and class labels.</p>
<p>Itâ€™s very unlikely to ever have perfect weights (unless your dataset is very small) but we can make them quite good (and useful).</p>
<p>When you have a good set of weights, this is known as a good <a href="https://en.wikipedia.org/wiki/Feature_learning"><strong>representation</strong></a>.</p>
<p>Right now, our weights have been trained on COCO, a collection of 91 different common objects.</p>
<p>So they have a fairly good representation of detecting general common objects, however, weâ€™d like to <strong>fine-tune</strong> these weights to detect our target objects.</p>
<p>Importantly, our model will not be starting from scratch when it begins to train.</p>
<p>It will instead take off from its existing knowledge of detecting common objects in images and try to adhere to our task.</p>
<p>When it comes to parameters and weights, generally, more is better.</p>
<p>Meaning the more parameters your model has, the better representation it can learn.</p>
<p>For example, <a href="https://huggingface.co/microsoft/resnet-50">ResNet50</a> (our computer vision backbone) has ~25 million parameters, about 100 MB in <code>float32</code> precision or 50MB in <code>float16</code> precision.</p>
<p>Whereas a model such as <a href="https://huggingface.co/meta-llama/Llama-3.1-405B">Llama-3.1-405B</a> has ~405 billion parameters, about 1.45 TB in <code>float32</code> precision or 740 GB in <code>float16</code> precision, about 16,000x more than ResNet50.</p>
<p>However, as we can see having more parameters comes with the tradeoff of size and latency.</p>
<p>For each new parameter requires to be stored and it also adds an extra computation unit to your model.</p>
<p>In the case of Trashify, since weâ€™d like our model to run on-device (e.g.&nbsp;make predictions live on an iPhone), weâ€™d opt for the smallest number of parameters we could get acceptable results from.</p>
<p>If performance is your number 1 criteria and size and latency donâ€™t matter, then youâ€™d likely opt for the model with the largest number of parameters (though always evaluate these models on your own data, larger models are <em>generally</em> better, not <em>always</em> better).</p>
<p>Since our model is built using PyTorch, letâ€™s write a small function to count the number of:</p>
<ul>
<li>Trainable parameters (parameters which will be tweaked during training)</li>
<li>Non-trainable parameters (parameters which will <em>not</em> be tweaked during training)</li>
<li>Total parameters (trainable parameters + non-trainable parameters)</li>
</ul>
<div id="cell-51" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of parameters in the model</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_parameters(model):</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Takes in a PyTorch model and returns the number of parameters."""</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    trainable_parameters <span class="op">=</span> <span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters() <span class="cf">if</span> p.requires_grad)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    non_trainable_parameters <span class="op">=</span> <span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters() <span class="cf">if</span> <span class="kw">not</span> p.requires_grad)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    total_parameters <span class="op">=</span> <span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters())</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total parameters: </span><span class="sc">{</span>total_parameters<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Trainable parameters (will be updated): </span><span class="sc">{</span>trainable_parameters<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Non-trainable parameters (will not be updated): </span><span class="sc">{</span>non_trainable_parameters<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>count_parameters(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total parameters: 43,396,813
Trainable parameters (will be updated): 43,174,413
Non-trainable parameters (will not be updated): 222,400</code></pre>
</div>
</div>
<p>Cool!</p>
<p>It looks like our model has a total of <code>43,396,813</code> parameters, of which, most of them are trainable.</p>
<p>This means that when we fine-tune our model later on, weâ€™ll be tweaking the majority of the parameters to try and represent our data.</p>
<p>In practice, this is known as <strong>full fine-tuning</strong>, trying to fine-tune a large portion of the model to our data.</p>
<p>There are other methods for fine-tuning, such as <strong>feature extraction</strong> (where you only fine-tune the final layers of the model) and <strong>partial fine-tuning</strong> (where you fine-tune a portion of the model).</p>
<p>And even methods such as <a href="https://huggingface.co/papers/2106.09685"><strong>LoRA</strong> (Low-Rank Adaptation)</a> which fine-tunes an adaptor matrix as a compliment to the modelâ€™s parameters.</p>
</section>
<section id="creating-a-function-to-build-our-model" class="level3" data-number="6.5">
<h3 data-number="6.5" class="anchored" data-anchor-id="creating-a-function-to-build-our-model"><span class="header-section-number">6.5</span> Creating a function to build our model</h3>
<p>Since machine learning is very experimental, we may want to create multiple instances of our <code>model</code> to test various things.</p>
<p>So letâ€™s functionize the creation of a new model with parameters for our target model name, <code>id2label</code> and <code>label2id</code> dictionaries.</p>
<div id="cell-54" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForObjectDetection</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup the model</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model(pretrained_model_name_or_path: <span class="bu">str</span> <span class="op">=</span> MODEL_NAME, </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                 label2id: <span class="bu">dict</span> <span class="op">=</span> label2id, </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>                 id2label: <span class="bu">dict</span> <span class="op">=</span> id2label):</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Creates and returns an instance of AutoModelForObjectDetection.</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Args: </span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co">        pretrained_model_name_or_path (str): The name or path of the pretrained model to load. </span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">            Defaults to MODEL_NAME.</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co">        label2id (dict): A dictionary mapping class labels to IDs. Defaults to label2id.</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">        id2label (dict): A dictionary mapping class IDs to labels. Defaults to id2label.</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co">        AutoModelForObjectDetection: A pretrained model for object detection with number of output</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co">            classes equivalent to len(label2id).</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> AutoModelForObjectDetection.from_pretrained(</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        pretrained_model_name_or_path<span class="op">=</span>MODEL_NAME,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>        label2id<span class="op">=</span>label2id,</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        id2label<span class="op">=</span>id2label,</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        ignore_mismatched_sizes<span class="op">=</span><span class="va">True</span>, <span class="co"># default</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        backbone<span class="op">=</span><span class="st">"resnet50"</span>, <span class="co"># default </span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect!</p>
<p>And to make sure our function worksâ€¦</p>
<div id="cell-56" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new model instance</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> create_model()</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of ConditionalDetrForObjectDetection were not initialized from the model checkpoint at microsoft/conditional-detr-resnet-50 and are newly initialized because the shapes did not match:
- class_labels_classifier.bias: found shape torch.Size([91]) in the checkpoint and torch.Size([7]) in the model instantiated
- class_labels_classifier.weight: found shape torch.Size([91, 256]) in the checkpoint and torch.Size([7, 256]) in the model instantiated
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</code></pre>
</div>
</div>
</section>
<section id="trying-to-pass-a-single-sample-through-our-model-part-1" class="level3" data-number="6.6">
<h3 data-number="6.6" class="anchored" data-anchor-id="trying-to-pass-a-single-sample-through-our-model-part-1"><span class="header-section-number">6.6</span> Trying to pass a single sample through our model (part 1)</h3>
<p>Okay, now weâ€™ve got a model, letâ€™s put some data through it!</p>
<p>When we call our <code>model</code>, because itâ€™s a PyTorch Module (<a href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module"><code>torch.nn.Module</code></a>) it will by default run the <code>forward</code> method.</p>
<p>In PyTorch, <code>forward</code> overrides the special <code>__call__</code> method on functions.</p>
<p>So we can pass data into our model by running:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>model(input_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Which is equivalent to running:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>model.forward(input_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To see what happens when we call our model, letâ€™s inspect the <code>forward</code> methodâ€™s docstring with <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrModel.forward"><code>model.forward?</code></a>.</p>
<div id="cell-58" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What happens when we call our model?</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: for PyTorch modules, `forward` overrides the __call__ method, </span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># so calling the model is equivalent to calling the forward method.</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>model.forward?</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details>
<summary>
Output of model.forward?
</summary>
<pre><code>Signature:
model.forward(
    pixel_values: torch.FloatTensor,
    pixel_mask: Optional[torch.LongTensor] = None,
    decoder_attention_mask: Optional[torch.LongTensor] = None,
    encoder_outputs: Optional[torch.FloatTensor] = None,
    inputs_embeds: Optional[torch.FloatTensor] = None,
    decoder_inputs_embeds: Optional[torch.FloatTensor] = None,
    labels: Optional[List[dict]] = None,
    output_attentions: Optional[bool] = None,
    output_hidden_states: Optional[bool] = None,
    return_dict: Optional[bool] = None,
) -&gt; Union[Tuple[torch.FloatTensor], transformers.models.conditional_detr.modeling_conditional_detr.ConditionalDetrObjectDetectionOutput]
Docstring:
The [`ConditionalDetrForObjectDetection`] forward method, overrides the `__call__` special method.

&lt;Tip&gt;

Although the recipe for forward pass needs to be defined within this function, one should call the [`Module`]
instance afterwards instead of this since the former takes care of running the pre and post processing steps while
the latter silently ignores them.

&lt;/Tip&gt;

Args:
    pixel_values (`torch.FloatTensor` of shape `(batch_size, num_channels, height, width)`):
        Pixel values. Padding will be ignored by default should you provide it.

        Pixel values can be obtained using [`AutoImageProcessor`]. See [`ConditionalDetrImageProcessor.__call__`]
        for details.

    pixel_mask (`torch.LongTensor` of shape `(batch_size, height, width)`, *optional*):
        Mask to avoid performing attention on padding pixel values. Mask values selected in `[0, 1]`:

        - 1 for pixels that are real (i.e. **not masked**),
        - 0 for pixels that are padding (i.e. **masked**).

        [What are attention masks?](../glossary#attention-mask)

    decoder_attention_mask (`torch.FloatTensor` of shape `(batch_size, num_queries)`, *optional*):
        Not used by default. Can be used to mask object queries.
    encoder_outputs (`tuple(tuple(torch.FloatTensor)`, *optional*):
        Tuple consists of (`last_hidden_state`, *optional*: `hidden_states`, *optional*: `attentions`)
        `last_hidden_state` of shape `(batch_size, sequence_length, hidden_size)`, *optional*) is a sequence of
        hidden-states at the output of the last layer of the encoder. Used in the cross-attention of the decoder.
    inputs_embeds (`torch.FloatTensor` of shape `(batch_size, sequence_length, hidden_size)`, *optional*):
        Optionally, instead of passing the flattened feature map (output of the backbone + projection layer), you
        can choose to directly pass a flattened representation of an image.
    decoder_inputs_embeds (`torch.FloatTensor` of shape `(batch_size, num_queries, hidden_size)`, *optional*):
        Optionally, instead of initializing the queries with a tensor of zeros, you can choose to directly pass an
        embedded representation.
    output_attentions (`bool`, *optional*):
        Whether or not to return the attentions tensors of all attention layers. See `attentions` under returned
        tensors for more detail.
    output_hidden_states (`bool`, *optional*):
        Whether or not to return the hidden states of all layers. See `hidden_states` under returned tensors for
        more detail.
    return_dict (`bool`, *optional*):
        Whether or not to return a [`~utils.ModelOutput`] instead of a plain tuple.

    labels (`List[Dict]` of len `(batch_size,)`, *optional*):
        Labels for computing the bipartite matching loss. List of dicts, each dictionary containing at least the
        following 2 keys: 'class_labels' and 'boxes' (the class labels and bounding boxes of an image in the batch
        respectively). The class labels themselves should be a `torch.LongTensor` of len `(number of bounding boxes
        in the image,)` and the boxes a `torch.FloatTensor` of shape `(number of bounding boxes in the image, 4)`.


    Returns:
        [`transformers.models.conditional_detr.modeling_conditional_detr.ConditionalDetrObjectDetectionOutput`] or `tuple(torch.FloatTensor)`: A [`transformers.models.conditional_detr.modeling_conditional_detr.ConditionalDetrObjectDetectionOutput`] or a tuple of
        `torch.FloatTensor` (if `return_dict=False` is passed or when `config.return_dict=False`) comprising various
        elements depending on the configuration ([`ConditionalDetrConfig`]) and inputs.

        - **loss** (`torch.FloatTensor` of shape `(1,)`, *optional*, returned when `labels` are provided)) -- Total loss as a linear combination of a negative log-likehood (cross-entropy) for class prediction and a
          bounding box loss. The latter is defined as a linear combination of the L1 loss and the generalized
          scale-invariant IoU loss.
        - **loss_dict** (`Dict`, *optional*) -- A dictionary containing the individual losses. Useful for logging.
        - **logits** (`torch.FloatTensor` of shape `(batch_size, num_queries, num_classes + 1)`) -- Classification logits (including no-object) for all queries.
        - **pred_boxes** (`torch.FloatTensor` of shape `(batch_size, num_queries, 4)`) -- Normalized boxes coordinates for all queries, represented as (center_x, center_y, width, height). These
          values are normalized in [0, 1], relative to the size of each individual image in the batch (disregarding
          possible padding). You can use [`~ConditionalDetrImageProcessor.post_process_object_detection`] to retrieve the
          unnormalized bounding boxes.
        - **auxiliary_outputs** (`list[Dict]`, *optional*) -- Optional, only returned when auxilary losses are activated (i.e. `config.auxiliary_loss` is set to `True`)
          and labels are provided. It is a list of dictionaries containing the two above keys (`logits` and
          `pred_boxes`) for each decoder layer.
        - **last_hidden_state** (`torch.FloatTensor` of shape `(batch_size, sequence_length, hidden_size)`, *optional*) -- Sequence of hidden-states at the output of the last layer of the decoder of the model.
        - **decoder_hidden_states** (`tuple(torch.FloatTensor)`, *optional*, returned when `output_hidden_states=True` is passed or when `config.output_hidden_states=True`) -- Tuple of `torch.FloatTensor` (one for the output of the embeddings + one for the output of each layer) of
          shape `(batch_size, sequence_length, hidden_size)`. Hidden-states of the decoder at the output of each
          layer plus the initial embedding outputs.
        - **decoder_attentions** (`tuple(torch.FloatTensor)`, *optional*, returned when `output_attentions=True` is passed or when `config.output_attentions=True`) -- Tuple of `torch.FloatTensor` (one for each layer) of shape `(batch_size, num_heads, sequence_length,
          sequence_length)`. Attentions weights of the decoder, after the attention softmax, used to compute the
          weighted average in the self-attention heads.
        - **cross_attentions** (`tuple(torch.FloatTensor)`, *optional*, returned when `output_attentions=True` is passed or when `config.output_attentions=True`) -- Tuple of `torch.FloatTensor` (one for each layer) of shape `(batch_size, num_heads, sequence_length,
          sequence_length)`. Attentions weights of the decoder's cross-attention layer, after the attention softmax,
          used to compute the weighted average in the cross-attention heads.
        - **encoder_last_hidden_state** (`torch.FloatTensor` of shape `(batch_size, sequence_length, hidden_size)`, *optional*) -- Sequence of hidden-states at the output of the last layer of the encoder of the model.
        - **encoder_hidden_states** (`tuple(torch.FloatTensor)`, *optional*, returned when `output_hidden_states=True` is passed or when `config.output_hidden_states=True`) -- Tuple of `torch.FloatTensor` (one for the output of the embeddings + one for the output of each layer) of
          shape `(batch_size, sequence_length, hidden_size)`. Hidden-states of the encoder at the output of each
          layer plus the initial embedding outputs.
        - **encoder_attentions** (`tuple(torch.FloatTensor)`, *optional*, returned when `output_attentions=True` is passed or when `config.output_attentions=True`) -- Tuple of `torch.FloatTensor` (one for each layer) of shape `(batch_size, num_heads, sequence_length,
          sequence_length)`. Attentions weights of the encoder, after the attention softmax, used to compute the
          weighted average in the self-attention heads.
  

    Examples:

    ```python
    &gt;&gt;&gt; from transformers import AutoImageProcessor, AutoModelForObjectDetection
    &gt;&gt;&gt; from PIL import Image
    &gt;&gt;&gt; import requests

    &gt;&gt;&gt; url = "http://images.cocodataset.org/val2017/000000039769.jpg"
    &gt;&gt;&gt; image = Image.open(requests.get(url, stream=True).raw)

    &gt;&gt;&gt; image_processor = AutoImageProcessor.from_pretrained("microsoft/conditional-detr-resnet-50")
    &gt;&gt;&gt; model = AutoModelForObjectDetection.from_pretrained("microsoft/conditional-detr-resnet-50")

    &gt;&gt;&gt; inputs = image_processor(images=image, return_tensors="pt")

    &gt;&gt;&gt; outputs = model(**inputs)

    &gt;&gt;&gt; # convert outputs (bounding boxes and class logits) to Pascal VOC format (xmin, ymin, xmax, ymax)
    &gt;&gt;&gt; target_sizes = torch.tensor([image.size[::-1]])
    &gt;&gt;&gt; results = image_processor.post_process_object_detection(outputs, threshold=0.5, target_sizes=target_sizes)[
    ...     0
    ... ]
    &gt;&gt;&gt; for score, label, box in zip(results["scores"], results["labels"], results["boxes"]):
    ...     box = [round(i, 2) for i in box.tolist()]
    ...     print(
    ...         f"Detected {model.config.id2label[label.item()]} with confidence "
    ...         f"{round(score.item(), 3)} at location {box}"
    ...     )
    Detected remote with confidence 0.833 at location [38.31, 72.1, 177.63, 118.45]
    Detected cat with confidence 0.831 at location [9.2, 51.38, 321.13, 469.0]
    Detected cat with confidence 0.804 at location [340.3, 16.85, 642.93, 370.95]
    Detected remote with confidence 0.683 at location [334.48, 73.49, 366.37, 190.01]
    Detected couch with confidence 0.535 at location [0.52, 1.19, 640.35, 475.1]
    ```
File:      ~/miniconda3/envs/ai/lib/python3.11/site-packages/transformers/models/conditional_detr/modeling_conditional_detr.py
Type:      method</code></pre>
</details>
<p>Running <code>model.forward?</code> we can see that our model wants to take in <code>pixel_values</code> as well as a <code>pixel_mask</code> as arguments.</p>
<p>What happens if we try to pass in a single image from our <code>random_sample</code>?</p>
<p>Letâ€™s try!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Itâ€™s good practice to try and pass a single sample through your model as soon as possible to see what happens.</p>
<p>If weâ€™re lucky, itâ€™ll work.</p>
<p>If weâ€™re <em>really</em> lucky, weâ€™ll get an error message saying why it <em>didnâ€™t</em> work (this is usually the case because rarely does raw data flow through a model without being preprocessed first).</p>
</div>
</div>
<p>Weâ€™ll do so by setting <code>pixel_values</code> to our <code>random_sample["image"]</code> and <code>pixel_mask=None</code>.</p>
<div id="cell-61" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Do a single forward pass with the model</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>random_sample_outputs <span class="op">=</span> model(pixel_values<span class="op">=</span>random_sample[<span class="st">"image"</span>],</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                              pixel_mask<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>random_sample_outputs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details>
<summary>
Output of random_sample_outputs
</summary>
<pre><code>---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
Cell In[34], line 2
      1 # Do a single forward pass with the model
----&gt; 2 random_sample_outputs = model(pixel_values=random_sample["image"],
      3                               pixel_mask=None)
      4 random_sample_outputs

File ~/miniconda3/envs/ai/lib/python3.11/site-packages/torch/nn/modules/module.py:1739, in Module._wrapped_call_impl(self, *args, **kwargs)
   1737     return self._compiled_call_impl(*args, **kwargs)  # type: ignore[misc]
   1738 else:
-&gt; 1739     return self._call_impl(*args, **kwargs)

File ~/miniconda3/envs/ai/lib/python3.11/site-packages/torch/nn/modules/module.py:1750, in Module._call_impl(self, *args, **kwargs)
   1745 # If we don't have any hooks, we want to skip the rest of the logic in
   1746 # this function, and just call forward.
   1747 if not (self._backward_hooks or self._backward_pre_hooks or self._forward_hooks or self._forward_pre_hooks
   1748         or _global_backward_pre_hooks or _global_backward_hooks
   1749         or _global_forward_hooks or _global_forward_pre_hooks):
-&gt; 1750     return forward_call(*args, **kwargs)
   1752 result = None
   1753 called_always_called_hooks = set()

File ~/miniconda3/envs/ai/lib/python3.11/site-packages/transformers/models/conditional_detr/modeling_conditional_detr.py:1717, in ConditionalDetrForObjectDetection.forward(self, pixel_values, pixel_mask, decoder_attention_mask, encoder_outputs, inputs_embeds, decoder_inputs_embeds, labels, output_attentions, output_hidden_states, return_dict)
   1714 return_dict = return_dict if return_dict is not None else self.config.use_return_dict
   1716 # First, sent images through CONDITIONAL_DETR base model to obtain encoder + decoder outputs
-&gt; 1717 outputs = self.model(
   1718     pixel_values,
   1719     pixel_mask=pixel_mask,
   1720     decoder_attention_mask=decoder_attention_mask,
   1721     encoder_outputs=encoder_outputs,
   1722     inputs_embeds=inputs_embeds,
   1723     decoder_inputs_embeds=decoder_inputs_embeds,
   1724     output_attentions=output_attentions,
   1725     output_hidden_states=output_hidden_states,
   1726     return_dict=return_dict,
   1727 )
   1729 sequence_output = outputs[0]
   1731 # class logits + predicted bounding boxes

File ~/miniconda3/envs/ai/lib/python3.11/site-packages/torch/nn/modules/module.py:1739, in Module._wrapped_call_impl(self, *args, **kwargs)
   1737     return self._compiled_call_impl(*args, **kwargs)  # type: ignore[misc]
   1738 else:
-&gt; 1739     return self._call_impl(*args, **kwargs)

File ~/miniconda3/envs/ai/lib/python3.11/site-packages/torch/nn/modules/module.py:1750, in Module._call_impl(self, *args, **kwargs)
   1745 # If we don't have any hooks, we want to skip the rest of the logic in
   1746 # this function, and just call forward.
   1747 if not (self._backward_hooks or self._backward_pre_hooks or self._forward_hooks or self._forward_pre_hooks
   1748         or _global_backward_pre_hooks or _global_backward_hooks
   1749         or _global_forward_hooks or _global_forward_pre_hooks):
-&gt; 1750     return forward_call(*args, **kwargs)
   1752 result = None
   1753 called_always_called_hooks = set()

File ~/miniconda3/envs/ai/lib/python3.11/site-packages/transformers/models/conditional_detr/modeling_conditional_detr.py:1521, in ConditionalDetrModel.forward(self, pixel_values, pixel_mask, decoder_attention_mask, encoder_outputs, inputs_embeds, decoder_inputs_embeds, output_attentions, output_hidden_states, return_dict)
   1516 output_hidden_states = (
   1517     output_hidden_states if output_hidden_states is not None else self.config.output_hidden_states
   1518 )
   1519 return_dict = return_dict if return_dict is not None else self.config.use_return_dict
-&gt; 1521 batch_size, num_channels, height, width = pixel_values.shape
   1522 device = pixel_values.device
   1524 if pixel_mask is None:

AttributeError: 'Image' object has no attribute 'shape'</code></pre>
</details>
<p>Oh no!â€¦ I meanâ€¦ Oh, yes!</p>
<p>We get an error:</p>
<blockquote class="blockquote">
<p>AttributeError: â€˜Imageâ€™ object has no attribute â€˜shapeâ€™</p>
</blockquote>
<p>Hmmmâ€¦ it seems weâ€™ve tried to pass a <code>PIL.Image</code> to our model rather than a <code>torch.FloatTensor</code> of shape <code>(batch_size, num_channels, height, width)</code>.</p>
<p>It looks like our input data might require some preprocessing before we can pass it to our model.</p>
</section>
</section>
<section id="aside-processor-to-model-pattern" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="aside-processor-to-model-pattern"><span class="header-section-number">7</span> Aside: Processor to Model Pattern</h2>
<p>Many Hugging Face data loading and modelling workflows as well as machine learning workflows in general follow the pattern of:</p>
<ul>
<li>Data -&gt; Preprocessor -&gt; Model</li>
</ul>
<p>TK image - can we make data -&gt; preprocessor -&gt; model look better? potentially a flow chart?</p>
<p>Meaning, the raw input data gets preprocessed or transformed in some way before being passed to a model.</p>
<p>Preprocessors and models are often loaded with an <a href="https://huggingface.co/docs/transformers/en/model_doc/auto">Auto Class</a>.</p>
<p>An Auto Class pairs a preprocessor and model based on their model name or key.</p>
<p>For example:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoProcessor, AutoModel</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load raw data</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>raw_data <span class="op">=</span> load_data()</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define target model name</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>MODEL_NAME <span class="op">=</span> <span class="st">"..."</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load preprocessor and model (these two are often paired)</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> AutoProcessor.from_pretrained(MODEL_NAME)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModel.from_pretrained(MODEL_NAME)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess data</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>preprocessed_data <span class="op">=</span> preprocessor.preprocess(raw_data)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Pass preprocessed data to model</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> model(preprocessed_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is the same for our Trashify ðŸš® project.</p>
<p>Weâ€™ve got our raw data (images and bounding boxes), however, they need to be preprocessed in order for our model to be able to handle them.</p>
<p>Previously we tried to pass a sample of raw data to our model and this errored.</p>
<p>We can fix this by first preprocessing our raw data with our modelâ€™s pair preprocessor and <em>then</em> passing to our model again.</p>
</section>
<section id="loading-our-models-processor" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="loading-our-models-processor"><span class="header-section-number">8</span> Loading our modelâ€™s processor</h2>
<p>Time to get our raw data ready for our model!</p>
<p>To begin, letâ€™s load our modelâ€™s processor.</p>
<p>Weâ€™ll use this to prepare our input images for the model.</p>
<p>To do so, weâ€™ll use <a href="https://huggingface.co/docs/transformers/en/model_doc/auto#transformers.AutoImageProcessor"><code>transformers.AutoImageProcessor</code></a> and pass our target model name to the <code>from_pretrained</code> method.</p>
<div id="cell-65" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoImageProcessor</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>MODEL_NAME <span class="op">=</span> <span class="st">"microsoft/conditional-detr-resnet-50"</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># MODEL_NAME = "facebook/detr-resnet-50" # Could also use this model as an another experiment</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the image processor</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>image_processor <span class="op">=</span> AutoImageProcessor.from_pretrained(pretrained_model_name_or_path<span class="op">=</span>MODEL_NAME)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out the image processor</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>image_processor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using a slow image processor as `use_fast` is unset and a slow processor was saved with this model. `use_fast=True` will be the default behavior in v4.48, even if the model was saved with a slow processor. This will result in minor differences in outputs. You'll still be able to use a slow processor with `use_fast=False`.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>ConditionalDetrImageProcessor {
  "do_convert_annotations": true,
  "do_normalize": true,
  "do_pad": true,
  "do_rescale": true,
  "do_resize": true,
  "format": "coco_detection",
  "image_mean": [
    0.485,
    0.456,
    0.406
  ],
  "image_processor_type": "ConditionalDetrImageProcessor",
  "image_std": [
    0.229,
    0.224,
    0.225
  ],
  "pad_size": null,
  "resample": 2,
  "rescale_factor": 0.00392156862745098,
  "size": {
    "longest_edge": 1333,
    "shortest_edge": 800
  }
}</code></pre>
</div>
</div>
<p>Ok, a few things going on here.</p>
<p>These parameters will transform our input images before we pass them to our model.</p>
<p>One of the first things to see is the <code>image_processor</code> is expecting our bounding boxes to be in <a href="https://cocodataset.org/#format-data">COCO (or <code>coco_detection</code>) format</a> (this is the default).</p>
<p>Weâ€™ll see what this looks like later on but our processor wants this format because thatâ€™s the format our model has been trained on (itâ€™s generally best practice to input data to a model in the same way its been trained on, otherwise you might get poor results).</p>
<p>Another thing to notice is that our input images will be resized to the values of the <code>size</code> parameter.</p>
<p>In our case, itâ€™s currently:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">"size"</span>: {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longest_edge"</span>: <span class="dv">1333</span>,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shortest_edge"</span>: <span class="dv">800</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Which means that the longest edge will have size less or equal to <code>1333</code> and the shortest edge less or equal to <code>800</code>.</p>
<p>For simplicity, weâ€™ll change this shortly to make both sides the same size.</p>
<p>You can read more about what each of these does in the <a href="https://huggingface.co/docs/transformers/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor"><code>transformers.ConditionalDetrImageProcessor</code> documentation</a>.</p>
<p>Letâ€™s update our instance of <code>transformers.ConditionalDetrImageProcessor</code> with a few custom parameters:</p>
<ul>
<li><code>do_convert_annotations=True</code> - This is the default and it will convert our boxes to the format <code>CXCYWH</code> or <code>(center_x, center_y, width, height)</code> (see <a href="#tbl-bbox-formats" class="quarto-xref">Table&nbsp;1</a>) in the range <code>[0, 1]</code>.</li>
<li><code>size</code> - Weâ€™ll update the <code>size</code> dictionary so all of our images have <code>"longest_edge": 640</code> and <code>"shortest_edge: 640"</code>. Weâ€™ll use a value of <code>640</code> which is a common size in world of object detection. But there are also other sizes such as <code>300x300</code>, <code>480x480</code>, <code>512x512</code>, <code>800x800</code> and more.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Depending on what task youâ€™re working on, you might want to tweak the image resolution youâ€™re working with.</p>
<p>For example, I like this quote from <a href="https://lucasb.eyer.be/articles/vit_cnn_speed.html">Lucas Beyer</a>, a former research scientist at DeepMind and engineer at OpenAI:</p>
<blockquote class="blockquote">
<p>My conservative claim is that you can always stretch to a square, and for:</p>
<p>natural images, meaning most photos, 224pxÂ² is enough; text in photos, phone screens, diagrams and charts, 448pxÂ² is enough; desktop screens and single-page documents, 896pxÂ² is enough.</p>
</blockquote>
<p>Typically, in the case of object detection, youâ€™ll want to use a higher value.</p>
<p>But this is another thing that is open to experimentation.</p>
</div>
</div>
<div id="cell-67" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set image size</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>IMAGE_SIZE <span class="op">=</span> <span class="dv">640</span> <span class="co"># we could try other sizes here: 300x300, 480x480, 512x512, 640x640, 800x800 (best to experiment and see which works best)</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new instance of the image processor with the desired image size</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>image_processor <span class="op">=</span> AutoImageProcessor.from_pretrained(</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    pretrained_model_name_or_path<span class="op">=</span>MODEL_NAME,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span><span class="op">=</span><span class="st">"coco_detection"</span>, <span class="co"># this is the default</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    do_convert_annotations<span class="op">=</span><span class="va">True</span>, <span class="co"># defaults to True, converts boxes to (center_x, center_y, width, height) in range [0, 1]</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>{<span class="st">"shortest_edge"</span>: IMAGE_SIZE, </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">"longest_edge"</span>: IMAGE_SIZE}</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: View the docstring of our image_processor.preprocess function</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="co"># image_processor.preprocess?</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out our new image processor size</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>image_processor.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>{'shortest_edge': 640, 'longest_edge': 640}</code></pre>
</div>
</div>
<p>Beautiful!</p>
<p>Now our images will be resized to a square of size <code>640x640</code> when we pass them to our model.</p>
<p>How about we try to preprocess our <code>random_sample</code>?</p>
<p>To do so, we can pass its <code>"image"</code> key and <code>"annotations"</code> key to our <code>image_processor</code>â€™s <a href="https://huggingface.co/docs/transformers/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.preprocess"><code>preprocess</code></a> method.</p>
<p>Letâ€™s try!</p>
<div id="cell-69" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Try to process a single image and annotation pair (spoiler: this will error)</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>random_sample_preprocessed <span class="op">=</span> image_processor.preprocess(images<span class="op">=</span>random_sample[<span class="st">"image"</span>],</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                                                        annotations<span class="op">=</span>random_sample[<span class="st">"annotations"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[23], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># Try to process a single image and annotation pair (spoiler: this will error)</span>
<span class="ansi-green-fg">----&gt; 2</span> random_sample_preprocessed <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">image_processor</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">preprocess</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">images</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">random_sample</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">image</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      3</span> <span class="ansi-yellow-bg">                                                        </span><span class="ansi-yellow-bg">annotations</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">random_sample</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">annotations</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/ai/lib/python3.11/site-packages/transformers/models/conditional_detr/image_processing_conditional_detr.py:1422</span>, in <span class="ansi-cyan-fg">ConditionalDetrImageProcessor.preprocess</span><span class="ansi-blue-fg">(self, images, annotations, return_segmentation_masks, masks_path, do_resize, size, resample, do_rescale, rescale_factor, do_normalize, do_convert_annotations, image_mean, image_std, do_pad, format, return_tensors, data_format, input_data_format, pad_size, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1420</span> <span style="color:rgb(0,135,0)">format</span> <span style="color:rgb(98,98,98)">=</span> AnnotationFormat(<span style="color:rgb(0,135,0)">format</span>)
<span class="ansi-green-fg ansi-bold">   1421</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> annotations <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">-&gt; 1422</span>     <span class="ansi-yellow-bg">validate_annotations</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">format</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">SUPPORTED_ANNOTATION_FORMATS</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">annotations</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1424</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> (
<span class="ansi-green-fg ansi-bold">   1425</span>     masks_path <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1426</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">format</span> <span style="color:rgb(98,98,98)">==</span> AnnotationFormat<span style="color:rgb(98,98,98)">.</span>COCO_PANOPTIC
<span class="ansi-green-fg ansi-bold">   1427</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">isinstance</span>(masks_path, (pathlib<span style="color:rgb(98,98,98)">.</span>Path, <span style="color:rgb(0,135,0)">str</span>))
<span class="ansi-green-fg ansi-bold">   1428</span> ):
<span class="ansi-green-fg ansi-bold">   1429</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-fg ansi-bold">   1430</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">The path to the directory containing the mask PNG files should be provided as a</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">   1431</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)"> `pathlib.Path` or string object, but is </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">type</span>(masks_path)<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> instead.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">   1432</span>     )

File <span class="ansi-green-fg">~/miniconda3/envs/ai/lib/python3.11/site-packages/transformers/image_utils.py:851</span>, in <span class="ansi-cyan-fg">validate_annotations</span><span class="ansi-blue-fg">(annotation_format, supported_annotation_formats, annotations)</span>
<span class="ansi-green-fg ansi-bold">    849</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> annotation_format <span style="font-weight:bold;color:rgb(175,0,255)">is</span> AnnotationFormat<span style="color:rgb(98,98,98)">.</span>COCO_DETECTION:
<span class="ansi-green-fg ansi-bold">    850</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> valid_coco_detection_annotations(annotations):
<span class="ansi-green-fg">--&gt; 851</span>         <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-fg ansi-bold">    852</span>             <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Invalid COCO detection annotations. Annotations must a dict (single image) or list of dicts </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    853</span>             <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">(batch of images) with the following keys: `image_id` and `annotations`, with the latter </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    854</span>             <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">being a list of annotations in the COCO format.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    855</span>         )
<span class="ansi-green-fg ansi-bold">    857</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> annotation_format <span style="font-weight:bold;color:rgb(175,0,255)">is</span> AnnotationFormat<span style="color:rgb(98,98,98)">.</span>COCO_PANOPTIC:
<span class="ansi-green-fg ansi-bold">    858</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> valid_coco_panoptic_annotations(annotations):

<span class="ansi-red-fg">ValueError</span>: Invalid COCO detection annotations. Annotations must a dict (single image) or list of dicts (batch of images) with the following keys: `image_id` and `annotations`, with the latter being a list of annotations in the COCO format.</pre>
</div>
</div>
</div>
<p>Oh no!</p>
<p>We get an error:</p>
<blockquote class="blockquote">
<p>ValueError: Invalid COCO detection annotations. Annotations must a dict (single image) or list of dicts (batch of images) with the following keys: <code>image_id</code> and <code>annotations</code>, with the latter being a list of annotations in the COCO format.</p>
</blockquote>
<section id="preprocessing-a-single-image" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="preprocessing-a-single-image"><span class="header-section-number">8.1</span> Preprocessing a single image</h3>
<p>Okay so it turns out that our annotations arenâ€™t in the format that the <code>preprocess</code> method was expecting.</p>
<p>Since our pre-trained model was trained on the COCO dataset, the <code>preprocess</code> method expects input data to be in line with the COCO format.</p>
<p>We can fix this later on by adjusting our annotations.</p>
<p>How about we try to preprocess just a single image instead?</p>
<div id="cell-72" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess our target sample</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>random_sample_preprocessed_image_only <span class="op">=</span> image_processor.preprocess(images<span class="op">=</span>random_sample[<span class="st">"image"</span>],</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                                                                   annotations<span class="op">=</span><span class="va">None</span>, <span class="co"># no annotations this time </span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                                                                   return_tensors<span class="op">=</span><span class="st">"pt"</span>) <span class="co"># return as PyTorch tensors</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment to see the full output</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print(random_sample_preprocessed_image_only)</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out the keys of the preprocessed image</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(random_sample_preprocessed_image_only.keys())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dict_keys(['pixel_values', 'pixel_mask'])</code></pre>
</div>
</div>
<p>Nice! It looks like the <code>preprocess</code> method works on a single image.</p>
<p>And it seems like we get a dictionary output with the following keys:</p>
<ul>
<li><code>pixel_values</code> - the processed pixel values of the input image.</li>
<li><code>pixel_mask</code> - a mask multiplier for the pixel values as to whether they should be paid attention to or not (a value of <code>0</code> means the pixel value should be ignored by the model and a value of <code>1</code> means the pixel value should be paid attention to by the model).</li>
</ul>
<p>In our case, all values of the <code>pixel_mask</code> are <code>1</code> since weâ€™re not using any masks.</p>
<p>Letâ€™s check.</p>
<p>PS Do you remember where we needed these keys? <code>pixel_values</code> and <code>pixel_mask</code>? Hint: itâ€™s the reverse of <code>drawrof.ledom</code>.</p>
<div id="cell-74" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check all values of the pixel_mask are 1</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>torch.<span class="bu">all</span>(random_sample_preprocessed_image_only[<span class="st">"pixel_mask"</span>][<span class="dv">0</span>]) <span class="op">==</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>tensor(True)</code></pre>
</div>
</div>
<p>Beautiful!</p>
<p>Now how about we inspect our processed imageâ€™s shape?</p>
<div id="cell-76" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment to inspect all preprocessed pixel values</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># print(random_sample_preprocessed_image_only["pixel_values"][0])</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Original image shape: </span><span class="sc">{</span>random_sample[<span class="st">'image'</span>]<span class="sc">.</span>size<span class="sc">}</span><span class="ss"> -&gt; [width, height]"</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Preprocessed image shape: </span><span class="sc">{</span>random_sample_preprocessed_image_only[<span class="st">'pixel_values'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [batch_size, colour_channles, height, width]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Original image shape: (960, 1280) -&gt; [width, height]
[INFO] Preprocessed image shape: torch.Size([1, 3, 640, 480]) -&gt; [batch_size, colour_channles, height, width]</code></pre>
</div>
</div>
<p>Ok wonderful, it looks like our image has been downsized to <code>[3, 640, 480]</code> (1 item in the batch, 3 colour channels, 640 pixels high, 480 pixels wide).</p>
<p>This is down from its original size of <code>[960, 1280]</code> (1280 pixels high, 960 pixels wide).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The order of image dimensions can differ between libraries and frameworks.</p>
<p>For example, image tensors in PyTorch typically follow the format <code>[colour_channels, height, width]</code> whereas in TensorFlow they follow <code>[height, width, colour_channels]</code>.</p>
<p>And in PIL, the format is <code>[width, height]</code>.</p>
<p>As you can imagine, this can get confusing.</p>
<p>However, with some practice, youâ€™ll be able to decipher which is which.</p>
<p>And if your images and bounding boxes start looking strange, perhaps checking the image dimension and format can help.</p>
</div>
</div>
</section>
<section id="trying-to-pass-a-single-sample-through-our-model-part-2" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="trying-to-pass-a-single-sample-through-our-model-part-2"><span class="header-section-number">8.2</span> Trying to pass a single sample through our model (part 2)</h3>
<p>This is exciting!</p>
<p>Weâ€™ve processed an image into the format our model is expecting.</p>
<p>How about we try another forward by calling <code>model.forward(pixel_values, pixel_mask)</code>?</p>
<p>Which is the same as calling <code>model(pixel_values, pixel_mask)</code>.</p>
<div id="cell-79" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Do a single forward pass with the model</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>random_sample_outputs <span class="op">=</span> model(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    pixel_values<span class="op">=</span>random_sample_preprocessed_image_only[<span class="st">"pixel_values"</span>], <span class="co"># model expects input [batch_size, color_channels, height, width]</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    pixel_mask<span class="op">=</span>random_sample_preprocessed_image_only[<span class="st">"pixel_mask"</span>],</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the outputs</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>random_sample_outputs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>ConditionalDetrObjectDetectionOutput(loss=None, loss_dict=None, logits=tensor([[[ 0.1757,  0.4370, -0.1690,  ..., -0.1258, -0.4003, -0.2219],
         [ 0.4472,  0.3915,  0.2849,  ...,  0.1475, -0.3723, -0.4446],
         [ 0.2622,  0.5060,  0.1885,  ...,  0.2149,  0.0383, -0.6638],
         ...,
         [ 0.5465,  0.2946, -0.1081,  ..., -0.0089, -0.6618, -0.6334],
         [ 0.1288,  0.5877,  0.0886,  ...,  0.2062, -0.1418, -0.7392],
         [ 0.5138,  0.4494,  0.1688,  ...,  0.2361, -0.3010, -0.3232]]],
       grad_fn=&lt;ViewBackward0&gt;), pred_boxes=tensor([[[0.7542, 0.9303, 0.4992, 0.1405],
         [0.6286, 0.0153, 0.1567, 0.0288],
         [0.9243, 0.4090, 0.1390, 0.1281],
         ...,
         [0.4614, 0.4677, 0.7212, 0.4662],
         [0.8921, 0.3894, 0.2044, 0.1685],
         [0.0087, 0.2845, 0.0171, 0.1204]]], grad_fn=&lt;SigmoidBackward0&gt;), auxiliary_outputs=None, last_hidden_state=tensor([[[ 0.1552, -1.2381,  0.8227,  ..., -1.1727,  0.0825,  0.9137],
         [ 0.4654,  0.7841,  0.1328,  ..., -0.1978, -0.0941, -0.0371],
         [ 0.3621, -0.3662,  0.2910,  ..., -0.6333, -0.4972,  0.2925],
         ...,
         [ 0.3586, -0.8927,  0.5577,  ..., -0.8926, -0.0692,  0.1071],
         [ 0.3931, -0.6438,  0.5788,  ..., -0.7311, -0.6509,  0.0632],
         [-0.2122,  1.0794,  0.2088,  ..., -0.1402,  0.0552,  0.8678]]],
       grad_fn=&lt;NativeLayerNormBackward0&gt;), decoder_hidden_states=None, decoder_attentions=None, cross_attentions=None, encoder_last_hidden_state=tensor([[[-0.3168,  0.4146, -0.3426,  ..., -0.4606,  0.4501,  0.2935],
         [ 0.1309,  0.3931, -0.0549,  ...,  0.2440,  0.2703,  0.3214],
         [ 0.0961,  0.4969, -0.1218,  ...,  0.0107,  0.2344,  0.2396],
         ...,
         [ 0.0789,  0.0419,  0.1211,  ..., -0.5272, -0.1697, -0.0448],
         [ 0.0761,  0.1426,  0.0241,  ...,  0.3203, -0.1235,  0.1125],
         [-0.1036,  0.0904,  0.0968,  ...,  0.1425, -0.0034,  0.2197]]],
       grad_fn=&lt;NativeLayerNormBackward0&gt;), encoder_hidden_states=None, encoder_attentions=None)</code></pre>
</div>
</div>
<p>Nice!</p>
<p>It looks like it worked!</p>
<p>Our model processed our <code>random_sample_preprocessed_image_only["pixel_values"]</code> and returned a <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrForObjectDetection.forward"><code>ConditionalDetrObjectDetectionOutput</code></a> object as output.</p>
<p>Letâ€™s inspect the <code>keys()</code> method of this output and see what they are.</p>
<div id="cell-81" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the keys of the output</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>random_sample_outputs.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>odict_keys(['logits', 'pred_boxes', 'last_hidden_state', 'encoder_last_hidden_state'])</code></pre>
</div>
</div>
<p>Breaking these down:</p>
<ul>
<li><code>logits</code> - The raw outputs from the model, these are the classification <a href="https://datascience.stackexchange.com/questions/31041/what-does-logits-in-machine-learning-mean">logits</a> we can later apply a <a href="https://pytorch.org/docs/stable/generated/torch.nn.Softmax.html"><strong>softmax function</strong></a>/<a href="https://en.wikipedia.org/wiki/Sigmoid_function"><strong>sigmoid function</strong></a> to to get <strong>prediction probabilties</strong>.</li>
<li><code>pred_boxes</code> - Normalized box coordinates in <code>CXCYWH</code> (<code>(center_x, center_y, width, height)</code>) format.</li>
<li><code>last_hidden_state</code> - Last hidden state of the last decoder layer of the model.</li>
<li><code>encoder_last_hidden_state</code> - Last hidden state of the last encoder layer of the model.</li>
</ul>
<p>How about we inspect the <code>shape</code> attribute of the <code>logits</code>?</p>
<div id="cell-84" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect logits output shape</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>output_logits <span class="op">=</span> random_sample_outputs.logits</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output logits shape: </span><span class="sc">{</span>output_logits<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [1 image, 300 boxes, 7 classes]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output logits shape: torch.Size([1, 300, 7]) -&gt; [1 image, 300 boxes, 7 classes]</code></pre>
</div>
</div>
<p>Nice!</p>
<p>We get an output from our model that coincides with the shape of our data.</p>
<p>The final value of <code>7</code> in the <code>output_logits</code> tensor is equivalent to the number of classes we have.</p>
<p>And the <code>300</code> is the number of boxes our model predicts for each image (this is defined by the <code>num_queries</code> parameter of the <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrConfig"><code>transformers.ConditionalDetrConfig</code></a>, where <code>num_queries=300</code> is the default).</p>
<div id="cell-86" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect predicted boxes output shape</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>output_pred_boxes <span class="op">=</span> random_sample_outputs.pred_boxes</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output predicted boxes shape: </span><span class="sc">{</span>output_pred_boxes<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [1 image, 300 boxes, 4 coordinates (center_x, center_y, width, height)]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output predicted boxes shape: torch.Size([1, 300, 4]) -&gt; [1 image, 300 boxes, 4 coordinates (center_x, center_y, width, height)]</code></pre>
</div>
</div>
<p>Reading the <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrForObjectDetection.forward">documentation for the <code>forward</code> method</a>, we can determine the output format of our models predicted boxes:</p>
<blockquote class="blockquote">
<p>Returns:</p>
<p>pred_boxes (torch.FloatTensor of shape (batch_size, num_queries, 4)) â€” Normalized boxes coordinates for all queries, represented as (center_x, center_y, width, height). These values are normalized in [0, 1], relative to the size of each individual image in the batch (disregarding possible padding). You can use <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.post_process_object_detection"><code>post_process_object_detection()</code></a> to retrieve the unnormalized bounding boxes.</p>
</blockquote>
<p>This is good to know!</p>
<p>It means that the raw output boxes from our model come in normalized <code>CXCYWH</code> format (see <a href="#tbl-bbox-formats" class="quarto-xref">Table&nbsp;1</a> for more).</p>
<p>How about we inspect a single box?</p>
<div id="cell-88" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Single example predicted bounding box coordinates</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Example output box: </span><span class="sc">{</span>output_pred_boxes[:, <span class="dv">0</span>, :][<span class="dv">0</span>]<span class="sc">.</span>detach()<span class="sc">}</span><span class="ss"> -&gt; (center_x, center_y, width, height)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Example output box: tensor([0.7542, 0.9303, 0.4992, 0.1405]) -&gt; (center_x, center_y, width, height)</code></pre>
</div>
</div>
<p>Excellent!</p>
<p>We can process these boxes and logits later on into different formats using the <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.post_process_object_detection"><code>transformers.ConditionalDetrImageProcessor.post_process_object_detection</code></a> method.</p>
<p>For now, letâ€™s figure out how to preprocess our annotations.</p>
</section>
</section>
<section id="preprocessing-our-annotations" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="preprocessing-our-annotations"><span class="header-section-number">9</span> Preprocessing our annotations</h2>
<p>One of the most tricky parts of any machine learning problem is getting your data in the right format.</p>
<p>Weâ€™ve done it for our images.</p>
<p>Now letâ€™s do it for our annotations.</p>
<section id="trying-to-preprocess-a-single-annotation" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="trying-to-preprocess-a-single-annotation"><span class="header-section-number">9.1</span> Trying to preprocess a single annotation</h3>
<p>Recall in a previous section we tried to preprocess a single image and its annotation.</p>
<p>And we got an error.</p>
<p>Letâ€™s make sure weâ€™re not crazy and this is still the case.</p>
<div id="cell-92" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess a single image and annotation pair</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>image_processor.preprocess(</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    images<span class="op">=</span>random_sample[<span class="st">"image"</span>], </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    annotations<span class="op">=</span>random_sample[<span class="st">"annotations"</span>]</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[32], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># Preprocess a single image and annotation pair</span>
<span class="ansi-green-fg">----&gt; 2</span> <span class="ansi-yellow-bg">image_processor</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">preprocess</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">      3</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">images</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">random_sample</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">image</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span>
<span class="ansi-green-fg ansi-bold">      4</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">annotations</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">random_sample</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">annotations</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">]</span>
<span class="ansi-green-fg ansi-bold">      5</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/ai/lib/python3.11/site-packages/transformers/models/conditional_detr/image_processing_conditional_detr.py:1422</span>, in <span class="ansi-cyan-fg">ConditionalDetrImageProcessor.preprocess</span><span class="ansi-blue-fg">(self, images, annotations, return_segmentation_masks, masks_path, do_resize, size, resample, do_rescale, rescale_factor, do_normalize, do_convert_annotations, image_mean, image_std, do_pad, format, return_tensors, data_format, input_data_format, pad_size, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1420</span> <span style="color:rgb(0,135,0)">format</span> <span style="color:rgb(98,98,98)">=</span> AnnotationFormat(<span style="color:rgb(0,135,0)">format</span>)
<span class="ansi-green-fg ansi-bold">   1421</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> annotations <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">-&gt; 1422</span>     <span class="ansi-yellow-bg">validate_annotations</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">format</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">SUPPORTED_ANNOTATION_FORMATS</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">annotations</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1424</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> (
<span class="ansi-green-fg ansi-bold">   1425</span>     masks_path <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1426</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">format</span> <span style="color:rgb(98,98,98)">==</span> AnnotationFormat<span style="color:rgb(98,98,98)">.</span>COCO_PANOPTIC
<span class="ansi-green-fg ansi-bold">   1427</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">isinstance</span>(masks_path, (pathlib<span style="color:rgb(98,98,98)">.</span>Path, <span style="color:rgb(0,135,0)">str</span>))
<span class="ansi-green-fg ansi-bold">   1428</span> ):
<span class="ansi-green-fg ansi-bold">   1429</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-fg ansi-bold">   1430</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">The path to the directory containing the mask PNG files should be provided as a</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">   1431</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)"> `pathlib.Path` or string object, but is </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">type</span>(masks_path)<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> instead.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">   1432</span>     )

File <span class="ansi-green-fg">~/miniconda3/envs/ai/lib/python3.11/site-packages/transformers/image_utils.py:851</span>, in <span class="ansi-cyan-fg">validate_annotations</span><span class="ansi-blue-fg">(annotation_format, supported_annotation_formats, annotations)</span>
<span class="ansi-green-fg ansi-bold">    849</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> annotation_format <span style="font-weight:bold;color:rgb(175,0,255)">is</span> AnnotationFormat<span style="color:rgb(98,98,98)">.</span>COCO_DETECTION:
<span class="ansi-green-fg ansi-bold">    850</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> valid_coco_detection_annotations(annotations):
<span class="ansi-green-fg">--&gt; 851</span>         <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-fg ansi-bold">    852</span>             <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Invalid COCO detection annotations. Annotations must a dict (single image) or list of dicts </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    853</span>             <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">(batch of images) with the following keys: `image_id` and `annotations`, with the latter </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    854</span>             <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">being a list of annotations in the COCO format.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    855</span>         )
<span class="ansi-green-fg ansi-bold">    857</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> annotation_format <span style="font-weight:bold;color:rgb(175,0,255)">is</span> AnnotationFormat<span style="color:rgb(98,98,98)">.</span>COCO_PANOPTIC:
<span class="ansi-green-fg ansi-bold">    858</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> valid_coco_panoptic_annotations(annotations):

<span class="ansi-red-fg">ValueError</span>: Invalid COCO detection annotations. Annotations must a dict (single image) or list of dicts (batch of images) with the following keys: `image_id` and `annotations`, with the latter being a list of annotations in the COCO format.</pre>
</div>
</div>
</div>
<p>Wonderful!</p>
<p>Weâ€™re not crazyâ€¦</p>
<p>But we still get an error:</p>
<blockquote class="blockquote">
<p>ValueError: Invalid COCO detection annotations. Annotations must a dict (single image) or list of dicts (batch of images) with the following keys: <code>image_id</code> and <code>annotations</code>, with the latter being a list of annotations in the COCO format.</p>
</blockquote>
<p>In this section, weâ€™re going to fix it.</p>
</section>
<section id="discussing-the-format-our-annotations-need-to-be-in" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="discussing-the-format-our-annotations-need-to-be-in"><span class="header-section-number">9.2</span> Discussing the format our annotations need to be in</h3>
<p>According the error we got in the previous segment, the <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.preprocess"><code>transformers.ConditionalDetrImageProcessor.preprocess</code></a> method expects input annotations in COCO format.</p>
<p>In the documentation we can read that the <code>annotations</code> parameter taks in a list of dictionaries with the following keys:</p>
<ul>
<li><code>"image_id"</code> (<code>int</code>): The image id.</li>
<li><code>"annotations"</code> (<code>List[Dict]</code>): List of annotations for an image. Each annotation should be a dictionary. An image can have no annotations, in which case the list should be empty.</li>
</ul>
<p>As for the <code>"annotations"</code> field, this should be a list of dictionaries containing individual annotations in <a href="https://cocodataset.org/#format-data">COCO format</a>:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># COCO format, see: https://cocodataset.org/#format-data  </span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>[{</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"image_id"</span>: <span class="dv">42</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"annotations"</span>: [{</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"id"</span>: <span class="dv">123456</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"category_id"</span>: <span class="dv">1</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"iscrowd"</span>: <span class="dv">0</span>,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"segmentation"</span>: [</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>            [<span class="fl">42.0</span>, <span class="fl">55.6</span>, ... <span class="fl">99.3</span>, <span class="fl">102.3</span>]</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image_id"</span>: <span class="dv">42</span>, <span class="co"># this matches the 'image_id' field above</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"area"</span>: <span class="fl">135381.07</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bbox"</span>: [<span class="fl">523.70</span>,</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>                 <span class="fl">545.09</span>,</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>                 <span class="fl">402.79</span>,</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>                 <span class="fl">336.11</span>]</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Next annotation in the same format as the previous one (one annotation per dict).</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For example, if an image had 4 bounding boxes, there would be a list of 4 dictionaries</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># each containing a single annotation.</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    ...]</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>}]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Letâ€™s breakdown each of the fields in the COCO annotation:</p>
<div id="tbl-coco-format" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-coco-format-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: COCO data format keys breakdown
</figcaption>
<div aria-describedby="tbl-coco-format-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Field</th>
<th>Requirement</th>
<th>Data Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>image_id</code> (top-level)</td>
<td>Required</td>
<td>Integer</td>
<td>ID of the target image.</td>
</tr>
<tr class="even">
<td><code>annotations</code></td>
<td>Required</td>
<td>List[Dict]</td>
<td>List of dictionaries with one box annotation per dict. Can be empty if there are no boxes.</td>
</tr>
<tr class="odd">
<td><code>id</code></td>
<td>Not required</td>
<td>Integer</td>
<td>ID of the particular annotation.</td>
</tr>
<tr class="even">
<td><code>category_id</code></td>
<td>Required</td>
<td>Integer</td>
<td>ID of the class the box relates to (e.g.&nbsp;<code>{0: 'bin', 1: 'hand', 2: 'not_bin', 3: 'not_hand', 4: 'not_trash', 5: 'trash'}</code>).</td>
</tr>
<tr class="odd">
<td><code>segmentation</code></td>
<td>Not required</td>
<td>List or None</td>
<td>Segmentation mask related to an annotation instance. Focus is on boxes, not segmentation.</td>
</tr>
<tr class="even">
<td><code>image_id</code> (inside <code>annotations</code> field)</td>
<td>Required</td>
<td>Integer</td>
<td>ID of the target image the particular box relates to, should match <code>image_id</code> on the top-level field.</td>
</tr>
<tr class="odd">
<td><code>area</code></td>
<td>Not required</td>
<td>Float</td>
<td>Area of the target bounding box (e.g.&nbsp;box height * width).</td>
</tr>
<tr class="even">
<td><code>bbox</code></td>
<td>Required</td>
<td>List[Float]</td>
<td>Coordinates of the target bounding box in <code>XYWH</code> (<code>[x, y, width, height]</code>) format. <code>(x, y)</code> are the top left corner coordinates, <code>width</code> and <code>height</code> are dimensions.</td>
</tr>
<tr class="odd">
<td><code>is_crowd</code></td>
<td>Not required</td>
<td>Int</td>
<td>Boolean flag (0 or 1) to indicate whether or not an object is multiple (a crowd) of the same thing. For example, a crowd of â€œpeopleâ€ or a group of â€œapplesâ€ rather than a single apple.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>And now our annotation data comes in the format:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">'image'</span>: <span class="op">&lt;</span>PIL.Image.Image image mode<span class="op">=</span>RGB size<span class="op">=</span><span class="dv">960</span><span class="er">x1280</span><span class="op">&gt;</span>,</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a> <span class="st">'image_id'</span>: <span class="dv">292</span>,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a> <span class="st">'annotations'</span>: {<span class="st">'file_name'</span>: [<span class="st">'00347467-13f1-4cb9-94aa-4e4369457e0c.jpeg'</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>   <span class="st">'00347467-13f1-4cb9-94aa-4e4369457e0c.jpeg'</span>],</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'image_id'</span>: [<span class="dv">292</span>, <span class="dv">292</span>],</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">'category_id'</span>: [<span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">'bbox'</span>: [[<span class="fl">523.7000122070312</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="fl">545.0999755859375</span>,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="fl">402.79998779296875</span>,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="fl">336.1000061035156</span>],</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>   [<span class="fl">10.399999618530273</span>,</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    <span class="fl">163.6999969482422</span>,</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    <span class="fl">943.4000244140625</span>,</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1101.9000244140625</span>]],</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">'iscrowd'</span>: [<span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">'area'</span>: [<span class="fl">135381.078125</span>, <span class="fl">1039532.4375</span>]},</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a> <span class="st">'label_source'</span>: <span class="st">'manual_prodigy_label'</span>,</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a> <span class="st">'image_source'</span>: <span class="st">'manual_taken_photo'</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>How about we write some code to convert our current annotation format to COCO format?</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Itâ€™s common practice to get a dataset in a certain format and then have to preprocess it into another format before you can use it with a model.</p>
<p>Weâ€™re getting hands-on and practicing here so when it comes to working on converting another dataset, youâ€™ve already had some practice.</p>
</div>
</div>
</section>
<section id="creating-dataclasses-to-represent-the-coco-bounding-box-format" class="level3" data-number="9.3">
<h3 data-number="9.3" class="anchored" data-anchor-id="creating-dataclasses-to-represent-the-coco-bounding-box-format"><span class="header-section-number">9.3</span> Creating dataclasses to represent the COCO bounding box format</h3>
<p>Letâ€™s write some code to transform our existing annotation data into the format required by <code>transformers.ConditionalDetrImageProcessor.preprocess</code>.</p>
<p>Weâ€™ll start by creating two <a href="https://docs.python.org/3/library/dataclasses.html#module-dataclasses">Python dataclasses</a> to house our desired COCO annotation format.</p>
<p>To do this weâ€™ll:</p>
<ol type="1">
<li>Create <code>SingleCOCOAnnotation</code> which contains the format structure of a single COCO annotation.</li>
<li>Create <code>ImageCOCOAnnotations</code> which contains all of the annotations for a given image in COCO format. This may be a single instance of <code>SingleCOCOAnnotation</code> or multiple.</li>
</ol>
<p>Weâ€™ll decorate both of these with the <a href="https://docs.python.org/3/library/dataclasses.html#dataclasses.dataclass"><code>@dataclass</code></a> decorator.</p>
<p>Using a <code>@dataclass</code> gives several benefits:</p>
<ul>
<li>Type hints - we can define the types of objects we want in the class definition, for example, we want <code>image_id</code> to be an <code>int</code>.</li>
<li>Helpful built-in methods - we can use methods such as <a href="https://docs.python.org/3/library/dataclasses.html#dataclasses.asdict"><code>asdict</code></a> to convert our <code>@dataclass</code> into a dictionary (COCO wants lists of dictionaries).</li>
<li>Data validation - we can use methods such as <a href="https://docs.python.org/3/library/dataclasses.html#dataclasses.__post_init__"><code>__post_init__</code></a> to run checks on our <code>@dataclass</code> as itâ€™s initialized, for example, we always want the length of <code>bbox</code> to be 4 (bounding box coordinates in <code>XYWH</code> format).</li>
</ul>
<div id="cell-96" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, asdict</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Create a dataclass for a single COCO annotation</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SingleCOCOAnnotation:</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""An instance of a single COCO annotation. </span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Represent a COCO-formatted (see: https://cocodataset.org/#format-data) single instance of an object </span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co">    in an image. </span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Attributes:</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="co">        image_id: Unique integer identifier for the image which the annotation belongs to.</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co">        category_id: Integer identifier for the target object label/category (e.g. "0" for "bin").</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="co">        bbox: List of floats containing target bounding box coordinates in absolute XYWH format ([x_top_left, y_top_left, width, height]).</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="co">        area: Area of the target bounding box. Defaults to 0.0.</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="co">        iscrowd: Boolean flag (0 or 1) indicating whether the target is a crowd of objects, for example, a group of </span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co">            apples rather than a single apple. Defaults to 0.</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    image_id: <span class="bu">int</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    category_id: <span class="bu">int</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>    bbox: List[<span class="bu">float</span>] <span class="co"># bboxes in XYWH format ([x_top_left, y_top_left, width, height])</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>    area: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    iscrowd: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure the bbox is always a list of 4 values (XYWH format)</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __post_init__(<span class="va">self</span>):</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>.bbox) <span class="op">!=</span> <span class="dv">4</span>:</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"bbox must contain exactly 4 values, current length: </span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.bbox)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Create a dataclass for a collection of COCO annotations for a single image</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImageCOCOAnnotations:</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""A collection of COCO annotations for a single image_id.</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="co">    Attributes:</span></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a><span class="co">        image_id: Unique integer identifier for the image which the annotations belong to.</span></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a><span class="co">        annotations: List of SingleCOCOAnnotation instances.</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    image_id: <span class="bu">int</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    annotations: List[SingleCOCOAnnotation]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Beautiful!</p>
<p>Letâ€™s now inspect our <code>SingleCOCOAnnotation</code> dataclass.</p>
<p>We can use the <code>SingleCOCOAnnotation?</code> syntax to view the docstring of the class.</p>
<div id="cell-98" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># One of the benefits of using a dataclass is that we can inspect the attributes with the `?` syntax</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>SingleCOCOAnnotation?</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Init signature:
SingleCOCOAnnotation(
    image_id: int,
    category_id: int,
    bbox: List[float],
    area: float = 0.0,
    iscrowd: int = 0,
) -&gt; None
Docstring:     
An instance of a single COCO annotation. 

Represent a COCO-formatted (see: https://cocodataset.org/#format-data) single instance of an object 
in an image. 

Attributes:
    image_id: Unique integer identifier for the image which the annotation belongs to.
    category_id: Integer identifier for the target object label/category (e.g. "0" for "bin").
    bbox: List of floats containing target bounding box coordinates in absolute XYWH format ([x_top_left, y_top_left, width, height]).
    area: Area of the target bounding box. Defaults to 0.0.
    iscrowd: Boolean flag (0 or 1) indicating whether the target is a crowd of objects, for example, a group of 
        apples rather than a single apple. Defaults to 0.
Type:           type
Subclasses:     </code></pre>
</div>
</div>
<p>We can also see the error handling of our <code>__post_init__</code> method in action by trying to create an instance of <code>SingleCOCOAnnotation</code> with an incorrect number of bbox values.</p>
<div id="cell-100" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's try our SingleCOCOAnnotation dataclass (this will error since the bbox doesn't have 4 values)</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>SingleCOCOAnnotation(image_id<span class="op">=</span><span class="dv">42</span>, </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                     category_id<span class="op">=</span><span class="dv">0</span>, </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>                     bbox<span class="op">=</span>[<span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>]) <span class="co"># missing a 4th value</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[35], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># Let's try our SingleCOCOAnnotation dataclass (this will error since the bbox doesn't have 4 values)</span>
<span class="ansi-green-fg">----&gt; 2</span> <span class="ansi-yellow-bg">SingleCOCOAnnotation</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">image_id</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">42</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span>
<span class="ansi-green-fg ansi-bold">      3</span> <span class="ansi-yellow-bg">                     </span><span class="ansi-yellow-bg">category_id</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">0</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span>
<span class="ansi-green-fg ansi-bold">      4</span> <span class="ansi-yellow-bg">                     </span><span class="ansi-yellow-bg">bbox</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">100</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">100</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">100</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span> <span style="font-style:italic;color:rgb(95,135,135)"># missing a 4th value</span>

File <span class="ansi-green-fg">&lt;string&gt;:8</span>, in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, image_id, category_id, bbox, area, iscrowd)</span>

Cell <span class="ansi-green-fg">In[33], line 29</span>, in <span class="ansi-cyan-fg">SingleCOCOAnnotation.__post_init__</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">     27</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">__post_init__</span>(<span style="color:rgb(0,135,0)">self</span>):
<span class="ansi-green-fg ansi-bold">     28</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">len</span>(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>bbox) <span style="color:rgb(98,98,98)">!=</span> <span style="color:rgb(98,98,98)">4</span>:
<span class="ansi-green-fg">---&gt; 29</span>         <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">bbox must contain exactly 4 values, current length: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">len</span>(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>bbox)<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)

<span class="ansi-red-fg">ValueError</span>: bbox must contain exactly 4 values, current length: 3</pre>
</div>
</div>
</div>
<p>And now if we pass the correct number of values to our <code>SingleCOCOAnnotation</code>, it should work.</p>
<div id="cell-102" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>SingleCOCOAnnotation(image_id<span class="op">=</span><span class="dv">42</span>, </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>                     category_id<span class="op">=</span><span class="dv">0</span>, </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>                     bbox<span class="op">=</span>[<span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>]) <span class="co"># correct number of values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>SingleCOCOAnnotation(image_id=42, category_id=0, bbox=[100, 100, 100, 100], area=0.0, iscrowd=0)</code></pre>
</div>
</div>
</section>
<section id="creating-a-function-to-format-our-annotations-as-coco-format" class="level3" data-number="9.4">
<h3 data-number="9.4" class="anchored" data-anchor-id="creating-a-function-to-format-our-annotations-as-coco-format"><span class="header-section-number">9.4</span> Creating a function to format our annotations as COCO format</h3>
<p>Now weâ€™ve got the COCO data format in our <code>SingleCOCOAnnotation</code> and <code>ImageCOCOAnnotation</code> dataclasses, letâ€™s write a function to take our existing image annotations and format them in COCO style.</p>
<p>Our <code>format_image_annotations_as_coco</code> function will:</p>
<ol type="1">
<li>Take in an <code>image_id</code> to represent a unique identifier for the image as well as lists of category integers, area values and bounding box coordinates.</li>
<li>Perform a list comprehension on a zipped version of each category, area and bounding box coordinate value in the input lists creating an instance of <code>SingleCOCOAnnotation</code> as a dictionary (using the <code>asdict</code> method) each time, this will give us a list of <code>SingleCOCOAnnotation</code> formatted dictionaries.</li>
<li>Return a dictionary version of <code>ImageCOCOAnnotations</code> using <code>asdict</code> passing it the <code>image_id</code> as well as list of <code>SingleCOCOAnnotation</code> dictionaries from 2.</li>
</ol>
<p>Why does our function take in lists of categories, areas and bounding boxes?</p>
<p>Because thatâ€™s the current format our existing annotations are in (how we downloaded them from Hugging Face in the beginning).</p>
<p>Letâ€™s do it!</p>
<div id="cell-104" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Take in a unique image_id as well as lists of categories, areas, and bounding boxes</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_image_annotations_as_coco(</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>        image_id: <span class="bu">int</span>,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        categories: List[<span class="bu">int</span>],</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        areas: List[<span class="bu">float</span>],</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        bboxes: List[Tuple[<span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>]] <span class="co"># bboxes in XYWH format ([x_top_left, y_top_left, width, height])</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Formats lists of image annotations into COCO format.</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Takes in parallel lists of categories, areas, and bounding boxes and</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="co">    then formats them into a COCO-style dictionary of annotations.</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="co">        image_id: Unique integer identifier for an image.</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="co">        categories: List of integer category IDs for each annotation.</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="co">        areas: List of float areas for each annotation.</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="co">        bboxes: List of tuples containing bounding box coordinates in XYWH format </span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="co">            ([x_top_left, y_top_left, width, height]).</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="co">        A dictionary of image annotations in COCO format with the following structure:</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="co">        {</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="co">            "image_id": int,</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="co">            "annotations": [</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="co">                {</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a><span class="co">                    "image_id": int,</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a><span class="co">                    "category_id": int,</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a><span class="co">                    "bbox": List[float],</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a><span class="co">                    "area": float</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a><span class="co">                },</span></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a><span class="co">                ...more annotations here</span></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a><span class="co">            ]</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a><span class="co">        }</span></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a><span class="co">    Note:</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a><span class="co">        All input lists much be the same length and in the same order.</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a><span class="co">        Otherwise, there will be mismatched annotations.</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Turn input lists into a list of dicts in SingleCOCOAnnotation format</span></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>    coco_format_annotations <span class="op">=</span> [</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>        asdict(SingleCOCOAnnotation(</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>            image_id<span class="op">=</span>image_id,</span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>            category_id<span class="op">=</span>category,</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>            bbox<span class="op">=</span><span class="bu">list</span>(bbox),</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>            area<span class="op">=</span>area,</span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> category, area, bbox <span class="kw">in</span> <span class="bu">zip</span>(categories, areas, bboxes)</span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Return a of annotations with format {"image_id": ..., "annotations": [...]} (required COCO format)</span></span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> asdict(ImageCOCOAnnotations(image_id<span class="op">=</span>image_id,</span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>                                       annotations<span class="op">=</span>coco_format_annotations))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nice!</p>
<p>Having those pre-built dataclasses makes everything else fall into place.</p>
<p>Now letâ€™s try our <code>format_image_annotations_as_coco</code> function on a new <em>not so</em> <code>random_sample</code> (weâ€™ll make a <code>random_sample</code> with a known index for reproducibility).</p>
<p>First, weâ€™ll remind ourselves what our <code>random_sample</code> looks like.</p>
<div id="cell-106" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a not so random sample and inspect it </span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>random_sample <span class="op">=</span> dataset[<span class="st">"train"</span>][<span class="dv">77</span>]</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>random_sample</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>{'image': &lt;PIL.Image.Image image mode=RGB size=960x1280&gt;,
 'image_id': 558,
 'annotations': {'file_name': ['13df7e4a-1a5c-4da9-a5d3-204b6119670c.jpeg',
   '13df7e4a-1a5c-4da9-a5d3-204b6119670c.jpeg',
   '13df7e4a-1a5c-4da9-a5d3-204b6119670c.jpeg'],
  'image_id': [558, 558, 558],
  'category_id': [5, 0, 1],
  'bbox': [[261.8999938964844, 734.5, 181.8000030517578, 216.3000030517578],
   [99.80000305175781, 215.1999969482422, 730.0, 685.7999877929688],
   [0.0, 769.2999877929688, 367.8999938964844, 508.70001220703125]],
  'iscrowd': [0, 0, 0],
  'area': [39323.33984375, 500634.0, 187150.734375]},
 'label_source': 'manual_prodigy_label',
 'image_source': 'manual_taken_photo'}</code></pre>
</div>
</div>
<p>Ok wonderful, looks like we can extract the <code>image_id</code>, <code>category_id</code> <code>bbox</code> and <code>area</code> fields from our <code>random_sample</code> to get the required inputs to our <code>format_image_annotations_as_coco</code> function.</p>
<p>Letâ€™s try it out.</p>
<div id="cell-108" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract image_id, categories, areas, and bboxes from the random sample</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>random_sample_image_id <span class="op">=</span> random_sample[<span class="st">"image_id"</span>]</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>random_sample_categories <span class="op">=</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"category_id"</span>]</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>random_sample_areas <span class="op">=</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"area"</span>]</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>random_sample_bboxes <span class="op">=</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"bbox"</span>]</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Format the random sample annotations as COCO format</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>random_sample_coco_annotations <span class="op">=</span> format_image_annotations_as_coco(image_id<span class="op">=</span>random_sample_image_id,</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>                                                                  categories<span class="op">=</span>random_sample_categories,</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>                                                                  areas<span class="op">=</span>random_sample_areas,</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>                                                                  bboxes<span class="op">=</span>random_sample_bboxes)</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>random_sample_coco_annotations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>{'image_id': 558,
 'annotations': [{'image_id': 558,
   'category_id': 5,
   'bbox': [261.8999938964844, 734.5, 181.8000030517578, 216.3000030517578],
   'area': 39323.33984375,
   'iscrowd': 0},
  {'image_id': 558,
   'category_id': 0,
   'bbox': [99.80000305175781, 215.1999969482422, 730.0, 685.7999877929688],
   'area': 500634.0,
   'iscrowd': 0},
  {'image_id': 558,
   'category_id': 1,
   'bbox': [0.0, 769.2999877929688, 367.8999938964844, 508.70001220703125],
   'area': 187150.734375,
   'iscrowd': 0}]}</code></pre>
</div>
</div>
<p>Woohoo!</p>
<p>Looks like we may have just fixed our <code>ValueError</code> from before:</p>
<blockquote class="blockquote">
<p>ValueError: Invalid COCO detection annotations. Annotations must a dict (single image) or list of dicts (batch of images) with the following keys: <code>image_id</code> and <code>annotations</code>, with the latter being a list of annotations in the COCO format.</p>
</blockquote>
<p>Our COCO formatted annotations have the <code>image_id</code> and <code>annotations</code> keys and our <code>annotations</code> are a list of annotations in COCO format.</p>
<p>Perfect!</p>
</section>
<section id="preprocess-a-single-image-and-set-of-coco-format-annotations" class="level3" data-number="9.5">
<h3 data-number="9.5" class="anchored" data-anchor-id="preprocess-a-single-image-and-set-of-coco-format-annotations"><span class="header-section-number">9.5</span> Preprocess a single image and set of COCO format annotations</h3>
<p>Now weâ€™ve preprocessed our annotations to be in COCO format, we can use them with <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.preprocess"><code>transformers.ConditionalDetrImageProcessor.preprocess</code></a>.</p>
<p>Letâ€™s pass our <code>random_sample</code> image and COCO formatted annotations to the <code>preprocess</code> method.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The default value for the <a href="https://huggingface.co/docs/transformers/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.preprocess.do_convert_annotations">parameter <code>do_convert_annotations</code></a> of the <code>preprocess</code> method is <code>True</code>.</p>
<p>This means our boxes will go into the <code>preprocess</code> method in absolute <code>XYWH</code> format (the format we downloaded them in) and will be returned in normalized <code>CXCYWH</code> (or <code>(center_x, center_y, width, height)</code>) format.</p>
<p>Whenever you perform adjustments or preprocessing steps on your annotations, itâ€™s always good to keep track of the format that they are in, otherwise it can lead to unexpected bugs later on.</p>
</div>
</div>
<div id="cell-111" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess random sample image and assosciated annotations</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>random_sample_preprocessed <span class="op">=</span> image_processor.preprocess(images<span class="op">=</span>random_sample[<span class="st">"image"</span>],</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>                                                        annotations<span class="op">=</span>random_sample_coco_annotations,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>                                                        do_convert_annotations<span class="op">=</span><span class="va">True</span>, <span class="co"># defaults to True, this will convert our annotations to normalized CXCYWH format</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>                                                        return_tensors<span class="op">=</span><span class="st">"pt"</span> <span class="co"># can return as tensors or not, "pt" returns as PyTorch tensors</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>                                                        ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The `max_size` parameter is deprecated and will be removed in v4.26. Please specify in `size['longest_edge'] instead`.</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When processing our single image and annotation, you may see a warning similar to the following:</p>
<blockquote class="blockquote">
<p>The <code>max_size</code> parameter is deprecated and will be removed in v4.26. Please specify in <code>size['longest_edge'] instead</code>.</p>
</blockquote>
<p>If you are not using the <code>max_size</code> parameter and are using a version of <code>transformers</code> &gt; 4.26, you can ignore this or disable it (as shown below).</p>
</div>
</div>
<div id="cell-113" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Disable warnings about `max_size` parameter being deprecated</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, message<span class="op">=</span><span class="st">"The `max_size` parameter is deprecated*"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Excellent!</p>
<p>It looks like the <code>preprocess</code> method worked on our single sample.</p>
<p>Letâ€™s inspect the <code>keys()</code> method of our <code>random_sample_preprocessed</code>.</p>
<div id="cell-115" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the keys of our preprocessed example</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>random_sample_preprocessed.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>dict_keys(['pixel_values', 'pixel_mask', 'labels'])</code></pre>
</div>
</div>
<p>Wonderful, we get a preprocessed image and labels:</p>
<ul>
<li><code>pixel_values</code> = preprocessed pixels (the preprocessed image).</li>
<li><code>pixel_mask</code> = whether or not to mask the pixels (e.g.&nbsp;0 = mask, 1 = no mask, in our case, all values will be <code>1</code> since we want the model to see all pixels).</li>
<li><code>labels</code> = preprocessed labels (the preprocessed annotations).</li>
</ul>
<div id="cell-117" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect preprocessed image shape</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Preprocessed image shape: </span><span class="sc">{</span>random_sample_preprocessed[<span class="st">'pixel_values'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [batch_size, colour_channels, height, width]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Preprocessed image shape: torch.Size([1, 3, 640, 480]) -&gt; [batch_size, colour_channels, height, width]</code></pre>
</div>
</div>
<p>Since we only passed a single sample to <code>preprocess</code>, we get back a batch size of 1.</p>
<p>Now how do our labels look?</p>
<div id="cell-119" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the preprocessed labels (our boxes and other metadata)</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>pprint(random_sample_preprocessed[<span class="st">"labels"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'area': tensor([  9830.8350, 125158.5000,  46787.6836]),
  'boxes': tensor([[0.3675, 0.6583, 0.1894, 0.1690],
        [0.4842, 0.4360, 0.7604, 0.5358],
        [0.1916, 0.7997, 0.3832, 0.3974]]),
  'class_labels': tensor([5, 0, 1]),
  'image_id': tensor([558]),
  'iscrowd': tensor([0, 0, 0]),
  'orig_size': tensor([1280,  960]),
  'size': tensor([640, 480])}]</code></pre>
</div>
</div>
<p>Letâ€™s break this down:</p>
<ul>
<li><code>area</code> - An array/tensor of floats containing the area (<code>box_width * box_height</code>) of our boxes.</li>
<li><code>boxes</code> - An array/tensor containing all of the bounding boxes for our image in normalized <code>CXCYWH</code> (<code>(center_x, center_y, width, height)</code>) format.</li>
<li><code>class_labels</code> - An array/tensor of integer labels assosciated with each box (e.g.&nbsp;<code>tensor([5, 1, 0, 0, 4])</code> -&gt; <code>['trash', 'hand', 'bin', 'bin', 'not_trash']</code>).</li>
<li><code>image_id</code> - A unique integer identifier for our target image.</li>
<li><code>is_crowd</code> - An array/tensor of a boolean value (0 or 1) for whether an annotation is a group or not.</li>
<li><code>orig_size</code> - An array/tensor containing the original size in <code>(height, width)</code> format (this is important for drawing conversion factors when using originally sized images).</li>
<li><code>size</code> - An array/tensor with the current size in <code>(height, width)</code> format of the processed image tensor contained within <code>random_sample_preprocessed["pixel_values"]</code>.</li>
</ul>
<p>Woohoo!</p>
<p>Weâ€™ve done it!</p>
<p>Weâ€™ve officially preprocessed a single sample of our own data, both the image and its annotation pair.</p>
<p>Weâ€™ll write some code later on to scale this up to our whole dataset.</p>
<p>For now, letâ€™s see what it looks like postprocessing a single output.</p>
</section>
</section>
<section id="postprocessing-a-single-output" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="postprocessing-a-single-output"><span class="header-section-number">10</span> Postprocessing a single output</h2>
<p>Weâ€™ve got our inputs processed and successfully passed them through our model.</p>
<p>How about we postprocess the outputs of our model?</p>
<p>Doing so will make our modelâ€™s outputs far more usable.</p>
</section>
<section id="going-end-to-end-on-a-single-sample" class="level2 {callout-tip}" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="going-end-to-end-on-a-single-sample"><span class="header-section-number">11</span> Going end-to-end on a single sample</h2>
<p>When working on a new problem or with a custom dataset and an existing model, itâ€™s good practice to go end-to-end on a single sample.</p>
<p>For example, preprocess one of your samples, pass it through the model and then postprocess it (just like weâ€™re in the middle of doing here).</p>
<p>Being able to go end-to-end on a single sample will help you see the overall process and discover any bugs that may hinder you later on.</p>
</section>
<p>To postprocess the outputs of our model we can use the <a href="https://huggingface.co/docs/transformers/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.post_process_object_detection"><code>transformers.ConditionalDetrImageProcessor.post_process_object_detection()</code></a> method.</p>
<p>Letâ€™s frist recompute the modelâ€™s outputs for our preprocessed single sample.</p>
<div id="cell-122" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recompute the random sample outputs with our preprocessed sample</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>random_sample_outputs <span class="op">=</span> model(</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    pixel_values<span class="op">=</span>random_sample_preprocessed[<span class="st">"pixel_values"</span>], <span class="co"># model expects input [batch_size, color_channels, height, width]</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    pixel_mask<span class="op">=</span>random_sample_preprocessed[<span class="st">"pixel_mask"</span>],</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the output type</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(random_sample_outputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>transformers.models.conditional_detr.modeling_conditional_detr.ConditionalDetrObjectDetectionOutput</code></pre>
</div>
</div>
<p>Wonderful!</p>
<p>We get the exact output our <code>post_process_object_detection()</code> method is looking for.</p>
<p>Now we can fill in the following parameters:</p>
<ul>
<li><code>outputs</code> - Raw outputs of the model (for us, this is <code>random_sample_outputs</code>).</li>
<li><code>threshold</code> - A float score value to keep or discard boxes (e.g.&nbsp;<code>threshold=0.3</code> means all boxes under <code>0.3</code> will be discarded). This value can be adjusted as needed. A higher value means only the boxes the model is most confident on will be kept. A lower value means more boxes will be kept, however, these may be over lower quality. Best to be experimented with.</li>
<li><code>target_sizes</code> - Size of target image in <code>(height, width)</code> format for bounding boxes. For example, if our image is 960 pixels wide by 1280 high, we could pass in <code>[1280, 960]</code>. Number of <code>target_sizes</code> must match number of <code>outputs</code>. For example, if pass in 1 set of outputs, only 1 <code>target_sizes</code> is needed. If we pass in a batch of 32 <code>outputs</code>, 32 <code>target_sizes</code> are required, else it will error. If <code>None</code>, postprocessed outputs wonâ€™t be resized (this can be lead to poor looking boxes as the coordinates donâ€™t match your image).</li>
<li><code>top_k</code> - Integer defining the number of boxes youâ€™d like to prepare for postprocessing before thresholding. Defaults to <code>100</code>. For example, <code>top_k=100</code> and <code>threshold=0.3</code> means sample 100 boxes and then of those 100 boxes, only keep those with a score over 0.3.</li>
</ul>
<p>You can see what happens behind the scenes of <code>post_process_object_detection</code> in the <a href="https://github.com/huggingface/transformers/blob/a22a4378d97d06b7a1d9abad6e0086d30fdea199/src/transformers/models/conditional_detr/image_processing_conditional_detr.py#L1574">source code</a>.</p>
<div id="cell-124" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the score threshold for postprocessing</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>THRESHOLD <span class="op">=</span> <span class="fl">0.63</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Post process a single output from our model</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>random_sample_outputs_post_processed <span class="op">=</span> image_processor.post_process_object_detection(</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>random_sample_outputs,</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    threshold<span class="op">=</span>THRESHOLD, <span class="co"># all boxes with scores under this value will be discarded (best to experiment with it)</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    target_sizes<span class="op">=</span>[random_sample_preprocessed[<span class="st">"labels"</span>][<span class="dv">0</span>][<span class="st">"orig_size"</span>]] <span class="co"># original input image size (or whichever target size you'd like), required to be same number of input items in a list</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>random_sample_outputs_post_processed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>[{'scores': tensor([0.6885, 0.6805, 0.6791, 0.6782, 0.6776, 0.6770, 0.6679, 0.6674, 0.6670,
          0.6660, 0.6657, 0.6642, 0.6640, 0.6640, 0.6637, 0.6631, 0.6630, 0.6629,
          0.6624, 0.6622, 0.6622, 0.6620, 0.6606, 0.6602, 0.6591, 0.6589, 0.6573,
          0.6572, 0.6571, 0.6570, 0.6556, 0.6554, 0.6553, 0.6550, 0.6548, 0.6545,
          0.6543, 0.6542, 0.6541, 0.6535, 0.6533, 0.6532, 0.6530, 0.6530, 0.6528,
          0.6527, 0.6527, 0.6524, 0.6524, 0.6523, 0.6520, 0.6519, 0.6517, 0.6515,
          0.6503, 0.6490, 0.6488, 0.6488, 0.6486, 0.6485, 0.6485, 0.6484, 0.6478,
          0.6476, 0.6474, 0.6472, 0.6472, 0.6471, 0.6470, 0.6463, 0.6463, 0.6460,
          0.6457, 0.6456, 0.6456, 0.6455, 0.6455, 0.6452, 0.6451, 0.6451, 0.6448,
          0.6445, 0.6444, 0.6437, 0.6436, 0.6436, 0.6435, 0.6435, 0.6433, 0.6432,
          0.6432, 0.6431, 0.6430, 0.6429, 0.6423, 0.6423, 0.6419, 0.6418, 0.6416,
          0.6414], grad_fn=&lt;IndexBackward0&gt;),
  'labels': tensor([0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
          1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1,
          0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1,
          0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 0, 3,
          1, 1, 3, 1]),
  'boxes': tensor([[ 1.2123e+02,  3.5433e+02,  8.2553e+02,  8.9930e+02],
          [ 9.0145e+01,  2.1167e+02,  9.3758e+02,  9.0924e+02],
          [ 1.7806e+02,  1.2474e+03,  4.4031e+02,  1.2803e+03],
          [-9.0223e+00,  1.2011e+03,  3.0000e+02,  1.2824e+03],
          [ 1.6178e+02,  1.2456e+03,  3.4017e+02,  1.2792e+03],
          [ 1.9601e+02,  3.8210e+02,  9.0176e+02,  8.8410e+02],
          [ 2.4636e+01,  4.5235e+02,  9.6235e+02,  9.4141e+02],
          [ 3.5597e+02,  7.8528e+02,  6.8660e+02,  9.0548e+02],
          [ 3.0127e+02,  7.6123e+02,  4.2038e+02,  8.6240e+02],
          [ 2.3368e+02,  1.2565e+03,  5.9090e+02,  1.2816e+03],
          [ 6.3640e+00,  1.1779e+03,  1.7585e+02,  1.2811e+03],
          [ 7.1338e+02,  8.3587e+02,  7.6293e+02,  8.7276e+02],
          [ 4.7895e+01,  8.7897e+02,  2.9067e+02,  9.7540e+02],
          [ 2.7494e+02,  5.9645e+02,  7.2545e+02,  8.7642e+02],
          [ 7.3872e+02,  4.1121e+02,  8.0068e+02,  4.6706e+02],
          [ 2.0096e+02,  8.0009e+02,  2.9176e+02,  8.8018e+02],
          [ 2.7494e+02,  5.9645e+02,  7.2545e+02,  8.7642e+02],
          [ 1.3735e+01,  9.1022e+02,  2.9293e+02,  1.0740e+03],
          [ 2.8621e+02,  7.0827e+02,  9.3920e+02,  1.2241e+03],
          [-5.1576e-01,  1.1405e+03,  2.2407e+02,  1.2801e+03],
          [ 4.3130e+02,  1.2597e+03,  6.2168e+02,  1.2803e+03],
          [ 6.5522e+02,  5.7333e+02,  7.3998e+02,  6.6246e+02],
          [ 5.9225e+02,  3.8776e+02,  7.2474e+02,  4.4297e+02],
          [ 2.6299e+00,  9.7695e+02,  4.4713e+02,  1.2724e+03],
          [ 7.0814e+02,  8.5948e+02,  7.6244e+02,  8.9554e+02],
          [ 7.2725e+02,  5.2208e+02,  7.7721e+02,  5.7284e+02],
          [-6.6632e-01,  8.6555e+02,  2.7398e+01,  9.1621e+02],
          [ 3.7016e+02,  5.7040e+02,  5.7561e+02,  6.5241e+02],
          [ 3.0009e+02,  5.7616e+02,  3.8840e+02,  6.3507e+02],
          [ 3.7169e+02,  7.5060e+02,  7.4934e+02,  9.0293e+02],
          [ 9.1577e+02,  1.1804e+03,  9.6465e+02,  1.2883e+03],
          [ 3.9819e+02,  4.5123e+02,  6.9701e+02,  5.3574e+02],
          [ 4.0725e+02,  4.9339e+02,  7.5597e+02,  7.3908e+02],
          [ 3.7014e+02,  5.8483e+02,  5.4816e+02,  6.3988e+02],
          [ 2.8679e+02,  5.2711e+02,  3.6690e+02,  5.8425e+02],
          [ 4.4779e+02,  5.6168e+02,  6.2028e+02,  6.2971e+02],
          [ 6.4507e+02,  2.1860e+02,  9.4680e+02,  2.8260e+02],
          [-3.9370e-01,  1.1320e+03,  2.8009e+01,  1.2843e+03],
          [ 8.4393e+01,  3.7440e+02,  8.0348e+02,  8.8292e+02],
          [ 6.6233e+01,  8.6461e+02,  3.1800e+02,  9.8859e+02],
          [ 5.3249e+02,  8.7122e+02,  9.2832e+02,  9.4956e+02],
          [ 3.6446e+02,  2.3490e+02,  4.5898e+02,  2.7860e+02],
          [ 3.4743e+02,  4.4988e+02,  9.4097e+02,  9.1384e+02],
          [ 7.8389e+02,  1.0058e+03,  9.7121e+02,  1.2788e+03],
          [ 5.8749e+02,  1.2549e+03,  9.3796e+02,  1.2811e+03],
          [ 3.9504e+02,  8.5966e+02,  9.5390e+02,  1.2720e+03],
          [ 1.3533e+02,  3.9646e+02,  2.4717e+02,  4.4188e+02],
          [ 1.9504e+02,  2.9783e+02,  5.4496e+02,  4.4237e+02],
          [ 2.7290e+02,  5.2131e+02,  9.3924e+02,  9.2335e+02],
          [ 3.9746e+02,  6.2830e+02,  5.3551e+02,  7.0473e+02],
          [-1.8056e-01,  8.6747e+02,  7.4031e+00,  9.4205e+02],
          [ 1.6929e+02,  4.1140e+02,  2.6023e+02,  4.5203e+02],
          [ 4.0718e+02,  2.5563e+02,  9.6950e+02,  9.0817e+02],
          [ 5.1952e+02,  1.2612e+03,  8.4501e+02,  1.2811e+03],
          [ 3.5041e+01,  7.5374e+02,  4.4130e+02,  9.2604e+02],
          [ 2.0272e+02,  7.4809e+02,  4.4182e+02,  9.1270e+02],
          [ 9.0257e+02,  7.8603e+02,  9.5583e+02,  9.1146e+02],
          [ 1.0376e+02,  1.2447e+03,  9.6211e+02,  1.2829e+03],
          [ 4.4421e+02,  6.3375e+02,  5.4019e+02,  6.9746e+02],
          [ 9.5318e+02,  9.6392e+02,  9.6036e+02,  1.2315e+03],
          [ 9.4437e+02,  7.6368e+02,  9.5974e+02,  8.6280e+02],
          [ 7.6898e+02,  1.2521e+03,  9.5188e+02,  1.2815e+03],
          [ 1.0570e+02,  1.8401e+02,  1.4442e+02,  2.2755e+02],
          [ 4.0679e+02,  8.6530e+02,  6.3646e+02,  9.1152e+02],
          [ 9.2369e+02,  7.3249e+02,  9.6240e+02,  9.2597e+02],
          [ 4.5927e+02,  3.6187e+02,  9.8274e+02,  1.2437e+03],
          [ 2.9423e+02,  4.5842e+02,  8.3598e+02,  8.8238e+02],
          [ 3.0991e+00,  9.5915e+02,  3.2855e+02,  1.2699e+03],
          [ 1.4968e+02,  1.2528e+03,  9.2357e+02,  1.2818e+03],
          [ 2.7290e+02,  5.2131e+02,  9.3924e+02,  9.2335e+02],
          [ 5.1953e+02,  2.3453e+02,  6.6533e+02,  2.8722e+02],
          [ 2.3540e+02,  4.3965e+02,  3.3418e+02,  4.8865e+02],
          [ 1.3900e+02,  4.7284e+02,  7.7919e+02,  8.6403e+02],
          [ 6.5495e+02,  6.1375e+02,  7.1011e+02,  6.7939e+02],
          [ 4.4646e+00,  9.2248e+02,  3.0692e+02,  1.2576e+03],
          [ 2.8322e+02,  7.4716e+02,  9.3993e+02,  9.3833e+02],
          [ 1.5355e+02,  2.2595e+02,  9.7318e+02,  9.1923e+02],
          [ 3.5153e+02,  5.9145e+02,  9.5706e+02,  9.3315e+02],
          [ 9.3631e+02,  5.5085e+02,  9.6135e+02,  6.4936e+02],
          [ 9.4331e+02,  8.6794e+02,  9.6124e+02,  9.4417e+02],
          [ 1.4235e+02,  4.0410e+02,  7.9358e+02,  7.9189e+02],
          [ 9.1172e+02,  1.0090e+03,  9.6355e+02,  1.2581e+03],
          [ 2.9423e+02,  4.5842e+02,  8.3598e+02,  8.8238e+02],
          [ 6.1276e+02,  5.8869e+02,  6.9500e+02,  6.7819e+02],
          [ 2.7491e+02,  5.2836e+02,  7.4790e+02,  8.4349e+02],
          [ 7.4487e+02,  8.6033e+02,  8.1685e+02,  9.0291e+02],
          [ 7.2192e+01,  7.0326e+02,  9.6203e+02,  1.0553e+03],
          [ 2.5401e+02,  5.3171e+02,  7.4973e+02,  8.8372e+02],
          [ 3.6065e+02,  2.2885e+02,  4.6806e+02,  3.2740e+02],
          [ 4.5502e+02,  2.5827e+02,  7.9227e+02,  4.2188e+02],
          [ 4.5927e+02,  3.6187e+02,  9.8274e+02,  1.2437e+03],
          [ 4.4148e+02,  5.5655e+02,  7.1180e+02,  7.3738e+02],
          [ 1.0376e+02,  1.2447e+03,  9.6211e+02,  1.2829e+03],
          [ 3.9097e+02,  8.3127e+02,  9.1433e+02,  9.3486e+02],
          [ 3.9833e+02,  3.2578e+02,  8.5323e+02,  8.9026e+02],
          [ 2.7491e+02,  5.2836e+02,  7.4790e+02,  8.4349e+02],
          [ 9.3911e+02,  7.8165e+02,  9.6162e+02,  9.3691e+02],
          [ 4.9251e+02,  4.1722e+02,  5.9723e+02,  6.7205e+02],
          [ 1.4968e+02,  1.2528e+03,  9.2357e+02,  1.2818e+03],
          [ 2.4444e+02,  7.6424e+02,  4.3126e+02,  8.9915e+02]],
         grad_fn=&lt;IndexBackward0&gt;)}]</code></pre>
</div>
</div>
<p>Perfect!</p>
<p>This looks like something we can use.</p>
<p>Letâ€™s break down each of the keys in <code>random_sample_outputs_post_processed</code>.</p>
<p>We get three equal length tensors:</p>
<ul>
<li><code>scores</code> - The prediction probabilities for each box, higher means the model is more confident in this prediction (though it doesnâ€™t mean the prediction is correct). Notice how all the values in this tensor are over our <code>threshold</code> value. This value is acquired by applying <a href="https://pytorch.org/docs/main/generated/torch.sigmoid.html"><code>torch.sigmoid()</code></a> to the models raw output logits.</li>
<li><code>labels</code> - The predicted classification label values for each box. These will be random as our model hasnâ€™t been trained for our dataset. We can turn these into class names by mapping them to the <code>id2label</code> dictionary.</li>
<li><code>boxes</code> - The predicted bounding boxes whose scores are above the <code>threshold</code> parameter. These are normalized and in the format <code>XYXY</code> or <code>(x_top_left, y_top_left, x_bottom_right, y_bottom_right)</code>.</li>
</ul>
<section id="reproducing-our-postprocessed-box-scores-by-hand" class="level3" data-number="11.1">
<h3 data-number="11.1" class="anchored" data-anchor-id="reproducing-our-postprocessed-box-scores-by-hand"><span class="header-section-number">11.1</span> Reproducing our postprocessed box scores by hand</h3>
<p>When a raw prediction output from our model goes through the <code>post_process_object_detection</code> method, a few steps happen.</p>
<p>One of them is that the raw logits from our model get converted into prediction probabilities.</p>
<p>This happens by:</p>
<ol type="1">
<li>Applying the <a href="https://pytorch.org/docs/main/generated/torch.sigmoid.html"><code>torch.sigmoid()</code></a> function to the logits to turn them into prediction probabilities.</li>
<li>Finding the max value for each prediction using <a href="https://pytorch.org/docs/main/generated/torch.max.html"><code>torch.max()</code></a> (e.g.&nbsp;the class index with the highest prediction probability).</li>
<li>Removing the predictions with prediction probabilities which are not above the <code>threshold</code>.</li>
<li>Sorting the top 100 (<code>post_process_object_detection</code> returns the top 100 values by default) predictions in descending order using <a href="https://pytorch.org/docs/main/generated/torch.topk.html"><code>torch.topk()</code></a> followed by <a href="https://pytorch.org/docs/stable/generated/torch.sort.html"><code>torch.sort()</code></a> (so the predictions with the highest prediction probability come first).</li>
</ol>
<p><code>torch.max()</code> and <code>torch.sort()</code> will return both raw tensor values and the indicies of where they occur in a tuple <code>(values, indicies)</code>.</p>
<p>These index values are the predicted label ID.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When a prediction probability is assigned to a prediction, it usually falls between 0 and 1.</p>
<p>With 1 being the highest possible score.</p>
<p>The value with the highest prediction probability is the value the model is predicting to the be the <em>most likely</em> value.</p>
<p>However, just because a prediction has being assigned a high prediction probability does not mean it is correct.</p>
<p>A high prediction probability is essentially the model saying, â€œbased on the training data I have and the patterns Iâ€™ve learned, this is the <em>most likely</em> outcomeâ€.</p>
<p>A workflow using prediction probabilities could be to automatically send samples with low prediction probabilities for manual review.</p>
<p>For now, our model will likely assign close to random prediction probabilities as it has not been trained on our data.</p>
</div>
</div>
<p>To see this happen, letâ€™s reproduce the <code>"scores"</code> key in <code>random_sample_outputs_post_processed</code> by hand.</p>
<div id="cell-127" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the output scores from our post processed single output</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>output_scores <span class="op">=</span> random_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"scores"</span>]</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(output_scores), output_scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>(100,
 tensor([0.6885, 0.6805, 0.6791, 0.6782, 0.6776, 0.6770, 0.6679, 0.6674, 0.6670,
         0.6660, 0.6657, 0.6642, 0.6640, 0.6640, 0.6637, 0.6631, 0.6630, 0.6629,
         0.6624, 0.6622, 0.6622, 0.6620, 0.6606, 0.6602, 0.6591, 0.6589, 0.6573,
         0.6572, 0.6571, 0.6570, 0.6556, 0.6554, 0.6553, 0.6550, 0.6548, 0.6545,
         0.6543, 0.6542, 0.6541, 0.6535, 0.6533, 0.6532, 0.6530, 0.6530, 0.6528,
         0.6527, 0.6527, 0.6524, 0.6524, 0.6523, 0.6520, 0.6519, 0.6517, 0.6515,
         0.6503, 0.6490, 0.6488, 0.6488, 0.6486, 0.6485, 0.6485, 0.6484, 0.6478,
         0.6476, 0.6474, 0.6472, 0.6472, 0.6471, 0.6470, 0.6463, 0.6463, 0.6460,
         0.6457, 0.6456, 0.6456, 0.6455, 0.6455, 0.6452, 0.6451, 0.6451, 0.6448,
         0.6445, 0.6444, 0.6437, 0.6436, 0.6436, 0.6435, 0.6435, 0.6433, 0.6432,
         0.6432, 0.6431, 0.6430, 0.6429, 0.6423, 0.6423, 0.6419, 0.6418, 0.6416,
         0.6414], grad_fn=&lt;IndexBackward0&gt;))</code></pre>
</div>
</div>
<p>And we can reproduce these scores by following the steps outlined above.</p>
<div id="cell-129" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># UPTOHERE: </span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix this so it works for various samples by editing out the scores under a certain threshold... </span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Perform sigmoid on the logits to get predictions probabilities and take the max value for each prediction</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>output_scores_manual <span class="op">=</span> random_sample_outputs.logits.sigmoid()</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output scores shape: </span><span class="sc">{</span>output_scores_manual<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] First scores:</span><span class="ch">\n</span><span class="sc">{</span>output_scores_manual[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">.</span>detach()<span class="sc">.</span>cpu()<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get the max value of each prediction and the index of the max value</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>output_scores_manual_max, output_scores_manual_max_indices <span class="op">=</span> output_scores_manual.<span class="bu">max</span>(dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Max scores shape: </span><span class="sc">{</span>output_scores_manual_max<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] First max score:</span><span class="ch">\n</span><span class="sc">{</span>output_scores_manual_max[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">.</span>detach()<span class="sc">.</span>cpu()<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Get the top 100 scores (this the default setting in post_process_object_detection)</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>output_scores_manual_top_100, output_scores_manual_top_100_indices <span class="op">=</span> torch.topk(<span class="bu">input</span><span class="op">=</span>output_scores_manual_max,</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>                                                                                k<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>                                                                                dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Top 100 scores shape: </span><span class="sc">{</span>output_scores_manual_top_100<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] First top 100 score:</span><span class="ch">\n</span><span class="sc">{</span>output_scores_manual_top_100[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Find the values above the threshold and create a mask</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>output_scores_manual_mask <span class="op">=</span> output_scores_manual_top_100 <span class="op">&gt;</span> THRESHOLD</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Filter the top 100 scores which are above the threshold and sort them in descending order and get the indices</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>output_scores_manual_filtered, output_scores_manual_filtered_indices <span class="op">=</span> torch.sort(<span class="bu">input</span><span class="op">=</span>output_scores_manual_top_100[output_scores_manual_mask], </span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>                                                                                  descending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Filtered scores shape: </span><span class="sc">{</span>output_scores_manual_filtered<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] First filtered score:</span><span class="ch">\n</span><span class="sc">{</span>output_scores_manual_filtered[<span class="dv">0</span>]<span class="sc">.</span>detach()<span class="sc">.</span>cpu()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output scores shape: torch.Size([1, 300, 7])
[INFO] First scores:
tensor([0.6472, 0.6432, 0.4187, 0.5424, 0.5525, 0.4859, 0.4146])

[INFO] Max scores shape: torch.Size([1, 300])
[INFO] First max score:
0.6472

[INFO] Top 100 scores shape: torch.Size([1, 100])
[INFO] First top 100 score:
0.6885

[INFO] Filtered scores shape: torch.Size([100])
[INFO] First filtered score:
0.6885</code></pre>
</div>
</div>
<p>Now weâ€™ve got our own <code>output_scores_manual_filtered</code>, how about we compare it to <code>output_scores</code>?</p>
<p>We can see if theyâ€™re close to each other with <a href="https://pytorch.org/docs/stable/generated/torch.isclose.html"><code>torch.isclose()</code></a>.</p>
<div id="cell-131" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the original output scores to our own manual version</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>torch.isclose(<span class="bu">input</span><span class="op">=</span>output_scores, other<span class="op">=</span>output_scores_manual_top_100, atol<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>tensor([[True, True, True, True, True, True, True, True, True, True, True, True,
         True, True, True, True, True, True, True, True, True, True, True, True,
         True, True, True, True, True, True, True, True, True, True, True, True,
         True, True, True, True, True, True, True, True, True, True, True, True,
         True, True, True, True, True, True, True, True, True, True, True, True,
         True, True, True, True, True, True, True, True, True, True, True, True,
         True, True, True, True, True, True, True, True, True, True, True, True,
         True, True, True, True, True, True, True, True, True, True, True, True,
         True, True, True, True]])</code></pre>
</div>
</div>
<div id="cell-132" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>output_scores_manual_top_100.shape, output_scores.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>(torch.Size([1, 100]), torch.Size([100]))</code></pre>
</div>
</div>
<p>Nice!</p>
<p>We managed to reproduce our postprocessed output scores values by hand.</p>
<p>How about the labels?</p>
</section>
<section id="reproducing-our-postprocessed-box-labels-by-hand" class="level3" data-number="11.2">
<h3 data-number="11.2" class="anchored" data-anchor-id="reproducing-our-postprocessed-box-labels-by-hand"><span class="header-section-number">11.2</span> Reproducing our postprocessed box labels by hand</h3>
<p>Weâ€™ve reproduce our postprocessed model prediction scores by hand.</p>
<p>Now letâ€™s do the same with the labels.</p>
<p>First, weâ€™ll get the output labels from our postprocessed object.</p>
<div id="cell-135" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the model's predicted labels</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>output_labels <span class="op">=</span> random_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"labels"</span>]</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output labels shape: </span><span class="sc">{</span><span class="bu">len</span>(output_labels)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output labels:</span><span class="ch">\n</span><span class="sc">{</span>output_labels<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output labels shape: 100
[INFO] Output labels:
tensor([0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1,
        0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1,
        0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 0, 3,
        1, 1, 3, 1])</code></pre>
</div>
</div>
<p>Wonderful!</p>
<p>Now to reproduce these values, we can:</p>
<ol type="1">
<li>Filter the <code>output_scores_manual_max_indices</code> for the top 100 indices which made it past the <code>threshold</code> using <code>output_scores_manual_mask</code>.</li>
<li>Order the remaining label values from 1 in descending order according to <code>output_scores_manual_filtered_indices</code>.</li>
</ol>
<div id="cell-137" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Filter the labels for those which above the threshold</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>output_labels_manual_over_threshold <span class="op">=</span> output_scores_manual_max_indices[:, output_scores_manual_top_100_indices[<span class="dv">0</span>]][output_scores_manual_mask]</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Sort the labels to be in the same order as the scores</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>output_labels_manual <span class="op">=</span> output_labels_manual_over_threshold[output_scores_manual_filtered_indices]</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output labels manual: </span><span class="sc">{</span>output_labels_manual<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output labels manual: tensor([0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0,
        1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1,
        1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0,
        1, 1, 1, 1])</code></pre>
</div>
</div>
<div id="cell-138" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>output_labels.shape, output_labels_manual.shape, output_scores_manual_filtered_indices.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(torch.Size([100]), torch.Size([100]), torch.Size([100]))</code></pre>
</div>
</div>
<p>Excellent, now letâ€™s make sure these labels are equivalent to the postprocessed labels.</p>
<div id="cell-140" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check our manually obtained labels match the model's postprocessed predictions</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>output_labels <span class="op">==</span> output_labels_manual</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>tensor([ True,  True,  True,  True,  True,  True,  True,  True,  True,  True,
         True,  True,  True,  True,  True,  True,  True,  True,  True,  True,
         True,  True,  True,  True,  True,  True,  True,  True,  True,  True,
         True,  True,  True,  True,  True,  True,  True, False, False,  True,
         True, False, False,  True,  True,  True,  True, False, False,  True,
         True, False, False,  True,  True,  True,  True,  True,  True,  True,
         True,  True,  True,  True, False,  True, False,  True,  True,  True,
        False,  True, False,  True, False,  True, False,  True,  True,  True,
         True,  True,  True,  True,  True,  True,  True,  True,  True, False,
         True,  True, False,  True, False, False,  True,  True, False,  True])</code></pre>
</div>
</div>
<p>Perfect!</p>
<p>How about we repeat the same for our modelâ€™s postprocessed predicted boxes?</p>
</section>
<section id="reproducing-our-postprocessed-box-coordinates-by-hand" class="level3" data-number="11.3">
<h3 data-number="11.3" class="anchored" data-anchor-id="reproducing-our-postprocessed-box-coordinates-by-hand"><span class="header-section-number">11.3</span> Reproducing our postprocessed box coordinates by hand</h3>
<p>Our postprocessed boxes are in absolute <code>XYXY</code> format.</p>
<p>And the raw boxes out of the model are in normalized <code>CXCYWH</code> format.</p>
<p>If we want to go from raw boxes out of the model to the same format as our postprocessed boxes or from normalized <code>CXCYWH</code> to absolute <code>XYXY</code>, weâ€™ll have to:</p>
<ol type="1">
<li>Filter for the top 100 scoring boxes coordinates which make it over the <code>threshold</code> using the <code>output_scores_manual_mask</code>.</li>
<li>Convert the filtered box coordinates from normalized <code>CXCYWH</code> to normalized <code>XYXY</code> using <a href="https://pytorch.org/vision/main/generated/torchvision.ops.box_convert.html"><code>torchvision.ops.box_convert</code></a>.</li>
<li>Convert the normalized <code>XYXY</code> coordinates to absolute <code>XYXY</code> coordinates by multiplying the <code>x</code> coordinates by the desired width and the <code>y</code> coordinates by the desired height. For example, if we want to plot our boxes on the original image, weâ€™d use the original image dimensions of <code>(1280, 960)</code> (height, width).</li>
<li>Sort the bounding box coordinates in the same order as the scores (descending).</li>
</ol>
<p>First, letâ€™s get the postprocessed predicted boxes weâ€™re trying to reproduce.</p>
<div id="cell-143" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These are in absolute XYXY (x_top_left, y_top_left, x_bottom_right, y_bottom_right) format</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>output_boxes <span class="op">=</span> random_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"boxes"</span>]</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output boxes shape: </span><span class="sc">{</span>output_boxes<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output boxes (absolute XYXY format):</span><span class="ch">\n</span><span class="sc">{</span>output_boxes<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output boxes shape: torch.Size([100, 4])
[INFO] Output boxes (absolute XYXY format):
tensor([[ 1.2123e+02,  3.5433e+02,  8.2553e+02,  8.9930e+02],
        [ 9.0145e+01,  2.1167e+02,  9.3758e+02,  9.0924e+02],
        [ 1.7806e+02,  1.2474e+03,  4.4031e+02,  1.2803e+03],
        [-9.0223e+00,  1.2011e+03,  3.0000e+02,  1.2824e+03],
        [ 1.6178e+02,  1.2456e+03,  3.4017e+02,  1.2792e+03],
        [ 1.9601e+02,  3.8210e+02,  9.0176e+02,  8.8410e+02],
        [ 2.4636e+01,  4.5235e+02,  9.6235e+02,  9.4141e+02],
        [ 3.5597e+02,  7.8528e+02,  6.8660e+02,  9.0548e+02],
        [ 3.0127e+02,  7.6123e+02,  4.2038e+02,  8.6240e+02],
        [ 2.3368e+02,  1.2565e+03,  5.9090e+02,  1.2816e+03],
        [ 6.3640e+00,  1.1779e+03,  1.7585e+02,  1.2811e+03],
        [ 7.1338e+02,  8.3587e+02,  7.6293e+02,  8.7276e+02],
        [ 4.7895e+01,  8.7897e+02,  2.9067e+02,  9.7540e+02],
        [ 2.7494e+02,  5.9645e+02,  7.2545e+02,  8.7642e+02],
        [ 7.3872e+02,  4.1121e+02,  8.0068e+02,  4.6706e+02],
        [ 2.0096e+02,  8.0009e+02,  2.9176e+02,  8.8018e+02],
        [ 2.7494e+02,  5.9645e+02,  7.2545e+02,  8.7642e+02],
        [ 1.3735e+01,  9.1022e+02,  2.9293e+02,  1.0740e+03],
        [ 2.8621e+02,  7.0827e+02,  9.3920e+02,  1.2241e+03],
        [-5.1576e-01,  1.1405e+03,  2.2407e+02,  1.2801e+03],
        [ 4.3130e+02,  1.2597e+03,  6.2168e+02,  1.2803e+03],
        [ 6.5522e+02,  5.7333e+02,  7.3998e+02,  6.6246e+02],
        [ 5.9225e+02,  3.8776e+02,  7.2474e+02,  4.4297e+02],
        [ 2.6299e+00,  9.7695e+02,  4.4713e+02,  1.2724e+03],
        [ 7.0814e+02,  8.5948e+02,  7.6244e+02,  8.9554e+02],
        [ 7.2725e+02,  5.2208e+02,  7.7721e+02,  5.7284e+02],
        [-6.6632e-01,  8.6555e+02,  2.7398e+01,  9.1621e+02],
        [ 3.7016e+02,  5.7040e+02,  5.7561e+02,  6.5241e+02],
        [ 3.0009e+02,  5.7616e+02,  3.8840e+02,  6.3507e+02],
        [ 3.7169e+02,  7.5060e+02,  7.4934e+02,  9.0293e+02],
        [ 9.1577e+02,  1.1804e+03,  9.6465e+02,  1.2883e+03],
        [ 3.9819e+02,  4.5123e+02,  6.9701e+02,  5.3574e+02],
        [ 4.0725e+02,  4.9339e+02,  7.5597e+02,  7.3908e+02],
        [ 3.7014e+02,  5.8483e+02,  5.4816e+02,  6.3988e+02],
        [ 2.8679e+02,  5.2711e+02,  3.6690e+02,  5.8425e+02],
        [ 4.4779e+02,  5.6168e+02,  6.2028e+02,  6.2971e+02],
        [ 6.4507e+02,  2.1860e+02,  9.4680e+02,  2.8260e+02],
        [-3.9370e-01,  1.1320e+03,  2.8009e+01,  1.2843e+03],
        [ 8.4393e+01,  3.7440e+02,  8.0348e+02,  8.8292e+02],
        [ 6.6233e+01,  8.6461e+02,  3.1800e+02,  9.8859e+02],
        [ 5.3249e+02,  8.7122e+02,  9.2832e+02,  9.4956e+02],
        [ 3.6446e+02,  2.3490e+02,  4.5898e+02,  2.7860e+02],
        [ 3.4743e+02,  4.4988e+02,  9.4097e+02,  9.1384e+02],
        [ 7.8389e+02,  1.0058e+03,  9.7121e+02,  1.2788e+03],
        [ 5.8749e+02,  1.2549e+03,  9.3796e+02,  1.2811e+03],
        [ 3.9504e+02,  8.5966e+02,  9.5390e+02,  1.2720e+03],
        [ 1.3533e+02,  3.9646e+02,  2.4717e+02,  4.4188e+02],
        [ 1.9504e+02,  2.9783e+02,  5.4496e+02,  4.4237e+02],
        [ 2.7290e+02,  5.2131e+02,  9.3924e+02,  9.2335e+02],
        [ 3.9746e+02,  6.2830e+02,  5.3551e+02,  7.0473e+02],
        [-1.8056e-01,  8.6747e+02,  7.4031e+00,  9.4205e+02],
        [ 1.6929e+02,  4.1140e+02,  2.6023e+02,  4.5203e+02],
        [ 4.0718e+02,  2.5563e+02,  9.6950e+02,  9.0817e+02],
        [ 5.1952e+02,  1.2612e+03,  8.4501e+02,  1.2811e+03],
        [ 3.5041e+01,  7.5374e+02,  4.4130e+02,  9.2604e+02],
        [ 2.0272e+02,  7.4809e+02,  4.4182e+02,  9.1270e+02],
        [ 9.0257e+02,  7.8603e+02,  9.5583e+02,  9.1146e+02],
        [ 1.0376e+02,  1.2447e+03,  9.6211e+02,  1.2829e+03],
        [ 4.4421e+02,  6.3375e+02,  5.4019e+02,  6.9746e+02],
        [ 9.5318e+02,  9.6392e+02,  9.6036e+02,  1.2315e+03],
        [ 9.4437e+02,  7.6368e+02,  9.5974e+02,  8.6280e+02],
        [ 7.6898e+02,  1.2521e+03,  9.5188e+02,  1.2815e+03],
        [ 1.0570e+02,  1.8401e+02,  1.4442e+02,  2.2755e+02],
        [ 4.0679e+02,  8.6530e+02,  6.3646e+02,  9.1152e+02],
        [ 9.2369e+02,  7.3249e+02,  9.6240e+02,  9.2597e+02],
        [ 4.5927e+02,  3.6187e+02,  9.8274e+02,  1.2437e+03],
        [ 2.9423e+02,  4.5842e+02,  8.3598e+02,  8.8238e+02],
        [ 3.0991e+00,  9.5915e+02,  3.2855e+02,  1.2699e+03],
        [ 1.4968e+02,  1.2528e+03,  9.2357e+02,  1.2818e+03],
        [ 2.7290e+02,  5.2131e+02,  9.3924e+02,  9.2335e+02],
        [ 5.1953e+02,  2.3453e+02,  6.6533e+02,  2.8722e+02],
        [ 2.3540e+02,  4.3965e+02,  3.3418e+02,  4.8865e+02],
        [ 1.3900e+02,  4.7284e+02,  7.7919e+02,  8.6403e+02],
        [ 6.5495e+02,  6.1375e+02,  7.1011e+02,  6.7939e+02],
        [ 4.4646e+00,  9.2248e+02,  3.0692e+02,  1.2576e+03],
        [ 2.8322e+02,  7.4716e+02,  9.3993e+02,  9.3833e+02],
        [ 1.5355e+02,  2.2595e+02,  9.7318e+02,  9.1923e+02],
        [ 3.5153e+02,  5.9145e+02,  9.5706e+02,  9.3315e+02],
        [ 9.3631e+02,  5.5085e+02,  9.6135e+02,  6.4936e+02],
        [ 9.4331e+02,  8.6794e+02,  9.6124e+02,  9.4417e+02],
        [ 1.4235e+02,  4.0410e+02,  7.9358e+02,  7.9189e+02],
        [ 9.1172e+02,  1.0090e+03,  9.6355e+02,  1.2581e+03],
        [ 2.9423e+02,  4.5842e+02,  8.3598e+02,  8.8238e+02],
        [ 6.1276e+02,  5.8869e+02,  6.9500e+02,  6.7819e+02],
        [ 2.7491e+02,  5.2836e+02,  7.4790e+02,  8.4349e+02],
        [ 7.4487e+02,  8.6033e+02,  8.1685e+02,  9.0291e+02],
        [ 7.2192e+01,  7.0326e+02,  9.6203e+02,  1.0553e+03],
        [ 2.5401e+02,  5.3171e+02,  7.4973e+02,  8.8372e+02],
        [ 3.6065e+02,  2.2885e+02,  4.6806e+02,  3.2740e+02],
        [ 4.5502e+02,  2.5827e+02,  7.9227e+02,  4.2188e+02],
        [ 4.5927e+02,  3.6187e+02,  9.8274e+02,  1.2437e+03],
        [ 4.4148e+02,  5.5655e+02,  7.1180e+02,  7.3738e+02],
        [ 1.0376e+02,  1.2447e+03,  9.6211e+02,  1.2829e+03],
        [ 3.9097e+02,  8.3127e+02,  9.1433e+02,  9.3486e+02],
        [ 3.9833e+02,  3.2578e+02,  8.5323e+02,  8.9026e+02],
        [ 2.7491e+02,  5.2836e+02,  7.4790e+02,  8.4349e+02],
        [ 9.3911e+02,  7.8165e+02,  9.6162e+02,  9.3691e+02],
        [ 4.9251e+02,  4.1722e+02,  5.9723e+02,  6.7205e+02],
        [ 1.4968e+02,  1.2528e+03,  9.2357e+02,  1.2818e+03],
        [ 2.4444e+02,  7.6424e+02,  4.3126e+02,  8.9915e+02]],
       grad_fn=&lt;IndexBackward0&gt;)</code></pre>
</div>
</div>
<p>Beautiful!</p>
<p>These are the boxes weâ€™d like to reproduce.</p>
<p>Letâ€™s now get the raw predicted box coordinates from our model.</p>
<div id="cell-145" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get model output raw boxes</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="co"># These are in format: normalized CXCYWH (center_x, center_y, width, height) format</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>output_boxes_manual_cxcywh <span class="op">=</span> random_sample_outputs.pred_boxes[<span class="dv">0</span>]</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output boxes manual shape: </span><span class="sc">{</span>output_boxes_manual_cxcywh<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output boxes manual (normalized CXCYWH format):</span><span class="ch">\n</span><span class="sc">{</span>output_boxes_manual_cxcywh<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output boxes manual shape: torch.Size([300, 4])
[INFO] Output boxes manual (normalized CXCYWH format):
tensor([[0.7510, 0.6272, 0.5453, 0.6889],
        [0.6387, 0.0282, 0.2119, 0.0660],
        [0.9950, 0.4598, 0.0118, 0.3402],
        ...,
        [0.4391, 0.4068, 0.3671, 0.1045],
        [0.9922, 0.4313, 0.0171, 0.5450],
        [0.0147, 0.2964, 0.0287, 0.1153]], grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<p>Ok, so weâ€™ve got 300 boxes here, letâ€™s filter these down to only the boxes which have a score above the target <code>threshold</code> using our <code>output_scores_manual_mask</code> tensor.</p>
<div id="cell-147" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Filter boxes for top 100 above the target threshold</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>output_boxes_manual_above_threshold_cxcywh <span class="op">=</span> output_boxes_manual_cxcywh[output_scores_manual_top_100_indices[<span class="dv">0</span>]][output_scores_manual_mask[<span class="dv">0</span>], :]</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output boxes manual above threshold shape: </span><span class="sc">{</span>output_boxes_manual_above_threshold_cxcywh<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output boxes manual above threshold (normalized CXCYWH format):</span><span class="ch">\n</span><span class="sc">{</span>output_boxes_manual_above_threshold_cxcywh<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output boxes manual above threshold shape: torch.Size([100, 4])
[INFO] Output boxes manual above threshold (normalized CXCYWH format):
tensor([[0.4931, 0.4897, 0.7336, 0.4258],
        [0.5353, 0.4379, 0.8827, 0.5450],
        [0.3221, 0.9874, 0.2732, 0.0257],
        [0.1516, 0.9701, 0.3219, 0.0635],
        [0.2614, 0.9862, 0.1858, 0.0263],
        [0.5718, 0.4946, 0.7352, 0.3922],
        [0.5141, 0.5444, 0.9768, 0.3821],
        [0.5430, 0.6605, 0.3444, 0.0939],
        [0.3759, 0.6342, 0.1241, 0.0790],
        [0.4295, 0.9914, 0.3721, 0.0196],
        [0.0949, 0.9606, 0.1765, 0.0807],
        [0.7689, 0.6674, 0.0516, 0.0288],
        [0.1763, 0.7244, 0.2529, 0.0753],
        [0.5210, 0.5753, 0.4693, 0.2187],
        [0.8018, 0.3431, 0.0645, 0.0436],
        [0.2566, 0.6564, 0.0946, 0.0626],
        [0.1597, 0.7751, 0.2908, 0.1279],
        [0.6382, 0.7548, 0.6802, 0.4030],
        [0.1164, 0.9455, 0.2339, 0.1090],
        [0.5484, 0.9922, 0.1983, 0.0161],
        [0.7267, 0.4827, 0.0883, 0.0696],
        [0.6859, 0.3245, 0.1380, 0.0431],
        [0.2343, 0.8786, 0.4630, 0.2308],
        [0.7659, 0.6856, 0.0566, 0.0282],
        [0.7836, 0.4277, 0.0520, 0.0397],
        [0.0139, 0.6960, 0.0292, 0.0396],
        [0.4926, 0.4777, 0.2140, 0.0641],
        [0.3586, 0.4731, 0.0920, 0.0460],
        [0.5839, 0.6459, 0.3934, 0.1190],
        [0.9794, 0.9643, 0.0509, 0.0843],
        [0.5704, 0.3855, 0.3113, 0.0660],
        [0.6058, 0.4814, 0.3633, 0.1919],
        [0.4783, 0.4784, 0.1854, 0.0430],
        [0.3405, 0.4341, 0.0834, 0.0446],
        [0.5563, 0.4654, 0.1797, 0.0532],
        [0.8291, 0.1958, 0.3143, 0.0500],
        [0.0144, 0.9439, 0.0296, 0.1190],
        [0.4624, 0.4911, 0.7490, 0.3973],
        [0.2001, 0.7239, 0.2623, 0.0969],
        [0.7608, 0.7112, 0.4123, 0.0612],
        [0.4289, 0.2006, 0.0985, 0.0341],
        [0.6710, 0.5327, 0.6183, 0.3625],
        [0.9141, 0.8924, 0.1951, 0.2133],
        [0.7945, 0.9907, 0.3651, 0.0205],
        [0.7026, 0.8327, 0.5821, 0.3222],
        [0.1992, 0.3275, 0.1165, 0.0355],
        [0.3854, 0.2891, 0.3645, 0.1129],
        [0.6313, 0.5643, 0.6941, 0.3141],
        [0.4859, 0.5207, 0.1438, 0.0597],
        [0.0038, 0.7068, 0.0079, 0.0583],
        [0.2237, 0.3373, 0.0947, 0.0317],
        [0.7170, 0.4546, 0.5857, 0.5098],
        [0.7107, 0.9931, 0.3390, 0.0155],
        [0.2481, 0.6562, 0.4232, 0.1346],
        [0.3357, 0.6487, 0.2491, 0.1286],
        [0.9679, 0.6631, 0.0555, 0.0980],
        [0.5551, 0.9873, 0.8941, 0.0298],
        [0.5127, 0.5200, 0.1000, 0.0498],
        [0.9966, 0.8576, 0.0075, 0.2091],
        [0.9917, 0.6353, 0.0160, 0.0774],
        [0.8963, 0.9897, 0.1905, 0.0229],
        [0.1303, 0.1608, 0.0403, 0.0340],
        [0.5434, 0.6941, 0.2392, 0.0361],
        [0.9823, 0.6478, 0.0403, 0.1512],
        [0.7510, 0.6272, 0.5453, 0.6889],
        [0.5887, 0.5237, 0.5643, 0.3312],
        [0.1727, 0.8707, 0.3390, 0.2428],
        [0.5590, 0.9901, 0.8061, 0.0227],
        [0.6171, 0.2038, 0.1519, 0.0412],
        [0.2967, 0.3626, 0.1029, 0.0383],
        [0.4782, 0.5222, 0.6669, 0.3056],
        [0.7110, 0.5051, 0.0575, 0.0513],
        [0.1622, 0.8516, 0.3151, 0.2618],
        [0.6371, 0.6584, 0.6841, 0.1494],
        [0.5868, 0.4473, 0.8538, 0.5416],
        [0.6816, 0.5955, 0.6308, 0.2669],
        [0.9884, 0.4688, 0.0261, 0.0770],
        [0.9920, 0.7079, 0.0187, 0.0596],
        [0.4875, 0.4672, 0.6784, 0.3030],
        [0.9767, 0.8856, 0.0540, 0.1946],
        [0.6811, 0.4949, 0.0857, 0.0699],
        [0.5327, 0.5359, 0.4927, 0.2462],
        [0.8134, 0.6888, 0.0750, 0.0333],
        [0.5387, 0.6870, 0.9269, 0.2751],
        [0.5228, 0.5529, 0.5164, 0.2750],
        [0.4316, 0.2173, 0.1119, 0.0770],
        [0.6496, 0.2657, 0.3513, 0.1278],
        [0.6007, 0.5054, 0.2816, 0.1413],
        [0.6798, 0.6899, 0.5452, 0.0809],
        [0.6519, 0.4750, 0.4739, 0.4410],
        [0.9900, 0.6713, 0.0234, 0.1213],
        [0.5676, 0.4255, 0.1091, 0.1991],
        [0.3519, 0.6498, 0.1946, 0.1054],
        [0.6129, 0.1538, 0.0848, 0.0442],
        [0.6589, 0.1994, 0.0929, 0.0354],
        [0.2490, 0.1875, 0.4721, 0.3679],
        [0.5410, 0.5375, 0.5085, 0.2666],
        [0.2179, 0.6857, 0.1432, 0.0861],
        [0.6630, 0.5086, 0.1217, 0.0868],
        [0.4513, 0.9920, 0.9950, 0.0183]], grad_fn=&lt;IndexBackward0&gt;)</code></pre>
</div>
</div>
<p>Nice!</p>
<p>Okay, now letâ€™s convert the boxes from normalized <code>CXCYWH</code> to normalized <code>XYXY</code> format using <code>torchvision.ops.box_convert</code>.</p>
<div id="cell-149" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.ops <span class="im">import</span> box_convert</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Convert the model's predicted boxes from CXCYWH to XYXY format</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>output_boxes_manual_above_threshold_xyxy <span class="op">=</span> box_convert(boxes<span class="op">=</span>output_boxes_manual_above_threshold_cxcywh,</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>                                                       in_fmt<span class="op">=</span><span class="st">"cxcywh"</span>,</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>                                                       out_fmt<span class="op">=</span><span class="st">"xyxy"</span>)</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Output boxes manual above threshold (absolute XYXY format):</span><span class="ch">\n</span><span class="sc">{</span>output_boxes_manual_above_threshold_xyxy<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Output boxes manual above threshold (absolute XYXY format):
tensor([[ 1.2628e-01,  2.7682e-01,  8.5993e-01,  7.0258e-01],
        [ 9.3901e-02,  1.6537e-01,  9.7665e-01,  7.1034e-01],
        [ 1.8548e-01,  9.7452e-01,  4.5866e-01,  1.0003e+00],
        [-9.3983e-03,  9.3833e-01,  3.1250e-01,  1.0019e+00],
        [ 1.6852e-01,  9.7310e-01,  3.5435e-01,  9.9939e-01],
        [ 2.0418e-01,  2.9851e-01,  9.3934e-01,  6.9071e-01],
        [ 2.5663e-02,  3.5340e-01,  1.0024e+00,  7.3548e-01],
        [ 3.7080e-01,  6.1350e-01,  7.1521e-01,  7.0740e-01],
        [ 3.1382e-01,  5.9471e-01,  4.3790e-01,  6.7375e-01],
        [ 2.4342e-01,  9.8166e-01,  6.1553e-01,  1.0012e+00],
        [ 6.6292e-03,  9.2023e-01,  1.8318e-01,  1.0009e+00],
        [ 7.4311e-01,  6.5303e-01,  7.9472e-01,  6.8185e-01],
        [ 4.9891e-02,  6.8670e-01,  3.0278e-01,  7.6203e-01],
        [ 2.8640e-01,  4.6598e-01,  7.5567e-01,  6.8470e-01],
        [ 7.6950e-01,  3.2126e-01,  8.3404e-01,  3.6489e-01],
        [ 2.0933e-01,  6.2507e-01,  3.0392e-01,  6.8764e-01],
        [ 1.4307e-02,  7.1111e-01,  3.0514e-01,  8.3903e-01],
        [ 2.9814e-01,  5.5333e-01,  9.7833e-01,  9.5631e-01],
        [-5.3725e-04,  8.9102e-01,  2.3341e-01,  1.0001e+00],
        [ 4.4927e-01,  9.8416e-01,  6.4758e-01,  1.0002e+00],
        [ 6.8252e-01,  4.4792e-01,  7.7081e-01,  5.1754e-01],
        [ 6.1693e-01,  3.0294e-01,  7.5494e-01,  3.4607e-01],
        [ 2.7395e-03,  7.6324e-01,  4.6576e-01,  9.9405e-01],
        [ 7.3764e-01,  6.7147e-01,  7.9421e-01,  6.9964e-01],
        [ 7.5756e-01,  4.0788e-01,  8.0959e-01,  4.4753e-01],
        [-6.9408e-04,  6.7621e-01,  2.8540e-02,  7.1579e-01],
        [ 3.8558e-01,  4.4562e-01,  5.9960e-01,  5.0969e-01],
        [ 3.1259e-01,  4.5012e-01,  4.0459e-01,  4.9615e-01],
        [ 3.8718e-01,  5.8641e-01,  7.8056e-01,  7.0541e-01],
        [ 9.5392e-01,  9.2219e-01,  1.0048e+00,  1.0065e+00],
        [ 4.1478e-01,  3.5252e-01,  7.2605e-01,  4.1855e-01],
        [ 4.2422e-01,  3.8546e-01,  7.8747e-01,  5.7740e-01],
        [ 3.8556e-01,  4.5690e-01,  5.7100e-01,  4.9991e-01],
        [ 2.9874e-01,  4.1180e-01,  3.8219e-01,  4.5645e-01],
        [ 4.6645e-01,  4.3881e-01,  6.4613e-01,  4.9196e-01],
        [ 6.7195e-01,  1.7078e-01,  9.8625e-01,  2.2078e-01],
        [-4.1011e-04,  8.8440e-01,  2.9176e-02,  1.0034e+00],
        [ 8.7909e-02,  2.9250e-01,  8.3696e-01,  6.8978e-01],
        [ 6.8993e-02,  6.7548e-01,  3.3125e-01,  7.7234e-01],
        [ 5.5467e-01,  6.8064e-01,  9.6700e-01,  7.4185e-01],
        [ 3.7964e-01,  1.8351e-01,  4.7810e-01,  2.1766e-01],
        [ 3.6191e-01,  3.5147e-01,  9.8017e-01,  7.1394e-01],
        [ 8.1656e-01,  7.8574e-01,  1.0117e+00,  9.9907e-01],
        [ 6.1197e-01,  9.8042e-01,  9.7705e-01,  1.0009e+00],
        [ 4.1150e-01,  6.7161e-01,  9.9365e-01,  9.9377e-01],
        [ 1.4097e-01,  3.0974e-01,  2.5747e-01,  3.4522e-01],
        [ 2.0316e-01,  2.3268e-01,  5.6767e-01,  3.4560e-01],
        [ 2.8427e-01,  4.0727e-01,  9.7837e-01,  7.2137e-01],
        [ 4.1402e-01,  4.9086e-01,  5.5782e-01,  5.5057e-01],
        [-1.8808e-04,  6.7771e-01,  7.7116e-03,  7.3598e-01],
        [ 1.7634e-01,  3.2141e-01,  2.7107e-01,  3.5315e-01],
        [ 4.2415e-01,  1.9971e-01,  1.0099e+00,  7.0951e-01],
        [ 5.4117e-01,  9.8533e-01,  8.8021e-01,  1.0009e+00],
        [ 3.6501e-02,  5.8886e-01,  4.5968e-01,  7.2347e-01],
        [ 2.1117e-01,  5.8445e-01,  4.6023e-01,  7.1304e-01],
        [ 9.4018e-01,  6.1408e-01,  9.9566e-01,  7.1208e-01],
        [ 1.0808e-01,  9.7244e-01,  1.0022e+00,  1.0023e+00],
        [ 4.6272e-01,  4.9512e-01,  5.6270e-01,  5.4489e-01],
        [ 9.9290e-01,  7.5306e-01,  1.0004e+00,  9.6212e-01],
        [ 9.8372e-01,  5.9662e-01,  9.9973e-01,  6.7406e-01],
        [ 8.0102e-01,  9.7819e-01,  9.9154e-01,  1.0011e+00],
        [ 1.1011e-01,  1.4376e-01,  1.5044e-01,  1.7778e-01],
        [ 4.2374e-01,  6.7601e-01,  6.6298e-01,  7.1213e-01],
        [ 9.6218e-01,  5.7225e-01,  1.0025e+00,  7.2342e-01],
        [ 4.7840e-01,  2.8271e-01,  1.0237e+00,  9.7165e-01],
        [ 3.0649e-01,  3.5814e-01,  8.7081e-01,  6.8936e-01],
        [ 3.2282e-03,  7.4934e-01,  3.4223e-01,  9.9213e-01],
        [ 1.5592e-01,  9.7877e-01,  9.6205e-01,  1.0014e+00],
        [ 5.4117e-01,  1.8322e-01,  6.9306e-01,  2.2439e-01],
        [ 2.4521e-01,  3.4348e-01,  3.4811e-01,  3.8176e-01],
        [ 1.4479e-01,  3.6940e-01,  8.1166e-01,  6.7502e-01],
        [ 6.8224e-01,  4.7949e-01,  7.3970e-01,  5.3077e-01],
        [ 4.6506e-03,  7.2069e-01,  3.1970e-01,  9.8253e-01],
        [ 2.9502e-01,  5.8372e-01,  9.7909e-01,  7.3307e-01],
        [ 1.5994e-01,  1.7652e-01,  1.0137e+00,  7.1815e-01],
        [ 3.6617e-01,  4.6207e-01,  9.9694e-01,  7.2902e-01],
        [ 9.7532e-01,  4.3035e-01,  1.0014e+00,  5.0731e-01],
        [ 9.8261e-01,  6.7808e-01,  1.0013e+00,  7.3763e-01],
        [ 1.4828e-01,  3.1571e-01,  8.2665e-01,  6.1867e-01],
        [ 9.4971e-01,  7.8830e-01,  1.0037e+00,  9.8290e-01],
        [ 6.3830e-01,  4.5991e-01,  7.2396e-01,  5.2984e-01],
        [ 2.8637e-01,  4.1278e-01,  7.7906e-01,  6.5897e-01],
        [ 7.7590e-01,  6.7213e-01,  8.5088e-01,  7.0540e-01],
        [ 7.5200e-02,  5.4943e-01,  1.0021e+00,  8.2448e-01],
        [ 2.6459e-01,  4.1540e-01,  7.8097e-01,  6.9041e-01],
        [ 3.7568e-01,  1.7879e-01,  4.8756e-01,  2.5578e-01],
        [ 4.7398e-01,  2.0178e-01,  8.2528e-01,  3.2960e-01],
        [ 4.5988e-01,  4.3481e-01,  7.4146e-01,  5.7607e-01],
        [ 4.0726e-01,  6.4943e-01,  9.5243e-01,  7.3036e-01],
        [ 4.1492e-01,  2.5452e-01,  8.8878e-01,  6.9552e-01],
        [ 9.7824e-01,  6.1066e-01,  1.0017e+00,  7.3196e-01],
        [ 5.1303e-01,  3.2596e-01,  6.2211e-01,  5.2504e-01],
        [ 2.5462e-01,  5.9706e-01,  4.4923e-01,  7.0246e-01],
        [ 5.7053e-01,  1.3174e-01,  6.5537e-01,  1.7594e-01],
        [ 6.1241e-01,  1.8171e-01,  7.0533e-01,  2.1707e-01],
        [ 1.2951e-02,  3.5312e-03,  4.8502e-01,  3.7148e-01],
        [ 2.8681e-01,  4.0421e-01,  7.9527e-01,  6.7080e-01],
        [ 1.4634e-01,  6.4266e-01,  2.8951e-01,  7.2878e-01],
        [ 6.0213e-01,  4.6520e-01,  7.2381e-01,  5.5196e-01],
        [-4.6202e-02,  9.8288e-01,  9.4876e-01,  1.0011e+00]],
       grad_fn=&lt;StackBackward0&gt;)</code></pre>
</div>
</div>
<p>Excellent, weâ€™ve got our box coordinates in normalized <code>XYXY</code> format.</p>
<p>We could keep them here.</p>
<p>But to fully replicate the outputs of our postprocessed boxes, weâ€™ll convert them to absolute format.</p>
<p>Absolute format conversion will depend on the target size of image weâ€™d like to use.</p>
<p>For example, if weâ€™d like to convert our boxes to the original dimensions of our input image so we can plot them on that image, we can use the imageâ€™s original dimensions.</p>
<p>To get the original dimensions of our image we can access the <code>orig_size</code> attribute of our preprocessed sample.</p>
<div id="cell-151" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the image original size</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>random_sample_image_original_size<span class="op">=</span> random_sample_preprocessed[<span class="st">"labels"</span>][<span class="dv">0</span>][<span class="st">"orig_size"</span>]</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Image original size: </span><span class="sc">{</span>random_sample_image_original_size<span class="sc">}</span><span class="ss"> (height, width)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Image original size: tensor([1280,  960]) (height, width)</code></pre>
</div>
</div>
<p>Now to convert our normalized coordinates to absolute coordinates we can multiply <code>x</code> coordinates by the target width and <code>y</code> coordinates by the target height.</p>
<div id="cell-153" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Convert normalized box coordinates to absolute pixel values</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get image original height and width</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>original_height, original_width <span class="op">=</span> random_sample_image_original_size</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an XYXY tensor to multiply by</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>original_dimensions <span class="op">=</span> torch.tensor([original_width,   <span class="co"># x1</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>                                    original_height,  <span class="co"># y1 </span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>                                    original_width,   <span class="co"># x2</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>                                    original_height]) <span class="co"># y2</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the boxes to absolute pixel values</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>output_boxes_manual_above_threshold_xyxy_absolute <span class="op">=</span> output_boxes_manual_above_threshold_xyxy <span class="op">*</span> original_dimensions</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>output_boxes_manual_above_threshold_xyxy_absolute</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>tensor([[ 1.2123e+02,  3.5433e+02,  8.2553e+02,  8.9930e+02],
        [ 9.0145e+01,  2.1167e+02,  9.3758e+02,  9.0924e+02],
        [ 1.7806e+02,  1.2474e+03,  4.4031e+02,  1.2803e+03],
        [-9.0223e+00,  1.2011e+03,  3.0000e+02,  1.2824e+03],
        [ 1.6178e+02,  1.2456e+03,  3.4017e+02,  1.2792e+03],
        [ 1.9601e+02,  3.8210e+02,  9.0176e+02,  8.8410e+02],
        [ 2.4636e+01,  4.5235e+02,  9.6235e+02,  9.4141e+02],
        [ 3.5597e+02,  7.8528e+02,  6.8660e+02,  9.0548e+02],
        [ 3.0127e+02,  7.6123e+02,  4.2038e+02,  8.6240e+02],
        [ 2.3368e+02,  1.2565e+03,  5.9090e+02,  1.2816e+03],
        [ 6.3640e+00,  1.1779e+03,  1.7585e+02,  1.2811e+03],
        [ 7.1338e+02,  8.3587e+02,  7.6293e+02,  8.7276e+02],
        [ 4.7895e+01,  8.7897e+02,  2.9067e+02,  9.7540e+02],
        [ 2.7494e+02,  5.9645e+02,  7.2545e+02,  8.7642e+02],
        [ 7.3872e+02,  4.1121e+02,  8.0068e+02,  4.6706e+02],
        [ 2.0096e+02,  8.0009e+02,  2.9176e+02,  8.8018e+02],
        [ 1.3735e+01,  9.1022e+02,  2.9293e+02,  1.0740e+03],
        [ 2.8621e+02,  7.0827e+02,  9.3920e+02,  1.2241e+03],
        [-5.1576e-01,  1.1405e+03,  2.2407e+02,  1.2801e+03],
        [ 4.3130e+02,  1.2597e+03,  6.2168e+02,  1.2803e+03],
        [ 6.5522e+02,  5.7333e+02,  7.3998e+02,  6.6246e+02],
        [ 5.9225e+02,  3.8776e+02,  7.2474e+02,  4.4297e+02],
        [ 2.6299e+00,  9.7695e+02,  4.4713e+02,  1.2724e+03],
        [ 7.0814e+02,  8.5948e+02,  7.6244e+02,  8.9554e+02],
        [ 7.2725e+02,  5.2208e+02,  7.7721e+02,  5.7284e+02],
        [-6.6632e-01,  8.6555e+02,  2.7398e+01,  9.1621e+02],
        [ 3.7016e+02,  5.7040e+02,  5.7561e+02,  6.5241e+02],
        [ 3.0009e+02,  5.7616e+02,  3.8840e+02,  6.3507e+02],
        [ 3.7169e+02,  7.5060e+02,  7.4934e+02,  9.0293e+02],
        [ 9.1577e+02,  1.1804e+03,  9.6465e+02,  1.2883e+03],
        [ 3.9819e+02,  4.5123e+02,  6.9701e+02,  5.3574e+02],
        [ 4.0725e+02,  4.9339e+02,  7.5597e+02,  7.3908e+02],
        [ 3.7014e+02,  5.8483e+02,  5.4816e+02,  6.3988e+02],
        [ 2.8679e+02,  5.2711e+02,  3.6690e+02,  5.8425e+02],
        [ 4.4779e+02,  5.6168e+02,  6.2028e+02,  6.2971e+02],
        [ 6.4507e+02,  2.1860e+02,  9.4680e+02,  2.8260e+02],
        [-3.9370e-01,  1.1320e+03,  2.8009e+01,  1.2843e+03],
        [ 8.4393e+01,  3.7440e+02,  8.0348e+02,  8.8292e+02],
        [ 6.6233e+01,  8.6461e+02,  3.1800e+02,  9.8859e+02],
        [ 5.3249e+02,  8.7122e+02,  9.2832e+02,  9.4956e+02],
        [ 3.6446e+02,  2.3490e+02,  4.5898e+02,  2.7860e+02],
        [ 3.4743e+02,  4.4988e+02,  9.4097e+02,  9.1384e+02],
        [ 7.8389e+02,  1.0058e+03,  9.7121e+02,  1.2788e+03],
        [ 5.8749e+02,  1.2549e+03,  9.3796e+02,  1.2811e+03],
        [ 3.9504e+02,  8.5966e+02,  9.5390e+02,  1.2720e+03],
        [ 1.3533e+02,  3.9646e+02,  2.4717e+02,  4.4188e+02],
        [ 1.9504e+02,  2.9783e+02,  5.4496e+02,  4.4237e+02],
        [ 2.7290e+02,  5.2131e+02,  9.3924e+02,  9.2335e+02],
        [ 3.9746e+02,  6.2830e+02,  5.3551e+02,  7.0473e+02],
        [-1.8056e-01,  8.6747e+02,  7.4031e+00,  9.4205e+02],
        [ 1.6929e+02,  4.1140e+02,  2.6023e+02,  4.5203e+02],
        [ 4.0718e+02,  2.5563e+02,  9.6950e+02,  9.0817e+02],
        [ 5.1952e+02,  1.2612e+03,  8.4501e+02,  1.2811e+03],
        [ 3.5041e+01,  7.5374e+02,  4.4130e+02,  9.2604e+02],
        [ 2.0272e+02,  7.4809e+02,  4.4182e+02,  9.1270e+02],
        [ 9.0257e+02,  7.8603e+02,  9.5583e+02,  9.1146e+02],
        [ 1.0376e+02,  1.2447e+03,  9.6211e+02,  1.2829e+03],
        [ 4.4421e+02,  6.3375e+02,  5.4019e+02,  6.9746e+02],
        [ 9.5318e+02,  9.6392e+02,  9.6036e+02,  1.2315e+03],
        [ 9.4437e+02,  7.6368e+02,  9.5974e+02,  8.6280e+02],
        [ 7.6898e+02,  1.2521e+03,  9.5188e+02,  1.2815e+03],
        [ 1.0570e+02,  1.8401e+02,  1.4442e+02,  2.2755e+02],
        [ 4.0679e+02,  8.6530e+02,  6.3646e+02,  9.1152e+02],
        [ 9.2369e+02,  7.3249e+02,  9.6240e+02,  9.2597e+02],
        [ 4.5927e+02,  3.6187e+02,  9.8274e+02,  1.2437e+03],
        [ 2.9423e+02,  4.5842e+02,  8.3598e+02,  8.8238e+02],
        [ 3.0991e+00,  9.5915e+02,  3.2855e+02,  1.2699e+03],
        [ 1.4968e+02,  1.2528e+03,  9.2357e+02,  1.2818e+03],
        [ 5.1953e+02,  2.3453e+02,  6.6533e+02,  2.8722e+02],
        [ 2.3540e+02,  4.3965e+02,  3.3418e+02,  4.8865e+02],
        [ 1.3900e+02,  4.7284e+02,  7.7919e+02,  8.6403e+02],
        [ 6.5495e+02,  6.1375e+02,  7.1011e+02,  6.7939e+02],
        [ 4.4646e+00,  9.2248e+02,  3.0692e+02,  1.2576e+03],
        [ 2.8322e+02,  7.4716e+02,  9.3993e+02,  9.3833e+02],
        [ 1.5355e+02,  2.2595e+02,  9.7318e+02,  9.1923e+02],
        [ 3.5153e+02,  5.9145e+02,  9.5706e+02,  9.3315e+02],
        [ 9.3631e+02,  5.5085e+02,  9.6135e+02,  6.4936e+02],
        [ 9.4331e+02,  8.6794e+02,  9.6124e+02,  9.4417e+02],
        [ 1.4235e+02,  4.0410e+02,  7.9358e+02,  7.9189e+02],
        [ 9.1172e+02,  1.0090e+03,  9.6355e+02,  1.2581e+03],
        [ 6.1276e+02,  5.8869e+02,  6.9500e+02,  6.7819e+02],
        [ 2.7491e+02,  5.2836e+02,  7.4790e+02,  8.4349e+02],
        [ 7.4487e+02,  8.6033e+02,  8.1685e+02,  9.0291e+02],
        [ 7.2192e+01,  7.0326e+02,  9.6203e+02,  1.0553e+03],
        [ 2.5401e+02,  5.3171e+02,  7.4973e+02,  8.8372e+02],
        [ 3.6065e+02,  2.2885e+02,  4.6806e+02,  3.2740e+02],
        [ 4.5502e+02,  2.5827e+02,  7.9227e+02,  4.2188e+02],
        [ 4.4148e+02,  5.5655e+02,  7.1180e+02,  7.3738e+02],
        [ 3.9097e+02,  8.3127e+02,  9.1433e+02,  9.3486e+02],
        [ 3.9833e+02,  3.2578e+02,  8.5323e+02,  8.9026e+02],
        [ 9.3911e+02,  7.8165e+02,  9.6162e+02,  9.3691e+02],
        [ 4.9251e+02,  4.1722e+02,  5.9723e+02,  6.7205e+02],
        [ 2.4444e+02,  7.6424e+02,  4.3126e+02,  8.9915e+02],
        [ 5.4770e+02,  1.6863e+02,  6.2916e+02,  2.2521e+02],
        [ 5.8792e+02,  2.3259e+02,  6.7711e+02,  2.7785e+02],
        [ 1.2433e+01,  4.5200e+00,  4.6562e+02,  4.7549e+02],
        [ 2.7534e+02,  5.1739e+02,  7.6346e+02,  8.5863e+02],
        [ 1.4049e+02,  8.2260e+02,  2.7793e+02,  9.3284e+02],
        [ 5.7805e+02,  5.9546e+02,  6.9485e+02,  7.0651e+02],
        [-4.4354e+01,  1.2581e+03,  9.1081e+02,  1.2815e+03]],
       grad_fn=&lt;MulBackward0&gt;)</code></pre>
</div>
</div>
<p>Absolute <code>XYXY</code> coordinates acquired!</p>
<p>Time to order them in the same order as our descending scores.</p>
<div id="cell-155" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Order boxes in same order as labels and scores (descending based on score)</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>output_boxes_manual_sorted <span class="op">=</span> output_boxes_manual_above_threshold_xyxy_absolute[output_scores_manual_filtered_indices]</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>output_boxes_manual_sorted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>tensor([[ 1.2123e+02,  3.5433e+02,  8.2553e+02,  8.9930e+02],
        [ 9.0145e+01,  2.1167e+02,  9.3758e+02,  9.0924e+02],
        [ 1.7806e+02,  1.2474e+03,  4.4031e+02,  1.2803e+03],
        [-9.0223e+00,  1.2011e+03,  3.0000e+02,  1.2824e+03],
        [ 1.6178e+02,  1.2456e+03,  3.4017e+02,  1.2792e+03],
        [ 1.9601e+02,  3.8210e+02,  9.0176e+02,  8.8410e+02],
        [ 2.4636e+01,  4.5235e+02,  9.6235e+02,  9.4141e+02],
        [ 3.5597e+02,  7.8528e+02,  6.8660e+02,  9.0548e+02],
        [ 3.0127e+02,  7.6123e+02,  4.2038e+02,  8.6240e+02],
        [ 2.3368e+02,  1.2565e+03,  5.9090e+02,  1.2816e+03],
        [ 6.3640e+00,  1.1779e+03,  1.7585e+02,  1.2811e+03],
        [ 7.1338e+02,  8.3587e+02,  7.6293e+02,  8.7276e+02],
        [ 4.7895e+01,  8.7897e+02,  2.9067e+02,  9.7540e+02],
        [ 2.7494e+02,  5.9645e+02,  7.2545e+02,  8.7642e+02],
        [ 7.3872e+02,  4.1121e+02,  8.0068e+02,  4.6706e+02],
        [ 2.0096e+02,  8.0009e+02,  2.9176e+02,  8.8018e+02],
        [ 1.3735e+01,  9.1022e+02,  2.9293e+02,  1.0740e+03],
        [ 2.8621e+02,  7.0827e+02,  9.3920e+02,  1.2241e+03],
        [-5.1576e-01,  1.1405e+03,  2.2407e+02,  1.2801e+03],
        [ 4.3130e+02,  1.2597e+03,  6.2168e+02,  1.2803e+03],
        [ 6.5522e+02,  5.7333e+02,  7.3998e+02,  6.6246e+02],
        [ 5.9225e+02,  3.8776e+02,  7.2474e+02,  4.4297e+02],
        [ 2.6299e+00,  9.7695e+02,  4.4713e+02,  1.2724e+03],
        [ 7.0814e+02,  8.5948e+02,  7.6244e+02,  8.9554e+02],
        [ 7.2725e+02,  5.2208e+02,  7.7721e+02,  5.7284e+02],
        [-6.6632e-01,  8.6555e+02,  2.7398e+01,  9.1621e+02],
        [ 3.7016e+02,  5.7040e+02,  5.7561e+02,  6.5241e+02],
        [ 3.0009e+02,  5.7616e+02,  3.8840e+02,  6.3507e+02],
        [ 3.7169e+02,  7.5060e+02,  7.4934e+02,  9.0293e+02],
        [ 9.1577e+02,  1.1804e+03,  9.6465e+02,  1.2883e+03],
        [ 3.9819e+02,  4.5123e+02,  6.9701e+02,  5.3574e+02],
        [ 4.0725e+02,  4.9339e+02,  7.5597e+02,  7.3908e+02],
        [ 3.7014e+02,  5.8483e+02,  5.4816e+02,  6.3988e+02],
        [ 2.8679e+02,  5.2711e+02,  3.6690e+02,  5.8425e+02],
        [ 4.4779e+02,  5.6168e+02,  6.2028e+02,  6.2971e+02],
        [ 6.4507e+02,  2.1860e+02,  9.4680e+02,  2.8260e+02],
        [-3.9370e-01,  1.1320e+03,  2.8009e+01,  1.2843e+03],
        [ 8.4393e+01,  3.7440e+02,  8.0348e+02,  8.8292e+02],
        [ 6.6233e+01,  8.6461e+02,  3.1800e+02,  9.8859e+02],
        [ 5.3249e+02,  8.7122e+02,  9.2832e+02,  9.4956e+02],
        [ 3.6446e+02,  2.3490e+02,  4.5898e+02,  2.7860e+02],
        [ 3.4743e+02,  4.4988e+02,  9.4097e+02,  9.1384e+02],
        [ 7.8389e+02,  1.0058e+03,  9.7121e+02,  1.2788e+03],
        [ 5.8749e+02,  1.2549e+03,  9.3796e+02,  1.2811e+03],
        [ 3.9504e+02,  8.5966e+02,  9.5390e+02,  1.2720e+03],
        [ 1.3533e+02,  3.9646e+02,  2.4717e+02,  4.4188e+02],
        [ 1.9504e+02,  2.9783e+02,  5.4496e+02,  4.4237e+02],
        [ 2.7290e+02,  5.2131e+02,  9.3924e+02,  9.2335e+02],
        [ 3.9746e+02,  6.2830e+02,  5.3551e+02,  7.0473e+02],
        [-1.8056e-01,  8.6747e+02,  7.4031e+00,  9.4205e+02],
        [ 1.6929e+02,  4.1140e+02,  2.6023e+02,  4.5203e+02],
        [ 4.0718e+02,  2.5563e+02,  9.6950e+02,  9.0817e+02],
        [ 5.1952e+02,  1.2612e+03,  8.4501e+02,  1.2811e+03],
        [ 3.5041e+01,  7.5374e+02,  4.4130e+02,  9.2604e+02],
        [ 2.0272e+02,  7.4809e+02,  4.4182e+02,  9.1270e+02],
        [ 9.0257e+02,  7.8603e+02,  9.5583e+02,  9.1146e+02],
        [ 1.0376e+02,  1.2447e+03,  9.6211e+02,  1.2829e+03],
        [ 4.4421e+02,  6.3375e+02,  5.4019e+02,  6.9746e+02],
        [ 9.5318e+02,  9.6392e+02,  9.6036e+02,  1.2315e+03],
        [ 9.4437e+02,  7.6368e+02,  9.5974e+02,  8.6280e+02],
        [ 7.6898e+02,  1.2521e+03,  9.5188e+02,  1.2815e+03],
        [ 1.0570e+02,  1.8401e+02,  1.4442e+02,  2.2755e+02],
        [ 4.0679e+02,  8.6530e+02,  6.3646e+02,  9.1152e+02],
        [ 9.2369e+02,  7.3249e+02,  9.6240e+02,  9.2597e+02],
        [ 4.5927e+02,  3.6187e+02,  9.8274e+02,  1.2437e+03],
        [ 2.9423e+02,  4.5842e+02,  8.3598e+02,  8.8238e+02],
        [ 3.0991e+00,  9.5915e+02,  3.2855e+02,  1.2699e+03],
        [ 1.4968e+02,  1.2528e+03,  9.2357e+02,  1.2818e+03],
        [ 5.1953e+02,  2.3453e+02,  6.6533e+02,  2.8722e+02],
        [ 2.3540e+02,  4.3965e+02,  3.3418e+02,  4.8865e+02],
        [ 1.3900e+02,  4.7284e+02,  7.7919e+02,  8.6403e+02],
        [ 6.5495e+02,  6.1375e+02,  7.1011e+02,  6.7939e+02],
        [ 4.4646e+00,  9.2248e+02,  3.0692e+02,  1.2576e+03],
        [ 2.8322e+02,  7.4716e+02,  9.3993e+02,  9.3833e+02],
        [ 1.5355e+02,  2.2595e+02,  9.7318e+02,  9.1923e+02],
        [ 3.5153e+02,  5.9145e+02,  9.5706e+02,  9.3315e+02],
        [ 9.3631e+02,  5.5085e+02,  9.6135e+02,  6.4936e+02],
        [ 9.4331e+02,  8.6794e+02,  9.6124e+02,  9.4417e+02],
        [ 1.4235e+02,  4.0410e+02,  7.9358e+02,  7.9189e+02],
        [ 9.1172e+02,  1.0090e+03,  9.6355e+02,  1.2581e+03],
        [ 6.1276e+02,  5.8869e+02,  6.9500e+02,  6.7819e+02],
        [ 2.7491e+02,  5.2836e+02,  7.4790e+02,  8.4349e+02],
        [ 7.4487e+02,  8.6033e+02,  8.1685e+02,  9.0291e+02],
        [ 7.2192e+01,  7.0326e+02,  9.6203e+02,  1.0553e+03],
        [ 2.5401e+02,  5.3171e+02,  7.4973e+02,  8.8372e+02],
        [ 3.6065e+02,  2.2885e+02,  4.6806e+02,  3.2740e+02],
        [ 4.5502e+02,  2.5827e+02,  7.9227e+02,  4.2188e+02],
        [ 4.4148e+02,  5.5655e+02,  7.1180e+02,  7.3738e+02],
        [ 3.9097e+02,  8.3127e+02,  9.1433e+02,  9.3486e+02],
        [ 3.9833e+02,  3.2578e+02,  8.5323e+02,  8.9026e+02],
        [ 9.3911e+02,  7.8165e+02,  9.6162e+02,  9.3691e+02],
        [ 4.9251e+02,  4.1722e+02,  5.9723e+02,  6.7205e+02],
        [ 2.4444e+02,  7.6424e+02,  4.3126e+02,  8.9915e+02],
        [ 5.4770e+02,  1.6863e+02,  6.2916e+02,  2.2521e+02],
        [ 5.8792e+02,  2.3259e+02,  6.7711e+02,  2.7785e+02],
        [ 1.2433e+01,  4.5200e+00,  4.6562e+02,  4.7549e+02],
        [ 2.7534e+02,  5.1739e+02,  7.6346e+02,  8.5863e+02],
        [ 1.4049e+02,  8.2260e+02,  2.7793e+02,  9.3284e+02],
        [ 5.7805e+02,  5.9546e+02,  6.9485e+02,  7.0651e+02],
        [-4.4354e+01,  1.2581e+03,  9.1081e+02,  1.2815e+03]],
       grad_fn=&lt;IndexBackward0&gt;)</code></pre>
</div>
</div>
<p>Finally, we can check to see if our manually postprocessed boxes are equivalent to original post processed boxes.</p>
<div id="cell-157" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for equivalence between original postprocessed boxes and our manually processed boxes</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>output_boxes <span class="op">==</span> output_boxes_manual_sorted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>tensor([[ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [ True,  True,  True,  True],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False],
        [False, False, False, False]])</code></pre>
</div>
</div>
<p>Excellent!</p>
<p>Weâ€™ve now successfully converted our modelâ€™s raw outputs to postprocessed usable outputs.</p>
<p>Taking the time to do steps like this helps us understand the steps taken behind the scenes for in-built postprocessing methods.</p>
<p>Knowing how to do these conversion steps can also help use troubleshoot errors we may come across in the future.</p>
</section>
<section id="plotting-our-models-first-box-predictions-on-an-image" class="level3" data-number="11.4">
<h3 data-number="11.4" class="anchored" data-anchor-id="plotting-our-models-first-box-predictions-on-an-image"><span class="header-section-number">11.4</span> Plotting our modelâ€™s first box predictions on an image</h3>
<p>Weâ€™ve got some predictions, time to follow the data explorerâ€™s motto and <em>visualize, visualize, visualize!</em></p>
<p>To do so weâ€™ll:</p>
<ol type="1">
<li>Extract the scores, labels and boxes from our <code>random_sample_outputs_post_processed</code>.</li>
<li>Create a list of label names to plot by mapping label IDs to class names as well as a list of colours to colour our boxes with in accordance to our <code>colour_palette</code>.</li>
<li>Draw boxes on the image with a combination of <code>torchvision</code>â€™s <a href="https://pytorch.org/vision/main/generated/torchvision.transforms.functional.pil_to_tensor.html"><code>pil_to_tensor</code></a>, <a href="https://pytorch.org/vision/main/generated/torchvision.utils.draw_bounding_boxes.html"><code>draw_bounding_boxes</code></a> and <a href="https://pytorch.org/vision/main/generated/torchvision.transforms.functional.to_pil_image.html"><code>to_pil_image</code></a>.</li>
</ol>
<p>Weâ€™ll halve the image as well as the box coordinates using <code>half_image</code> and <code>half_boxes</code> to save space in our notebook (this is not 100% necessary, just for convenience).</p>
<div id="cell-160" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Extract scores, labels and boxes</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>random_sample_pred_scores <span class="op">=</span> random_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"scores"</span>]</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>random_sample_pred_labels <span class="op">=</span> random_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"labels"</span>]</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>random_sample_pred_boxes <span class="op">=</span> half_boxes(random_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"boxes"</span>])</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Create a list of labels and colours to plot on the image/boxes</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>random_sample_pred_labels_to_plot <span class="op">=</span> [<span class="ss">f"Pred: </span><span class="sc">{</span>id2label[label_pred.item()]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score_pred.item(), <span class="dv">4</span>)<span class="sc">}</span><span class="ss">)"</span> </span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> label_pred, score_pred <span class="kw">in</span> <span class="bu">zip</span>(random_sample_pred_labels, random_sample_pred_scores)]</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>random_sample_pred_colours <span class="op">=</span> [colour_palette[id2label[label_pred.item()]] <span class="cf">for</span> label_pred <span class="kw">in</span> random_sample_pred_labels]</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Labels with scores: </span><span class="sc">{</span>random_sample_pred_labels_to_plot[:<span class="dv">3</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Plot the random sample image with randomly predicted boxes </span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="co"># (these will be very poor since the model is not trained on our data yet)</span></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>to_pil_image(</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>half_image(random_sample[<span class="st">"image"</span>])),</span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>random_sample_pred_boxes, <span class="co"># boxes are in XYXY format, which is required for draw_bounding_boxes</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_sample_pred_labels_to_plot,</span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>        colors<span class="op">=</span>random_sample_pred_colours,</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">3</span></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Labels with scores: ['Pred: bin (0.6885)', 'Pred: bin (0.6805)', 'Pred: hand (0.6791)']...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="63">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-64-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Woah! Those boxes donâ€™t look good at all both the label and the coordinates look off.</p>
<p>This should be expected thoughâ€¦</p>
<p>While our model has been pretrained on the COCO dataset, it hasnâ€™t been trained on our specific data.</p>
<p>The good news is we can hopefully (there are no guarantees in machine learning) improve our modelâ€™s box predictions by fine-tuning it on our dataset.</p>
</section>
<section id="aside-bounding-box-formats-in-and-out-of-our-model" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="aside-bounding-box-formats-in-and-out-of-our-model"><span class="header-section-number">12</span> Aside: Bounding box formats in and out of our model</h2>
<p>Weâ€™ve done a fair bit of data transformation to get our data ready to go into our model and weâ€™ve also taken a fair few steps to postprocess it into a usable format.</p>
<p>This is often a standard practice in many machine learning workflows.</p>
<p>Much of the work before ever training a model is preparing the data for the model.</p>
<p>And much of the work after training a model is preparing the data for your use case.</p>
<p>The following table highlights the different states our bounding boxes go in and out of.</p>
<p>TK image - turn this into a nice image of the workflow</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Step</strong></th>
<th><strong>Box format</strong></th>
<th><strong>Scale</strong></th>
<th><strong>Goes into</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Starting data (default downloaded from Hugging Face)</td>
<td><code>XYWH</code> or <code>[x1, y1, width, height]</code></td>
<td>Absolute</td>
<td><code>preprocess()</code> method</td>
</tr>
<tr class="even">
<td>Out of <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.preprocess"><code>preprocess()</code></a></td>
<td><code>CXCYWH</code> or <code>[center_x, center_y, width, height]</code></td>
<td>Normalized</td>
<td><code>model.forward()</code></td>
</tr>
<tr class="odd">
<td>Out of <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrForObjectDetection.forward"><code>model.forward()</code></a></td>
<td><code>CXCYWH</code> or <code>[center_x, center_y, width, height]</code></td>
<td>Normalized</td>
<td><code>post_process_object_detection()</code></td>
</tr>
<tr class="even">
<td>Out of <a href="https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.post_process_object_detection"><code>post_process_object_detection()</code></a></td>
<td><code>XYXY</code> or <code>[x_top_left, y_top_left, x_bottom_right, y_bottom_right]</code></td>
<td>Absolute (in relation to the <code>target_sizes</code> parameter).</td>
<td>Plotting or display function.</td>
</tr>
</tbody>
</table>
<p>Keeping track of these input and output formats is helpful for knowing the state of your data.</p>
<p>But remember, just because our current workflow is like this, doesnâ€™t mean all future workflows you work on will have the same transformation steps.</p>
</section>
<section id="tk---preparing-data-at-scale" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="tk---preparing-data-at-scale"><span class="header-section-number">13</span> TK - Preparing data at scale</h2>
<p>Weâ€™ve performed preprocessing and postprocessing steps on a single data sample.</p>
<p>However, in practice, weâ€™ll likely want to work with many more samples.</p>
<p>Our model is hungry for more data.</p>
<p>So letâ€™s step it up a notch and write some code thatâ€™s capable of preprocessing <em>many</em> samples to pass to our model.</p>
<p>Weâ€™ll break it down into three subsections:</p>
<ol type="1">
<li><strong>Splitting the data</strong> into training, validation and test sets. Weâ€™ll train our model on the training set and check its performance on the validation and test sets (our model wonâ€™t see any of these samples during training). We perform these splits before preprocessing the samples in them in case weâ€™d like to perform different preprocessing steps depending on the split. For example, we may want to use <a href="https://pytorch.org/vision/main/transforms.html"><strong>data augmentation</strong></a> on the training set and not use it on the testing set.</li>
<li><strong>Preprocessing multiple samples at a time</strong> by iterating over groups of samples. Rather than preprocess a single sample at a time, weâ€™ll write code capable of processing lists of examples simultaneously.</li>
<li><strong>Collate samples into batches</strong> so our model can view multiple samples simultaneously. Rather than performing a forward pass on a single sample at a time, weâ€™ll pass <strong>batches</strong> of data to the model. For example, we may pass 32 samples (image and label pairs) at a time to our model for it to try and learn the patterns between them. We use batches of data rather than the whole dataset as itâ€™s often much more memory efficient. If you have a <em>really</em> large dataset, all of your samples may not fit into memory at once, so in practice, you break it up into smaller batches of samples.</li>
</ol>
<p>Letâ€™s start by splitting the data into different sets.</p>
<section id="splitting-the-data-into-training-and-test-sets" class="level3" data-number="13.1">
<h3 data-number="13.1" class="anchored" data-anchor-id="splitting-the-data-into-training-and-test-sets"><span class="header-section-number">13.1</span> Splitting the data into training and test sets</h3>
<p>Right now our data is all in one big group.</p>
<p>However, itâ€™s best practice to split our data into two (or three) different sets:</p>
<ol type="1">
<li><strong>Training set (~70-80% of data)</strong> - This is the data the model will learn from, all samples in this set are seen by the model during training.</li>
<li><strong>Validation set (~5-20% of data)</strong> - This is the data we can fine-tune our modelâ€™s hyperparameters on, all samples in this set are <em>not</em> seen by the model during training.</li>
<li><strong>Test set (~5-20% of data)</strong> - This is the data we will evaluate what our model has learned after going through the training set, all samples in this set are <em>not</em> seen by the model during training.</li>
</ol>
<p>Using the analogy of a student at univeristy, the <strong>training set</strong> would be the course materials throughout the semester, the <strong>validation set</strong> would be the practice exam and the <strong>test set</strong> would be the final exam.</p>
<p>If a student doesnâ€™t perform well on the final exam, then we would usually say perhaps the course materials werenâ€™t of the highest quality.</p>
<p>This is similar to our machine learning workflow.</p>
<p>In an ideal world, the samples in the training set are sufficiently representative of those in the test set and in turn, sufficiently representative of samples in the wild.</p>
<p>Before we split our dataset into different sets, letâ€™s remind ourselves of what it looks like.</p>
<div id="cell-165" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original dataset (only a "train" split)</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> load_dataset(path<span class="op">=</span><span class="st">"mrdbourke/trashify_manual_labelled_images"</span>)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['image', 'image_id', 'annotations', 'label_source', 'image_source'],
        num_rows: 1128
    })
})</code></pre>
</div>
</div>
<p>Wonderful! Right now, weâ€™ve only got one split, <code>"train"</code>.</p>
<p>To make our required splits, we can call the <a href="https://huggingface.co/docs/datasets/en/package_reference/main_classes#datasets.Dataset.train_test_split"><code>train_test_split()</code></a> method on our dataset and pass in the size of the split weâ€™d like via the <code>test_size</code> parameter.</p>
<p>For example, <code>test_size=0.3</code> means 30% of the data will go to the test set and 70% will go to the training set.</p>
<p>Weâ€™ll make the following splits:</p>
<ul>
<li>70% of data to training set.</li>
<li>~10% of data to validation set.</li>
<li>~20% of data to testing set.</li>
</ul>
<p>To do so, weâ€™ll call <code>train_test_split()</code> twice with different amounts:</p>
<ol type="1">
<li>First on <code>dataset["train"]</code> with <code>test_size=0.3</code> to make the 70/30 training/test split, weâ€™ll save this split to the variable <code>dataset_split</code>.</li>
<li>Next on <code>dataset_split["test"]</code> with <code>test_size=0.66</code> to make the 66/33 test/validation split, weâ€™ll set this variable to <code>dataset_test_val_split</code>.</li>
</ol>
<p>Once weâ€™ve done this, weâ€™ll reassign all of the splits back to our original <code>dataset</code>.</p>
<p>Weâ€™ll also set <code>seed=42</code> for reproducibility.</p>
<p>Letâ€™s do it!</p>
<p>TK image - make an image of these workflows to make it easier to understand</p>
<div id="cell-167" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Split the data into "train" and "test" splits</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>dataset_split <span class="op">=</span> dataset[<span class="st">"train"</span>].train_test_split(test_size<span class="op">=</span><span class="fl">0.3</span>, seed<span class="op">=</span><span class="dv">42</span>) <span class="co"># split the dataset into 70/30 train/test</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Split the test split into "test" and "validation" splits</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>dataset_test_val_split <span class="op">=</span> dataset_split[<span class="st">"test"</span>].train_test_split(test_size<span class="op">=</span><span class="fl">0.66</span>, seed<span class="op">=</span><span class="dv">42</span>) <span class="co"># split the test set into 40/60 validation/test</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create "train" split from 1.</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>dataset[<span class="st">"train"</span>] <span class="op">=</span> dataset_split[<span class="st">"train"</span>]</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a "validation" and "test" split from 2.</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>dataset[<span class="st">"validation"</span>] <span class="op">=</span> dataset_test_val_split[<span class="st">"train"</span>]</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>dataset[<span class="st">"test"</span>] <span class="op">=</span> dataset_test_val_split[<span class="st">"test"</span>]</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a><span class="co"># View the dataset (now with splits)</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['image', 'image_id', 'annotations', 'label_source', 'image_source'],
        num_rows: 789
    })
    validation: Dataset({
        features: ['image', 'image_id', 'annotations', 'label_source', 'image_source'],
        num_rows: 115
    })
    test: Dataset({
        features: ['image', 'image_id', 'annotations', 'label_source', 'image_source'],
        num_rows: 224
    })
})</code></pre>
</div>
</div>
<p>Perfect!</p>
<p>Now weâ€™ve got three splits of our dataset to work with.</p>
<p>Weâ€™ll make sure our model never sees the <code>validation</code> and <code>test</code> splits during training, so when evaluate it we know that itâ€™s only seeing new samples.</p>
</section>
<section id="tk---writing-a-function-for-preprocessing-multiple-samples-at-a-time" class="level3" data-number="13.2">
<h3 data-number="13.2" class="anchored" data-anchor-id="tk---writing-a-function-for-preprocessing-multiple-samples-at-a-time"><span class="header-section-number">13.2</span> TK - Writing a function for preprocessing multiple samples at a time</h3>
<p>UPTOHERE - preprocessing multiple samples at a time</p>
<p>Weâ€™ve preprocessed and passed one sample through our model, new letâ€™s do the same for multiple samples.</p>
<p>Weâ€™re going to work towards having a function that can go from a group or batch of samples (images and their annotations) and return them in preprocessed form (via <a href="https://huggingface.co/docs/transformers/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.preprocess"><code>transformers.ConditionalDetrImageProcessor.preprocess</code></a>) ready to be used with our model.</p>
<p>Letâ€™s first remind ourselves of what a single unprocessed sample looks like.</p>
<div id="cell-170" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get one sample from the training dataset </span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>one_sample <span class="op">=</span> dataset[<span class="st">"train"</span>][<span class="dv">42</span>]</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>one_sample</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>{'image': &lt;PIL.Image.Image image mode=RGB size=960x1280&gt;,
 'image_id': 663,
 'annotations': {'file_name': ['1d2ea64a-0296-403d-93cd-31e3f116c995.jpeg',
   '1d2ea64a-0296-403d-93cd-31e3f116c995.jpeg'],
  'image_id': [663, 663],
  'category_id': [1, 5],
  'bbox': [[413.29998779296875,
    529.7000122070312,
    343.6000061035156,
    687.0999755859375],
   [435.8999938964844, 463.0, 77.19999694824219, 99.9000015258789]],
  'iscrowd': [0, 0],
  'area': [236087.5625, 7712.27978515625]},
 'label_source': 'manual_prodigy_label',
 'image_source': 'manual_taken_photo'}</code></pre>
</div>
</div>
<p>Awesome, we get an <code>image</code> in <code>PIL.Image.Image</code> form as well as a single dictionary of <code>annotations</code>.</p>
<p>How about if we were to inspect a group of three samples?</p>
<div id="cell-172" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get three samples from the training set</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>group_of_samples <span class="op">=</span> dataset[<span class="st">"train"</span>][<span class="dv">0</span>:<span class="dv">3</span>]</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment for full output (commented for brevity)</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="co"># group_of_samples </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details>
<summary>
Output of random_samples
</summary>
<pre><code>Signature:
{'image': [&lt;PIL.Image.Image image mode=RGB size=960x1280&gt;,
  &lt;PIL.Image.Image image mode=RGB size=960x1280&gt;,
  &lt;PIL.Image.Image image mode=RGB size=960x1280&gt;],
 'image_id': [69, 1027, 1092],
 'annotations': [{'file_name': ['c56fee61-959c-44b8-ada2-807d2ff45f90.jpeg',
    'c56fee61-959c-44b8-ada2-807d2ff45f90.jpeg',
    'c56fee61-959c-44b8-ada2-807d2ff45f90.jpeg',
    'c56fee61-959c-44b8-ada2-807d2ff45f90.jpeg',
    'c56fee61-959c-44b8-ada2-807d2ff45f90.jpeg',
    'c56fee61-959c-44b8-ada2-807d2ff45f90.jpeg',
    'c56fee61-959c-44b8-ada2-807d2ff45f90.jpeg',
    'c56fee61-959c-44b8-ada2-807d2ff45f90.jpeg'],
   'image_id': [69, 69, 69, 69, 69, 69, 69, 69],
   'category_id': [5, 0, 1, 4, 4, 4, 4, 4],
   'bbox': [[360.20001220703125, 528.5, 177.1999969482422, 261.79998779296875],
    [298.29998779296875,
     495.1000061035156,
     381.1000061035156,
     505.70001220703125],
    [81.5999984741211,
     592.0999755859375,
     358.79998779296875,
     316.29998779296875],
    [1.2999999523162842,
     776.7000122070312,
     193.8000030517578,
     211.89999389648438],
    [301.1000061035156, 60.79999923706055, 146.89999389648438, 115.0],
    [501.0, 75.9000015258789, 24.200000762939453, 71.19999694824219],
    [546.4000244140625,
     54.70000076293945,
     130.3000030517578,
     115.0999984741211],
    [862.9000244140625,
     41.099998474121094,
     75.69999694824219,
     80.19999694824219]],
   'iscrowd': [0, 0, 0, 0, 0, 0, 0, 0],
   'area': [46390.9609375,
    192722.265625,
    113488.4375,
    41066.21875,
    16893.5,
    1723.0400390625,
    14997.5302734375,
    6071.14013671875]},
  {'file_name': ['b664785b-f8b6-4dd2-9ede-d89c07564812.jpeg',
    'b664785b-f8b6-4dd2-9ede-d89c07564812.jpeg',
    'b664785b-f8b6-4dd2-9ede-d89c07564812.jpeg',
    'b664785b-f8b6-4dd2-9ede-d89c07564812.jpeg',
    'b664785b-f8b6-4dd2-9ede-d89c07564812.jpeg'],
   'image_id': [1027, 1027, 1027, 1027, 1027],
   'category_id': [5, 4, 1, 0, 0],
   'bbox': [[378.29998779296875, 657.5, 139.8000030517578, 165.10000610351562],
    [463.29998779296875, 754.5, 39.400001525878906, 30.299999237060547],
    [451.20001220703125,
     734.7999877929688,
     109.19999694824219,
     163.8000030517578],
    [140.39999389648438, 400.29998779296875, 460.8999938964844, 491.5],
    [2.299999952316284,
     322.29998779296875,
     201.6999969482422,
     429.20001220703125]],
   'iscrowd': [0, 0, 0, 0, 0],
   'area': [23080.98046875,
    1193.8199462890625,
    17886.9609375,
    226532.34375,
    86569.640625]},
  {'file_name': ['d822c383-f53a-4a2e-b2f2-3eac55c0e515.jpeg',
    'd822c383-f53a-4a2e-b2f2-3eac55c0e515.jpeg',
    'd822c383-f53a-4a2e-b2f2-3eac55c0e515.jpeg',
    'd822c383-f53a-4a2e-b2f2-3eac55c0e515.jpeg'],
   'image_id': [1092, 1092, 1092, 1092],
   'category_id': [2, 5, 1, 0],
   'bbox': [[97.80000305175781, 93.30000305175781, 177.5, 101.5999984741211],
    [342.20001220703125, 572.5999755859375, 350.0, 344.20001220703125],
    [185.1999969482422, 803.0, 304.3999938964844, 371.6000061035156],
    [219.39999389648438, 259.1000061035156, 598.7000122070312, 584.5]],
   'iscrowd': [0, 0, 0, 0],
   'area': [18034.0, 120470.0, 113115.0390625, 349940.15625]}],
 'label_source': ['manual_prodigy_label',
  'manual_prodigy_label',
  'manual_prodigy_label'],
 'image_source': ['manual_taken_photo',
  'manual_taken_photo',
  'manual_taken_photo']}</code></pre>
</details>
<p>Okay, now we get a list of <code>image</code> objects as well as a list of <code>annotation</code> dictionaries and more in the format:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"image"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">&lt;PIL.Image.Image&gt;</span><span class="ot">,</span> <span class="er">&lt;PIL.Image.Image&gt;</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"image_id"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">int</span><span class="ot">,</span> <span class="er">int</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"annotations"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"file_name"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">str</span><span class="ot">,</span> <span class="er">str</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"image_id"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">int</span><span class="ot">,</span> <span class="er">int</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"category_id"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">int</span><span class="ot">,</span> <span class="er">int</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"bbox"</span><span class="fu">:</span> <span class="ot">[[</span><span class="er">float</span><span class="ot">,</span> <span class="er">float</span><span class="ot">,</span> <span class="er">float</span><span class="ot">,</span> <span class="er">float</span><span class="ot">],</span> <span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"iscrowd"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">int</span><span class="ot">,</span> <span class="er">int</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"area"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">float</span><span class="ot">,</span> <span class="er">float</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span><span class="er">...</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span><span class="er">...</span><span class="fu">}</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"label_source"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">str</span><span class="ot">,</span> <span class="er">str</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"image_source"</span><span class="fu">:</span> <span class="ot">[</span><span class="er">str</span><span class="ot">,</span> <span class="er">str</span><span class="ot">,</span> <span class="er">...</span><span class="ot">]</span></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Knowing this structure, weâ€™ll want to write a function capable of taking it as input and then preparing it for the <code>preprocess</code> method.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our data is in this structure (a dictionary of lists, rather than a list of dictionaries) because it is built on Hugging Face Datasets and <a href="https://huggingface.co/docs/datasets/en/about_arrow">Hugging Face Datasets is built on Apache Arrow</a>.</p>
<p>And <a href="https://arrow.apache.org/">Apache Arrow</a> is column-orientated in nature.</p>
<p>So instead of our dataset being represented as many rows (list of dictionaries), it is represented as many columns (dictionary of lists).</p>
</div>
</div>
<p>The <code>preprocess</code> method expects a list of images as well as COCO formatted annotations as input.</p>
<p>So to create our <code>preprocess_batch</code> function weâ€™ll:</p>
<ol type="1">
<li>Take in a list of examples (these will be in the format above), an <code>image_processor</code> and optional <code>transforms</code> (we donâ€™t need to pass these in for now but itâ€™s good to have the option).</li>
<li>Create empty lists of <code>images</code> and <code>coco_annotations</code> weâ€™ll fill throughout the rest of the function.</li>
<li>Extract the <code>image</code>, <code>image_id</code> and <code>annotations_dict</code> from our list of input examples.</li>
<li>Create lists of annotations attributes such as <code>bbox</code>, <code>category_id</code> and <code>area</code> (these are required for our <code>format_image_annotations_as_coco</code> function.</li>
<li>Optionally perform transforms/augmentations on the image and related boxes (because in object detection if you transform an image, should transform the related boxes as well).</li>
<li>Convert the annotations into COCO format using the <code>format_image_annotations_as_coco</code> helper function we created earlier.</li>
<li>Append the images and COCO formatted annotations to the empty lists created in 2.</li>
<li>Pass the list of images and COCO formatted annotations to the <code>image_processor.preprocess</code> method to get the preprocessed batch.</li>
<li>Return the preprocessed batch.</li>
</ol>
<p>Letâ€™s do it!</p>
<div id="cell-174" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Take in a list of examples, image processor and optional transforms</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_batch(examples, </span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>                     image_processor,</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>                     transforms<span class="op">=</span><span class="va">None</span>, <span class="co"># Note: Could optionally add transforms (e.g. data augmentation) here </span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>                     ):</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Preprocesses a batch of image data with annotations for object detection models.</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a><span class="co">    This function takes a batch of examples in a custom dataset format, extracts images and</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="co">    their corresponding annotations, and converts them into a format suitable for model training</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a><span class="co">    or inference using the provided image processor.</span></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a><span class="co">        examples (dict): A dictionary containing the batch data with the following structure:</span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a><span class="co">            - "image" (List[PIL.Image.Image]): List of PIL Image objects</span></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a><span class="co">            - "image_id" (List[int]): List of unique image identifiers</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a><span class="co">            - "annotations" (List[dict]): List of annotation dictionaries, where each contains:</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a><span class="co">                - "file_name" (List[str]): List of image filenames</span></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a><span class="co">                - "image_id" (List[int]): List of image identifiers</span></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a><span class="co">                - "category_id" (List[int]): List of object category IDs</span></span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a><span class="co">                - "bbox" (List[List[float]]): List of bounding boxes as [x, y, width, height]</span></span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a><span class="co">                - "iscrowd" (List[int]): List of crowd indicators (0 or 1)</span></span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a><span class="co">                - "area" (List[float]): List of object areas</span></span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a><span class="co">            - "label_source" (List[str]): List of label sources</span></span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a><span class="co">            - "image_source" (List[str]): List of image sources</span></span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a><span class="co">        image_processor: An image processor object to preprocess images for model input.</span></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a><span class="co">            For example, can be `transformers.ConditionalDetrImageProcessor`.</span></span>
<span id="cb137-29"><a href="#cb137-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-30"><a href="#cb137-30" aria-hidden="true" tabindex="-1"></a><span class="co">        transforms (optional): Image and annotations transforms for data augmentation.</span></span>
<span id="cb137-31"><a href="#cb137-31" aria-hidden="true" tabindex="-1"></a><span class="co">            Defaults to None.</span></span>
<span id="cb137-32"><a href="#cb137-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-33"><a href="#cb137-33" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb137-34"><a href="#cb137-34" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Preprocessed batch with images and annotations converted to tensors</span></span>
<span id="cb137-35"><a href="#cb137-35" aria-hidden="true" tabindex="-1"></a><span class="co">            in the format required for a `transformers.ConditionalDetrForObjectDetection` model.</span></span>
<span id="cb137-36"><a href="#cb137-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-37"><a href="#cb137-37" aria-hidden="true" tabindex="-1"></a><span class="co">    Note:</span></span>
<span id="cb137-38"><a href="#cb137-38" aria-hidden="true" tabindex="-1"></a><span class="co">        The `format_image_annotations_as_coco` function converts the input annotation format to COCO</span></span>
<span id="cb137-39"><a href="#cb137-39" aria-hidden="true" tabindex="-1"></a><span class="co">        format before applying the image_processor. This is required as the image_processor is designed</span></span>
<span id="cb137-40"><a href="#cb137-40" aria-hidden="true" tabindex="-1"></a><span class="co">        to handle COCO format annotations. </span></span>
<span id="cb137-41"><a href="#cb137-41" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb137-42"><a href="#cb137-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Create empty lists to store images and annotations</span></span>
<span id="cb137-43"><a href="#cb137-43" aria-hidden="true" tabindex="-1"></a>    images <span class="op">=</span> []</span>
<span id="cb137-44"><a href="#cb137-44" aria-hidden="true" tabindex="-1"></a>    coco_annotations <span class="op">=</span> [] </span>
<span id="cb137-45"><a href="#cb137-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-46"><a href="#cb137-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Extract the image, image_id and annotations from the examples</span></span>
<span id="cb137-47"><a href="#cb137-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> image, image_id, annotations_dict <span class="kw">in</span> <span class="bu">zip</span>(examples[<span class="st">"image"</span>], </span>
<span id="cb137-48"><a href="#cb137-48" aria-hidden="true" tabindex="-1"></a>                                                 examples[<span class="st">"image_id"</span>], </span>
<span id="cb137-49"><a href="#cb137-49" aria-hidden="true" tabindex="-1"></a>                                                 examples[<span class="st">"annotations"</span>]):</span>
<span id="cb137-50"><a href="#cb137-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-51"><a href="#cb137-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4. Create lists of annotation attributes</span></span>
<span id="cb137-52"><a href="#cb137-52" aria-hidden="true" tabindex="-1"></a>        bbox_list <span class="op">=</span> annotations_dict[<span class="st">"bbox"</span>]</span>
<span id="cb137-53"><a href="#cb137-53" aria-hidden="true" tabindex="-1"></a>        category_list <span class="op">=</span> annotations_dict[<span class="st">"category_id"</span>]</span>
<span id="cb137-54"><a href="#cb137-54" aria-hidden="true" tabindex="-1"></a>        area_list <span class="op">=</span> annotations_dict[<span class="st">"area"</span>]</span>
<span id="cb137-55"><a href="#cb137-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-56"><a href="#cb137-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">###</span></span>
<span id="cb137-57"><a href="#cb137-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5. Note: Could optionally apply a transform/augmentation here.</span></span>
<span id="cb137-58"><a href="#cb137-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> transforms:</span>
<span id="cb137-59"><a href="#cb137-59" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Perform transform on image/boxes</span></span>
<span id="cb137-60"><a href="#cb137-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb137-61"><a href="#cb137-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">###</span></span>
<span id="cb137-62"><a href="#cb137-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-63"><a href="#cb137-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 6. Format the annotations into COCO format</span></span>
<span id="cb137-64"><a href="#cb137-64" aria-hidden="true" tabindex="-1"></a>        cooc_format_annotations <span class="op">=</span> format_image_annotations_as_coco(image_id<span class="op">=</span>image_id,</span>
<span id="cb137-65"><a href="#cb137-65" aria-hidden="true" tabindex="-1"></a>                                                                   categories<span class="op">=</span>category_list,</span>
<span id="cb137-66"><a href="#cb137-66" aria-hidden="true" tabindex="-1"></a>                                                                   areas<span class="op">=</span>area_list,</span>
<span id="cb137-67"><a href="#cb137-67" aria-hidden="true" tabindex="-1"></a>                                                                   bboxes<span class="op">=</span>bbox_list)</span>
<span id="cb137-68"><a href="#cb137-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb137-69"><a href="#cb137-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 7. Add images/annotations to their respective lists</span></span>
<span id="cb137-70"><a href="#cb137-70" aria-hidden="true" tabindex="-1"></a>        images.append(image) <span class="co"># Note: may need to open image if it is an image path rather than PIL.Image</span></span>
<span id="cb137-71"><a href="#cb137-71" aria-hidden="true" tabindex="-1"></a>        coco_annotations.append(cooc_format_annotations)</span>
<span id="cb137-72"><a href="#cb137-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-73"><a href="#cb137-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-74"><a href="#cb137-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 8. Apply the image processor to lists of images and annotations</span></span>
<span id="cb137-75"><a href="#cb137-75" aria-hidden="true" tabindex="-1"></a>    preprocessed_batch <span class="op">=</span> image_processor.preprocess(images<span class="op">=</span>images,</span>
<span id="cb137-76"><a href="#cb137-76" aria-hidden="true" tabindex="-1"></a>                                                    annotations<span class="op">=</span>coco_annotations,</span>
<span id="cb137-77"><a href="#cb137-77" aria-hidden="true" tabindex="-1"></a>                                                    return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb137-78"><a href="#cb137-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-79"><a href="#cb137-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 9. Return the preprocessed batch</span></span>
<span id="cb137-80"><a href="#cb137-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> preprocessed_batch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nice!</p>
<p>Now how about we test it out on our <code>group_of_samples</code>?</p>
<div id="cell-176" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>preprocessed_samples <span class="op">=</span> preprocess_batch(examples<span class="op">=</span>group_of_samples,</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>                                        image_processor<span class="op">=</span>image_processor)</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>preprocessed_samples.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>dict_keys(['pixel_values', 'pixel_mask', 'labels'])</code></pre>
</div>
</div>
<p>Perfect, we get the same <code>keys()</code> as with our single sample.</p>
<p>Except this time, weâ€™ve got multiple samples, letâ€™s check the shape.</p>
<div id="cell-178" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the shape of our preprocessed samples</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Shape of preprocessed samples: </span><span class="sc">{</span>preprocessed_samples[<span class="st">'pixel_values'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [batch_size, colour_channels, height, width]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Shape of preprocessed samples: torch.Size([3, 3, 640, 480]) -&gt; [batch_size, colour_channels, height, width]</code></pre>
</div>
</div>
<p>Wonderful, our batch of three samples have been preprocessed and are ready for input to our model.</p>
</section>
<section id="applying-our-preprocessing-function-to-each-data-split" class="level3" data-number="13.3">
<h3 data-number="13.3" class="anchored" data-anchor-id="applying-our-preprocessing-function-to-each-data-split"><span class="header-section-number">13.3</span> Applying our preprocessing function to each data split</h3>
<p>Weâ€™ve seen our <code>preprocess_batch</code> function in action on a small group of samples.</p>
<p>Now letâ€™s apply it to our different data splits.</p>
<p>To do so, we can call the <a href="https://huggingface.co/docs/datasets/en/package_reference/main_classes#datasets.Dataset.with_transform"><code>with_transform()</code></a> method on our target dataset split and pass it our desired <code>transform</code>.</p>
<p>Using <code>with_transform()</code> means our transformations will be applied on-the-fly when we call on our split datasets.</p>
<p>Because the <code>with_transform()</code> method expects a callable with a single argument (the input examples), weâ€™ll turn our <code>preprocess_batch</code> into a <a href="https://docs.python.org/3/library/functools.html#functools.partial">Python partial function</a>.</p>
<p>Doing this will mean we can prefill the <code>image_processor</code> and optionally the <code>transforms</code> parameter of our <code>preprocess_batch</code> function meaning it will only take <code>examples</code> as input, this is inline with the <code>with_transform()</code> method.</p>
<div id="cell-181" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a partial function for preprocessing</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Could create separate preprocess functions with different inputs depending on the split </span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g. use data augmentation on training but not on validation/test)</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>preprocess_batch_partial <span class="op">=</span> partial(preprocess_batch,</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>                                   image_processor<span class="op">=</span>image_processor,</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>                                   transforms<span class="op">=</span><span class="va">None</span>) <span class="co"># could use transforms here if wanted</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the preprocess_batch_partial function</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a><span class="co"># preprocess_batch_partial</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Beautiful, now letâ€™s pass the <code>preprocess_batch_partial</code> function to the <code>with_transform()</code> method on each of our data splits.</p>
<div id="cell-183" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a copy of the original dataset </span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (we don't need to do this, this is just so we can inspect the original dataset later on)</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>processed_dataset <span class="op">=</span> dataset.copy()</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the preprocessing function to the datasets (the preprocessing will happen on the fly, e.g. when the dataset is called rather than in-place)</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>processed_dataset[<span class="st">"train"</span>] <span class="op">=</span> dataset[<span class="st">"train"</span>].with_transform(transform<span class="op">=</span>preprocess_batch_partial)</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>processed_dataset[<span class="st">"validation"</span>] <span class="op">=</span> dataset[<span class="st">"validation"</span>].with_transform(transform<span class="op">=</span>preprocess_batch_partial)</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>processed_dataset[<span class="st">"test"</span>] <span class="op">=</span> dataset[<span class="st">"test"</span>].with_transform(transform<span class="op">=</span>preprocess_batch_partial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now when we get (via <code>__getitem__</code>) one of our samples from a <code>processed_dataset</code> split, it will be preprocessed on the fly.</p>
<div id="cell-185" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get an item from the dataset (in will be preprocessed as we get it)</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>processed_dataset[<span class="st">"train"</span>][<span class="dv">42</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>{'pixel_values': tensor([[[-1.7583, -1.1247, -1.0390,  ..., -0.6965, -0.7822, -0.4568],
          [-0.9877, -1.4158, -0.9363,  ..., -0.3712, -0.1143, -0.0801],
          [-0.9363, -0.9877, -1.0048,  ...,  0.9646,  0.3652, -0.1828],
          ...,
          [ 0.0398, -0.7479, -1.1418,  ..., -0.9192, -1.1075, -1.3987],
          [-0.0116,  0.2796, -1.0733,  ..., -1.3644, -1.4843, -1.1760],
          [-0.7308,  0.1939, -0.7479,  ..., -1.2274, -1.6555, -1.4672]],
 
         [[-1.6155, -0.9678, -0.8978,  ..., -0.6176, -0.7227, -0.3550],
          [-0.8277, -1.2829, -0.7927,  ..., -0.2850, -0.0399,  0.0126],
          [-0.7927, -0.8452, -0.8803,  ...,  1.0805,  0.4503, -0.0924],
          ...,
          [ 0.0476, -0.7752, -1.1954,  ..., -0.7402, -0.8978, -1.1429],
          [-0.0224,  0.2402, -1.1429,  ..., -1.1779, -1.2129, -0.8803],
          [-0.7752,  0.1527, -0.8277,  ..., -0.9853, -1.3529, -1.1429]],
 
         [[-1.6476, -1.0376, -1.0724,  ..., -1.0550, -1.1944, -1.0027],
          [-0.9678, -1.3513, -1.0376,  ..., -0.7587, -0.5495, -0.6193],
          [-0.9504, -1.0027, -1.1421,  ...,  0.6008, -0.1138, -0.7064],
          ...,
          [-0.4101, -0.9504, -1.2467,  ..., -1.1596, -1.2119, -1.4733],
          [-0.5321, -0.0615, -1.2119,  ..., -1.5081, -1.5604, -1.2990],
          [-1.1944, -0.2532, -0.9156,  ..., -1.4210, -1.7522, -1.5779]]]),
 'pixel_mask': tensor([[1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         ...,
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1]]),
 'labels': {'size': tensor([640, 480]), 'image_id': tensor([663]), 'class_labels': tensor([1, 5]), 'boxes': tensor([[0.6095, 0.6822, 0.3579, 0.5368],
         [0.4943, 0.4007, 0.0804, 0.0780]]), 'area': tensor([59021.8906,  1928.0699]), 'iscrowd': tensor([0, 0]), 'orig_size': tensor([1280,  960])}}</code></pre>
</div>
</div>
<p>And the same happens when we get multiple (a batch) samples!</p>
<div id="cell-187" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now when we call one or more of our samples, the preprocessing will take place</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>batch_size_to_get <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Shape of preprocessed images: </span><span class="sc">{</span>processed_dataset[<span class="st">'train'</span>][:batch_size_to_get][<span class="st">'pixel_values'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> -&gt; [batch_size, colour_channels, height, width]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Shape of preprocessed images: torch.Size([32, 3, 640, 480]) -&gt; [batch_size, colour_channels, height, width]</code></pre>
</div>
</div>
<div id="cell-188" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can pass these straight to our model! (note: may take a while if it's on CPU)</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co"># model(processed_dataset["train"][:batch_size_to_get]["pixel_values"]) # uncomment to view output</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-a-collation-function" class="level3" data-number="13.4">
<h3 data-number="13.4" class="anchored" data-anchor-id="creating-a-collation-function"><span class="header-section-number">13.4</span> Creating a collation function</h3>
<p>We now preprocess multiple samples at once.</p>
<p>Time to create a collation function which will tell our model trainer how to stack these samples together into batches.</p>
<p>We do this because processing more samples at once (e.g.&nbsp;32 samples in a batch) in a batch is generally more efficient than one sample at a time or trying to process all samples at once.</p>
<p>Our collation function will be used for the <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer#transformers.Trainer.data_collator"><code>data_collator</code> parameter</a> in our <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer"><code>transformers.Trainer</code></a> instance later on.</p>
<p>The input to our data collation function will be the output of <code>image_processor.preprocess()</code> (a preprocessed sample).</p>
<p>And the output will be passed as a batch (weâ€™ll define the batch size later on) to our modelâ€™s <a href="https://huggingface.co/docs/transformers/en/model_doc/conditional_detr#transformers.ConditionalDetrModel.forward"><code>forward()</code> method</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>What batch size should I use?</p>
<p>You should generally use the batch size which uses the maximum amount of GPU memory you have.</p>
<p>For example, if you have 16GB of GPU memory and a batch size of 32 only uses 8GB of that memory, you should try doubling the batch size to 64.</p>
<p>The ideal batch size for a given dataset/model/hardware is often discovered in an iterative process.</p>
</div>
</div>
<div id="cell-190" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Any</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> data_collate_function(preprocessed_batch: List[Dict[<span class="bu">str</span>, Any]]) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Any]:</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Stacks together groups of preprocessed samples into batches for our model.</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="co">        preprocessed_batch: A list of dictionaries where each dictionary represnets a preprocessed sample.</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a><span class="co">        collated_data: A dictionary containing the batched data ready in the format our model</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a><span class="co">            is expecting. The dictionary has the following keys: </span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a><span class="co">                - "pixel_values": A stacked tensor of preprocessed pixel values.</span></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a><span class="co">                - "labels": A list of label dictionaries.</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a><span class="co">                - "pixel_mask": (Optional) A stacked tensor of pixel masks (this will be present </span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a><span class="co">                    only if the input contains a "pixel_mask" key.</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create an empty dictionary (our model wants a dictionary input) </span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>    collated_data <span class="op">=</span> {} </span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stack together a collection of pixel_values tensors</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>    collated_data[<span class="st">"pixel_values"</span>] <span class="op">=</span> torch.stack([sample[<span class="st">"pixel_values"</span>] <span class="cf">for</span> sample <span class="kw">in</span> preprocessed_batch])</span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the labels (these are dictionaries so no need to use torch.stack)</span></span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a>    collated_data[<span class="st">"labels"</span>] <span class="op">=</span> [sample[<span class="st">"labels"</span>] <span class="cf">for</span> sample <span class="kw">in</span> preprocessed_batch]</span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If there is a pixel_mask key, return the pixel_mask's as well</span></span>
<span id="cb149-27"><a href="#cb149-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"pixel_mask"</span> <span class="kw">in</span> preprocessed_batch[<span class="dv">0</span>]:</span>
<span id="cb149-28"><a href="#cb149-28" aria-hidden="true" tabindex="-1"></a>        collated_data[<span class="st">"pixel_mask"</span>] <span class="op">=</span> torch.stack([sample[<span class="st">"pixel_mask"</span>] <span class="cf">for</span> sample <span class="kw">in</span> preprocessed_batch])</span>
<span id="cb149-29"><a href="#cb149-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-30"><a href="#cb149-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> collated_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Excellent! Now letâ€™s try out our data collation function.</p>
<div id="cell-192" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Try data_collate_function </span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>example_collated_data_batch <span class="op">=</span> data_collate_function(processed_dataset[<span class="st">"train"</span>].select(<span class="bu">range</span>(<span class="dv">32</span>)))</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>example_collated_data_batch.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.13 s, sys: 133 ms, total: 2.26 s
Wall time: 1.58 s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>dict_keys(['pixel_values', 'labels', 'pixel_mask'])</code></pre>
</div>
</div>
<p>Perfect! Looks like it worked. Weâ€™ve now got a batch of preprocessed images and label pairs.</p>
<p>Letâ€™s check the shapes.</p>
<div id="cell-194" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check shapes of batched preprocessed samples</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Batch of pixel value shapes: </span><span class="sc">{</span>example_collated_data_batch[<span class="st">'pixel_values'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Batch of labels: </span><span class="sc">{</span>example_collated_data_batch[<span class="st">'labels'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"pixel_mask"</span> <span class="kw">in</span> example_collated_data_batch:</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"[INFO] Batch of pixel masks: </span><span class="sc">{</span>example_collated_data_batch[<span class="st">'pixel_mask'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Batch of pixel value shapes: torch.Size([32, 3, 640, 480])
[INFO] Batch of labels: [{'size': tensor([640, 480]), 'image_id': tensor([69]), 'class_labels': tensor([5, 0, 1, 4, 4, 4, 4, 4]), 'boxes': tensor([[0.4675, 0.5152, 0.1846, 0.2045],
        [0.5092, 0.5843, 0.3970, 0.3951],
        [0.2719, 0.5861, 0.3738, 0.2471],
        [0.1023, 0.6896, 0.2019, 0.1655],
        [0.3902, 0.0924, 0.1530, 0.0898],
        [0.5345, 0.0871, 0.0252, 0.0556],
        [0.6370, 0.0877, 0.1357, 0.0899],
        [0.9383, 0.0634, 0.0789, 0.0627]]), 'area': tensor([11597.7402, 48180.5664, 28372.1094, 10266.5547,  4223.3750,   430.7600,
         3749.3826,  1517.7850]), 'iscrowd': tensor([0, 0, 0, 0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([1027]), 'class_labels': tensor([5, 4, 1, 0, 0]), 'boxes': tensor([[0.4669, 0.5782, 0.1456, 0.1290],
        [0.5031, 0.6013, 0.0410, 0.0237],
        [0.5269, 0.6380, 0.1138, 0.1280],
        [0.3863, 0.5047, 0.4801, 0.3840],
        [0.1074, 0.4195, 0.2101, 0.3353]]), 'area': tensor([ 5770.2451,   298.4550,  4471.7402, 56633.0859, 21642.4102]), 'iscrowd': tensor([0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([1092]), 'class_labels': tensor([2, 5, 1, 0]), 'boxes': tensor([[0.1943, 0.1126, 0.1849, 0.0794],
        [0.5387, 0.5818, 0.3646, 0.2689],
        [0.3515, 0.7725, 0.3171, 0.2903],
        [0.5404, 0.4307, 0.6236, 0.4566]]), 'area': tensor([ 4508.5000, 30117.5000, 28278.7598, 87485.0391]), 'iscrowd': tensor([0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([228]), 'class_labels': tensor([0]), 'boxes': tensor([[0.5187, 0.5418, 0.4982, 0.5698]]), 'area': tensor([87218.0078]), 'iscrowd': tensor([0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([511]), 'class_labels': tensor([5, 1]), 'boxes': tensor([[0.5284, 0.5886, 0.2903, 0.3347],
        [0.7784, 0.7873, 0.4400, 0.4222]]), 'area': tensor([29848.7695, 57066.2383]), 'iscrowd': tensor([0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([338]), 'class_labels': tensor([5, 0, 1]), 'boxes': tensor([[0.4990, 0.5424, 0.2227, 0.1716],
        [0.5455, 0.5335, 0.3754, 0.3595],
        [0.7111, 0.6979, 0.3313, 0.2838]]), 'area': tensor([11742.9648, 41455.0117, 28882.3496]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([405]), 'class_labels': tensor([0, 1, 5]), 'boxes': tensor([[0.4952, 0.6559, 0.6088, 0.4872],
        [0.2074, 0.7760, 0.4117, 0.4459],
        [0.4132, 0.5714, 0.0663, 0.0580]]), 'area': tensor([91107.9609, 56385.1602,  1179.7800]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([3]), 'class_labels': tensor([0, 5, 1, 4, 4, 4]), 'boxes': tensor([[0.5020, 0.4466, 0.6579, 0.5829],
        [0.5148, 0.5684, 0.2288, 0.1367],
        [0.7040, 0.7836, 0.4468, 0.4219],
        [0.3160, 0.8416, 0.3991, 0.2993],
        [0.4095, 0.0661, 0.0888, 0.0666],
        [0.7489, 0.1356, 0.3843, 0.2637]]), 'area': tensor([117809.1875,   9607.5000,  57901.5000,  36691.4023,   1814.7600,
         31125.9375]), 'iscrowd': tensor([0, 0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([182]), 'class_labels': tensor([0, 1, 5]), 'boxes': tensor([[0.5786, 0.5016, 0.5992, 0.4539],
        [0.6307, 0.7197, 0.4165, 0.3323],
        [0.4415, 0.6429, 0.1546, 0.2070]]), 'area': tensor([83547.7969, 42508.7344,  9827.7900]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([640]), 'class_labels': tensor([5, 1, 0]), 'boxes': tensor([[0.5314, 0.6391, 0.2920, 0.4553],
        [0.7088, 0.7733, 0.5596, 0.4422],
        [0.5282, 0.5060, 0.5678, 0.4612]]), 'area': tensor([40839.7109, 76013.7969, 80443.1328]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([1126]), 'class_labels': tensor([5, 1, 0, 0, 4]), 'boxes': tensor([[0.4897, 0.6114, 0.2720, 0.2612],
        [0.6082, 0.7287, 0.2006, 0.2145],
        [0.4549, 0.5349, 0.4550, 0.3859],
        [0.1698, 0.4514, 0.3276, 0.2998],
        [0.6611, 0.1925, 0.4202, 0.1516]]), 'area': tensor([21821.4316, 13217.1748, 53944.8008, 30168.4121, 19574.9844]), 'iscrowd': tensor([0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([902]), 'class_labels': tensor([5, 1, 0, 4]), 'boxes': tensor([[0.5237, 0.4816, 0.0443, 0.0498],
        [0.6509, 0.3957, 0.2670, 0.1695],
        [0.3200, 0.4485, 0.6094, 0.6062],
        [0.6201, 0.1730, 0.1955, 0.0725]]), 'area': tensor([   676.8125,  13904.2754, 113490.0000,   4354.6401]), 'iscrowd': tensor([0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([166]), 'class_labels': tensor([5, 1, 0, 4, 0]), 'boxes': tensor([[0.4320, 0.5441, 0.2114, 0.1963],
        [0.2735, 0.6612, 0.3580, 0.2412],
        [0.5321, 0.5080, 0.3639, 0.3277],
        [0.1142, 0.7866, 0.2067, 0.1561],
        [0.7246, 0.4182, 0.2477, 0.2401]]), 'area': tensor([12742.1201, 26533.6406, 36624.1055,  9910.0801, 18268.9844]), 'iscrowd': tensor([0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([409]), 'class_labels': tensor([0, 4, 4, 5, 1]), 'boxes': tensor([[0.3715, 0.6465, 0.7429, 0.5014],
        [0.5047, 0.6748, 0.2114, 0.1916],
        [0.1167, 0.7180, 0.2303, 0.1904],
        [0.4180, 0.6086, 0.0883, 0.0780],
        [0.3020, 0.6926, 0.3045, 0.2649]]), 'area': tensor([114432.9375,  12437.7695,  13470.5176,   2117.8799,  24779.7324]), 'iscrowd': tensor([0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([504]), 'class_labels': tensor([1, 0]), 'boxes': tensor([[0.2105, 0.6075, 0.3550, 0.2591],
        [0.4267, 0.5508, 0.5474, 0.3703]]), 'area': tensor([28260.8398, 62271.7500]), 'iscrowd': tensor([0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([1012]), 'class_labels': tensor([0, 2]), 'boxes': tensor([[0.4518, 0.4870, 0.5355, 0.5652],
        [0.9084, 0.5812, 0.1724, 0.4217]]), 'area': tensor([92987.8359, 22334.2246]), 'iscrowd': tensor([0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([769]), 'class_labels': tensor([6, 5, 0, 2]), 'boxes': tensor([[0.7015, 0.4236, 0.5892, 0.0759],
        [0.4368, 0.4307, 0.1043, 0.1327],
        [0.2781, 0.5959, 0.3932, 0.4465],
        [0.6999, 0.3721, 0.5797, 0.7238]]), 'area': tensor([ 13744.0801,   4249.2451,  53935.3125, 128899.3125]), 'iscrowd': tensor([0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([510]), 'class_labels': tensor([5, 1]), 'boxes': tensor([[0.3557, 0.4248, 0.2382, 0.1798],
        [0.6917, 0.7145, 0.6135, 0.5677]]), 'area': tensor([ 13155.9678, 106991.8516]), 'iscrowd': tensor([0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([429]), 'class_labels': tensor([4, 0, 1, 5]), 'boxes': tensor([[0.4661, 0.8003, 0.4432, 0.1715],
        [0.4992, 0.6146, 0.9984, 0.6917],
        [0.2310, 0.6193, 0.3612, 0.2520],
        [0.4227, 0.5342, 0.0790, 0.0650]]), 'area': tensor([ 23349.3125, 212163.9688,  27969.4199,   1576.6400]), 'iscrowd': tensor([0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([714]), 'class_labels': tensor([5, 1, 0]), 'boxes': tensor([[0.3350, 0.6024, 0.2067, 0.2968],
        [0.2292, 0.7662, 0.4445, 0.4472],
        [0.5794, 0.6870, 0.6228, 0.5439]]), 'area': tensor([ 18843.0391,  61060.7695, 104064.4922]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([301]), 'class_labels': tensor([5, 1, 0]), 'boxes': tensor([[0.4706, 0.5429, 0.0994, 0.0970],
        [0.2963, 0.6009, 0.3128, 0.2155],
        [0.4525, 0.4761, 0.8737, 0.6209]]), 'area': tensor([  2959.7849,  20713.1934, 166669.5625]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([816]), 'class_labels': tensor([6, 5, 0]), 'boxes': tensor([[0.7607, 0.7381, 0.4707, 0.3945],
        [0.5418, 0.5427, 0.1593, 0.1055],
        [0.4945, 0.5723, 0.5662, 0.4344]]), 'area': tensor([57052.3750,  5160.3750, 75560.3984]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([392]), 'class_labels': tensor([5, 1, 4, 4, 4]), 'boxes': tensor([[0.4599, 0.6063, 0.0836, 0.0493],
        [0.2533, 0.7866, 0.5063, 0.4221],
        [0.5349, 0.6495, 0.7540, 0.5713],
        [0.8369, 0.9173, 0.3234, 0.1632],
        [0.5333, 0.9232, 0.1924, 0.1514]]), 'area': tensor([  1266.7325,  65646.4531, 132310.6406,  16215.8623,   8948.7148]), 'iscrowd': tensor([0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([439]), 'class_labels': tensor([5, 0, 1]), 'boxes': tensor([[0.4638, 0.6099, 0.2429, 0.3724],
        [0.4283, 0.5034, 0.4528, 0.3891],
        [0.7492, 0.6229, 0.4982, 0.4316]]), 'area': tensor([27791.6094, 54120.1484, 66053.2266]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([319]), 'class_labels': tensor([5, 1, 0, 4, 4]), 'boxes': tensor([[0.4927, 0.4708, 0.1688, 0.0946],
        [0.7135, 0.5453, 0.3644, 0.2980],
        [0.4998, 0.5359, 0.6276, 0.4492],
        [0.5456, 0.8173, 0.1482, 0.1584],
        [0.4667, 0.9237, 0.1009, 0.1277]]), 'area': tensor([ 4904.5498, 33353.4297, 86609.3750,  7214.6099,  3960.7876]), 'iscrowd': tensor([0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([1106]), 'class_labels': tensor([5, 1, 4, 0]), 'boxes': tensor([[0.4597, 0.4787, 0.1184, 0.0961],
        [0.5932, 0.6244, 0.2401, 0.2405],
        [0.6587, 0.7589, 0.2219, 0.1490],
        [0.3902, 0.5373, 0.7309, 0.5996]]), 'area': tensor([  3496.2749,  17742.7383,  10154.7754, 134638.6875]), 'iscrowd': tensor([0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([763]), 'class_labels': tensor([0, 0, 0, 5, 1]), 'boxes': tensor([[0.4510, 0.5231, 0.5637, 0.4548],
        [0.7868, 0.4366, 0.4092, 0.3365],
        [0.2204, 0.4396, 0.3318, 0.3187],
        [0.5497, 0.5397, 0.2101, 0.0714],
        [0.6421, 0.6682, 0.3070, 0.2901]]), 'area': tensor([78758.1328, 42294.7383, 32479.0371,  4608.8452, 27355.5273]), 'iscrowd': tensor([0, 0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([379]), 'class_labels': tensor([5, 1]), 'boxes': tensor([[0.5053, 0.5406, 0.5852, 0.7876],
        [0.7293, 0.6370, 0.5284, 0.4556]]), 'area': tensor([141587.6406,  73964.3438]), 'iscrowd': tensor([0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([394]), 'class_labels': tensor([1, 5, 0]), 'boxes': tensor([[0.2053, 0.7470, 0.4101, 0.4966],
        [0.4299, 0.5713, 0.1728, 0.0933],
        [0.4994, 0.6560, 0.9984, 0.6693]]), 'area': tensor([ 62568.7734,   4952.1152, 205286.7344]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([665]), 'class_labels': tensor([0, 2]), 'boxes': tensor([[0.5282, 0.6071, 0.4164, 0.3630],
        [0.6520, 0.8419, 0.5095, 0.2905]]), 'area': tensor([46425.1562, 45461.8438]), 'iscrowd': tensor([0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([362]), 'class_labels': tensor([5, 1, 0]), 'boxes': tensor([[0.4643, 0.5164, 0.3293, 0.3087],
        [0.6197, 0.7712, 0.7412, 0.4446],
        [0.4982, 0.5305, 0.9742, 0.8731]]), 'area': tensor([ 31222.7773, 101242.8906, 261294.8750]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}, {'size': tensor([640, 480]), 'image_id': tensor([1019]), 'class_labels': tensor([5, 1, 0]), 'boxes': tensor([[0.4699, 0.5841, 0.2358, 0.3263],
        [0.5916, 0.6374, 0.2653, 0.2050],
        [0.4858, 0.5195, 0.6066, 0.5119]]), 'area': tensor([23641.8203, 16708.3203, 95380.7422]), 'iscrowd': tensor([0, 0, 0]), 'orig_size': tensor([1280,  960])}]
[INFO] Batch of pixel masks: torch.Size([32, 640, 480])</code></pre>
</div>
</div>
<p>Now letâ€™s try to pass the <code>"pixel_values"</code> through our model.</p>
<div id="cell-196" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time </span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Try pass a batch through our model (note: this will be relatively slow if our model is on the CPU)</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> create_model()</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="co"># example_batch_outputs = model(example_collated_data_batch["pixel_values"])</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>example_batch_outputs <span class="op">=</span> model(example_collated_data_batch[<span class="st">"pixel_values"</span>])</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="co"># example_batch_outputs # uncomment for full output</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>example_batch_outputs.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of ConditionalDetrForObjectDetection were not initialized from the model checkpoint at microsoft/conditional-detr-resnet-50 and are newly initialized because the shapes did not match:
- class_labels_classifier.bias: found shape torch.Size([91]) in the checkpoint and torch.Size([7]) in the model instantiated
- class_labels_classifier.weight: found shape torch.Size([91, 256]) in the checkpoint and torch.Size([7, 256]) in the model instantiated
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1min 13s, sys: 20.1 s, total: 1min 33s
Wall time: 7.79 s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>odict_keys(['logits', 'pred_boxes', 'last_hidden_state', 'encoder_last_hidden_state'])</code></pre>
</div>
</div>
<div id="cell-197" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We get 300 predictions per image in our batch, each with a logit value for each of the classes in our dataset </span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>example_batch_outputs.logits.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>torch.Size([32, 300, 7])</code></pre>
</div>
</div>
<p>This is what will happen during training, our model will continually go over batches (the size of these batches will be defined by us) over data and try to match its own predictions with the ground truth labels.</p>
<p>In summary, weâ€™ve created two major steps:</p>
<ol type="1">
<li><code>preprocess_batch</code> - Preprocesses single or groups of samples into the specific format required by our model.</li>
<li><code>data_collate_function</code> - Stacks together groups/batches of samples to be passed to our modelâ€™s <code>forward()</code> method.</li>
</ol>
</section>
</section>
<section id="tk---setting-up-trainingarguments-and-a-trainer-instance-to-train-our-model" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="tk---setting-up-trainingarguments-and-a-trainer-instance-to-train-our-model"><span class="header-section-number">14</span> TK - Setting up TrainingArguments and a Trainer instance to train our model</h2>
<p>Data ready and prepared, time to train a model!</p>
<p>Weâ€™ll use <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer#transformers.TrainingArguments"><code>transformers.TrainingArguments</code></a> to set various hyperparameters for our model (many of these will be set by default, however, we can tweak them to our liking).</p>
<p>Weâ€™ll also create an instance of <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer"><code>transformers.Trainer</code></a> which we can pass our preprocessed datasets for it to train/evaluate on.</p>
<p>To train a model, weâ€™ll go through the following steps:</p>
<ol type="1">
<li>Create a fresh instance of our model using the <code>create_model()</code> function.</li>
<li>Make a directory for saving our trained models to.</li>
<li>Define our modelâ€™s hyperparameters using <code>transformers.TrainingArguments</code>, weâ€™ll take many of these settings from the assosciated research papers that introduced the models.</li>
<li>Create an instance of <code>transformers.Trainer</code> and pass it our training arguments from 2 as well as our preprocessed data.</li>
<li>Call <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer#transformers.Trainer.train"><code>transformers.Trainer.train()</code></a> to train the model from 1 on our own data.</li>
</ol>
<p>Letâ€™s do it!</p>
<div id="cell-200" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Create a model instance </span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> create_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of ConditionalDetrForObjectDetection were not initialized from the model checkpoint at microsoft/conditional-detr-resnet-50 and are newly initialized because the shapes did not match:
- class_labels_classifier.bias: found shape torch.Size([91]) in the checkpoint and torch.Size([7]) in the model instantiated
- class_labels_classifier.weight: found shape torch.Size([91, 256]) in the checkpoint and torch.Size([7, 256]) in the model instantiated
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</code></pre>
</div>
</div>
<p>Model ready, letâ€™s now create a folder where we can save our trained models to.</p>
<div id="cell-202" class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Make a models directory for saving models</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>models_dir <span class="op">=</span> Path(<span class="st">"models"</span>)</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>models_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perfect! Time to setup our modelâ€™s hyperparameters with <code>transformers.TrainingArguments</code>.</p>
<section id="setting-up-our-trainingarguments" class="level3" data-number="14.1">
<h3 data-number="14.1" class="anchored" data-anchor-id="setting-up-our-trainingarguments"><span class="header-section-number">14.1</span> Setting up our TrainingArguments</h3>
<p>The <code>transformers.TrainingArguments</code> class holds many of the hyperparameters/settings for training our model.</p>
<p>Many of them are set by default in the <a href="https://huggingface.co/docs/transformers/en/model_doc/conditional_detr#transformers.ConditionalDetrConfig"><code>transformers.ConditionalDetrConfig</code></a> class.</p>
<p>However, we can tweak any of them to our own liking.</p>
<p>Where do we get the settings from?</p>
<p>The original <a href="https://arxiv.org/abs/2108.06152"><em>Conditional DETR for fast training convergence</em></a> paper states that all hyperparameters are the same as the original DETR (<a href="https://arxiv.org/abs/2005.12872"><em>End-to-End Object Detection with Transformers</em></a>).</p>
<p>We can even dig into related papers such as <a href="https://arxiv.org/abs/2304.08069"><em>DETRs Beat YOLOs on Real-time Object Detection</em></a> and find the hyperaparameter settings as well.</p>
<p>The main hyperparameters we are going to set are:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Hyperparameter</strong></th>
<th><strong>Value</strong></th>
<th><strong>What does it do?</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>per_device_train_batch_size</code>, <code>per_device_eval_batch_size</code></td>
<td><code>16</code>, <code>32</code> or larger (hardware dependent)</td>
<td>Defines the number of samples passed to our model at one time. For example, if batch size is 16, our model will see 16 samples at a time. Itâ€™s usually best practice to set this value to the highest your hardware can handle.</td>
</tr>
<tr class="even">
<td><code>learning_rate</code></td>
<td><code>0.0001</code> (as per the listed papers)</td>
<td>Defines the multiplier on the size of gradient updates during training. Too high and gradients will explode, too low and gradients wonâ€™t update, both lead to poor training results. The papers mention two different learning rates for the backbone and the detection head, I tried these and got poor results (likely because of our smaller dataset), a single learning rate for the whole network turned out to be better.</td>
</tr>
<tr class="odd">
<td><code>weight_decay</code></td>
<td><code>0.0001</code> (as per the listed papers)</td>
<td>Prevents model weights from getting too large by applying a small decay penalty over time. This prevents a single weight providing too much information. In essence, the model is forced to learn smaller, simpler weights to represent the data. A form of regularization (overfitting prevention). See more at <a href="https://paperswithcode.com/method/weight-decay">paperswithcode.com/method/weight-decay</a>.</td>
</tr>
<tr class="even">
<td><code>max_grad_norm</code></td>
<td><code>0.1</code> (as per the listed papers)</td>
<td>Prevents gradients from getting too large during training. This will help to ensure stable training. See more at <a href="https://paperswithcode.com/method/gradient-clipping">paperswithcode.com/method/gradient-clipping</a>.</td>
</tr>
<tr class="odd">
<td><code>num_train_epochs</code></td>
<td><code>25</code> (depends on training data and available time)</td>
<td>Defines how many laps of the data your model will do. For example, setting epochs to 25 means the model will do 25 laps of the training data to learn different patterns. In practice, Iâ€™ve found this value to be a good starting point for our dataset and also because we are fine-tuning rather than training from scratch. However, if you had more data you might want to do more epochs (when training from scratch, the papers did 300 epochs).</td>
</tr>
<tr class="even">
<td><code>warmup_ratio</code></td>
<td><code>0.05</code></td>
<td>Percentage of total training steps to take learning rate from <code>0</code> to to the set value (e.g.&nbsp;<code>0.0001</code>). Can help with training stability in the early training steps of the model by not doing too large updates when first starting out. The papers state <code>2000</code> warmup steps, however, in practice I found this to be too many for our smaller dataset.</td>
</tr>
<tr class="odd">
<td><code>dataloader_num_workers</code></td>
<td><code>4</code> (hardware dependent)</td>
<td>Number of workers to load data from the CPU to the GPU. Higher is generally better if it is available, however, it can often cap out. Experimentally Iâ€™ve found that <code>0.5 * os.cpu_count()</code> generally works well.</td>
</tr>
</tbody>
</table>
<p>TK image - showcase different papers referencing the hyperparameters for the models</p>
<p>Itâ€™s important to note that all of these values can be experimented with.</p>
<p>And just because a research paper mentions a specific value, doesnâ€™t mean you have to use.</p>
<p>For example, all the mentioned research papers tend to focus on training a model from scratch on the COCO dataset (330k images, 80 classes).</p>
<p>Which is a much larger dataset with more classes than our dataset (1k images, 7 classes) which we are trying to fine-tune an existing model on rather than train from scratch.</p>
<p>There are many more possible arguments/settings weâ€™ve left out in the above table but if youâ€™d like to explore these, Iâ€™d encourage you to check out the documentation for <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer#transformers.TrainingArguments"><code>transformers.TrainingArguments</code></a>.</p>
<div id="cell-205" class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> TrainingArguments</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Hardware dependent hyperparameters</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the batch size according to the memory you have available on your GPU</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. on my NVIDIA RTX 4090 with 24GB of VRAM, I can use a batch size of 32 </span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="co"># without running out of memory</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>DATALOADER_NUM_WORKERS <span class="op">=</span> <span class="dv">4</span> <span class="co"># note: if you're on Google Colab, you may have to lower this to os.cpu_count() or to 0 </span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Set number of epochs to how many laps you'd like to do over the data</span></span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>NUM_EPOCHS <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup hyperameters for training from the DETR paper(s)</span></span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a>WEIGHT_DECAY <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>MAX_GRAD_NORM <span class="op">=</span> <span class="fl">0.1</span> </span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a>WARMUP_RATIO <span class="op">=</span> <span class="fl">0.05</span> <span class="co"># learning rate warmup from 0 to learning_rate as a ratio of total steps (e.g. 0.05 = 5% of total steps)</span></span>
<span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create directory to save models to </span></span>
<span id="cb164-20"><a href="#cb164-20" aria-hidden="true" tabindex="-1"></a>OUTPUT_DIR <span class="op">=</span> Path(models_dir, <span class="st">"detr_finetuned_trashify_box_detector_v1"</span>)</span>
<span id="cb164-21"><a href="#cb164-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Saving model to: </span><span class="sc">{</span>OUTPUT_DIR<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb164-22"><a href="#cb164-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-23"><a href="#cb164-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create TrainingArguments to pass to Trainer</span></span>
<span id="cb164-24"><a href="#cb164-24" aria-hidden="true" tabindex="-1"></a>training_args <span class="op">=</span> TrainingArguments(</span>
<span id="cb164-25"><a href="#cb164-25" aria-hidden="true" tabindex="-1"></a>    output_dir<span class="op">=</span>OUTPUT_DIR,</span>
<span id="cb164-26"><a href="#cb164-26" aria-hidden="true" tabindex="-1"></a>    per_device_train_batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb164-27"><a href="#cb164-27" aria-hidden="true" tabindex="-1"></a>    per_device_eval_batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb164-28"><a href="#cb164-28" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span>LEARNING_RATE,</span>
<span id="cb164-29"><a href="#cb164-29" aria-hidden="true" tabindex="-1"></a>    weight_decay<span class="op">=</span>WEIGHT_DECAY,</span>
<span id="cb164-30"><a href="#cb164-30" aria-hidden="true" tabindex="-1"></a>    max_grad_norm<span class="op">=</span>GRAD_NORM,</span>
<span id="cb164-31"><a href="#cb164-31" aria-hidden="true" tabindex="-1"></a>    num_train_epochs<span class="op">=</span>NUM_EPOCHS,</span>
<span id="cb164-32"><a href="#cb164-32" aria-hidden="true" tabindex="-1"></a>    lr_scheduler_type<span class="op">=</span><span class="st">"linear"</span>,</span>
<span id="cb164-33"><a href="#cb164-33" aria-hidden="true" tabindex="-1"></a>    warmup_ratio<span class="op">=</span>WARMUP_RATIO, </span>
<span id="cb164-34"><a href="#cb164-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># warmup_steps=2000, # number of warmup steps from 0 to learning_rate (overrides warmup_ratio, found this to be too long for our dataset)</span></span>
<span id="cb164-35"><a href="#cb164-35" aria-hidden="true" tabindex="-1"></a>    logging_strategy<span class="op">=</span><span class="st">"epoch"</span>,</span>
<span id="cb164-36"><a href="#cb164-36" aria-hidden="true" tabindex="-1"></a>    save_strategy<span class="op">=</span><span class="st">"epoch"</span>,</span>
<span id="cb164-37"><a href="#cb164-37" aria-hidden="true" tabindex="-1"></a>    save_total_limit<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb164-38"><a href="#cb164-38" aria-hidden="true" tabindex="-1"></a>    remove_unused_columns<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb164-39"><a href="#cb164-39" aria-hidden="true" tabindex="-1"></a>    fp16<span class="op">=</span><span class="va">True</span>, <span class="co"># use mixed precision training</span></span>
<span id="cb164-40"><a href="#cb164-40" aria-hidden="true" tabindex="-1"></a>    dataloader_num_workers<span class="op">=</span>NUM_WORKERS, <span class="co"># note: if you're on Google Colab, you may have to lower this to os.cpu_count() or to 0</span></span>
<span id="cb164-41"><a href="#cb164-41" aria-hidden="true" tabindex="-1"></a>    eval_strategy<span class="op">=</span><span class="st">"epoch"</span>,</span>
<span id="cb164-42"><a href="#cb164-42" aria-hidden="true" tabindex="-1"></a>    metric_for_best_model<span class="op">=</span><span class="st">"eval_loss"</span>,</span>
<span id="cb164-43"><a href="#cb164-43" aria-hidden="true" tabindex="-1"></a>    greater_is_better<span class="op">=</span><span class="va">False</span>, <span class="co"># want to minimize eval_loss (e.g. lower is better)</span></span>
<span id="cb164-44"><a href="#cb164-44" aria-hidden="true" tabindex="-1"></a>    report_to<span class="op">=</span><span class="st">"none"</span>, <span class="co"># don't save experiments to a third party service</span></span>
<span id="cb164-45"><a href="#cb164-45" aria-hidden="true" tabindex="-1"></a>    push_to_hub<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb164-46"><a href="#cb164-46" aria-hidden="true" tabindex="-1"></a>    eval_do_concat_batches<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb164-47"><a href="#cb164-47" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Saving model to: models/detr_finetuned_trashify_box_detector_v1</code></pre>
</div>
</div>
<div id="cell-206" class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: You might notice a different learning rate for the backbone and detection head in the papers, however,</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># When I tried these settings with our use case, they did not work. So I opted for a single learning rate value across the whole model.</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Create a custom optimizer for using different learning rates for different parts of the model</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="co"># In my experiments with our smaller dataset size, I've found this doesn't work as well as just setting the whole model to the same learning rate</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> Trainer</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>backbone_parameters <span class="op">=</span> []</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>other_parameters <span class="op">=</span> []</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Can loop through model parameters and extract different model sections</span></span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, param <span class="kw">in</span> model.model.named_parameters(): </span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"backbone"</span> <span class="kw">in</span> name:</span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Backbone parameter: {name}")</span></span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>        backbone_parameters.append(param)</span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Other parameter: {name}")</span></span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a>        other_parameters.append(param)</span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Number of backbone parameters: </span><span class="sc">{</span><span class="bu">len</span>(backbone_parameters)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Number of other parameters: </span><span class="sc">{</span><span class="bu">len</span>(other_parameters)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomTrainer(Trainer):</span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_optimizer(<span class="va">self</span>):</span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.optimizer <span class="op">=</span> torch.optim.AdamW([</span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"params"</span>: backbone_parameters, <span class="st">"lr"</span>: <span class="fl">1e-4</span>},</span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"params"</span>: other_parameters, <span class="st">"lr"</span>: <span class="fl">1e-4</span>}</span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>        ], weight_decay<span class="op">=</span><span class="fl">0.0001</span>)</span>
<span id="cb166-29"><a href="#cb166-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.optimizer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Number of backbone parameters: 53
[INFO] Number of other parameters: 315</code></pre>
</div>
</div>
<div id="cell-207" class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Depending on the size/speed of your GPU, this may take a while</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> Trainer</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>model_v1_trainer <span class="op">=</span> Trainer(</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model,</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>    args<span class="op">=</span>training_args,</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>    train_dataset<span class="op">=</span>processed_dataset[<span class="st">"train"</span>],</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>    eval_dataset<span class="op">=</span>processed_dataset[<span class="st">"validation"</span>],</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># data_collator=DefaultDataCollator(),</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tokenizer=image_processor,</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>    data_collator<span class="op">=</span>data_collate_function,</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute_metrics=None # </span><span class="al">TODO</span><span class="co">: TK - can add a metrics function, just see if model trains first, see here for an example: https://github.com/huggingface/transformers/blob/336dc69d63d56f232a183a3e7f52790429b871ef/examples/pytorch/object-detection/run_object_detection.py#L160 </span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>model_v1_results <span class="op">=</span> model_v1_trainer.train()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="537" max="625" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [537/625 04:16 &lt; 00:42, 2.09 it/s, Epoch 21.44/25]
    </div>
    
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>55.902400</td>
<td>16.134087</td>
</tr>
<tr class="even">
<td>2</td>
<td>6.125900</td>
<td>2.918935</td>
</tr>
<tr class="odd">
<td>3</td>
<td>2.436500</td>
<td>1.802156</td>
</tr>
<tr class="even">
<td>4</td>
<td>2.035200</td>
<td>1.735817</td>
</tr>
<tr class="odd">
<td>5</td>
<td>1.778500</td>
<td>1.557681</td>
</tr>
<tr class="even">
<td>6</td>
<td>1.703300</td>
<td>1.481651</td>
</tr>
<tr class="odd">
<td>7</td>
<td>1.575100</td>
<td>1.362348</td>
</tr>
<tr class="even">
<td>8</td>
<td>1.498500</td>
<td>1.300032</td>
</tr>
<tr class="odd">
<td>9</td>
<td>1.427300</td>
<td>1.279454</td>
</tr>
<tr class="even">
<td>10</td>
<td>1.365100</td>
<td>1.238343</td>
</tr>
<tr class="odd">
<td>11</td>
<td>1.298300</td>
<td>1.155103</td>
</tr>
<tr class="even">
<td>12</td>
<td>1.276600</td>
<td>1.128650</td>
</tr>
<tr class="odd">
<td>13</td>
<td>1.279800</td>
<td>1.094205</td>
</tr>
<tr class="even">
<td>14</td>
<td>1.167100</td>
<td>1.065403</td>
</tr>
<tr class="odd">
<td>15</td>
<td>1.179500</td>
<td>1.051846</td>
</tr>
<tr class="even">
<td>16</td>
<td>1.166200</td>
<td>1.031210</td>
</tr>
<tr class="odd">
<td>17</td>
<td>1.071700</td>
<td>1.008407</td>
</tr>
<tr class="even">
<td>18</td>
<td>1.076600</td>
<td>0.979133</td>
</tr>
<tr class="odd">
<td>19</td>
<td>1.006300</td>
<td>0.964392</td>
</tr>
<tr class="even">
<td>20</td>
<td>1.023700</td>
<td>0.965398</td>
</tr>
<tr class="odd">
<td>21</td>
<td>1.011000</td>
<td>0.967340</td>
</tr>
</tbody>
</table>
<p>
</p></div>
</div>
<ul>
<li>UPTOHERE: going through training steps and making sure we end with a model training</li>
<li>TK - if your loss values arenâ€™t the exact same, this is because of the randomness of machine learning, whatâ€™s important is that the direction is similar (e.g.&nbsp;loss going down)</li>
</ul>
<div id="cell-209" class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># seed=42, run 2, default settings</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="co"># seed=42, run 1, default settings</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Epoch Training Loss   Validation Loss</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 55.916800   16.268129</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 6.227300    2.916497</span></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 2.469300    2.022190</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 2.050000    1.777625</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 1.801600    1.497011</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 1.678200    1.465757</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 1.555500    1.356617</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 1.477100    1.282081</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 1.398100    1.273000</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 10    1.355700    1.229947</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 11    1.285300    1.205468</span></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 12    1.273100    1.128895</span></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 13    1.230600    1.094062</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 14    1.150400    1.063713</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 15    1.156200    1.070942</span></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 16    1.145200    1.052388</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 17    1.067300    1.021973</span></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 18    1.070400    0.999381</span></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 19    0.990000    0.966365</span></span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 20    1.012800    0.968811</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 21    0.990300    0.963048</span></span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 22    0.966200    0.950254</span></span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 23    0.953800    0.959737</span></span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 24    0.939200    0.948964</span></span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 25    0.927800    0.943143</span></span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a><span class="co"># No seed, default settings</span></span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Epoch Training Loss   Validation Loss</span></span>
<span id="cb169-33"><a href="#cb169-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 55.930900   16.391504</span></span>
<span id="cb169-34"><a href="#cb169-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 6.233600    2.633428</span></span>
<span id="cb169-35"><a href="#cb169-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 2.347700    2.013041</span></span>
<span id="cb169-36"><a href="#cb169-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 1.930700    1.615997</span></span>
<span id="cb169-37"><a href="#cb169-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 1.778200    1.448657</span></span>
<span id="cb169-38"><a href="#cb169-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 1.575800    1.372047</span></span>
<span id="cb169-39"><a href="#cb169-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 1.514900    1.375154</span></span>
<span id="cb169-40"><a href="#cb169-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 1.471600    1.285519</span></span>
<span id="cb169-41"><a href="#cb169-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 1.374200    1.217744</span></span>
<span id="cb169-42"><a href="#cb169-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 10    1.315600    1.182054</span></span>
<span id="cb169-43"><a href="#cb169-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 11    1.275600    1.134078</span></span>
<span id="cb169-44"><a href="#cb169-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 12    1.272000    1.107145</span></span>
<span id="cb169-45"><a href="#cb169-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 13    1.271600    1.107490</span></span>
<span id="cb169-46"><a href="#cb169-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 14    1.171700    1.079192</span></span>
<span id="cb169-47"><a href="#cb169-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 15    1.185200    1.039839</span></span>
<span id="cb169-48"><a href="#cb169-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 16    1.144900    1.021868</span></span>
<span id="cb169-49"><a href="#cb169-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 17    1.080000    1.012836</span></span>
<span id="cb169-50"><a href="#cb169-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 18    1.086100    0.993412</span></span>
<span id="cb169-51"><a href="#cb169-51" aria-hidden="true" tabindex="-1"></a><span class="co"># 19    1.009800    0.964021</span></span>
<span id="cb169-52"><a href="#cb169-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 20    1.040600    0.960465</span></span>
<span id="cb169-53"><a href="#cb169-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 21    1.030300    0.935562</span></span>
<span id="cb169-54"><a href="#cb169-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 22    1.006100    0.935101</span></span>
<span id="cb169-55"><a href="#cb169-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 23    0.992000    0.929327</span></span>
<span id="cb169-56"><a href="#cb169-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 24    0.972200    0.929375</span></span>
<span id="cb169-57"><a href="#cb169-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 25    0.964000    0.926712</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>TK - Plot loss curves</li>
<li>TK - Note: May get an error at the beginning where a box is predicted a negative output. This will break training as boxes are expected to be positive floats.</li>
</ul>
</section>
</section>
<section id="tk---making-predictions-on-the-test-dataset" class="level2" data-number="15">
<h2 data-number="15" class="anchored" data-anchor-id="tk---making-predictions-on-the-test-dataset"><span class="header-section-number">15</span> TK - Making predictions on the test dataset</h2>
<div id="cell-212" class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>processed_dataset[<span class="st">"test"</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>{'pixel_values': tensor([[[-0.9705, -0.7308, -0.9705,  ..., -1.8953, -1.8268, -1.3130],
          [-1.2959, -0.9363, -0.3883,  ..., -1.8953, -1.7240, -0.5596],
          [-1.4843, -1.1418, -0.1999,  ..., -1.8782, -1.2788, -0.5424],
          ...,
          [ 1.3242,  1.3242,  1.3413,  ..., -0.6452, -0.2856, -0.9877],
          [ 1.3070,  1.3584,  1.4098,  ..., -0.8678,  0.0398, -0.4911],
          [ 1.2728,  1.3413,  1.4098,  ..., -0.9705,  0.1768, -0.1657]],
 
         [[-0.5476, -0.3550, -0.6527,  ..., -1.7031, -1.6155, -1.0903],
          [-0.8803, -0.5476, -0.0399,  ..., -1.6856, -1.5280, -0.3200],
          [-1.0728, -0.7402,  0.1527,  ..., -1.6506, -1.0553, -0.3025],
          ...,
          [-1.7031, -1.7031, -1.6856,  ..., -0.3901,  0.0301, -0.7227],
          [-1.7206, -1.6681, -1.6155,  ..., -0.6176,  0.3803, -0.1800],
          [-1.7556, -1.6856, -1.6155,  ..., -0.7052,  0.5203,  0.1527]],
 
         [[-1.0550, -0.7064, -0.8284,  ..., -1.6824, -1.5953, -1.0201],
          [-1.3861, -0.9504, -0.2881,  ..., -1.6999, -1.4559, -0.2532],
          [-1.6476, -1.1944, -0.1661,  ..., -1.6650, -1.0376, -0.2881],
          ...,
          [-1.2641, -1.2641, -1.2467,  ..., -0.9504, -0.8284, -1.2293],
          [-1.2816, -1.2293, -1.1770,  ..., -1.1596, -0.5321, -1.0027],
          [-1.3164, -1.2467, -1.1770,  ..., -1.3513, -0.4973, -0.8981]]]),
 'pixel_mask': tensor([[1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         ...,
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1],
         [1, 1, 1,  ..., 1, 1, 1]]),
 'labels': {'size': tensor([640, 480]), 'image_id': tensor([61]), 'class_labels': tensor([4, 5, 1, 0]), 'boxes': tensor([[0.2104, 0.8563, 0.2855, 0.2720],
         [0.4194, 0.4927, 0.2398, 0.1785],
         [0.3610, 0.6227, 0.2706, 0.2330],
         [0.4974, 0.4785, 0.3829, 0.3820]]), 'area': tensor([23860.4043, 13150.1748, 19368.0898, 44929.9102]), 'iscrowd': tensor([0, 0, 0, 0]), 'orig_size': tensor([1280,  960])}}</code></pre>
</div>
</div>
<div id="cell-213" class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions with trainer containing trained model</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>test_dataset_preds <span class="op">=</span> model_v1_trainer.predict(test_dataset<span class="op">=</span>processed_dataset[<span class="st">"test"</span>])</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="co"># test_dataset_preds</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
</div>
<div id="cell-214" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the logits</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>test_pred_logits <span class="op">=</span> test_dataset_preds.predictions[<span class="dv">0</span>][<span class="dv">1</span>]</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the boxes</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>test_pred_boxes <span class="op">=</span> test_dataset_preds.predictions[<span class="dv">0</span>][<span class="dv">2</span>]</span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the label IDs</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>test_pred_label_ids <span class="op">=</span> test_dataset_preds.label_ids</span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Check shapes</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>test_pred_logits.shape, test_pred_boxes.shape, <span class="bu">len</span>(test_pred_label_ids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="144">
<pre><code>((32, 300, 7), (32, 300, 4), 7)</code></pre>
</div>
</div>
<div id="cell-215" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a random sample from the test preds</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>random_test_pred_index <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="bu">len</span>(processed_dataset[<span class="st">"test"</span>]))</span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Making predictions on test item with index: </span><span class="sc">{</span>random_test_pred_index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>random_test_sample <span class="op">=</span> processed_dataset[<span class="st">"test"</span>][random_test_pred_index]</span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Do a single forward pass with the model</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>random_test_sample_outputs <span class="op">=</span> model(pixel_values<span class="op">=</span>random_test_sample[<span class="st">"pixel_values"</span>].unsqueeze(<span class="dv">0</span>).to(<span class="st">"cuda"</span>), <span class="co"># model expects input [batch_size, color_channels, height, width]</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>                                   pixel_mask<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a><span class="co"># random_test_sample_outputs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Making predictions on test item with index: 163
CPU times: user 47.6 ms, sys: 0 ns, total: 47.6 ms
Wall time: 48.4 ms</code></pre>
</div>
</div>
<div id="cell-216" class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># image_processor.preprocess?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>TK - if your predictions arenâ€™t the exact same, this is because of the randomness of machine learning, whatâ€™s important is that the direction is similar</p>
<div id="cell-218" class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a random sample from the test preds</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>random_test_pred_index <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="bu">len</span>(processed_dataset[<span class="st">"test"</span>]))</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Making predictions on test item with index: </span><span class="sc">{</span>random_test_pred_index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>random_test_sample <span class="op">=</span> processed_dataset[<span class="st">"test"</span>][random_test_pred_index]</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # Do a single forward pass with the model</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>random_test_sample_outputs <span class="op">=</span> model(pixel_values<span class="op">=</span>random_test_sample[<span class="st">"pixel_values"</span>].unsqueeze(<span class="dv">0</span>).to(<span class="st">"cuda"</span>), <span class="co"># model expects input [batch_size, color_channels, height, width]</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>                                   pixel_mask<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Post process a random item from test preds</span></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>random_test_sample_outputs_post_processed <span class="op">=</span> image_processor.post_process_object_detection(</span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>random_test_sample_outputs,</span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>    threshold<span class="op">=</span><span class="fl">0.2</span>, <span class="co"># prediction probability threshold for boxes (note: boxes from an untrained model will likely be bad)</span></span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>    target_sizes<span class="op">=</span>[random_test_sample[<span class="st">"labels"</span>][<span class="st">"orig_size"</span>]] <span class="co"># original input image size (or whichever target size you'd like), required to be same number of input items in a list</span></span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-18"><a href="#cb178-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the random sample test preds</span></span>
<span id="cb178-19"><a href="#cb178-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract scores, labels and boxes</span></span>
<span id="cb178-20"><a href="#cb178-20" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_scores <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"scores"</span>]</span>
<span id="cb178-21"><a href="#cb178-21" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_labels <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"labels"</span>]</span>
<span id="cb178-22"><a href="#cb178-22" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_boxes <span class="op">=</span> half_boxes(random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"boxes"</span>])</span>
<span id="cb178-23"><a href="#cb178-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-24"><a href="#cb178-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of labels to plot on the boxes </span></span>
<span id="cb178-25"><a href="#cb178-25" aria-hidden="true" tabindex="-1"></a><span class="co"># TK - Update the colours here</span></span>
<span id="cb178-26"><a href="#cb178-26" aria-hidden="true" tabindex="-1"></a>random_test_sample_labels_to_plot <span class="op">=</span> [<span class="ss">f"Pred: </span><span class="sc">{</span>id2label[label_pred.item()]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score_pred.item(), <span class="dv">4</span>)<span class="sc">}</span><span class="ss">)"</span> </span>
<span id="cb178-27"><a href="#cb178-27" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> label_pred, score_pred <span class="kw">in</span> <span class="bu">zip</span>(random_test_sample_pred_labels, random_test_sample_pred_scores)]</span>
<span id="cb178-28"><a href="#cb178-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-29"><a href="#cb178-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Labels with scores: </span><span class="sc">{</span>random_test_sample_labels_to_plot<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb178-30"><a href="#cb178-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-31"><a href="#cb178-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted boxes on the random test image </span></span>
<span id="cb178-32"><a href="#cb178-32" aria-hidden="true" tabindex="-1"></a>to_pil_image(</span>
<span id="cb178-33"><a href="#cb178-33" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb178-34"><a href="#cb178-34" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>half_image(dataset[<span class="st">"test"</span>][random_test_pred_index][<span class="st">"image"</span>])),</span>
<span id="cb178-35"><a href="#cb178-35" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>random_test_sample_pred_boxes,</span>
<span id="cb178-36"><a href="#cb178-36" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_test_sample_labels_to_plot,</span>
<span id="cb178-37"><a href="#cb178-37" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">3</span></span>
<span id="cb178-38"><a href="#cb178-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb178-39"><a href="#cb178-39" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Making predictions on test item with index: 28
[INFO] Labels with scores: ['Pred: bin (0.293)', 'Pred: hand (0.2896)', 'Pred: not_trash (0.2511)', 'Pred: bin (0.2476)', 'Pred: not_trash (0.2362)', 'Pred: trash (0.2208)', 'Pred: bin (0.2012)']</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="147">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-93-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>TK - nice!!! these boxes look far better than our randomly predicted boxes with an untrained modelâ€¦</p>
<section id="tk---predict-on-image-from-filepath" class="level3" data-number="15.1">
<h3 data-number="15.1" class="anchored" data-anchor-id="tk---predict-on-image-from-filepath"><span class="header-section-number">15.1</span> TK - Predict on image from filepath</h3>
<div id="cell-221" class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pred on image from pathname</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>path_to_test_image_folder <span class="op">=</span> Path(<span class="st">"data/trashify_test_images"</span>)</span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>test_image_filepaths <span class="op">=</span> <span class="bu">list</span>(path_to_test_image_folder.rglob(<span class="st">"*.jp*g"</span>))</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>test_image_targ_filepath <span class="op">=</span> random.choice(test_image_filepaths)</span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a><span class="co"># test_image_targ_filepath = "data/trashify_test_images/IMG_6692.jpeg"</span></span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>test_image_pil <span class="op">=</span> Image.<span class="bu">open</span>(test_image_targ_filepath)</span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>test_image_preprocessed <span class="op">=</span> image_processor.preprocess(images<span class="op">=</span>test_image_pil,</span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>                                                     return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_image_dimensions_from_pil(image: Image.Image) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert the dimensions of a PIL image to a PyTorch tensor in the order (height, width).</span></span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a><span class="co">        image (Image.Image): The input PIL image.</span></span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a><span class="co">        torch.Tensor: A tensor containing the height and width of the image.</span></span>
<span id="cb180-21"><a href="#cb180-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb180-22"><a href="#cb180-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get (width, height) of image (PIL.Image.size returns width, height)</span></span>
<span id="cb180-23"><a href="#cb180-23" aria-hidden="true" tabindex="-1"></a>    width, height <span class="op">=</span> image.size</span>
<span id="cb180-24"><a href="#cb180-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-25"><a href="#cb180-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to a tensor in the order (height, width)</span></span>
<span id="cb180-26"><a href="#cb180-26" aria-hidden="true" tabindex="-1"></a>    image_dimensions_tensor <span class="op">=</span> torch.tensor([height, width])</span>
<span id="cb180-27"><a href="#cb180-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-28"><a href="#cb180-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image_dimensions_tensor</span>
<span id="cb180-29"><a href="#cb180-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-30"><a href="#cb180-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Get image original size</span></span>
<span id="cb180-31"><a href="#cb180-31" aria-hidden="true" tabindex="-1"></a>test_image_size <span class="op">=</span> get_image_dimensions_from_pil(image<span class="op">=</span>test_image_pil)</span>
<span id="cb180-32"><a href="#cb180-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-33"><a href="#cb180-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions on the preprocessed image</span></span>
<span id="cb180-34"><a href="#cb180-34" aria-hidden="true" tabindex="-1"></a>random_test_sample_outputs <span class="op">=</span> model(pixel_values<span class="op">=</span>test_image_preprocessed[<span class="st">"pixel_values"</span>].to(<span class="st">"cuda"</span>), <span class="co"># model expects input [batch_size, color_channels, height, width]</span></span>
<span id="cb180-35"><a href="#cb180-35" aria-hidden="true" tabindex="-1"></a>                                   pixel_mask<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb180-36"><a href="#cb180-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-37"><a href="#cb180-37" aria-hidden="true" tabindex="-1"></a>THRESHOLD <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb180-38"><a href="#cb180-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-39"><a href="#cb180-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Post process the predictions</span></span>
<span id="cb180-40"><a href="#cb180-40" aria-hidden="true" tabindex="-1"></a>random_test_sample_outputs_post_processed <span class="op">=</span> image_processor.post_process_object_detection(</span>
<span id="cb180-41"><a href="#cb180-41" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>random_test_sample_outputs,</span>
<span id="cb180-42"><a href="#cb180-42" aria-hidden="true" tabindex="-1"></a>    threshold<span class="op">=</span>THRESHOLD,</span>
<span id="cb180-43"><a href="#cb180-43" aria-hidden="true" tabindex="-1"></a>    target_sizes<span class="op">=</span>[test_image_size] <span class="co"># needs to be same length as batch dimension of the logits (e.g. [[height, width]])</span></span>
<span id="cb180-44"><a href="#cb180-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb180-45"><a href="#cb180-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-46"><a href="#cb180-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract scores, labels and boxes</span></span>
<span id="cb180-47"><a href="#cb180-47" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_scores <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"scores"</span>]</span>
<span id="cb180-48"><a href="#cb180-48" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_labels <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"labels"</span>]</span>
<span id="cb180-49"><a href="#cb180-49" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_boxes <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"boxes"</span>]</span>
<span id="cb180-50"><a href="#cb180-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-51"><a href="#cb180-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a lsit of labels to plot on the boxes </span></span>
<span id="cb180-52"><a href="#cb180-52" aria-hidden="true" tabindex="-1"></a>random_test_sample_labels_to_plot <span class="op">=</span> [<span class="ss">f"Pred: </span><span class="sc">{</span>id2label[label_pred.item()]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score_pred.item(), <span class="dv">4</span>)<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb180-53"><a href="#cb180-53" aria-hidden="true" tabindex="-1"></a>                                     <span class="cf">for</span> label_pred, score_pred <span class="kw">in</span> <span class="bu">zip</span>(random_test_sample_pred_labels, random_test_sample_pred_scores)]</span>
<span id="cb180-54"><a href="#cb180-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-55"><a href="#cb180-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"[INFO] Labels with scores:"</span>)</span>
<span id="cb180-56"><a href="#cb180-56" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> random_test_sample_labels_to_plot:</span>
<span id="cb180-57"><a href="#cb180-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(item)</span>
<span id="cb180-58"><a href="#cb180-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-59"><a href="#cb180-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted boxes on the random test image </span></span>
<span id="cb180-60"><a href="#cb180-60" aria-hidden="true" tabindex="-1"></a>to_pil_image(</span>
<span id="cb180-61"><a href="#cb180-61" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb180-62"><a href="#cb180-62" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>test_image_pil),                    </span>
<span id="cb180-63"><a href="#cb180-63" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>random_test_sample_pred_boxes,</span>
<span id="cb180-64"><a href="#cb180-64" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_test_sample_labels_to_plot,</span>
<span id="cb180-65"><a href="#cb180-65" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">3</span></span>
<span id="cb180-66"><a href="#cb180-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb180-67"><a href="#cb180-67" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">IndexError</span>                                Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[105], line 6</span>
<span class="ansi-green-fg ansi-bold">      4</span> path_to_test_image_folder <span style="color:rgb(98,98,98)">=</span> Path(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">data/trashify_test_images</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">      5</span> test_image_filepaths <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">list</span>(path_to_test_image_folder<span style="color:rgb(98,98,98)">.</span>rglob(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">*.jp*g</span><span style="color:rgb(175,0,0)">"</span>))
<span class="ansi-green-fg">----&gt; 6</span> test_image_targ_filepath <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">random</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">choice</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">test_image_filepaths</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      7</span> <span style="font-style:italic;color:rgb(95,135,135)"># test_image_targ_filepath = "data/trashify_test_images/IMG_6692.jpeg"</span>
<span class="ansi-green-fg ansi-bold">      8</span> test_image_pil <span style="color:rgb(98,98,98)">=</span> Image<span style="color:rgb(98,98,98)">.</span>open(test_image_targ_filepath)

File <span class="ansi-green-fg">~/miniconda3/envs/ai/lib/python3.11/random.py:373</span>, in <span class="ansi-cyan-fg">Random.choice</span><span class="ansi-blue-fg">(self, seq)</span>
<span class="ansi-green-fg ansi-bold">    370</span> <span style="font-style:italic;color:rgb(95,135,135)"># As an accommodation for NumPy, we don't use "if not seq"</span>
<span class="ansi-green-fg ansi-bold">    371</span> <span style="font-style:italic;color:rgb(95,135,135)"># because bool(numpy.array()) raises a ValueError.</span>
<span class="ansi-green-fg ansi-bold">    372</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">len</span>(seq):
<span class="ansi-green-fg">--&gt; 373</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">IndexError</span>(<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Cannot choose from an empty sequence</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg ansi-bold">    374</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> seq[<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_randbelow(<span style="color:rgb(0,135,0)">len</span>(seq))]

<span class="ansi-red-fg">IndexError</span>: Cannot choose from an empty sequence</pre>
</div>
</div>
</div>
</section>
</section>
<section id="tk---upload-our-trained-model-to-hugging-face-hub" class="level2" data-number="16">
<h2 data-number="16" class="anchored" data-anchor-id="tk---upload-our-trained-model-to-hugging-face-hub"><span class="header-section-number">16</span> TK - Upload our trained model to Hugging Face Hub</h2>
<p>TK - Letâ€™s make our model available for others to use.</p>
<div id="cell-223" class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TK</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Make extensions to make the model better... (e.g. data augmentation = harder training set = better overall validation loss)</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with data augmentation</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with longer training (e.g. 100 epochs) </span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Research eval_do_concat_batches=False/True &amp; see what the results do...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-224" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the model</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: update this save path so we know when the model was saved and what its parameters were</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>training_epochs_ <span class="op">=</span> training_args.num_train_epochs</span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>learning_rate_ <span class="op">=</span> <span class="st">"</span><span class="sc">{:.0e}</span><span class="st">"</span>.<span class="bu">format</span>(training_args.learning_rate)</span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>model_save_path <span class="op">=</span> <span class="ss">f"models/learn_hf_microsoft_detr_finetuned_trashify_box_dataset_only_manual_data_no_aug_</span><span class="sc">{</span>training_epochs_<span class="sc">}</span><span class="ss">_epochs_lr_</span><span class="sc">{</span>learning_rate_<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Saving model to: </span><span class="sc">{</span>model_save_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>model_v1_trainer.save_model(model_save_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Saving model to: models/learn_hf_microsoft_detr_finetuned_trashify_box_dataset_only_manual_data_no_aug_25_epochs_lr_1e-04</code></pre>
</div>
</div>
<div id="cell-225" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Push the model to the hub</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: this will require you to have your Hugging Face account setup </span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>model_v1_trainer.push_to_hub(commit_message<span class="op">=</span><span class="st">"upload trashify object detection model"</span>,</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># token=None # Optional to add a token manually</span></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>                    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a7fff4958f1046088387ea08ef67f7ae","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3697686114864827ae609ce445e1b916","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"15fb1db183b9482c97190244ab07ccd3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>CommitInfo(commit_url='https://huggingface.co/mrdbourke/detr_finetuned_trashify_box_detector/commit/ab273cec67e5124ac047dc1e068c379c718e6c37', commit_message='upload trashify object detection model', commit_description='', oid='ab273cec67e5124ac047dc1e068c379c718e6c37', pr_url=None, repo_url=RepoUrl('https://huggingface.co/mrdbourke/detr_finetuned_trashify_box_detector', endpoint='https://huggingface.co', repo_type='model', repo_id='mrdbourke/detr_finetuned_trashify_box_detector'), pr_revision=None, pr_num=None)</code></pre>
</div>
</div>
</section>
<section id="creating-a-demo-of-our-model-with-gradio" class="level2" data-number="17">
<h2 data-number="17" class="anchored" data-anchor-id="creating-a-demo-of-our-model-with-gradio"><span class="header-section-number">17</span> Creating a demo of our model with Gradio</h2>
<div id="cell-227" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector<span class="op">/</span>README.md</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>title: Trashify Demo V1 ðŸš®</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>emoji: ðŸ—‘ï¸</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>colorFrom: purple</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>colorTo: blue</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>sdk: gradio</span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>sdk_version: <span class="fl">4.40.0</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>app_file: app.py</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>pinned: false</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>license: apache<span class="op">-</span><span class="fl">2.0</span></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ðŸš® Trashify Object Detector V1 </span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>Object detection demo to detect `trash`, `bin`, `hand`, `trash_arm`, `not_trash`, `not_bin`, `not_hand`. </span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>Used <span class="im">as</span> example <span class="cf">for</span> encouraging people to cleanup their local area.</span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a>If `trash`, `hand`, `bin` <span class="bu">all</span> detected <span class="op">=</span> <span class="op">+</span><span class="dv">1</span> point.</span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a><span class="co">## Dataset</span></span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a>All Trashify models are trained on a custom hand<span class="op">-</span>labelled dataset of people picking up trash <span class="kw">and</span> placing it <span class="kw">in</span> a <span class="bu">bin</span>.</span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a>The dataset can be found on Hugging Face <span class="im">as</span> [`mrdbourke<span class="op">/</span>trashify_manual_labelled_images`](https:<span class="op">//</span>huggingface.co<span class="op">/</span>datasets<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_manual_labelled_images).</span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a><span class="co">## Demos</span></span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V1](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v1) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span>without<span class="op">*</span> data augmentation.</span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V2](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v2) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span><span class="cf">with</span><span class="op">*</span> data augmentation.</span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V3](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v3) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span><span class="cf">with</span><span class="op">*</span> data augmentation (same <span class="im">as</span> V2) <span class="cf">with</span> an NMS (Non Maximum Suppression) post<span class="op">-</span>processing step.</span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a>TK <span class="op">-</span> add links to resources to learn more</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector/README.md</code></pre>
</div>
</div>
<div id="cell-228" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector<span class="op">/</span>requirements.txt</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>timm</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>gradio</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>torch</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>transformers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector/requirements.txt</code></pre>
</div>
</div>
<div id="cell-229" class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector<span class="op">/</span>app.py</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image, ImageDraw, ImageFont</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoImageProcessor</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForObjectDetection</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Can load from Hugging Face or can load from local </span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>model_save_path <span class="op">=</span> <span class="st">"mrdbourke/detr_finetuned_trashify_box_detector"</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model and preprocessor</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>image_processor <span class="op">=</span> AutoImageProcessor.from_pretrained(model_save_path)</span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForObjectDetection.from_pretrained(model_save_path)</span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the id2label dictionary from the model</span></span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>id2label <span class="op">=</span> model.config.id2label</span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a colour dictionary for plotting boxes with different colours</span></span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>color_dict <span class="op">=</span> {   </span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bin"</span>: <span class="st">"green"</span>,</span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trash"</span>: <span class="st">"blue"</span>,</span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hand"</span>: <span class="st">"purple"</span>,</span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trash_arm"</span>: <span class="st">"yellow"</span>,</span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_trash"</span>: <span class="st">"red"</span>,</span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_bin"</span>: <span class="st">"red"</span>,</span>
<span id="cb190-30"><a href="#cb190-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_hand"</span>: <span class="st">"red"</span>,</span>
<span id="cb190-31"><a href="#cb190-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb190-32"><a href="#cb190-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-33"><a href="#cb190-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Create helper functions for seeing if items from one list are in another </span></span>
<span id="cb190-34"><a href="#cb190-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> any_in_list(list_a, list_b):</span>
<span id="cb190-35"><a href="#cb190-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns True if any item from list_a is in list_b, otherwise False."</span></span>
<span id="cb190-36"><a href="#cb190-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">any</span>(item <span class="kw">in</span> list_b <span class="cf">for</span> item <span class="kw">in</span> list_a)</span>
<span id="cb190-37"><a href="#cb190-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-38"><a href="#cb190-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_in_list(list_a, list_b):</span>
<span id="cb190-39"><a href="#cb190-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns True if all items from list_a are in list_b, otherwise False."</span></span>
<span id="cb190-40"><a href="#cb190-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">all</span>(item <span class="kw">in</span> list_b <span class="cf">for</span> item <span class="kw">in</span> list_a)</span>
<span id="cb190-41"><a href="#cb190-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-42"><a href="#cb190-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_on_image(image, conf_threshold):</span>
<span id="cb190-43"><a href="#cb190-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb190-44"><a href="#cb190-44" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> image_processor(images<span class="op">=</span>[image], return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb190-45"><a href="#cb190-45" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(<span class="op">**</span>inputs.to(device))</span>
<span id="cb190-46"><a href="#cb190-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-47"><a href="#cb190-47" aria-hidden="true" tabindex="-1"></a>        target_sizes <span class="op">=</span> torch.tensor([[image.size[<span class="dv">1</span>], image.size[<span class="dv">0</span>]]]) <span class="co"># height, width </span></span>
<span id="cb190-48"><a href="#cb190-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-49"><a href="#cb190-49" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> image_processor.post_process_object_detection(outputs,</span>
<span id="cb190-50"><a href="#cb190-50" aria-hidden="true" tabindex="-1"></a>                                                                threshold<span class="op">=</span>conf_threshold,</span>
<span id="cb190-51"><a href="#cb190-51" aria-hidden="true" tabindex="-1"></a>                                                                target_sizes<span class="op">=</span>target_sizes)[<span class="dv">0</span>]</span>
<span id="cb190-52"><a href="#cb190-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return all items in results to CPU</span></span>
<span id="cb190-53"><a href="#cb190-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> results.items():</span>
<span id="cb190-54"><a href="#cb190-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb190-55"><a href="#cb190-55" aria-hidden="true" tabindex="-1"></a>            results[key] <span class="op">=</span> value.item().cpu() <span class="co"># can't get scalar as .item() so add try/except block</span></span>
<span id="cb190-56"><a href="#cb190-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb190-57"><a href="#cb190-57" aria-hidden="true" tabindex="-1"></a>            results[key] <span class="op">=</span> value.cpu()</span>
<span id="cb190-58"><a href="#cb190-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-59"><a href="#cb190-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Can return results as plotted on a PIL image (then display the image)</span></span>
<span id="cb190-60"><a href="#cb190-60" aria-hidden="true" tabindex="-1"></a>    draw <span class="op">=</span> ImageDraw.Draw(image)</span>
<span id="cb190-61"><a href="#cb190-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-62"><a href="#cb190-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a font from ImageFont</span></span>
<span id="cb190-63"><a href="#cb190-63" aria-hidden="true" tabindex="-1"></a>    font <span class="op">=</span> ImageFont.load_default(size<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb190-64"><a href="#cb190-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-65"><a href="#cb190-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get class names as text for print out</span></span>
<span id="cb190-66"><a href="#cb190-66" aria-hidden="true" tabindex="-1"></a>    class_name_text_labels <span class="op">=</span> []</span>
<span id="cb190-67"><a href="#cb190-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-68"><a href="#cb190-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> box, score, label <span class="kw">in</span> <span class="bu">zip</span>(results[<span class="st">"boxes"</span>], results[<span class="st">"scores"</span>], results[<span class="st">"labels"</span>]):</span>
<span id="cb190-69"><a href="#cb190-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create coordinates</span></span>
<span id="cb190-70"><a href="#cb190-70" aria-hidden="true" tabindex="-1"></a>        x, y, x2, y2 <span class="op">=</span> <span class="bu">tuple</span>(box.tolist())</span>
<span id="cb190-71"><a href="#cb190-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-72"><a href="#cb190-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get label_name</span></span>
<span id="cb190-73"><a href="#cb190-73" aria-hidden="true" tabindex="-1"></a>        label_name <span class="op">=</span> id2label[label.item()]</span>
<span id="cb190-74"><a href="#cb190-74" aria-hidden="true" tabindex="-1"></a>        targ_color <span class="op">=</span> color_dict[label_name]</span>
<span id="cb190-75"><a href="#cb190-75" aria-hidden="true" tabindex="-1"></a>        class_name_text_labels.append(label_name)</span>
<span id="cb190-76"><a href="#cb190-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-77"><a href="#cb190-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the rectangle</span></span>
<span id="cb190-78"><a href="#cb190-78" aria-hidden="true" tabindex="-1"></a>        draw.rectangle(xy<span class="op">=</span>(x, y, x2, y2), </span>
<span id="cb190-79"><a href="#cb190-79" aria-hidden="true" tabindex="-1"></a>                       outline<span class="op">=</span>targ_color,</span>
<span id="cb190-80"><a href="#cb190-80" aria-hidden="true" tabindex="-1"></a>                       width<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb190-81"><a href="#cb190-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb190-82"><a href="#cb190-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a text string to display</span></span>
<span id="cb190-83"><a href="#cb190-83" aria-hidden="true" tabindex="-1"></a>        text_string_to_show <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>label_name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score.item(), <span class="dv">3</span>)<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb190-84"><a href="#cb190-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-85"><a href="#cb190-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the text on the image</span></span>
<span id="cb190-86"><a href="#cb190-86" aria-hidden="true" tabindex="-1"></a>        draw.text(xy<span class="op">=</span>(x, y),</span>
<span id="cb190-87"><a href="#cb190-87" aria-hidden="true" tabindex="-1"></a>                  text<span class="op">=</span>text_string_to_show,</span>
<span id="cb190-88"><a href="#cb190-88" aria-hidden="true" tabindex="-1"></a>                  fill<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb190-89"><a href="#cb190-89" aria-hidden="true" tabindex="-1"></a>                  font<span class="op">=</span>font)</span>
<span id="cb190-90"><a href="#cb190-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-91"><a href="#cb190-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the draw each time</span></span>
<span id="cb190-92"><a href="#cb190-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> draw</span>
<span id="cb190-93"><a href="#cb190-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-94"><a href="#cb190-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup blank string to print out</span></span>
<span id="cb190-95"><a href="#cb190-95" aria-hidden="true" tabindex="-1"></a>    return_string <span class="op">=</span> <span class="st">""</span></span>
<span id="cb190-96"><a href="#cb190-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-97"><a href="#cb190-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup list of target items to discover</span></span>
<span id="cb190-98"><a href="#cb190-98" aria-hidden="true" tabindex="-1"></a>    target_items <span class="op">=</span> [<span class="st">"trash"</span>, <span class="st">"bin"</span>, <span class="st">"hand"</span>]</span>
<span id="cb190-99"><a href="#cb190-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-100"><a href="#cb190-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no items detected or trash, bin, hand not in list, return notification </span></span>
<span id="cb190-101"><a href="#cb190-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">len</span>(class_name_text_labels) <span class="op">==</span> <span class="dv">0</span>) <span class="kw">or</span> <span class="kw">not</span> (any_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>class_name_text_labels)):</span>
<span id="cb190-102"><a href="#cb190-102" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"No trash, bin or hand detected at confidence threshold </span><span class="sc">{</span>conf_threshold<span class="sc">}</span><span class="ss">. Try another image or lowering the confidence threshold."</span></span>
<span id="cb190-103"><a href="#cb190-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, return_string</span>
<span id="cb190-104"><a href="#cb190-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-105"><a href="#cb190-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If there are some missing, print the ones which are missing</span></span>
<span id="cb190-106"><a href="#cb190-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="kw">not</span> all_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>class_name_text_labels):</span>
<span id="cb190-107"><a href="#cb190-107" aria-hidden="true" tabindex="-1"></a>        missing_items <span class="op">=</span> []</span>
<span id="cb190-108"><a href="#cb190-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> target_items:</span>
<span id="cb190-109"><a href="#cb190-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> item <span class="kw">not</span> <span class="kw">in</span> class_name_text_labels:</span>
<span id="cb190-110"><a href="#cb190-110" aria-hidden="true" tabindex="-1"></a>                missing_items.append(item)</span>
<span id="cb190-111"><a href="#cb190-111" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"Detected the following items: </span><span class="sc">{</span>class_name_text_labels<span class="sc">}</span><span class="ss">. But missing the following in order to get +1: </span><span class="sc">{</span>missing_items<span class="sc">}</span><span class="ss">. If this is an error, try another image or altering the confidence threshold. Otherwise, the model may need to be updated with better data."</span></span>
<span id="cb190-112"><a href="#cb190-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb190-113"><a href="#cb190-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If all 3 trash, bin, hand occur = + 1</span></span>
<span id="cb190-114"><a href="#cb190-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> all_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>class_name_text_labels):</span>
<span id="cb190-115"><a href="#cb190-115" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"+1! Found the following items: </span><span class="sc">{</span>class_name_text_labels<span class="sc">}</span><span class="ss">, thank you for cleaning up the area!"</span></span>
<span id="cb190-116"><a href="#cb190-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-117"><a href="#cb190-117" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(return_string)</span>
<span id="cb190-118"><a href="#cb190-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-119"><a href="#cb190-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image, return_string</span>
<span id="cb190-120"><a href="#cb190-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-121"><a href="#cb190-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the interface</span></span>
<span id="cb190-122"><a href="#cb190-122" aria-hidden="true" tabindex="-1"></a>demo <span class="op">=</span> gr.Interface(</span>
<span id="cb190-123"><a href="#cb190-123" aria-hidden="true" tabindex="-1"></a>    fn<span class="op">=</span>predict_on_image,</span>
<span id="cb190-124"><a href="#cb190-124" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span>[</span>
<span id="cb190-125"><a href="#cb190-125" aria-hidden="true" tabindex="-1"></a>        gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">"pil"</span>, label<span class="op">=</span><span class="st">"Target Image"</span>),</span>
<span id="cb190-126"><a href="#cb190-126" aria-hidden="true" tabindex="-1"></a>        gr.Slider(minimum<span class="op">=</span><span class="dv">0</span>, maximum<span class="op">=</span><span class="dv">1</span>, value<span class="op">=</span><span class="fl">0.25</span>, label<span class="op">=</span><span class="st">"Confidence Threshold"</span>)</span>
<span id="cb190-127"><a href="#cb190-127" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb190-128"><a href="#cb190-128" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>[</span>
<span id="cb190-129"><a href="#cb190-129" aria-hidden="true" tabindex="-1"></a>        gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">"pil"</span>, label<span class="op">=</span><span class="st">"Image Output"</span>),</span>
<span id="cb190-130"><a href="#cb190-130" aria-hidden="true" tabindex="-1"></a>        gr.Text(label<span class="op">=</span><span class="st">"Text Output"</span>)</span>
<span id="cb190-131"><a href="#cb190-131" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb190-132"><a href="#cb190-132" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"ðŸš® Trashify Object Detection Demo V1"</span>,</span>
<span id="cb190-133"><a href="#cb190-133" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"Help clean up your local area! Upload an image and get +1 if there is all of the following items detected: trash, bin, hand."</span>,</span>
<span id="cb190-134"><a href="#cb190-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Examples come in the form of a list of lists, where each inner list contains elements to prefill the `inputs` parameter with</span></span>
<span id="cb190-135"><a href="#cb190-135" aria-hidden="true" tabindex="-1"></a>    examples<span class="op">=</span>[</span>
<span id="cb190-136"><a href="#cb190-136" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_1.jpeg"</span>, <span class="fl">0.25</span>],</span>
<span id="cb190-137"><a href="#cb190-137" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_2.jpeg"</span>, <span class="fl">0.25</span>],</span>
<span id="cb190-138"><a href="#cb190-138" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_3.jpeg"</span>, <span class="fl">0.25</span>],</span>
<span id="cb190-139"><a href="#cb190-139" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb190-140"><a href="#cb190-140" aria-hidden="true" tabindex="-1"></a>    cache_examples<span class="op">=</span><span class="va">True</span></span>
<span id="cb190-141"><a href="#cb190-141" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb190-142"><a href="#cb190-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-143"><a href="#cb190-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch the demo</span></span>
<span id="cb190-144"><a href="#cb190-144" aria-hidden="true" tabindex="-1"></a>demo.launch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector/app.py</code></pre>
</div>
</div>
<section id="tk---upload-demo-to-hugging-face-spaces-to-get-it-live" class="level3" data-number="17.1">
<h3 data-number="17.1" class="anchored" data-anchor-id="tk---upload-demo-to-hugging-face-spaces-to-get-it-live"><span class="header-section-number">17.1</span> TK - Upload demo to Hugging Face Spaces to get it live</h3>
<div id="cell-231" class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Import the required methods for uploading to the Hugging Face Hub</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> huggingface_hub <span class="im">import</span> (</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    create_repo,</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    get_full_repo_name,</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>    upload_file, <span class="co"># for uploading a single file (if necessary)</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    upload_folder <span class="co"># for uploading multiple files (in a folder)</span></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Define the parameters we'd like to use for the upload</span></span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD <span class="op">=</span> <span class="st">"demos/trashify_object_detector"</span> <span class="co"># TK - update this path </span></span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>HF_TARGET_SPACE_NAME <span class="op">=</span> <span class="st">"trashify_demo_v1"</span></span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>HF_REPO_TYPE <span class="op">=</span> <span class="st">"space"</span> <span class="co"># we're creating a Hugging Face Space</span></span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a>HF_SPACE_SDK <span class="op">=</span> <span class="st">"gradio"</span></span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a>HF_TOKEN <span class="op">=</span> <span class="st">""</span> <span class="co"># optional: set to your Hugging Face token (but I'd advise storing this as an environment variable as previously discussed)</span></span>
<span id="cb192-15"><a href="#cb192-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-16"><a href="#cb192-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Create a Space repository on Hugging Face Hub </span></span>
<span id="cb192-17"><a href="#cb192-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Creating repo on Hugging Face Hub with name: </span><span class="sc">{</span>HF_TARGET_SPACE_NAME<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb192-18"><a href="#cb192-18" aria-hidden="true" tabindex="-1"></a>create_repo(</span>
<span id="cb192-19"><a href="#cb192-19" aria-hidden="true" tabindex="-1"></a>    repo_id<span class="op">=</span>HF_TARGET_SPACE_NAME,</span>
<span id="cb192-20"><a href="#cb192-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># token=HF_TOKEN, # optional: set token manually (though it will be automatically recognized if it's available as an environment variable)</span></span>
<span id="cb192-21"><a href="#cb192-21" aria-hidden="true" tabindex="-1"></a>    repo_type<span class="op">=</span>HF_REPO_TYPE,</span>
<span id="cb192-22"><a href="#cb192-22" aria-hidden="true" tabindex="-1"></a>    private<span class="op">=</span><span class="va">False</span>, <span class="co"># set to True if you don't want your Space to be accessible to others</span></span>
<span id="cb192-23"><a href="#cb192-23" aria-hidden="true" tabindex="-1"></a>    space_sdk<span class="op">=</span>HF_SPACE_SDK,</span>
<span id="cb192-24"><a href="#cb192-24" aria-hidden="true" tabindex="-1"></a>    exist_ok<span class="op">=</span><span class="va">True</span>, <span class="co"># set to False if you want an error to raise if the repo_id already exists </span></span>
<span id="cb192-25"><a href="#cb192-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb192-26"><a href="#cb192-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-27"><a href="#cb192-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Get the full repository name (e.g. {username}/{model_id} or {username}/{space_name})</span></span>
<span id="cb192-28"><a href="#cb192-28" aria-hidden="true" tabindex="-1"></a>full_hf_repo_name <span class="op">=</span> get_full_repo_name(model_id<span class="op">=</span>HF_TARGET_SPACE_NAME)</span>
<span id="cb192-29"><a href="#cb192-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Full Hugging Face Hub repo name: </span><span class="sc">{</span>full_hf_repo_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb192-30"><a href="#cb192-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-31"><a href="#cb192-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Upload our demo folder</span></span>
<span id="cb192-32"><a href="#cb192-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Uploading </span><span class="sc">{</span>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD<span class="sc">}</span><span class="ss"> to repo: </span><span class="sc">{</span>full_hf_repo_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb192-33"><a href="#cb192-33" aria-hidden="true" tabindex="-1"></a>folder_upload_url <span class="op">=</span> upload_folder(</span>
<span id="cb192-34"><a href="#cb192-34" aria-hidden="true" tabindex="-1"></a>    repo_id<span class="op">=</span>full_hf_repo_name,</span>
<span id="cb192-35"><a href="#cb192-35" aria-hidden="true" tabindex="-1"></a>    folder_path<span class="op">=</span>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD,</span>
<span id="cb192-36"><a href="#cb192-36" aria-hidden="true" tabindex="-1"></a>    path_in_repo<span class="op">=</span><span class="st">"."</span>, <span class="co"># upload our folder to the root directory ("." means "base" or "root", this is the default)</span></span>
<span id="cb192-37"><a href="#cb192-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># token=HF_TOKEN, # optional: set token manually</span></span>
<span id="cb192-38"><a href="#cb192-38" aria-hidden="true" tabindex="-1"></a>    repo_type<span class="op">=</span>HF_REPO_TYPE,</span>
<span id="cb192-39"><a href="#cb192-39" aria-hidden="true" tabindex="-1"></a>    commit_message<span class="op">=</span><span class="st">"Uploading Trashify box detection model app.py"</span></span>
<span id="cb192-40"><a href="#cb192-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb192-41"><a href="#cb192-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Demo folder successfully uploaded with commit URL: </span><span class="sc">{</span>folder_upload_url<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Creating repo on Hugging Face Hub with name: trashify_demo_v1
[INFO] Full Hugging Face Hub repo name: mrdbourke/trashify_demo_v1
[INFO] Uploading demos/trashify_object_detector to repo: mrdbourke/trashify_demo_v1
[INFO] Demo folder successfully uploaded with commit URL: https://huggingface.co/spaces/mrdbourke/trashify_demo_v1/tree/main/.</code></pre>
</div>
</div>
<p>TK - see the demo here: https://huggingface.co/spaces/mrdbourke/trashify_demo_v1</p>
</section>
<section id="tk---testing-the-hosted-demo" class="level3" data-number="17.2">
<h3 data-number="17.2" class="anchored" data-anchor-id="tk---testing-the-hosted-demo"><span class="header-section-number">17.2</span> TK - Testing the hosted demo</h3>
<div id="cell-234" class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a><span class="co"># You can get embeddable HTML code for your demo by clicking the "Embed" button on the demo page</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>HTML(data<span class="op">=</span><span class="st">'''</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;iframe</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a><span class="st">    src="https://mrdbourke-trashify-demo-v1.hf.space"</span></span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a><span class="st">    frameborder="0"</span></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a><span class="st">    width="850"</span></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a><span class="st">    height="1000"</span></span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a><span class="st">&gt;&lt;/iframe&gt;     </span></span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">

<iframe src="https://mrdbourke-trashify-demo-v1.hf.space" frameborder="0" width="850" height="1000"></iframe>     
</div>
</div>
</section>
</section>
<section id="tk---improve-our-model-with-data-augmentation" class="level2" data-number="18">
<h2 data-number="18" class="anchored" data-anchor-id="tk---improve-our-model-with-data-augmentation"><span class="header-section-number">18</span> TK - Improve our model with data augmentation</h2>
<p>UPTOHERE - Read for object detection augmentation (keep it simple) - Check out the papers for detection augmentation - Train a model with data augmentation - Compare the modelâ€™s metrics between data augmentation and no data augmentation</p>
<section id="load-dataset" class="level3" data-number="18.1">
<h3 data-number="18.1" class="anchored" data-anchor-id="load-dataset"><span class="header-section-number">18.1</span> Load dataset</h3>
<div id="cell-237" class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load_dataset?</span></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> load_dataset(path<span class="op">=</span><span class="st">"mrdbourke/trashify_manual_labelled_images"</span>)</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Length of original dataset: </span><span class="sc">{</span><span class="bu">len</span>(dataset[<span class="st">'train'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the data</span></span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>dataset_split <span class="op">=</span> dataset[<span class="st">"train"</span>].train_test_split(test_size<span class="op">=</span><span class="fl">0.3</span>, seed<span class="op">=</span><span class="dv">42</span>) <span class="co"># split the dataset into 70/30 train/test</span></span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>dataset_test_val_split <span class="op">=</span> dataset_split[<span class="st">"test"</span>].train_test_split(test_size<span class="op">=</span><span class="fl">0.6</span>, seed<span class="op">=</span><span class="dv">42</span>) <span class="co"># split the test set into 40/60 validation/test</span></span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create splits</span></span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>dataset[<span class="st">"train"</span>] <span class="op">=</span> dataset_split[<span class="st">"train"</span>]</span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>dataset[<span class="st">"validation"</span>] <span class="op">=</span> dataset_test_val_split[<span class="st">"train"</span>]</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>dataset[<span class="st">"test"</span>] <span class="op">=</span> dataset_test_val_split[<span class="st">"test"</span>]</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Length of original dataset: 1128</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['image', 'image_id', 'annotations', 'label_source', 'image_source'],
        num_rows: 789
    })
    validation: Dataset({
        features: ['image', 'image_id', 'annotations', 'label_source', 'image_source'],
        num_rows: 135
    })
    test: Dataset({
        features: ['image', 'image_id', 'annotations', 'label_source', 'image_source'],
        num_rows: 204
    })
})</code></pre>
</div>
</div>
<div id="cell-238" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the categories from the dataset</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: this requires the dataset to have been uploaded with this feature setup</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>categories <span class="op">=</span> dataset[<span class="st">"train"</span>].features[<span class="st">"annotations"</span>].feature[<span class="st">"category_id"</span>]</span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the names attribute</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>categories.names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="110">
<pre><code>['bin', 'hand', 'not_bin', 'not_hand', 'not_trash', 'trash', 'trash_arm']</code></pre>
</div>
</div>
<div id="cell-239" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>id2label <span class="op">=</span> {i: class_name <span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(categories.names)}</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>label2id <span class="op">=</span> {value: key <span class="cf">for</span> key, value <span class="kw">in</span> id2label.items()}</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>id2label, label2id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="111">
<pre><code>({0: 'bin',
  1: 'hand',
  2: 'not_bin',
  3: 'not_hand',
  4: 'not_trash',
  5: 'trash',
  6: 'trash_arm'},
 {'bin': 0,
  'hand': 1,
  'not_bin': 2,
  'not_hand': 3,
  'not_trash': 4,
  'trash': 5,
  'trash_arm': 6})</code></pre>
</div>
</div>
<div id="cell-240" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View a random sample</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>random_idx <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="bu">len</span>(dataset[<span class="st">"train"</span>]))</span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>random_sample <span class="op">=</span> dataset[<span class="st">"train"</span>][random_idx]</span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>random_sample</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>{'image': &lt;PIL.Image.Image image mode=RGB size=960x1280&gt;,
 'image_id': 955,
 'annotations': {'file_name': ['ed8cb1ab-2882-4ab7-a839-c53fa2908a72.jpeg',
   'ed8cb1ab-2882-4ab7-a839-c53fa2908a72.jpeg',
   'ed8cb1ab-2882-4ab7-a839-c53fa2908a72.jpeg',
   'ed8cb1ab-2882-4ab7-a839-c53fa2908a72.jpeg'],
  'image_id': [955, 955, 955, 955],
  'category_id': [5, 1, 0, 4],
  'bbox': [[464.79998779296875, 625.5999755859375, 68.30000305175781, 92.5],
   [483.0, 686.2000122070312, 173.0, 247.3000030517578],
   [102.80000305175781, 361.70001220703125, 813.5, 734.0],
   [325.29998779296875,
    716.5999755859375,
    189.60000610351562,
    215.3000030517578]],
  'iscrowd': [0, 0, 0, 0],
  'area': [6317.75, 42782.8984375, 597109.0, 40820.87890625]},
 'label_source': 'manual_prodigy_label',
 'image_source': 'manual_taken_photo'}</code></pre>
</div>
</div>
</section>
<section id="setup-model" class="level3" data-number="18.2">
<h3 data-number="18.2" class="anchored" data-anchor-id="setup-model"><span class="header-section-number">18.2</span> Setup model</h3>
<div id="cell-242" class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForObjectDetection, AutoImageProcessor</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Model config - https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrConfig </span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model docs - https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrModel </span></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>MODEL_NAME <span class="op">=</span> <span class="st">"microsoft/conditional-detr-resnet-50"</span></span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set image size</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>IMAGE_SIZE <span class="op">=</span> <span class="dv">640</span> <span class="co"># other common image sizes include: 300x300, 480x480, 512x512, 640x640, 800x800 (best to experiment and see which works best)</span></span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the image processor (this is required for prepraring images)</span></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a><span class="co"># See docs: https://huggingface.co/docs/transformers/main/en/model_doc/conditional_detr#transformers.ConditionalDetrImageProcessor.preprocess</span></span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a>image_processor <span class="op">=</span> AutoImageProcessor.from_pretrained(</span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a>    pretrained_model_name_or_path<span class="op">=</span>MODEL_NAME,</span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span><span class="op">=</span><span class="st">"coco_detection"</span>, <span class="co"># this is the default</span></span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>    do_convert_annotations<span class="op">=</span><span class="va">True</span>, <span class="co"># defaults to True, converts boxes to (center_x, center_y, width, height)</span></span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>{<span class="st">"shortest_edge"</span>: IMAGE_SIZE, <span class="st">"longest_edge"</span>: IMAGE_SIZE},</span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>    max_size<span class="op">=</span><span class="va">None</span> <span class="co"># Note: this parameter is deprecated and will produce a warning if used during processing.</span></span>
<span id="cb204-18"><a href="#cb204-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb204-19"><a href="#cb204-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-20"><a href="#cb204-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out the image processor</span></span>
<span id="cb204-21"><a href="#cb204-21" aria-hidden="true" tabindex="-1"></a>image_processor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>ConditionalDetrImageProcessor {
  "do_convert_annotations": true,
  "do_normalize": true,
  "do_pad": true,
  "do_rescale": true,
  "do_resize": true,
  "format": "coco_detection",
  "image_mean": [
    0.485,
    0.456,
    0.406
  ],
  "image_processor_type": "ConditionalDetrImageProcessor",
  "image_std": [
    0.229,
    0.224,
    0.225
  ],
  "pad_size": null,
  "resample": 2,
  "rescale_factor": 0.00392156862745098,
  "size": {
    "longest_edge": 640,
    "shortest_edge": 640
  }
}</code></pre>
</div>
</div>
<div id="cell-243" class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First create a couple of dataclasses to store our data format</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, asdict</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SingleCOCOAnnotation:</span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"An instance of a single COCO annotation. See COCO format: https://cocodataset.org/#format-data"</span></span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>    image_id: <span class="bu">int</span></span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>    category_id: <span class="bu">int</span></span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>    bbox: List[<span class="bu">float</span>] <span class="co"># bboxes in format [x_top_left, y_top_left, width, height]</span></span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>    area: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>    iscrowd: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImageCOCOAnnotations:</span>
<span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"A collection of COCO annotations for a given image_id."</span></span>
<span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a>    image_id: <span class="bu">int</span></span>
<span id="cb206-18"><a href="#cb206-18" aria-hidden="true" tabindex="-1"></a>    annotations: List[SingleCOCOAnnotation]</span>
<span id="cb206-19"><a href="#cb206-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-20"><a href="#cb206-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_image_annotations_as_coco(</span>
<span id="cb206-21"><a href="#cb206-21" aria-hidden="true" tabindex="-1"></a>        image_id: <span class="bu">int</span>,</span>
<span id="cb206-22"><a href="#cb206-22" aria-hidden="true" tabindex="-1"></a>        categories: List[<span class="bu">int</span>],</span>
<span id="cb206-23"><a href="#cb206-23" aria-hidden="true" tabindex="-1"></a>        areas: List[<span class="bu">float</span>],</span>
<span id="cb206-24"><a href="#cb206-24" aria-hidden="true" tabindex="-1"></a>        bboxes: List[Tuple[<span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>]] <span class="co"># bboxes in format </span></span>
<span id="cb206-25"><a href="#cb206-25" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb206-26"><a href="#cb206-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turn input lists into a list of dicts</span></span>
<span id="cb206-27"><a href="#cb206-27" aria-hidden="true" tabindex="-1"></a>    coco_format_annotations <span class="op">=</span> [</span>
<span id="cb206-28"><a href="#cb206-28" aria-hidden="true" tabindex="-1"></a>        asdict(SingleCOCOAnnotation(</span>
<span id="cb206-29"><a href="#cb206-29" aria-hidden="true" tabindex="-1"></a>            image_id<span class="op">=</span>image_id,</span>
<span id="cb206-30"><a href="#cb206-30" aria-hidden="true" tabindex="-1"></a>            category_id<span class="op">=</span>category,</span>
<span id="cb206-31"><a href="#cb206-31" aria-hidden="true" tabindex="-1"></a>            bbox<span class="op">=</span><span class="bu">list</span>(bbox),</span>
<span id="cb206-32"><a href="#cb206-32" aria-hidden="true" tabindex="-1"></a>            area<span class="op">=</span>area,</span>
<span id="cb206-33"><a href="#cb206-33" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb206-34"><a href="#cb206-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> category, area, bbox <span class="kw">in</span> <span class="bu">zip</span>(categories, areas, bboxes)</span>
<span id="cb206-35"><a href="#cb206-35" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb206-36"><a href="#cb206-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-37"><a href="#cb206-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return dictionary of annotations with format {"image_id": ..., "annotations": ...}</span></span>
<span id="cb206-38"><a href="#cb206-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> asdict(ImageCOCOAnnotations(image_id<span class="op">=</span>image_id,</span>
<span id="cb206-39"><a href="#cb206-39" aria-hidden="true" tabindex="-1"></a>                                       annotations<span class="op">=</span>coco_format_annotations))</span>
<span id="cb206-40"><a href="#cb206-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-41"><a href="#cb206-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's try it out</span></span>
<span id="cb206-42"><a href="#cb206-42" aria-hidden="true" tabindex="-1"></a>image_id <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb206-43"><a href="#cb206-43" aria-hidden="true" tabindex="-1"></a>random_idx <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="bu">len</span>(dataset[<span class="st">"train"</span>]))</span>
<span id="cb206-44"><a href="#cb206-44" aria-hidden="true" tabindex="-1"></a>random_sample <span class="op">=</span> dataset[<span class="st">"train"</span>][random_idx]</span>
<span id="cb206-45"><a href="#cb206-45" aria-hidden="true" tabindex="-1"></a>random_sample_categories <span class="op">=</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"category_id"</span>]</span>
<span id="cb206-46"><a href="#cb206-46" aria-hidden="true" tabindex="-1"></a>random_sample_areas <span class="op">=</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"area"</span>]</span>
<span id="cb206-47"><a href="#cb206-47" aria-hidden="true" tabindex="-1"></a>random_sample_bboxes <span class="op">=</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"bbox"</span>]</span>
<span id="cb206-48"><a href="#cb206-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-49"><a href="#cb206-49" aria-hidden="true" tabindex="-1"></a>random_sample_coco_annotations <span class="op">=</span> format_image_annotations_as_coco(image_id<span class="op">=</span>image_id,</span>
<span id="cb206-50"><a href="#cb206-50" aria-hidden="true" tabindex="-1"></a>                                                                  categories<span class="op">=</span>random_sample_categories,</span>
<span id="cb206-51"><a href="#cb206-51" aria-hidden="true" tabindex="-1"></a>                                                                  areas<span class="op">=</span>random_sample_areas,</span>
<span id="cb206-52"><a href="#cb206-52" aria-hidden="true" tabindex="-1"></a>                                                                  bboxes<span class="op">=</span>random_sample_bboxes)</span>
<span id="cb206-53"><a href="#cb206-53" aria-hidden="true" tabindex="-1"></a>random_sample_coco_annotations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>{'image_id': 0,
 'annotations': [{'image_id': 0,
   'category_id': 0,
   'bbox': [452.79998779296875,
    446.6000061035156,
    272.70001220703125,
    388.20001220703125],
   'area': 105862.140625,
   'iscrowd': 0},
  {'image_id': 0,
   'category_id': 0,
   'bbox': [146.5, 487.5, 348.3999938964844, 424.79998779296875],
   'area': 148000.3125,
   'iscrowd': 0},
  {'image_id': 0,
   'category_id': 0,
   'bbox': [8.300000190734863, 522.5, 241.3000030517578, 505.0],
   'area': 121856.5,
   'iscrowd': 0}]}</code></pre>
</div>
</div>
<div id="cell-244" class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup the model</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Can functionize this to create a base model (e.g. a model with all the base settings/untrained weights) </span></span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model():</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> AutoModelForObjectDetection.from_pretrained(</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>                pretrained_model_name_or_path<span class="op">=</span>MODEL_NAME,</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>                label2id<span class="op">=</span>label2id,</span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>                id2label<span class="op">=</span>id2label,</span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>                ignore_mismatched_sizes<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>                backbone<span class="op">=</span><span class="st">"resnet50"</span>)</span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>model_aug <span class="op">=</span> create_model()</span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>model_aug</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of ConditionalDetrForObjectDetection were not initialized from the model checkpoint at microsoft/conditional-detr-resnet-50 and are newly initialized because the shapes did not match:
- class_labels_classifier.bias: found shape torch.Size([91]) in the checkpoint and torch.Size([7]) in the model instantiated
- class_labels_classifier.weight: found shape torch.Size([91, 256]) in the checkpoint and torch.Size([7, 256]) in the model instantiated
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre><code>ConditionalDetrForObjectDetection(
  (model): ConditionalDetrModel(
    (backbone): ConditionalDetrConvModel(
      (conv_encoder): ConditionalDetrConvEncoder(
        (model): FeatureListNet(
          (conv1): Conv2d(3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False)
          (bn1): ConditionalDetrFrozenBatchNorm2d()
          (act1): ReLU(inplace=True)
          (maxpool): MaxPool2d(kernel_size=3, stride=2, padding=1, dilation=1, ceil_mode=False)
          (layer1): Sequential(
            (0): Bottleneck(
              (conv1): Conv2d(64, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
              (downsample): Sequential(
                (0): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
                (1): ConditionalDetrFrozenBatchNorm2d()
              )
            )
            (1): Bottleneck(
              (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (2): Bottleneck(
              (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
          )
          (layer2): Sequential(
            (0): Bottleneck(
              (conv1): Conv2d(256, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
              (downsample): Sequential(
                (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
                (1): ConditionalDetrFrozenBatchNorm2d()
              )
            )
            (1): Bottleneck(
              (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (2): Bottleneck(
              (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (3): Bottleneck(
              (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
          )
          (layer3): Sequential(
            (0): Bottleneck(
              (conv1): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
              (downsample): Sequential(
                (0): Conv2d(512, 1024, kernel_size=(1, 1), stride=(2, 2), bias=False)
                (1): ConditionalDetrFrozenBatchNorm2d()
              )
            )
            (1): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (2): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (3): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (4): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (5): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
          )
          (layer4): Sequential(
            (0): Bottleneck(
              (conv1): Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
              (downsample): Sequential(
                (0): Conv2d(1024, 2048, kernel_size=(1, 1), stride=(2, 2), bias=False)
                (1): ConditionalDetrFrozenBatchNorm2d()
              )
            )
            (1): Bottleneck(
              (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (2): Bottleneck(
              (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
          )
        )
      )
      (position_embedding): ConditionalDetrSinePositionEmbedding()
    )
    (input_projection): Conv2d(2048, 256, kernel_size=(1, 1), stride=(1, 1))
    (query_position_embeddings): Embedding(300, 256)
    (encoder): ConditionalDetrEncoder(
      (layers): ModuleList(
        (0-5): 6 x ConditionalDetrEncoderLayer(
          (self_attn): DetrAttention(
            (k_proj): Linear(in_features=256, out_features=256, bias=True)
            (v_proj): Linear(in_features=256, out_features=256, bias=True)
            (q_proj): Linear(in_features=256, out_features=256, bias=True)
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (self_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (activation_fn): ReLU()
          (fc1): Linear(in_features=256, out_features=2048, bias=True)
          (fc2): Linear(in_features=2048, out_features=256, bias=True)
          (final_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
        )
      )
    )
    (decoder): ConditionalDetrDecoder(
      (layers): ModuleList(
        (0): ConditionalDetrDecoderLayer(
          (sa_qcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_qpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_kcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_kpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_v_proj): Linear(in_features=256, out_features=256, bias=True)
          (self_attn): ConditionalDetrAttention(
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (activation_fn): ReLU()
          (self_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (ca_qcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_qpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_kcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_kpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_v_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_qpos_sine_proj): Linear(in_features=256, out_features=256, bias=True)
          (encoder_attn): ConditionalDetrAttention(
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (encoder_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (fc1): Linear(in_features=256, out_features=2048, bias=True)
          (fc2): Linear(in_features=2048, out_features=256, bias=True)
          (final_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
        )
        (1-5): 5 x ConditionalDetrDecoderLayer(
          (sa_qcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_qpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_kcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_kpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_v_proj): Linear(in_features=256, out_features=256, bias=True)
          (self_attn): ConditionalDetrAttention(
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (activation_fn): ReLU()
          (self_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (ca_qcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_qpos_proj): None
          (ca_kcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_kpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_v_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_qpos_sine_proj): Linear(in_features=256, out_features=256, bias=True)
          (encoder_attn): ConditionalDetrAttention(
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (encoder_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (fc1): Linear(in_features=256, out_features=2048, bias=True)
          (fc2): Linear(in_features=2048, out_features=256, bias=True)
          (final_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
        )
      )
      (layernorm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
      (query_scale): MLP(
        (layers): ModuleList(
          (0-1): 2 x Linear(in_features=256, out_features=256, bias=True)
        )
      )
      (ref_point_head): MLP(
        (layers): ModuleList(
          (0): Linear(in_features=256, out_features=256, bias=True)
          (1): Linear(in_features=256, out_features=2, bias=True)
        )
      )
    )
  )
  (class_labels_classifier): Linear(in_features=256, out_features=7, bias=True)
  (bbox_predictor): ConditionalDetrMLPPredictionHead(
    (layers): ModuleList(
      (0-1): 2 x Linear(in_features=256, out_features=256, bias=True)
      (2): Linear(in_features=256, out_features=4, bias=True)
    )
  )
)</code></pre>
</div>
</div>
</section>
<section id="tk---setup-and-visualize-transforms-augmentations" class="level3" data-number="18.3">
<h3 data-number="18.3" class="anchored" data-anchor-id="tk---setup-and-visualize-transforms-augmentations"><span class="header-section-number">18.3</span> tk - Setup and visualize transforms (augmentations)</h3>
<ul>
<li>TK - explain simple augmentations:
<ul>
<li>RandomHorizontalFlip</li>
<li>ColorJitter
<ul>
<li>Thatâ€™s itâ€¦</li>
<li>Tailor the data augmentations to your own dataset/problem</li>
</ul></li>
</ul></li>
</ul>
<div id="cell-246" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms <span class="im">import</span> v2 </span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms.v2.functional <span class="im">import</span> to_pil_image, pil_to_tensor, pad</span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.utils <span class="im">import</span> draw_bounding_boxes</span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional transform from here: https://arxiv.org/pdf/2012.07177</span></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale jitter -&gt; pad -&gt; resize </span></span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a>train_transforms <span class="op">=</span> v2.Compose([</span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a>    v2.ToImage(),</span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.RandomResizedCrop(size=(640, 640), antialias=True),</span></span>
<span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.Resize(size=(640, 640)),</span></span>
<span id="cb211-15"><a href="#cb211-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.RandomShortestSize(min_size=480, max_size=640),</span></span>
<span id="cb211-16"><a href="#cb211-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.ScaleJitter(target_size=(640, 640)),</span></span>
<span id="cb211-17"><a href="#cb211-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PadToSize(target_height=640, target_width=640),</span></span>
<span id="cb211-18"><a href="#cb211-18" aria-hidden="true" tabindex="-1"></a>    v2.RandomHorizontalFlip(p<span class="op">=</span><span class="fl">0.5</span>),</span>
<span id="cb211-19"><a href="#cb211-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.RandomPhotometricDistort(p=0.75),</span></span>
<span id="cb211-20"><a href="#cb211-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.RandomShortestSize(min_size=480, max_size=640),</span></span>
<span id="cb211-21"><a href="#cb211-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.Resize(size=(640, 640)),</span></span>
<span id="cb211-22"><a href="#cb211-22" aria-hidden="true" tabindex="-1"></a>    v2.ColorJitter(brightness<span class="op">=</span><span class="fl">0.75</span>, <span class="co"># randomly adjust the brightness </span></span>
<span id="cb211-23"><a href="#cb211-23" aria-hidden="true" tabindex="-1"></a>                   contrast<span class="op">=</span><span class="fl">0.75</span>), <span class="co"># randomly alter the contrast</span></span>
<span id="cb211-24"><a href="#cb211-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.RandomPerspective(distortion_scale=0.3, </span></span>
<span id="cb211-25"><a href="#cb211-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                      p=0.3,</span></span>
<span id="cb211-26"><a href="#cb211-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                      fill=(123, 117, 104)), # fill with average colour</span></span>
<span id="cb211-27"><a href="#cb211-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.RandomZoomOut(side_range=(1.0, 1.5),</span></span>
<span id="cb211-28"><a href="#cb211-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                  fill=(123, 117, 104)),</span></span>
<span id="cb211-29"><a href="#cb211-29" aria-hidden="true" tabindex="-1"></a>    v2.ToDtype(dtype<span class="op">=</span>torch.float32, scale<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb211-30"><a href="#cb211-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-31"><a href="#cb211-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># v2.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])</span></span>
<span id="cb211-32"><a href="#cb211-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sanitize boxes, recommended to be called at least once at the end of the transform pipeline</span></span>
<span id="cb211-33"><a href="#cb211-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># https://pytorch.org/vision/stable/generated/torchvision.transforms.v2.SanitizeBoundingBoxes.html#torchvision.transforms.v2.SanitizeBoundingBoxes</span></span>
<span id="cb211-34"><a href="#cb211-34" aria-hidden="true" tabindex="-1"></a>    v2.SanitizeBoundingBoxes(labels_getter<span class="op">=</span><span class="va">None</span>) </span>
<span id="cb211-35"><a href="#cb211-35" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tk---visualize-transforms" class="level3" data-number="18.4">
<h3 data-number="18.4" class="anchored" data-anchor-id="tk---visualize-transforms"><span class="header-section-number">18.4</span> TK - Visualize transforms</h3>
<div id="cell-248" class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>random_idx <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="bu">len</span>(dataset[<span class="st">"train"</span>]))</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>random_sample <span class="op">=</span> dataset[<span class="st">"train"</span>][random_idx]</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform transform on image</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>random_sample_image <span class="op">=</span> random_sample[<span class="st">"image"</span>]</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>random_sample_image_width, random_sample_image_height <span class="op">=</span> random_sample[<span class="st">"image"</span>].size</span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>random_sample_boxes_xywh <span class="op">=</span> random_sample[<span class="st">"annotations"</span>][<span class="st">"bbox"</span>] <span class="co"># these are in XYWH format</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a>random_sample_boxes_xyxy <span class="op">=</span> torchvision.ops.box_convert(boxes<span class="op">=</span>torch.tensor(random_sample_boxes_xywh),</span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>                                                       in_fmt<span class="op">=</span><span class="st">"xywh"</span>,</span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a>                                                       out_fmt<span class="op">=</span><span class="st">"xyxy"</span>)</span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Format boxes to be xyxy for transforms</span></span>
<span id="cb212-14"><a href="#cb212-14" aria-hidden="true" tabindex="-1"></a>random_sample_boxes_xyxy <span class="op">=</span> torchvision.tv_tensors.BoundingBoxes(</span>
<span id="cb212-15"><a href="#cb212-15" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>random_sample_boxes_xyxy,</span>
<span id="cb212-16"><a href="#cb212-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span><span class="op">=</span><span class="st">"XYXY"</span>,</span>
<span id="cb212-17"><a href="#cb212-17" aria-hidden="true" tabindex="-1"></a>    canvas_size<span class="op">=</span>(random_sample_image_height, random_sample_image_width) <span class="co"># comes in the form height, width</span></span>
<span id="cb212-18"><a href="#cb212-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb212-19"><a href="#cb212-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-20"><a href="#cb212-20" aria-hidden="true" tabindex="-1"></a>random_sample_image_transformed, random_sample_boxes_transformed <span class="op">=</span> train_transforms(random_sample_image,</span>
<span id="cb212-21"><a href="#cb212-21" aria-hidden="true" tabindex="-1"></a>                                                                                    random_sample_boxes_xyxy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-249" class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>random_sample_original_image_with_boxes <span class="op">=</span> to_pil_image(pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>                                                       image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>random_sample_image),                    </span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>                                                       boxes<span class="op">=</span>random_sample_boxes_xyxy,</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>                                                       labels<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>                                                       width<span class="op">=</span><span class="dv">3</span>))</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>random_sample_original_image_with_boxes_size <span class="op">=</span> (random_sample_original_image_with_boxes.size[<span class="dv">1</span>], random_sample_original_image_with_boxes.size[<span class="dv">0</span>])</span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted boxes on the random test image </span></span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>random_sample_transformed_image_with_boxes <span class="op">=</span> to_pil_image(pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a>                                                          image<span class="op">=</span>random_sample_image_transformed,                    </span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a>                                                          boxes<span class="op">=</span>random_sample_boxes_transformed,</span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a>                                                          labels<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a>                                                          width<span class="op">=</span><span class="dv">3</span>))</span>
<span id="cb213-14"><a href="#cb213-14" aria-hidden="true" tabindex="-1"></a>random_sample_transformed_image_with_boxes_size <span class="op">=</span> (random_sample_transformed_image_with_boxes.size[<span class="dv">1</span>], random_sample_transformed_image_with_boxes.size[<span class="dv">0</span>])</span>
<span id="cb213-15"><a href="#cb213-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-16"><a href="#cb213-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the transformed image </span></span>
<span id="cb213-17"><a href="#cb213-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb213-18"><a href="#cb213-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-19"><a href="#cb213-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure with two subplots</span></span>
<span id="cb213-20"><a href="#cb213-20" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb213-21"><a href="#cb213-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-22"><a href="#cb213-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Display image 1</span></span>
<span id="cb213-23"><a href="#cb213-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].imshow(random_sample_original_image_with_boxes)</span>
<span id="cb213-24"><a href="#cb213-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axis(<span class="st">"off"</span>)  <span class="co"># Hide axes</span></span>
<span id="cb213-25"><a href="#cb213-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="ss">f"Original Image | Size: </span><span class="sc">{</span>random_sample_original_image_with_boxes_size<span class="sc">}</span><span class="ss"> (hxw)"</span>)</span>
<span id="cb213-26"><a href="#cb213-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-27"><a href="#cb213-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Display image 2</span></span>
<span id="cb213-28"><a href="#cb213-28" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].imshow(random_sample_transformed_image_with_boxes)</span>
<span id="cb213-29"><a href="#cb213-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axis(<span class="st">"off"</span>)  <span class="co"># Hide axes</span></span>
<span id="cb213-30"><a href="#cb213-30" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="ss">f"Transformed Image | Size: </span><span class="sc">{</span>random_sample_transformed_image_with_boxes_size<span class="sc">}</span><span class="ss"> (hxw)"</span>)</span>
<span id="cb213-31"><a href="#cb213-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-32"><a href="#cb213-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb213-33"><a href="#cb213-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb213-34"><a href="#cb213-34" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-112-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="tk---create-function-to-preprocess-and-transform-batch-of-examples" class="level3" data-number="18.5">
<h3 data-number="18.5" class="anchored" data-anchor-id="tk---create-function-to-preprocess-and-transform-batch-of-examples"><span class="header-section-number">18.5</span> TK - Create function to preprocess and transform batch of examples</h3>
<div id="cell-251" class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> tv_tensors</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_and_transform_batch(examples,</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>                                   image_processor,</span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>                                   transforms<span class="op">=</span><span class="va">None</span> <span class="co"># Note: Could optionally add transforms (e.g. data augmentation) here </span></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>                                   ):</span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Function to preprocess batches of data.</span></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Can optionally apply a transform later on.</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a>    images <span class="op">=</span> []</span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>    coco_annotations <span class="op">=</span> [] </span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-16"><a href="#cb214-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> image, image_id, annotations_dict <span class="kw">in</span> <span class="bu">zip</span>(examples[<span class="st">"image"</span>], examples[<span class="st">"image_id"</span>], examples[<span class="st">"annotations"</span>]):</span>
<span id="cb214-17"><a href="#cb214-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Note: may need to open image if it is an image path rather than PIL.Image</span></span>
<span id="cb214-18"><a href="#cb214-18" aria-hidden="true" tabindex="-1"></a>        bbox_list <span class="op">=</span> annotations_dict[<span class="st">"bbox"</span>]</span>
<span id="cb214-19"><a href="#cb214-19" aria-hidden="true" tabindex="-1"></a>        category_list <span class="op">=</span> annotations_dict[<span class="st">"category_id"</span>]</span>
<span id="cb214-20"><a href="#cb214-20" aria-hidden="true" tabindex="-1"></a>        area_list <span class="op">=</span> annotations_dict[<span class="st">"area"</span>]</span>
<span id="cb214-21"><a href="#cb214-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-22"><a href="#cb214-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Note: Could optionally apply a transform here.</span></span>
<span id="cb214-23"><a href="#cb214-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> transforms:</span>
<span id="cb214-24"><a href="#cb214-24" aria-hidden="true" tabindex="-1"></a>            width, height <span class="op">=</span> image.size[<span class="dv">0</span>], image.size[<span class="dv">1</span>]</span>
<span id="cb214-25"><a href="#cb214-25" aria-hidden="true" tabindex="-1"></a>            bbox_list <span class="op">=</span> tv_tensors.BoundingBoxes(data<span class="op">=</span>torch.tensor(bbox_list),</span>
<span id="cb214-26"><a href="#cb214-26" aria-hidden="true" tabindex="-1"></a>                                                 <span class="bu">format</span><span class="op">=</span><span class="st">"XYWH"</span>,</span>
<span id="cb214-27"><a href="#cb214-27" aria-hidden="true" tabindex="-1"></a>                                                 canvas_size<span class="op">=</span>(height, width)) <span class="co"># canvas_size = height, width</span></span>
<span id="cb214-28"><a href="#cb214-28" aria-hidden="true" tabindex="-1"></a>            image, bbox_list <span class="op">=</span> transforms(image, </span>
<span id="cb214-29"><a href="#cb214-29" aria-hidden="true" tabindex="-1"></a>                                          bbox_list)</span>
<span id="cb214-30"><a href="#cb214-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-31"><a href="#cb214-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Format the annotations into COCO format</span></span>
<span id="cb214-32"><a href="#cb214-32" aria-hidden="true" tabindex="-1"></a>        cooc_format_annotations <span class="op">=</span> format_image_annotations_as_coco(image_id<span class="op">=</span>image_id,</span>
<span id="cb214-33"><a href="#cb214-33" aria-hidden="true" tabindex="-1"></a>                                                                   categories<span class="op">=</span>category_list,</span>
<span id="cb214-34"><a href="#cb214-34" aria-hidden="true" tabindex="-1"></a>                                                                   areas<span class="op">=</span>area_list,</span>
<span id="cb214-35"><a href="#cb214-35" aria-hidden="true" tabindex="-1"></a>                                                                   bboxes<span class="op">=</span>bbox_list)</span>
<span id="cb214-36"><a href="#cb214-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb214-37"><a href="#cb214-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add images/annotations to their respective lists</span></span>
<span id="cb214-38"><a href="#cb214-38" aria-hidden="true" tabindex="-1"></a>        images.append(image)</span>
<span id="cb214-39"><a href="#cb214-39" aria-hidden="true" tabindex="-1"></a>        coco_annotations.append(cooc_format_annotations)</span>
<span id="cb214-40"><a href="#cb214-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-41"><a href="#cb214-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-42"><a href="#cb214-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the image processor to lists of images and annotations</span></span>
<span id="cb214-43"><a href="#cb214-43" aria-hidden="true" tabindex="-1"></a>    preprocessed_batch <span class="op">=</span> image_processor.preprocess(images<span class="op">=</span>images,</span>
<span id="cb214-44"><a href="#cb214-44" aria-hidden="true" tabindex="-1"></a>                                                    annotations<span class="op">=</span>coco_annotations,</span>
<span id="cb214-45"><a href="#cb214-45" aria-hidden="true" tabindex="-1"></a>                                                    return_tensors<span class="op">=</span><span class="st">"pt"</span>,</span>
<span id="cb214-46"><a href="#cb214-46" aria-hidden="true" tabindex="-1"></a>                                                    do_rescale<span class="op">=</span><span class="va">False</span> <span class="cf">if</span> transforms <span class="cf">else</span> <span class="va">True</span>,</span>
<span id="cb214-47"><a href="#cb214-47" aria-hidden="true" tabindex="-1"></a>                                                    do_resize<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb214-48"><a href="#cb214-48" aria-hidden="true" tabindex="-1"></a>                                                    do_pad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb214-49"><a href="#cb214-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-50"><a href="#cb214-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> preprocessed_batch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-252" class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a transform for different splits</span></span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>train_transform_batch <span class="op">=</span> partial(</span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>    preprocess_and_transform_batch,</span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a>    transforms<span class="op">=</span>train_transforms,</span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a>    image_processor<span class="op">=</span>image_processor</span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb215-9"><a href="#cb215-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-10"><a href="#cb215-10" aria-hidden="true" tabindex="-1"></a>validation_transform_batch <span class="op">=</span> partial(</span>
<span id="cb215-11"><a href="#cb215-11" aria-hidden="true" tabindex="-1"></a>    preprocess_and_transform_batch,</span>
<span id="cb215-12"><a href="#cb215-12" aria-hidden="true" tabindex="-1"></a>    transforms<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb215-13"><a href="#cb215-13" aria-hidden="true" tabindex="-1"></a>    image_processor<span class="op">=</span>image_processor</span>
<span id="cb215-14"><a href="#cb215-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-253" class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>processed_dataset <span class="op">=</span> dataset.copy()</span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>processed_dataset[<span class="st">"train"</span>] <span class="op">=</span> dataset[<span class="st">"train"</span>].with_transform(train_transform_batch)</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>processed_dataset[<span class="st">"validation"</span>] <span class="op">=</span> dataset[<span class="st">"validation"</span>].with_transform(validation_transform_batch)</span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>processed_dataset[<span class="st">"test"</span>] <span class="op">=</span> dataset[<span class="st">"test"</span>].with_transform(validation_transform_batch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-254" class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data_collate_function to collect samples into batches</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a><span class="co"># TK - want to get a dictionary of {"pixel_mask": [batch_of_samples], "labels": [batch_of_samples], "pixel_mask": [batch_of_samples]}</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> data_collate_function(batch):</span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>    collated_data <span class="op">=</span> {} </span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stack together a collection of pixel_values tensors</span></span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>    collated_data[<span class="st">"pixel_values"</span>] <span class="op">=</span> torch.stack([sample[<span class="st">"pixel_values"</span>] <span class="cf">for</span> sample <span class="kw">in</span> batch])</span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the labels (these are dictionaries so no need to use torch.stack)</span></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>    collated_data[<span class="st">"labels"</span>] <span class="op">=</span> [sample[<span class="st">"labels"</span>] <span class="cf">for</span> sample <span class="kw">in</span> batch]</span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If there is a pixel_mask key, return the pixel_mask's as well</span></span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"pixel_mask"</span> <span class="kw">in</span> batch[<span class="dv">0</span>]:</span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a>        collated_data[<span class="st">"pixel_mask"</span>] <span class="op">=</span> torch.stack([sample[<span class="st">"pixel_mask"</span>] <span class="cf">for</span> sample <span class="kw">in</span> batch])</span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> collated_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-255" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>model_aug <span class="op">=</span> create_model()</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>model_aug</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of ConditionalDetrForObjectDetection were not initialized from the model checkpoint at microsoft/conditional-detr-resnet-50 and are newly initialized because the shapes did not match:
- class_labels_classifier.bias: found shape torch.Size([91]) in the checkpoint and torch.Size([7]) in the model instantiated
- class_labels_classifier.weight: found shape torch.Size([91, 256]) in the checkpoint and torch.Size([7, 256]) in the model instantiated
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="123">
<pre><code>ConditionalDetrForObjectDetection(
  (model): ConditionalDetrModel(
    (backbone): ConditionalDetrConvModel(
      (conv_encoder): ConditionalDetrConvEncoder(
        (model): FeatureListNet(
          (conv1): Conv2d(3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False)
          (bn1): ConditionalDetrFrozenBatchNorm2d()
          (act1): ReLU(inplace=True)
          (maxpool): MaxPool2d(kernel_size=3, stride=2, padding=1, dilation=1, ceil_mode=False)
          (layer1): Sequential(
            (0): Bottleneck(
              (conv1): Conv2d(64, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
              (downsample): Sequential(
                (0): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
                (1): ConditionalDetrFrozenBatchNorm2d()
              )
            )
            (1): Bottleneck(
              (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (2): Bottleneck(
              (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
          )
          (layer2): Sequential(
            (0): Bottleneck(
              (conv1): Conv2d(256, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
              (downsample): Sequential(
                (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
                (1): ConditionalDetrFrozenBatchNorm2d()
              )
            )
            (1): Bottleneck(
              (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (2): Bottleneck(
              (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (3): Bottleneck(
              (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
          )
          (layer3): Sequential(
            (0): Bottleneck(
              (conv1): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
              (downsample): Sequential(
                (0): Conv2d(512, 1024, kernel_size=(1, 1), stride=(2, 2), bias=False)
                (1): ConditionalDetrFrozenBatchNorm2d()
              )
            )
            (1): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (2): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (3): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (4): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (5): Bottleneck(
              (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
          )
          (layer4): Sequential(
            (0): Bottleneck(
              (conv1): Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
              (downsample): Sequential(
                (0): Conv2d(1024, 2048, kernel_size=(1, 1), stride=(2, 2), bias=False)
                (1): ConditionalDetrFrozenBatchNorm2d()
              )
            )
            (1): Bottleneck(
              (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
            (2): Bottleneck(
              (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn1): ConditionalDetrFrozenBatchNorm2d()
              (act1): ReLU(inplace=True)
              (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
              (bn2): ConditionalDetrFrozenBatchNorm2d()
              (drop_block): Identity()
              (act2): ReLU(inplace=True)
              (aa): Identity()
              (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
              (bn3): ConditionalDetrFrozenBatchNorm2d()
              (act3): ReLU(inplace=True)
            )
          )
        )
      )
      (position_embedding): ConditionalDetrSinePositionEmbedding()
    )
    (input_projection): Conv2d(2048, 256, kernel_size=(1, 1), stride=(1, 1))
    (query_position_embeddings): Embedding(300, 256)
    (encoder): ConditionalDetrEncoder(
      (layers): ModuleList(
        (0-5): 6 x ConditionalDetrEncoderLayer(
          (self_attn): DetrAttention(
            (k_proj): Linear(in_features=256, out_features=256, bias=True)
            (v_proj): Linear(in_features=256, out_features=256, bias=True)
            (q_proj): Linear(in_features=256, out_features=256, bias=True)
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (self_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (activation_fn): ReLU()
          (fc1): Linear(in_features=256, out_features=2048, bias=True)
          (fc2): Linear(in_features=2048, out_features=256, bias=True)
          (final_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
        )
      )
    )
    (decoder): ConditionalDetrDecoder(
      (layers): ModuleList(
        (0): ConditionalDetrDecoderLayer(
          (sa_qcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_qpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_kcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_kpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_v_proj): Linear(in_features=256, out_features=256, bias=True)
          (self_attn): ConditionalDetrAttention(
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (activation_fn): ReLU()
          (self_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (ca_qcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_qpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_kcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_kpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_v_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_qpos_sine_proj): Linear(in_features=256, out_features=256, bias=True)
          (encoder_attn): ConditionalDetrAttention(
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (encoder_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (fc1): Linear(in_features=256, out_features=2048, bias=True)
          (fc2): Linear(in_features=2048, out_features=256, bias=True)
          (final_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
        )
        (1-5): 5 x ConditionalDetrDecoderLayer(
          (sa_qcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_qpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_kcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_kpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (sa_v_proj): Linear(in_features=256, out_features=256, bias=True)
          (self_attn): ConditionalDetrAttention(
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (activation_fn): ReLU()
          (self_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (ca_qcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_qpos_proj): None
          (ca_kcontent_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_kpos_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_v_proj): Linear(in_features=256, out_features=256, bias=True)
          (ca_qpos_sine_proj): Linear(in_features=256, out_features=256, bias=True)
          (encoder_attn): ConditionalDetrAttention(
            (out_proj): Linear(in_features=256, out_features=256, bias=True)
          )
          (encoder_attn_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
          (fc1): Linear(in_features=256, out_features=2048, bias=True)
          (fc2): Linear(in_features=2048, out_features=256, bias=True)
          (final_layer_norm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
        )
      )
      (layernorm): LayerNorm((256,), eps=1e-05, elementwise_affine=True)
      (query_scale): MLP(
        (layers): ModuleList(
          (0-1): 2 x Linear(in_features=256, out_features=256, bias=True)
        )
      )
      (ref_point_head): MLP(
        (layers): ModuleList(
          (0): Linear(in_features=256, out_features=256, bias=True)
          (1): Linear(in_features=256, out_features=2, bias=True)
        )
      )
    )
  )
  (class_labels_classifier): Linear(in_features=256, out_features=7, bias=True)
  (bbox_predictor): ConditionalDetrMLPPredictionHead(
    (layers): ModuleList(
      (0-1): 2 x Linear(in_features=256, out_features=256, bias=True)
      (2): Linear(in_features=256, out_features=4, bias=True)
    )
  )
)</code></pre>
</div>
</div>
<div id="cell-256" class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Depending on the size/speed of your GPU, this may take a while</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> TrainingArguments, Trainer</span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the batch size according to the memory you have available on your GPU</span></span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. on my NVIDIA RTX 4090 with 24GB of VRAM, I can use a batch size of 32 without running out of memory</span></span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Disable warnings about `max_size` parameter being deprecated (this is okay)</span></span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, message<span class="op">=</span><span class="st">"The `max_size` parameter is deprecated*"</span>)</span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: AdamW Optimizer is used by default</span></span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a>training_args <span class="op">=</span> TrainingArguments(</span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a>    output_dir<span class="op">=</span><span class="st">"detr_finetuned_trashify_box_detector_with_data_aug"</span>, <span class="co"># Tk - make sure this is suitable for data aug model</span></span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a>    num_train_epochs<span class="op">=</span><span class="dv">25</span>,</span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a>    fp16<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a>    per_device_train_batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a>    per_device_eval_batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb221-20"><a href="#cb221-20" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">1e-4</span>,</span>
<span id="cb221-21"><a href="#cb221-21" aria-hidden="true" tabindex="-1"></a>    lr_scheduler_type<span class="op">=</span><span class="st">"linear"</span>, <span class="co"># default = "linear", can try others such as "cosine", "constant" etc</span></span>
<span id="cb221-22"><a href="#cb221-22" aria-hidden="true" tabindex="-1"></a>    weight_decay<span class="op">=</span><span class="fl">1e-4</span>,</span>
<span id="cb221-23"><a href="#cb221-23" aria-hidden="true" tabindex="-1"></a>    max_grad_norm<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb221-24"><a href="#cb221-24" aria-hidden="true" tabindex="-1"></a>    metric_for_best_model<span class="op">=</span><span class="st">"eval_loss"</span>,</span>
<span id="cb221-25"><a href="#cb221-25" aria-hidden="true" tabindex="-1"></a>    greater_is_better<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb221-26"><a href="#cb221-26" aria-hidden="true" tabindex="-1"></a>    eval_strategy<span class="op">=</span><span class="st">"epoch"</span>,</span>
<span id="cb221-27"><a href="#cb221-27" aria-hidden="true" tabindex="-1"></a>    save_strategy<span class="op">=</span><span class="st">"epoch"</span>,</span>
<span id="cb221-28"><a href="#cb221-28" aria-hidden="true" tabindex="-1"></a>    logging_strategy<span class="op">=</span><span class="st">"epoch"</span>,</span>
<span id="cb221-29"><a href="#cb221-29" aria-hidden="true" tabindex="-1"></a>    save_total_limit<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb221-30"><a href="#cb221-30" aria-hidden="true" tabindex="-1"></a>    remove_unused_columns<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb221-31"><a href="#cb221-31" aria-hidden="true" tabindex="-1"></a>    report_to<span class="op">=</span><span class="st">"none"</span>, <span class="co"># don't save experiments to a third party service</span></span>
<span id="cb221-32"><a href="#cb221-32" aria-hidden="true" tabindex="-1"></a>    dataloader_num_workers<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb221-33"><a href="#cb221-33" aria-hidden="true" tabindex="-1"></a>    warmup_ratio<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb221-34"><a href="#cb221-34" aria-hidden="true" tabindex="-1"></a>    push_to_hub<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb221-35"><a href="#cb221-35" aria-hidden="true" tabindex="-1"></a>    eval_do_concat_batches<span class="op">=</span><span class="va">False</span></span>
<span id="cb221-36"><a href="#cb221-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb221-37"><a href="#cb221-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-38"><a href="#cb221-38" aria-hidden="true" tabindex="-1"></a>model_v2_trainer <span class="op">=</span> Trainer(</span>
<span id="cb221-39"><a href="#cb221-39" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model_aug,</span>
<span id="cb221-40"><a href="#cb221-40" aria-hidden="true" tabindex="-1"></a>    args<span class="op">=</span>training_args,</span>
<span id="cb221-41"><a href="#cb221-41" aria-hidden="true" tabindex="-1"></a>    train_dataset<span class="op">=</span>processed_dataset[<span class="st">"train"</span>],</span>
<span id="cb221-42"><a href="#cb221-42" aria-hidden="true" tabindex="-1"></a>    eval_dataset<span class="op">=</span>processed_dataset[<span class="st">"validation"</span>],</span>
<span id="cb221-43"><a href="#cb221-43" aria-hidden="true" tabindex="-1"></a>    tokenizer<span class="op">=</span>image_processor,</span>
<span id="cb221-44"><a href="#cb221-44" aria-hidden="true" tabindex="-1"></a>    data_collator<span class="op">=</span>data_collate_function,</span>
<span id="cb221-45"><a href="#cb221-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute_metrics=None # </span><span class="al">TODO</span><span class="co">: add a metrics function, just see if model trains first</span></span>
<span id="cb221-46"><a href="#cb221-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb221-47"><a href="#cb221-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-48"><a href="#cb221-48" aria-hidden="true" tabindex="-1"></a>model_v2_results <span class="op">=</span> model_v2_trainer.train()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/daniel/miniconda3/envs/ai/lib/python3.11/site-packages/accelerate/accelerator.py:488: FutureWarning: `torch.cuda.amp.GradScaler(args...)` is deprecated. Please use `torch.amp.GradScaler('cuda', args...)` instead.
  self.scaler = torch.cuda.amp.GradScaler(**kwargs)</code></pre>
</div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="1250" max="1250" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [1250/1250 08:19, Epoch 25/25]
    </div>
    
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>100.473500</td>
<td>8.029722</td>
</tr>
<tr class="even">
<td>2</td>
<td>4.369000</td>
<td>2.737582</td>
</tr>
<tr class="odd">
<td>3</td>
<td>2.551800</td>
<td>2.183892</td>
</tr>
<tr class="even">
<td>4</td>
<td>2.222600</td>
<td>1.922801</td>
</tr>
<tr class="odd">
<td>5</td>
<td>1.990600</td>
<td>1.740759</td>
</tr>
<tr class="even">
<td>6</td>
<td>1.821900</td>
<td>1.557272</td>
</tr>
<tr class="odd">
<td>7</td>
<td>1.697400</td>
<td>1.477890</td>
</tr>
<tr class="even">
<td>8</td>
<td>1.602700</td>
<td>1.451024</td>
</tr>
<tr class="odd">
<td>9</td>
<td>1.551700</td>
<td>1.371128</td>
</tr>
<tr class="even">
<td>10</td>
<td>1.449100</td>
<td>1.317680</td>
</tr>
<tr class="odd">
<td>11</td>
<td>1.433500</td>
<td>1.281066</td>
</tr>
<tr class="even">
<td>12</td>
<td>1.364500</td>
<td>1.247493</td>
</tr>
<tr class="odd">
<td>13</td>
<td>1.331400</td>
<td>1.206003</td>
</tr>
<tr class="even">
<td>14</td>
<td>1.297300</td>
<td>1.187397</td>
</tr>
<tr class="odd">
<td>15</td>
<td>1.250600</td>
<td>1.179421</td>
</tr>
<tr class="even">
<td>16</td>
<td>1.231900</td>
<td>1.165661</td>
</tr>
<tr class="odd">
<td>17</td>
<td>1.147900</td>
<td>1.129974</td>
</tr>
<tr class="even">
<td>18</td>
<td>1.146600</td>
<td>1.117911</td>
</tr>
<tr class="odd">
<td>19</td>
<td>1.113800</td>
<td>1.109535</td>
</tr>
<tr class="even">
<td>20</td>
<td>1.115300</td>
<td>1.096120</td>
</tr>
<tr class="odd">
<td>21</td>
<td>1.089400</td>
<td>1.078995</td>
</tr>
<tr class="even">
<td>22</td>
<td>1.069100</td>
<td>1.087004</td>
</tr>
<tr class="odd">
<td>23</td>
<td>1.061900</td>
<td>1.080366</td>
</tr>
<tr class="even">
<td>24</td>
<td>1.045900</td>
<td>1.071728</td>
</tr>
<tr class="odd">
<td>25</td>
<td>1.036300</td>
<td>1.070385</td>
</tr>
</tbody>
</table>
<p>
</p></div>
</div>
<p>TK - Note: You might get the following issue (negative bounding box coordinate predictions), can try again for more stable predictions (predictions are inherently random to begin with) or use a learning rate warmup to help stabilize predictions:</p>
<blockquote class="blockquote">
<p>ValueError: boxes1 must be in [x0, y0, x1, y1] (corner) format, but got tensor([[ 0.5796, 0.5566, 0.9956, 0.9492], [ 0.5718, 0.0610, 0.7202, 0.1738], [ 0.8218, 0.5107, 0.9878, 0.6289], â€¦, [ 0.1379, 0.1403, 0.6709, 0.6138], [ 0.7471, 0.4319, 1.0088, 0.5864], [-0.0660, 0.2052, 0.2067, 0.5107]], device=â€˜cuda:0â€™, dtype=torch.float16)</p>
</blockquote>
</section>
<section id="tk---save-the-trained-model" class="level3" data-number="18.6">
<h3 data-number="18.6" class="anchored" data-anchor-id="tk---save-the-trained-model"><span class="header-section-number">18.6</span> TK - Save the trained model</h3>
<div id="cell-259" class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the model</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: update this save path so we know when the model was saved and what its parameters were</span></span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>training_epochs_ <span class="op">=</span> training_args.num_train_epochs</span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a>learning_rate_ <span class="op">=</span> <span class="st">"</span><span class="sc">{:.0e}</span><span class="st">"</span>.<span class="bu">format</span>(training_args.learning_rate)</span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a>model_v2_save_path <span class="op">=</span> <span class="ss">f"models/learn_hf_microsoft_detr_finetuned_trashify_box_dataset_only_manual_data_with_aug_</span><span class="sc">{</span>training_epochs_<span class="sc">}</span><span class="ss">_epochs_lr_</span><span class="sc">{</span>learning_rate_<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb223-9"><a href="#cb223-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Saving model to: </span><span class="sc">{</span>model_v2_save_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb223-10"><a href="#cb223-10" aria-hidden="true" tabindex="-1"></a>model_v2_trainer.save_model(model_v2_save_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Saving model to: models/learn_hf_microsoft_detr_finetuned_trashify_box_dataset_only_manual_data_with_aug_25_epochs_lr_1e-04</code></pre>
</div>
</div>
</section>
</section>
<section id="tk---upload-augmentation-model-to-hugging-face-hub" class="level2" data-number="19">
<h2 data-number="19" class="anchored" data-anchor-id="tk---upload-augmentation-model-to-hugging-face-hub"><span class="header-section-number">19</span> TK - Upload Augmentation Model to Hugging Face Hub</h2>
<div id="cell-261" class="cell">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Push the model to the Hugging Face Hub</span></span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a><span class="co"># TK Note: This will require you to have your Hugging Face account setup (e.g. see the setup guide, tk - link to setup guide)</span></span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a><span class="co"># TK - this will push to the parameter `output_dir="detr_finetuned_trashify_box_detector_with_data_aug"`</span></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>model_v2_trainer.push_to_hub(commit_message<span class="op">=</span><span class="st">"upload trashify object detection model with data augmentation"</span></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># token=None, # Optional to add token manually</span></span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a>                            )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2e6829f58185476ba947dc09556c17bc","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6a7acdabf33649d4a74398cb94b11d43","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"85d6fec5b30346dabe5c8d2fb6fda5ad","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="126">
<pre><code>CommitInfo(commit_url='https://huggingface.co/mrdbourke/detr_finetuned_trashify_box_detector_with_data_aug/commit/2f5f3ed0a205b13ddf2a0e3b76120412e33b0861', commit_message='upload trashify object detection model with data augmentation', commit_description='', oid='2f5f3ed0a205b13ddf2a0e3b76120412e33b0861', pr_url=None, repo_url=RepoUrl('https://huggingface.co/mrdbourke/detr_finetuned_trashify_box_detector_with_data_aug', endpoint='https://huggingface.co', repo_type='model', repo_id='mrdbourke/detr_finetuned_trashify_box_detector_with_data_aug'), pr_revision=None, pr_num=None)</code></pre>
</div>
</div>
</section>
<section id="tk---compare-results-of-different-models" class="level2" data-number="20">
<h2 data-number="20" class="anchored" data-anchor-id="tk---compare-results-of-different-models"><span class="header-section-number">20</span> TK - Compare results of different models</h2>
<p>UPTOHERE - Showcase model 2 doing better because of augmentation (harder to learn)</p>
<ul>
<li>TK - Compare v1 model to v2
<ul>
<li>TK - Get model_v1 results into a variable and save it for later</li>
<li>Compare both of these as plots against each other, e.g.&nbsp;have the training curves for aug/no_aug on one plot and the curves for validation data for aug/no_aug on another plot</li>
</ul></li>
<li>TK - offer extensions to improve the model
<ul>
<li>TK - training model for longer, potentially using synthetic dataâ€¦?
<ul>
<li>TK - could I use 1000 high quality synthetic data samples to improve our model?</li>
</ul></li>
<li>TK - try use a different learning rate</li>
</ul></li>
</ul>
<div id="cell-263" class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TK - Turn this workflow into a function e.g. def get_history_from_trainer() -&gt; df/dict of history</span></span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_history_metrics_from_trainer(trainer):</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>    trainer_history <span class="op">=</span> trainer.state.log_history </span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>    trainer_history_metrics <span class="op">=</span> trainer_history[:<span class="op">-</span><span class="dv">1</span>] <span class="co"># get everything except the training time metrics (we've seen these already)</span></span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>    trainer_history_training_time <span class="op">=</span> trainer_history[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>    model_train_loss <span class="op">=</span> [item[<span class="st">"loss"</span>] <span class="cf">for</span> item <span class="kw">in</span> trainer_history_metrics <span class="cf">if</span> <span class="st">"loss"</span> <span class="kw">in</span> item.keys()]</span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a>    model_eval_loss <span class="op">=</span> [item[<span class="st">"eval_loss"</span>] <span class="cf">for</span> item <span class="kw">in</span> trainer_history_metrics <span class="cf">if</span> <span class="st">"eval_loss"</span> <span class="kw">in</span> item.keys()]</span>
<span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a>    model_learning_rate <span class="op">=</span> [item[<span class="st">"learning_rate"</span>] <span class="cf">for</span> item <span class="kw">in</span> trainer_history_metrics <span class="cf">if</span> <span class="st">"learning_rate"</span> <span class="kw">in</span> item.keys()] </span>
<span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-11"><a href="#cb227-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model_train_loss, model_eval_loss, model_learning_rate, trainer_history_training_time</span>
<span id="cb227-12"><a href="#cb227-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-13"><a href="#cb227-13" aria-hidden="true" tabindex="-1"></a>model_v1_train_loss, model_v1_eval_loss, model_v1_learning_rate, _ <span class="op">=</span> get_history_metrics_from_trainer(trainer<span class="op">=</span>model_v1_trainer)</span>
<span id="cb227-14"><a href="#cb227-14" aria-hidden="true" tabindex="-1"></a>model_v2_train_loss, model_v2_eval_loss, model_v2_learning_rate, _ <span class="op">=</span> get_history_metrics_from_trainer(trainer<span class="op">=</span>model_v2_trainer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-264" class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot model loss curves against each other for same model</span></span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Start from index 1 onwards to remove large loss spike at beginning of training </span></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].plot(model_v1_train_loss[<span class="dv">1</span>:], label<span class="op">=</span><span class="st">"Model V1 Train Loss"</span>)</span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].plot(model_v1_eval_loss[<span class="dv">1</span>:], label<span class="op">=</span><span class="st">"Model V1 Eval Loss"</span>)</span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Model V1 Loss Curves"</span>)</span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"Loss"</span>)</span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">"Epoch"</span>)</span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].legend()</span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].plot(model_v2_train_loss[<span class="dv">1</span>:], label<span class="op">=</span><span class="st">"Model V2 Train Loss"</span>)</span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].plot(model_v2_eval_loss[<span class="dv">1</span>:], label<span class="op">=</span><span class="st">"Model V2 Eval Loss"</span>)</span>
<span id="cb228-15"><a href="#cb228-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Model V2 Loss Curves"</span>)</span>
<span id="cb228-16"><a href="#cb228-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">"Loss"</span>)</span>
<span id="cb228-17"><a href="#cb228-17" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"Epoch"</span>)</span>
<span id="cb228-18"><a href="#cb228-18" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-122-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>tk - notice the overfitting begin to happen with model v1 (no data augmentation) but model v2 has less overfitting and achieves a lower validation loss</p>
<div id="cell-266" class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>plt.plot(model_v1_learning_rate, label<span class="op">=</span><span class="st">"Model V1"</span>)</span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>plt.plot(model_v2_learning_rate, label<span class="op">=</span><span class="st">"Model V2"</span>)</span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Model Learning Rate vs. Epoch"</span>)</span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Learning Rate"</span>)</span>
<span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Epoch"</span>)</span>
<span id="cb229-8"><a href="#cb229-8" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-123-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-267" class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot loss values against each other</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a>num_epochs <span class="op">=</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(model_v1_train_loss))</span>
<span id="cb230-6"><a href="#cb230-6" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].plot(model_v1_train_loss[<span class="dv">1</span>:], label<span class="op">=</span><span class="st">"Model 1 Training Loss"</span>)</span>
<span id="cb230-7"><a href="#cb230-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].plot(model_v2_train_loss[<span class="dv">1</span>:], label<span class="op">=</span><span class="st">"Model 2 Training Loss"</span>)</span>
<span id="cb230-8"><a href="#cb230-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Model Training Loss Curves"</span>)</span>
<span id="cb230-9"><a href="#cb230-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"Training Loss"</span>)</span>
<span id="cb230-10"><a href="#cb230-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">"Epochs"</span>)</span>
<span id="cb230-11"><a href="#cb230-11" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].legend()</span>
<span id="cb230-12"><a href="#cb230-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-13"><a href="#cb230-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].plot(model_v1_eval_loss[<span class="dv">1</span>:], label<span class="op">=</span><span class="st">"Model 1 Eval Loss"</span>)</span>
<span id="cb230-14"><a href="#cb230-14" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].plot(model_v2_eval_loss[<span class="dv">1</span>:], label<span class="op">=</span><span class="st">"Model 2 Eval Loss"</span>)</span>
<span id="cb230-15"><a href="#cb230-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Model Eval Loss Curves"</span>)</span>
<span id="cb230-16"><a href="#cb230-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">"Eval Loss"</span>)</span>
<span id="cb230-17"><a href="#cb230-17" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"Epochs"</span>)</span>
<span id="cb230-18"><a href="#cb230-18" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-124-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>tk - describe the loss curves here, model 2 curves may be higher for training loss but they really start to accelerate on the evaluation set towards the end</p>
</section>
<section id="tk---create-demo-with-augmentation-model" class="level2" data-number="21">
<h2 data-number="21" class="anchored" data-anchor-id="tk---create-demo-with-augmentation-model"><span class="header-section-number">21</span> TK - Create demo with Augmentation Model</h2>
<div id="cell-270" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make directory for demo</span></span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>trashify_data_aug_model_dir <span class="op">=</span> Path(<span class="st">"demos/trashify_object_detector_data_aug_model/"</span>)</span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>trashify_data_aug_model_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-271" class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector_data_aug_model<span class="op">/</span>README.md</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>title: Trashify Demo V2 ðŸš®</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>emoji: ðŸ—‘ï¸</span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>colorFrom: purple</span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>colorTo: blue</span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a>sdk: gradio</span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a>sdk_version: <span class="fl">4.40.0</span></span>
<span id="cb232-9"><a href="#cb232-9" aria-hidden="true" tabindex="-1"></a>app_file: app.py</span>
<span id="cb232-10"><a href="#cb232-10" aria-hidden="true" tabindex="-1"></a>pinned: false</span>
<span id="cb232-11"><a href="#cb232-11" aria-hidden="true" tabindex="-1"></a>license: apache<span class="op">-</span><span class="fl">2.0</span></span>
<span id="cb232-12"><a href="#cb232-12" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb232-13"><a href="#cb232-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-14"><a href="#cb232-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ðŸš® Trashify Object Detector Demo V2</span></span>
<span id="cb232-15"><a href="#cb232-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-16"><a href="#cb232-16" aria-hidden="true" tabindex="-1"></a>Object detection demo to detect `trash`, `bin`, `hand`, `trash_arm`, `not_trash`, `not_bin`, `not_hand`. </span>
<span id="cb232-17"><a href="#cb232-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-18"><a href="#cb232-18" aria-hidden="true" tabindex="-1"></a>Used <span class="im">as</span> example <span class="cf">for</span> encouraging people to cleanup their local area.</span>
<span id="cb232-19"><a href="#cb232-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-20"><a href="#cb232-20" aria-hidden="true" tabindex="-1"></a>If `trash`, `hand`, `bin` <span class="bu">all</span> detected <span class="op">=</span> <span class="op">+</span><span class="dv">1</span> point.</span>
<span id="cb232-21"><a href="#cb232-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-22"><a href="#cb232-22" aria-hidden="true" tabindex="-1"></a><span class="co">## Dataset</span></span>
<span id="cb232-23"><a href="#cb232-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-24"><a href="#cb232-24" aria-hidden="true" tabindex="-1"></a>All Trashify models are trained on a custom hand<span class="op">-</span>labelled dataset of people picking up trash <span class="kw">and</span> placing it <span class="kw">in</span> a <span class="bu">bin</span>.</span>
<span id="cb232-25"><a href="#cb232-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-26"><a href="#cb232-26" aria-hidden="true" tabindex="-1"></a>The dataset can be found on Hugging Face <span class="im">as</span> [`mrdbourke<span class="op">/</span>trashify_manual_labelled_images`](https:<span class="op">//</span>huggingface.co<span class="op">/</span>datasets<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_manual_labelled_images).</span>
<span id="cb232-27"><a href="#cb232-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-28"><a href="#cb232-28" aria-hidden="true" tabindex="-1"></a><span class="co">## Demos</span></span>
<span id="cb232-29"><a href="#cb232-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-30"><a href="#cb232-30" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V1](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v1) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span>without<span class="op">*</span> data augmentation.</span>
<span id="cb232-31"><a href="#cb232-31" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V2](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v2) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span><span class="cf">with</span><span class="op">*</span> data augmentation.</span>
<span id="cb232-32"><a href="#cb232-32" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V3](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v3) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span><span class="cf">with</span><span class="op">*</span> data augmentation (same <span class="im">as</span> V2) <span class="cf">with</span> an NMS (Non Maximum Suppression) post<span class="op">-</span>processing step.</span>
<span id="cb232-33"><a href="#cb232-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-34"><a href="#cb232-34" aria-hidden="true" tabindex="-1"></a>TK <span class="op">-</span> finish the README.md <span class="op">+</span> update <span class="cf">with</span> links to materials</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector_data_aug_model/README.md</code></pre>
</div>
</div>
<div id="cell-272" class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector_data_aug_model<span class="op">/</span>requirements.txt</span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>timm</span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>gradio</span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>torch</span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>transformers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector_data_aug_model/requirements.txt</code></pre>
</div>
</div>
<div id="cell-273" class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector_data_aug_model<span class="op">/</span>app.py</span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image, ImageDraw, ImageFont</span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoImageProcessor</span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForObjectDetection</span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Can load from Hugging Face or can load from local.</span></span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a><span class="co"># You will have to replace {mrdbourke} for your own username if the model is on your Hugging Face account.</span></span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a>model_save_path <span class="op">=</span> <span class="st">"mrdbourke/detr_finetuned_trashify_box_detector_with_data_aug"</span> </span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model and preprocessor</span></span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a>image_processor <span class="op">=</span> AutoImageProcessor.from_pretrained(model_save_path)</span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForObjectDetection.from_pretrained(model_save_path)</span>
<span id="cb236-16"><a href="#cb236-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-17"><a href="#cb236-17" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb236-18"><a href="#cb236-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span>
<span id="cb236-19"><a href="#cb236-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-20"><a href="#cb236-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the id2label dictionary from the model</span></span>
<span id="cb236-21"><a href="#cb236-21" aria-hidden="true" tabindex="-1"></a>id2label <span class="op">=</span> model.config.id2label</span>
<span id="cb236-22"><a href="#cb236-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-23"><a href="#cb236-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a colour dictionary for plotting boxes with different colours</span></span>
<span id="cb236-24"><a href="#cb236-24" aria-hidden="true" tabindex="-1"></a>color_dict <span class="op">=</span> {   </span>
<span id="cb236-25"><a href="#cb236-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bin"</span>: <span class="st">"green"</span>,</span>
<span id="cb236-26"><a href="#cb236-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trash"</span>: <span class="st">"blue"</span>,</span>
<span id="cb236-27"><a href="#cb236-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hand"</span>: <span class="st">"purple"</span>,</span>
<span id="cb236-28"><a href="#cb236-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trash_arm"</span>: <span class="st">"yellow"</span>,</span>
<span id="cb236-29"><a href="#cb236-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_trash"</span>: <span class="st">"red"</span>,</span>
<span id="cb236-30"><a href="#cb236-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_bin"</span>: <span class="st">"red"</span>,</span>
<span id="cb236-31"><a href="#cb236-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_hand"</span>: <span class="st">"red"</span>,</span>
<span id="cb236-32"><a href="#cb236-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb236-33"><a href="#cb236-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-34"><a href="#cb236-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create helper functions for seeing if items from one list are in another </span></span>
<span id="cb236-35"><a href="#cb236-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> any_in_list(list_a, list_b):</span>
<span id="cb236-36"><a href="#cb236-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns True if any item from list_a is in list_b, otherwise False."</span></span>
<span id="cb236-37"><a href="#cb236-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">any</span>(item <span class="kw">in</span> list_b <span class="cf">for</span> item <span class="kw">in</span> list_a)</span>
<span id="cb236-38"><a href="#cb236-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-39"><a href="#cb236-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_in_list(list_a, list_b):</span>
<span id="cb236-40"><a href="#cb236-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns True if all items from list_a are in list_b, otherwise False."</span></span>
<span id="cb236-41"><a href="#cb236-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">all</span>(item <span class="kw">in</span> list_b <span class="cf">for</span> item <span class="kw">in</span> list_a)</span>
<span id="cb236-42"><a href="#cb236-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-43"><a href="#cb236-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_on_image(image, conf_threshold):</span>
<span id="cb236-44"><a href="#cb236-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb236-45"><a href="#cb236-45" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> image_processor(images<span class="op">=</span>[image], return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb236-46"><a href="#cb236-46" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(<span class="op">**</span>inputs.to(device))</span>
<span id="cb236-47"><a href="#cb236-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-48"><a href="#cb236-48" aria-hidden="true" tabindex="-1"></a>        target_sizes <span class="op">=</span> torch.tensor([[image.size[<span class="dv">1</span>], image.size[<span class="dv">0</span>]]]) <span class="co"># height, width </span></span>
<span id="cb236-49"><a href="#cb236-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-50"><a href="#cb236-50" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> image_processor.post_process_object_detection(outputs,</span>
<span id="cb236-51"><a href="#cb236-51" aria-hidden="true" tabindex="-1"></a>                                                                threshold<span class="op">=</span>conf_threshold,</span>
<span id="cb236-52"><a href="#cb236-52" aria-hidden="true" tabindex="-1"></a>                                                                target_sizes<span class="op">=</span>target_sizes)[<span class="dv">0</span>]</span>
<span id="cb236-53"><a href="#cb236-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return all items in results to CPU</span></span>
<span id="cb236-54"><a href="#cb236-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> results.items():</span>
<span id="cb236-55"><a href="#cb236-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb236-56"><a href="#cb236-56" aria-hidden="true" tabindex="-1"></a>            results[key] <span class="op">=</span> value.item().cpu() <span class="co"># can't get scalar as .item() so add try/except block</span></span>
<span id="cb236-57"><a href="#cb236-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb236-58"><a href="#cb236-58" aria-hidden="true" tabindex="-1"></a>            results[key] <span class="op">=</span> value.cpu()</span>
<span id="cb236-59"><a href="#cb236-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-60"><a href="#cb236-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Can return results as plotted on a PIL image (then display the image)</span></span>
<span id="cb236-61"><a href="#cb236-61" aria-hidden="true" tabindex="-1"></a>    draw <span class="op">=</span> ImageDraw.Draw(image)</span>
<span id="cb236-62"><a href="#cb236-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-63"><a href="#cb236-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a font from ImageFont</span></span>
<span id="cb236-64"><a href="#cb236-64" aria-hidden="true" tabindex="-1"></a>    font <span class="op">=</span> ImageFont.load_default(size<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb236-65"><a href="#cb236-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-66"><a href="#cb236-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get class names as text for print out</span></span>
<span id="cb236-67"><a href="#cb236-67" aria-hidden="true" tabindex="-1"></a>    class_name_text_labels <span class="op">=</span> []</span>
<span id="cb236-68"><a href="#cb236-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-69"><a href="#cb236-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> box, score, label <span class="kw">in</span> <span class="bu">zip</span>(results[<span class="st">"boxes"</span>], results[<span class="st">"scores"</span>], results[<span class="st">"labels"</span>]):</span>
<span id="cb236-70"><a href="#cb236-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create coordinates</span></span>
<span id="cb236-71"><a href="#cb236-71" aria-hidden="true" tabindex="-1"></a>        x, y, x2, y2 <span class="op">=</span> <span class="bu">tuple</span>(box.tolist())</span>
<span id="cb236-72"><a href="#cb236-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-73"><a href="#cb236-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get label_name</span></span>
<span id="cb236-74"><a href="#cb236-74" aria-hidden="true" tabindex="-1"></a>        label_name <span class="op">=</span> id2label[label.item()]</span>
<span id="cb236-75"><a href="#cb236-75" aria-hidden="true" tabindex="-1"></a>        targ_color <span class="op">=</span> color_dict[label_name]</span>
<span id="cb236-76"><a href="#cb236-76" aria-hidden="true" tabindex="-1"></a>        class_name_text_labels.append(label_name)</span>
<span id="cb236-77"><a href="#cb236-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-78"><a href="#cb236-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the rectangle</span></span>
<span id="cb236-79"><a href="#cb236-79" aria-hidden="true" tabindex="-1"></a>        draw.rectangle(xy<span class="op">=</span>(x, y, x2, y2), </span>
<span id="cb236-80"><a href="#cb236-80" aria-hidden="true" tabindex="-1"></a>                       outline<span class="op">=</span>targ_color,</span>
<span id="cb236-81"><a href="#cb236-81" aria-hidden="true" tabindex="-1"></a>                       width<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb236-82"><a href="#cb236-82" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-83"><a href="#cb236-83" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a text string to display</span></span>
<span id="cb236-84"><a href="#cb236-84" aria-hidden="true" tabindex="-1"></a>        text_string_to_show <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>label_name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score.item(), <span class="dv">3</span>)<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb236-85"><a href="#cb236-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-86"><a href="#cb236-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the text on the image</span></span>
<span id="cb236-87"><a href="#cb236-87" aria-hidden="true" tabindex="-1"></a>        draw.text(xy<span class="op">=</span>(x, y),</span>
<span id="cb236-88"><a href="#cb236-88" aria-hidden="true" tabindex="-1"></a>                  text<span class="op">=</span>text_string_to_show,</span>
<span id="cb236-89"><a href="#cb236-89" aria-hidden="true" tabindex="-1"></a>                  fill<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb236-90"><a href="#cb236-90" aria-hidden="true" tabindex="-1"></a>                  font<span class="op">=</span>font)</span>
<span id="cb236-91"><a href="#cb236-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-92"><a href="#cb236-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the draw each time</span></span>
<span id="cb236-93"><a href="#cb236-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> draw</span>
<span id="cb236-94"><a href="#cb236-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-95"><a href="#cb236-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup blank string to print out</span></span>
<span id="cb236-96"><a href="#cb236-96" aria-hidden="true" tabindex="-1"></a>    return_string <span class="op">=</span> <span class="st">""</span></span>
<span id="cb236-97"><a href="#cb236-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-98"><a href="#cb236-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup list of target items to discover</span></span>
<span id="cb236-99"><a href="#cb236-99" aria-hidden="true" tabindex="-1"></a>    target_items <span class="op">=</span> [<span class="st">"trash"</span>, <span class="st">"bin"</span>, <span class="st">"hand"</span>]</span>
<span id="cb236-100"><a href="#cb236-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-101"><a href="#cb236-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no items detected or trash, bin, hand not in list, return notification </span></span>
<span id="cb236-102"><a href="#cb236-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">len</span>(class_name_text_labels) <span class="op">==</span> <span class="dv">0</span>) <span class="kw">or</span> <span class="kw">not</span> (any_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>class_name_text_labels)):</span>
<span id="cb236-103"><a href="#cb236-103" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"No trash, bin or hand detected at confidence threshold </span><span class="sc">{</span>conf_threshold<span class="sc">}</span><span class="ss">. Try another image or lowering the confidence threshold."</span></span>
<span id="cb236-104"><a href="#cb236-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, return_string</span>
<span id="cb236-105"><a href="#cb236-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-106"><a href="#cb236-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If there are some missing, print the ones which are missing</span></span>
<span id="cb236-107"><a href="#cb236-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="kw">not</span> all_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>class_name_text_labels):</span>
<span id="cb236-108"><a href="#cb236-108" aria-hidden="true" tabindex="-1"></a>        missing_items <span class="op">=</span> []</span>
<span id="cb236-109"><a href="#cb236-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> target_items:</span>
<span id="cb236-110"><a href="#cb236-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> item <span class="kw">not</span> <span class="kw">in</span> class_name_text_labels:</span>
<span id="cb236-111"><a href="#cb236-111" aria-hidden="true" tabindex="-1"></a>                missing_items.append(item)</span>
<span id="cb236-112"><a href="#cb236-112" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"Detected the following items: </span><span class="sc">{</span>class_name_text_labels<span class="sc">}</span><span class="ss">. But missing the following in order to get +1: </span><span class="sc">{</span>missing_items<span class="sc">}</span><span class="ss">. If this is an error, try another image or altering the confidence threshold. Otherwise, the model may need to be updated with better data."</span></span>
<span id="cb236-113"><a href="#cb236-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-114"><a href="#cb236-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If all 3 trash, bin, hand occur = + 1</span></span>
<span id="cb236-115"><a href="#cb236-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> all_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>class_name_text_labels):</span>
<span id="cb236-116"><a href="#cb236-116" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"+1! Found the following items: </span><span class="sc">{</span>class_name_text_labels<span class="sc">}</span><span class="ss">, thank you for cleaning up the area!"</span></span>
<span id="cb236-117"><a href="#cb236-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-118"><a href="#cb236-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(return_string)</span>
<span id="cb236-119"><a href="#cb236-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-120"><a href="#cb236-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image, return_string</span>
<span id="cb236-121"><a href="#cb236-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-122"><a href="#cb236-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the interface</span></span>
<span id="cb236-123"><a href="#cb236-123" aria-hidden="true" tabindex="-1"></a>demo <span class="op">=</span> gr.Interface(</span>
<span id="cb236-124"><a href="#cb236-124" aria-hidden="true" tabindex="-1"></a>    fn<span class="op">=</span>predict_on_image,</span>
<span id="cb236-125"><a href="#cb236-125" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span>[</span>
<span id="cb236-126"><a href="#cb236-126" aria-hidden="true" tabindex="-1"></a>        gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">"pil"</span>, label<span class="op">=</span><span class="st">"Target Image"</span>),</span>
<span id="cb236-127"><a href="#cb236-127" aria-hidden="true" tabindex="-1"></a>        gr.Slider(minimum<span class="op">=</span><span class="dv">0</span>, maximum<span class="op">=</span><span class="dv">1</span>, value<span class="op">=</span><span class="fl">0.25</span>, label<span class="op">=</span><span class="st">"Confidence Threshold"</span>)</span>
<span id="cb236-128"><a href="#cb236-128" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb236-129"><a href="#cb236-129" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>[</span>
<span id="cb236-130"><a href="#cb236-130" aria-hidden="true" tabindex="-1"></a>        gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">"pil"</span>, label<span class="op">=</span><span class="st">"Image Output"</span>),</span>
<span id="cb236-131"><a href="#cb236-131" aria-hidden="true" tabindex="-1"></a>        gr.Text(label<span class="op">=</span><span class="st">"Text Output"</span>)</span>
<span id="cb236-132"><a href="#cb236-132" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb236-133"><a href="#cb236-133" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"ðŸš® Trashify Object Detection Demo V2"</span>,</span>
<span id="cb236-134"><a href="#cb236-134" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"""Help clean up your local area! Upload an image and get +1 if there is all of the following items detected: trash, bin, hand.</span></span>
<span id="cb236-135"><a href="#cb236-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-136"><a href="#cb236-136" aria-hidden="true" tabindex="-1"></a><span class="st">    The [model](https://huggingface.co/mrdbourke/detr_finetuned_trashify_box_detector_with_data_aug) in V2 has been trained with data augmentation preprocessing (color jitter, horizontal flipping) to improve robustness. </span></span>
<span id="cb236-137"><a href="#cb236-137" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb236-138"><a href="#cb236-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Examples come in the form of a list of lists, where each inner list contains elements to prefill the `inputs` parameter with</span></span>
<span id="cb236-139"><a href="#cb236-139" aria-hidden="true" tabindex="-1"></a>    examples<span class="op">=</span>[</span>
<span id="cb236-140"><a href="#cb236-140" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_1.jpeg"</span>, <span class="fl">0.25</span>],</span>
<span id="cb236-141"><a href="#cb236-141" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_2.jpeg"</span>, <span class="fl">0.25</span>],</span>
<span id="cb236-142"><a href="#cb236-142" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_3.jpeg"</span>, <span class="fl">0.25</span>]</span>
<span id="cb236-143"><a href="#cb236-143" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb236-144"><a href="#cb236-144" aria-hidden="true" tabindex="-1"></a>    cache_examples<span class="op">=</span><span class="va">True</span></span>
<span id="cb236-145"><a href="#cb236-145" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb236-146"><a href="#cb236-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-147"><a href="#cb236-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch the demo</span></span>
<span id="cb236-148"><a href="#cb236-148" aria-hidden="true" tabindex="-1"></a>demo.launch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector_data_aug_model/app.py</code></pre>
</div>
</div>
<div id="cell-274" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Import the required methods for uploading to the Hugging Face Hub</span></span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> huggingface_hub <span class="im">import</span> (</span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>    create_repo,</span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>    get_full_repo_name,</span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>    upload_file, <span class="co"># for uploading a single file (if necessary)</span></span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a>    upload_folder <span class="co"># for uploading multiple files (in a folder)</span></span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-9"><a href="#cb238-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Define the parameters we'd like to use for the upload</span></span>
<span id="cb238-10"><a href="#cb238-10" aria-hidden="true" tabindex="-1"></a>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD <span class="op">=</span> <span class="st">"demos/trashify_object_detector_data_aug_model"</span> <span class="co"># TK - update this path </span></span>
<span id="cb238-11"><a href="#cb238-11" aria-hidden="true" tabindex="-1"></a>HF_TARGET_SPACE_NAME <span class="op">=</span> <span class="st">"trashify_demo_v2"</span></span>
<span id="cb238-12"><a href="#cb238-12" aria-hidden="true" tabindex="-1"></a>HF_REPO_TYPE <span class="op">=</span> <span class="st">"space"</span> <span class="co"># we're creating a Hugging Face Space</span></span>
<span id="cb238-13"><a href="#cb238-13" aria-hidden="true" tabindex="-1"></a>HF_SPACE_SDK <span class="op">=</span> <span class="st">"gradio"</span></span>
<span id="cb238-14"><a href="#cb238-14" aria-hidden="true" tabindex="-1"></a>HF_TOKEN <span class="op">=</span> <span class="st">""</span> <span class="co"># optional: set to your Hugging Face token (but I'd advise storing this as an environment variable as previously discussed)</span></span>
<span id="cb238-15"><a href="#cb238-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-16"><a href="#cb238-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Create a Space repository on Hugging Face Hub </span></span>
<span id="cb238-17"><a href="#cb238-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Creating repo on Hugging Face Hub with name: </span><span class="sc">{</span>HF_TARGET_SPACE_NAME<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb238-18"><a href="#cb238-18" aria-hidden="true" tabindex="-1"></a>create_repo(</span>
<span id="cb238-19"><a href="#cb238-19" aria-hidden="true" tabindex="-1"></a>    repo_id<span class="op">=</span>HF_TARGET_SPACE_NAME,</span>
<span id="cb238-20"><a href="#cb238-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># token=HF_TOKEN, # optional: set token manually (though it will be automatically recognized if it's available as an environment variable)</span></span>
<span id="cb238-21"><a href="#cb238-21" aria-hidden="true" tabindex="-1"></a>    repo_type<span class="op">=</span>HF_REPO_TYPE,</span>
<span id="cb238-22"><a href="#cb238-22" aria-hidden="true" tabindex="-1"></a>    private<span class="op">=</span><span class="va">False</span>, <span class="co"># set to True if you don't want your Space to be accessible to others</span></span>
<span id="cb238-23"><a href="#cb238-23" aria-hidden="true" tabindex="-1"></a>    space_sdk<span class="op">=</span>HF_SPACE_SDK,</span>
<span id="cb238-24"><a href="#cb238-24" aria-hidden="true" tabindex="-1"></a>    exist_ok<span class="op">=</span><span class="va">True</span>, <span class="co"># set to False if you want an error to raise if the repo_id already exists </span></span>
<span id="cb238-25"><a href="#cb238-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb238-26"><a href="#cb238-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-27"><a href="#cb238-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Get the full repository name (e.g. {username}/{model_id} or {username}/{space_name})</span></span>
<span id="cb238-28"><a href="#cb238-28" aria-hidden="true" tabindex="-1"></a>full_hf_repo_name <span class="op">=</span> get_full_repo_name(model_id<span class="op">=</span>HF_TARGET_SPACE_NAME)</span>
<span id="cb238-29"><a href="#cb238-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Full Hugging Face Hub repo name: </span><span class="sc">{</span>full_hf_repo_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb238-30"><a href="#cb238-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-31"><a href="#cb238-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Upload our demo folder</span></span>
<span id="cb238-32"><a href="#cb238-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Uploading </span><span class="sc">{</span>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD<span class="sc">}</span><span class="ss"> to repo: </span><span class="sc">{</span>full_hf_repo_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb238-33"><a href="#cb238-33" aria-hidden="true" tabindex="-1"></a>folder_upload_url <span class="op">=</span> upload_folder(</span>
<span id="cb238-34"><a href="#cb238-34" aria-hidden="true" tabindex="-1"></a>    repo_id<span class="op">=</span>full_hf_repo_name,</span>
<span id="cb238-35"><a href="#cb238-35" aria-hidden="true" tabindex="-1"></a>    folder_path<span class="op">=</span>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD,</span>
<span id="cb238-36"><a href="#cb238-36" aria-hidden="true" tabindex="-1"></a>    path_in_repo<span class="op">=</span><span class="st">"."</span>, <span class="co"># upload our folder to the root directory ("." means "base" or "root", this is the default)</span></span>
<span id="cb238-37"><a href="#cb238-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># token=HF_TOKEN, # optional: set token manually</span></span>
<span id="cb238-38"><a href="#cb238-38" aria-hidden="true" tabindex="-1"></a>    repo_type<span class="op">=</span>HF_REPO_TYPE,</span>
<span id="cb238-39"><a href="#cb238-39" aria-hidden="true" tabindex="-1"></a>    commit_message<span class="op">=</span><span class="st">"Uploading Trashify V2 box detection model (with data augmentation) app.py"</span></span>
<span id="cb238-40"><a href="#cb238-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb238-41"><a href="#cb238-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Demo folder successfully uploaded with commit URL: </span><span class="sc">{</span>folder_upload_url<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Creating repo on Hugging Face Hub with name: trashify_demo_v2
[INFO] Full Hugging Face Hub repo name: mrdbourke/trashify_demo_v2
[INFO] Uploading demos/trashify_object_detector_data_aug_model to repo: mrdbourke/trashify_demo_v2
[INFO] Demo folder successfully uploaded with commit URL: https://huggingface.co/spaces/mrdbourke/trashify_demo_v2/tree/main/.</code></pre>
</div>
</div>
<div id="cell-275" class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Next:</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Upload augmentation model to Hugging Face Hub âœ…</span></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create demo for augmentation model âœ…</span></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare results from augmentation model to non-augmentation model âœ…</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="tk---make-a-prediction-on-a-random-test-sample-with-model-using-data-aug-model" class="level3" data-number="21.1">
<h3 data-number="21.1" class="anchored" data-anchor-id="tk---make-a-prediction-on-a-random-test-sample-with-model-using-data-aug-model"><span class="header-section-number">21.1</span> TK - Make a prediction on a random test sample with model using data aug model</h3>
<div id="cell-277" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a random sample from the test preds</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>random_test_pred_index <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="bu">len</span>(processed_dataset[<span class="st">"test"</span>]))</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Making predictions on test item with index: </span><span class="sc">{</span>random_test_pred_index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>random_test_sample <span class="op">=</span> processed_dataset[<span class="st">"test"</span>][random_test_pred_index]</span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # Do a single forward pass with the model</span></span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a>random_test_sample_outputs <span class="op">=</span> model_aug(pixel_values<span class="op">=</span>random_test_sample[<span class="st">"pixel_values"</span>].unsqueeze(<span class="dv">0</span>).to(<span class="st">"cuda"</span>), <span class="co"># model expects input [batch_size, color_channels, height, width]</span></span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a>                                       pixel_mask<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Post process a random item from test preds</span></span>
<span id="cb241-12"><a href="#cb241-12" aria-hidden="true" tabindex="-1"></a>random_test_sample_outputs_post_processed <span class="op">=</span> image_processor.post_process_object_detection(</span>
<span id="cb241-13"><a href="#cb241-13" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>random_test_sample_outputs,</span>
<span id="cb241-14"><a href="#cb241-14" aria-hidden="true" tabindex="-1"></a>    threshold<span class="op">=</span><span class="fl">0.25</span>, <span class="co"># prediction probability threshold for boxes (note: boxes from an untrained model will likely be bad)</span></span>
<span id="cb241-15"><a href="#cb241-15" aria-hidden="true" tabindex="-1"></a>    target_sizes<span class="op">=</span>[random_test_sample[<span class="st">"labels"</span>][<span class="st">"orig_size"</span>]] <span class="co"># original input image size (or whichever target size you'd like), required to be same number of input items in a list</span></span>
<span id="cb241-16"><a href="#cb241-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb241-17"><a href="#cb241-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-18"><a href="#cb241-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the random sample test preds</span></span>
<span id="cb241-19"><a href="#cb241-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract scores, labels and boxes</span></span>
<span id="cb241-20"><a href="#cb241-20" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_scores <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"scores"</span>]</span>
<span id="cb241-21"><a href="#cb241-21" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_labels <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"labels"</span>]</span>
<span id="cb241-22"><a href="#cb241-22" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_boxes <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"boxes"</span>]</span>
<span id="cb241-23"><a href="#cb241-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-24"><a href="#cb241-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of labels to plot on the boxes </span></span>
<span id="cb241-25"><a href="#cb241-25" aria-hidden="true" tabindex="-1"></a>random_test_sample_labels_to_plot <span class="op">=</span> [<span class="ss">f"Pred: </span><span class="sc">{</span>id2label[label_pred.item()]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score_pred.item(), <span class="dv">4</span>)<span class="sc">}</span><span class="ss">)"</span> </span>
<span id="cb241-26"><a href="#cb241-26" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> label_pred, score_pred <span class="kw">in</span> <span class="bu">zip</span>(random_test_sample_pred_labels, random_test_sample_pred_scores)]</span>
<span id="cb241-27"><a href="#cb241-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-28"><a href="#cb241-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Labels with scores: </span><span class="sc">{</span>random_test_sample_labels_to_plot<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb241-29"><a href="#cb241-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Boxes:"</span>)</span>
<span id="cb241-30"><a href="#cb241-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> random_test_sample_pred_boxes:</span>
<span id="cb241-31"><a href="#cb241-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(item.detach().cpu())</span>
<span id="cb241-32"><a href="#cb241-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Total preds: </span><span class="sc">{</span><span class="bu">len</span>(random_test_sample_labels_to_plot)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb241-33"><a href="#cb241-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-34"><a href="#cb241-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted boxes on the random test image </span></span>
<span id="cb241-35"><a href="#cb241-35" aria-hidden="true" tabindex="-1"></a>to_pil_image(</span>
<span id="cb241-36"><a href="#cb241-36" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb241-37"><a href="#cb241-37" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>dataset[<span class="st">"test"</span>][random_test_pred_index][<span class="st">"image"</span>]),</span>
<span id="cb241-38"><a href="#cb241-38" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>random_test_sample_pred_boxes,</span>
<span id="cb241-39"><a href="#cb241-39" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_test_sample_labels_to_plot,</span>
<span id="cb241-40"><a href="#cb241-40" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">3</span></span>
<span id="cb241-41"><a href="#cb241-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb241-42"><a href="#cb241-42" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Making predictions on test item with index: 163
[INFO] Labels with scores: ['Pred: bin (0.6625)', 'Pred: hand (0.5412)', 'Pred: trash (0.5007)', 'Pred: trash (0.4147)', 'Pred: trash (0.396)', 'Pred: not_trash (0.3237)', 'Pred: hand (0.2799)']
[INFO] Boxes:
tensor([  10.7812,  393.1250,  950.1562, 1160.6250])
tensor([ 149.8828,  667.9688,  471.6797, 1018.2812])
tensor([405.0000, 679.1406, 668.4375, 972.1094])
tensor([248.2031, 472.6562, 675.7031, 994.8438])
tensor([ 140.6250,  467.3438,  675.9375, 1002.6562])
tensor([ 373.2422,  896.4844,  648.6328, 1063.5156])
tensor([  10.3125,  667.9688,  472.0312, 1264.5312])
[INFO] Total preds: 7</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="137">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-131-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="tk---model-v3---cleaning-up-predictions-with-nms-non-max-suppression" class="level2" data-number="22">
<h2 data-number="22" class="anchored" data-anchor-id="tk---model-v3---cleaning-up-predictions-with-nms-non-max-suppression"><span class="header-section-number">22</span> TK - Model V3 - Cleaning up predictions with NMS (Non-max Suppression)</h2>
<p>UPTOHERE * Take preds from model v2 and perform NMS on them to see what happens * Need to calculate: * IoU (intersection over union) * Can write about these in a blog post as extension material * Test image index good to practice on: * 163, 108 * Create a demo which compares NMS-free boxes to boxes <em>with</em> NMS</p>
<section id="tk---nms-filtering-logic-to-do" class="level3" data-number="22.1">
<h3 data-number="22.1" class="anchored" data-anchor-id="tk---nms-filtering-logic-to-do"><span class="header-section-number">22.1</span> TK - NMS filtering logic to do</h3>
<p>TK - create a table of different items here</p>
<ol type="1">
<li>Simplest filtering: keep only 1x class label with the highest score per image (e.g.&nbsp;if there are two â€œhandâ€ predictions, keep only the highest scoring one) âœ…
<ul>
<li>TK - problem with simple filtering is that it might take out a box that wouldâ€™ve been helpful, it also assumes that thereâ€™s little false positives (e.g.&nbsp;each box is predicting the class that it should predict)</li>
</ul></li>
<li>Greedy IoU filtering: Filter boxes which have IoU &gt; 0.9 (big overlap) and keep the box with the higher score âœ…
<ul>
<li>TK - problem here is that it may filter heavily overlapping classes (e.g.&nbsp;if there are many boxes of different classes clustered together because your objects overlap, such as on a plate of food, items may overlap)</li>
</ul></li>
<li>Class-aware IoU filtering: Filter boxes which have the same label and have IoU &gt; 0.5 and keep the box with the higher score</li>
</ol>
<p>Other potential NMS options: * Greedy NMS (good for distinct boxes, just take the highest scoring box per class) * Soft-NMS with linear penalty (good for boxes which may have overlap, e.g.&nbsp;smaller boxes in clusters) * Class-aware NMS (only perform NMS on same class of boxes)</p>
<ul>
<li><p>See this video here: https://youtu.be/VAo84c1hQX8?si=dYftsYADb9Kq-bul</p></li>
<li><p>TK - show prediction with more boxes than ideal, then introduce NMS as a technique to fix the predictions (e.g.&nbsp;on the same sample)</p>
<ul>
<li>TK - NMS doesnâ€™t need an extra model, just a way to</li>
</ul></li>
<li><p>TK - test index 163 is a good example with many boxes that could be shortened to a few</p></li>
</ul>
</section>
<section id="tk---simple-nms---keep-only-highest-scoring-class-per-prediction" class="level3" data-number="22.2">
<h3 data-number="22.2" class="anchored" data-anchor-id="tk---simple-nms---keep-only-highest-scoring-class-per-prediction"><span class="header-section-number">22.2</span> TK - Simple NMS - Keep only highest scoring class per prediction</h3>
<p>TK - This is the simplest method and simply iterates through the boxes and keep the highest scoring box per class (e.g.&nbsp;if there are two â€œhandâ€ prediction boxes, only keep the higher scoring one).</p>
<div id="cell-281" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_highest_scoring_box_per_class(boxes, labels, scores):</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform NMS (Non-max Supression) to only keep the top scoring box per class.</span></span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a><span class="co">        boxes: tensor of shape (N, 4)</span></span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a><span class="co">        labels: tensor of shape (N,)</span></span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a><span class="co">        scores: tensor of shape (N,)</span></span>
<span id="cb243-9"><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb243-10"><a href="#cb243-10" aria-hidden="true" tabindex="-1"></a><span class="co">        boxes: tensor of shape (N, 4) filtered for max scoring item per class</span></span>
<span id="cb243-11"><a href="#cb243-11" aria-hidden="true" tabindex="-1"></a><span class="co">        labels: tensor of shape (N,) filtered for max scoring item per class</span></span>
<span id="cb243-12"><a href="#cb243-12" aria-hidden="true" tabindex="-1"></a><span class="co">        scores: tensor of shape (N,) filtered for max scoring item per class</span></span>
<span id="cb243-13"><a href="#cb243-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb243-14"><a href="#cb243-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start with a blank keep mask (e.g. all False and then update the boxes to keep with True)</span></span>
<span id="cb243-15"><a href="#cb243-15" aria-hidden="true" tabindex="-1"></a>    keep_mask <span class="op">=</span> torch.zeros(<span class="bu">len</span>(boxes), dtype<span class="op">=</span>torch.<span class="bu">bool</span>)</span>
<span id="cb243-16"><a href="#cb243-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-17"><a href="#cb243-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each unique class</span></span>
<span id="cb243-18"><a href="#cb243-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> class_id <span class="kw">in</span> labels.unique():</span>
<span id="cb243-19"><a href="#cb243-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the indicies for the target class</span></span>
<span id="cb243-20"><a href="#cb243-20" aria-hidden="true" tabindex="-1"></a>        class_mask <span class="op">=</span> labels <span class="op">==</span> class_id</span>
<span id="cb243-21"><a href="#cb243-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-22"><a href="#cb243-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If any of the labels match the current class_id</span></span>
<span id="cb243-23"><a href="#cb243-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> class_mask.<span class="bu">any</span>():</span>
<span id="cb243-24"><a href="#cb243-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Find the index of highest scoring box for this specific class</span></span>
<span id="cb243-25"><a href="#cb243-25" aria-hidden="true" tabindex="-1"></a>            class_scores <span class="op">=</span> scores[class_mask]</span>
<span id="cb243-26"><a href="#cb243-26" aria-hidden="true" tabindex="-1"></a>            highest_score_idx <span class="op">=</span> class_scores.argmax()</span>
<span id="cb243-27"><a href="#cb243-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-28"><a href="#cb243-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert back to the original index</span></span>
<span id="cb243-29"><a href="#cb243-29" aria-hidden="true" tabindex="-1"></a>            original_idx <span class="op">=</span> torch.where(class_mask)[<span class="dv">0</span>][highest_score_idx]</span>
<span id="cb243-30"><a href="#cb243-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-31"><a href="#cb243-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update the index in the keep mask to keep the highest scoring box </span></span>
<span id="cb243-32"><a href="#cb243-32" aria-hidden="true" tabindex="-1"></a>            keep_mask[original_idx] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb243-33"><a href="#cb243-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb243-34"><a href="#cb243-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> boxes[keep_mask], labels[keep_mask], scores[keep_mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-282" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mask with simple NMS keep mask</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>keep_boxes, keep_labels, keep_scores <span class="op">=</span> filter_highest_scoring_box_per_class(boxes<span class="op">=</span>random_test_sample_pred_boxes,</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>                                                                            labels<span class="op">=</span>random_test_sample_pred_labels,</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>                                                                            scores<span class="op">=</span>random_test_sample_pred_scores)</span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(random_test_sample_pred_boxes), <span class="bu">len</span>(random_test_sample_pred_labels), <span class="bu">len</span>(random_test_sample_pred_scores))</span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(keep_scores), <span class="bu">len</span>(keep_labels), <span class="bu">len</span>(keep_boxes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7 7 7
4 4 4</code></pre>
</div>
</div>
<div id="cell-283" class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>keep_boxes, keep_labels, keep_scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="140">
<pre><code>(tensor([[  10.7812,  393.1250,  950.1562, 1160.6250],
         [ 149.8828,  667.9688,  471.6797, 1018.2812],
         [ 405.0000,  679.1406,  668.4375,  972.1094],
         [ 373.2422,  896.4844,  648.6328, 1063.5156]], device='cuda:0',
        grad_fn=&lt;IndexBackward0&gt;),
 tensor([0, 1, 5, 4], device='cuda:0'),
 tensor([0.6625, 0.5412, 0.5007, 0.3237], device='cuda:0',
        grad_fn=&lt;IndexBackward0&gt;))</code></pre>
</div>
</div>
<div id="cell-284" class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of labels to plot on the boxes </span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>random_test_sample_labels_to_plot <span class="op">=</span> [<span class="ss">f"Pred: </span><span class="sc">{</span>id2label[label_pred.item()]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score_pred.item(), <span class="dv">4</span>)<span class="sc">}</span><span class="ss">)"</span> </span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> label_pred, score_pred <span class="kw">in</span> <span class="bu">zip</span>(random_test_sample_pred_labels, random_test_sample_pred_scores)]</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Labels with scores: </span><span class="sc">{</span>random_test_sample_labels_to_plot<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted boxes on the random test image </span></span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a>test_image_with_preds_original <span class="op">=</span> to_pil_image(</span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>dataset[<span class="st">"test"</span>][random_test_pred_index][<span class="st">"image"</span>]),</span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>random_test_sample_pred_boxes,</span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_test_sample_labels_to_plot,</span>
<span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">3</span></span>
<span id="cb248-14"><a href="#cb248-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb248-15"><a href="#cb248-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb248-16"><a href="#cb248-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-17"><a href="#cb248-17" aria-hidden="true" tabindex="-1"></a><span class="co">### Create image with filtered boxes</span></span>
<span id="cb248-18"><a href="#cb248-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-19"><a href="#cb248-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of labels to plot on the boxes </span></span>
<span id="cb248-20"><a href="#cb248-20" aria-hidden="true" tabindex="-1"></a>random_test_sample_labels_to_plot_filtered <span class="op">=</span> [<span class="ss">f"Pred: </span><span class="sc">{</span>id2label[label_pred.item()]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score_pred.item(), <span class="dv">4</span>)<span class="sc">}</span><span class="ss">)"</span> </span>
<span id="cb248-21"><a href="#cb248-21" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> label_pred, score_pred <span class="kw">in</span> <span class="bu">zip</span>(keep_labels, keep_scores)]</span>
<span id="cb248-22"><a href="#cb248-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-23"><a href="#cb248-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Labels with scores: </span><span class="sc">{</span>random_test_sample_labels_to_plot_filtered<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb248-24"><a href="#cb248-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-25"><a href="#cb248-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted boxes on the random test image </span></span>
<span id="cb248-26"><a href="#cb248-26" aria-hidden="true" tabindex="-1"></a>test_image_with_preds_filtered <span class="op">=</span> to_pil_image(</span>
<span id="cb248-27"><a href="#cb248-27" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb248-28"><a href="#cb248-28" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>dataset[<span class="st">"test"</span>][random_test_pred_index][<span class="st">"image"</span>]),</span>
<span id="cb248-29"><a href="#cb248-29" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>keep_boxes,</span>
<span id="cb248-30"><a href="#cb248-30" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_test_sample_labels_to_plot_filtered,</span>
<span id="cb248-31"><a href="#cb248-31" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">3</span></span>
<span id="cb248-32"><a href="#cb248-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb248-33"><a href="#cb248-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb248-34"><a href="#cb248-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-35"><a href="#cb248-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the transformed image </span></span>
<span id="cb248-36"><a href="#cb248-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb248-37"><a href="#cb248-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-38"><a href="#cb248-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure with two subplots</span></span>
<span id="cb248-39"><a href="#cb248-39" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>))</span>
<span id="cb248-40"><a href="#cb248-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-41"><a href="#cb248-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Display image 1</span></span>
<span id="cb248-42"><a href="#cb248-42" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].imshow(test_image_with_preds_original)</span>
<span id="cb248-43"><a href="#cb248-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axis(<span class="st">"off"</span>)  <span class="co"># Hide axes</span></span>
<span id="cb248-44"><a href="#cb248-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="ss">f"Original Image Preds (total: </span><span class="sc">{</span><span class="bu">len</span>(random_test_sample_pred_boxes)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb248-45"><a href="#cb248-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-46"><a href="#cb248-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Display image 2</span></span>
<span id="cb248-47"><a href="#cb248-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].imshow(test_image_with_preds_filtered)</span>
<span id="cb248-48"><a href="#cb248-48" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axis(<span class="st">"off"</span>)  <span class="co"># Hide axes</span></span>
<span id="cb248-49"><a href="#cb248-49" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="ss">f"Filtered Image Preds (total: </span><span class="sc">{</span><span class="bu">len</span>(keep_boxes)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb248-50"><a href="#cb248-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-51"><a href="#cb248-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb248-52"><a href="#cb248-52" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Simple NMS - Only keep the highest scoring box per prediction"</span>)</span>
<span id="cb248-53"><a href="#cb248-53" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb248-54"><a href="#cb248-54" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Labels with scores: ['Pred: bin (0.6625)', 'Pred: hand (0.5412)', 'Pred: trash (0.5007)', 'Pred: trash (0.4147)', 'Pred: trash (0.396)', 'Pred: not_trash (0.3237)', 'Pred: hand (0.2799)']
[INFO] Labels with scores: ['Pred: bin (0.6625)', 'Pred: hand (0.5412)', 'Pred: trash (0.5007)', 'Pred: not_trash (0.3237)']</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-135-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>TK - problem with simple filtering is that it might take out a box that wouldâ€™ve been helpful, it also assumes that thereâ€™s little false positives (e.g.&nbsp;each box is predicting the class that it should predict)</p>
</section>
<section id="tk---greedy-iou-filtering---intersection-over-union---if-a-pair-of-boxes-have-an-iou-over-a-certain-threshold-keep-the-box-with-the-higher-score" class="level3" data-number="22.3">
<h3 data-number="22.3" class="anchored" data-anchor-id="tk---greedy-iou-filtering---intersection-over-union---if-a-pair-of-boxes-have-an-iou-over-a-certain-threshold-keep-the-box-with-the-higher-score"><span class="header-section-number">22.3</span> TK - Greedy IoU Filtering - Intersection over Union - If a pair of boxes have an IoU over a certain threshold, keep the box with the higher score</h3>
<ul>
<li>IoU in torchmetrics - https://lightning.ai/docs/torchmetrics/stable/detection/intersection_over_union.html</li>
</ul>
<p>To calculate the <strong>Intersection over Union (IoU)</strong> between two bounding boxes:</p>
<ol type="1">
<li><strong>Coordinates of the intersection rectangle</strong>: <span class="math display">\[
x_{\text{left}} = \max(x_{1A}, x_{1B})
\]</span> <span class="math display">\[
y_{\text{top}} = \max(y_{1A}, y_{1B})
\]</span> <span class="math display">\[
x_{\text{right}} = \min(x_{2A}, x_{2B})
\]</span> <span class="math display">\[
y_{\text{bottom}} = \min(y_{2A}, y_{2B})
\]</span></li>
</ol>
<p>Where:</p>
<p><span class="math display">\[
   \text{A} = \text{Box 1}
\]</span> <span class="math display">\[
   \text{B} = \text{Box 2}
\]</span></p>
<ol start="2" type="1">
<li><p><strong>Width and height of the intersection</strong>: <span class="math display">\[
\text{intersection\_width} = \max(0, x_{\text{right}} - x_{\text{left}})
\]</span> <span class="math display">\[
\text{intersection\_height} = \max(0, y_{\text{bottom}} - y_{\text{top}})
\]</span></p></li>
<li><p><strong>Area of Overlap</strong>: <span class="math display">\[
\text{Area of Overlap} = \text{intersection\_width} \times \text{intersection\_height}
\]</span></p></li>
<li><p><strong>Area of Union</strong>: <span class="math display">\[
\text{Area of Union} = \text{Area of Box 1} + \text{Area of Box 2} - \text{Area of Overlap}
\]</span></p></li>
<li><p><strong>Intersection over Union (IoU)</strong>: $$ = / </p></li>
</ol>
<div id="cell-287" class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># IoU = Intersection / Union</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Inserction =</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x_left = max(x1_A, x1_B)</span></span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y_top = max(y1_A, y1_B)</span></span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x_right = min(x2_A, x2_B)</span></span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y_bottom = min(y2_A, x2_B)</span></span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Where: </span></span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># A = Box 1</span></span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># B = Box 2</span></span>
<span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># intersection_width = max(0, x_right - x_left)</span></span>
<span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># interesection_height = max(0, y_bottom - y_top)</span></span>
<span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># area_intersection = intersection_width * intersection_height</span></span>
<span id="cb250-14"><a href="#cb250-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Union = area_box_1 + area_box_2 - intersection</span></span>
<span id="cb250-15"><a href="#cb250-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-16"><a href="#cb250-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> intersection_over_union_score(box_1, box_2):</span>
<span id="cb250-17"><a href="#cb250-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculates Intersection over Union (IoU) score for two given boxes in XYXY format."""</span></span>
<span id="cb250-18"><a href="#cb250-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(box_1) <span class="op">==</span> <span class="dv">4</span>, <span class="ss">f"Box 1 should have four elements in the format [x_1, y_1, x_2, y_2] but has: </span><span class="sc">{</span><span class="bu">len</span>(box_1)<span class="sc">}</span><span class="ss">, see: </span><span class="sc">{</span>box_1<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb250-19"><a href="#cb250-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(box_2) <span class="op">==</span> <span class="dv">4</span>, <span class="ss">f"Box 2 should have four elements in the format [x_1, y_1, x_2, y_2] but has: </span><span class="sc">{</span><span class="bu">len</span>(box_2)<span class="sc">}</span><span class="ss">, see: </span><span class="sc">{</span>box_2<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb250-20"><a href="#cb250-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-21"><a href="#cb250-21" aria-hidden="true" tabindex="-1"></a>    x1_box_1, y1_box_1, x2_box_1, y2_box_1 <span class="op">=</span> box_1[<span class="dv">0</span>], box_1[<span class="dv">1</span>], box_1[<span class="dv">2</span>], box_1[<span class="dv">3</span>]</span>
<span id="cb250-22"><a href="#cb250-22" aria-hidden="true" tabindex="-1"></a>    x1_box_2, y1_box_2, x2_box_2, y2_box_2 <span class="op">=</span> box_2[<span class="dv">0</span>], box_2[<span class="dv">1</span>], box_2[<span class="dv">2</span>], box_2[<span class="dv">3</span>]</span>
<span id="cb250-23"><a href="#cb250-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-24"><a href="#cb250-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get coordinates of overlapping box (note: there may not be any overlapping box)</span></span>
<span id="cb250-25"><a href="#cb250-25" aria-hidden="true" tabindex="-1"></a>    x_left <span class="op">=</span> torch.<span class="bu">max</span>(x1_box_1, x1_box_2)</span>
<span id="cb250-26"><a href="#cb250-26" aria-hidden="true" tabindex="-1"></a>    y_top <span class="op">=</span> torch.<span class="bu">max</span>(y1_box_1, y1_box_2)</span>
<span id="cb250-27"><a href="#cb250-27" aria-hidden="true" tabindex="-1"></a>    x_right <span class="op">=</span> torch.<span class="bu">min</span>(x2_box_1, x2_box_2)</span>
<span id="cb250-28"><a href="#cb250-28" aria-hidden="true" tabindex="-1"></a>    y_bottom <span class="op">=</span> torch.<span class="bu">min</span>(y2_box_1, y2_box_2)</span>
<span id="cb250-29"><a href="#cb250-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-30"><a href="#cb250-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the intersection width and height (we take the max of 0 and the value to find non-overlapping boxes)</span></span>
<span id="cb250-31"><a href="#cb250-31" aria-hidden="true" tabindex="-1"></a>    intersection_width <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, x_right <span class="op">-</span> x_left)</span>
<span id="cb250-32"><a href="#cb250-32" aria-hidden="true" tabindex="-1"></a>    intersection_height <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, y_bottom <span class="op">-</span> y_top)</span>
<span id="cb250-33"><a href="#cb250-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-34"><a href="#cb250-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the area of intersection (note: this will 0 if either width or height are 0)</span></span>
<span id="cb250-35"><a href="#cb250-35" aria-hidden="true" tabindex="-1"></a>    area_of_intersection <span class="op">=</span> intersection_height <span class="op">*</span> intersection_width</span>
<span id="cb250-36"><a href="#cb250-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-37"><a href="#cb250-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate individual box areas</span></span>
<span id="cb250-38"><a href="#cb250-38" aria-hidden="true" tabindex="-1"></a>    box_1_area <span class="op">=</span> (x2_box_1 <span class="op">-</span> x1_box_1) <span class="op">*</span> (y2_box_1 <span class="op">-</span> y1_box_1) <span class="co"># width * height </span></span>
<span id="cb250-39"><a href="#cb250-39" aria-hidden="true" tabindex="-1"></a>    box_2_area <span class="op">=</span> (x2_box_2 <span class="op">-</span> x1_box_2) <span class="op">*</span> (y2_box_2 <span class="op">-</span> y1_box_2)</span>
<span id="cb250-40"><a href="#cb250-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-41"><a href="#cb250-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcuate area of union (sum of box areas minus the intersection area)</span></span>
<span id="cb250-42"><a href="#cb250-42" aria-hidden="true" tabindex="-1"></a>    area_of_union <span class="op">=</span> box_1_area <span class="op">+</span> box_2_area <span class="op">-</span> area_of_intersection</span>
<span id="cb250-43"><a href="#cb250-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-44"><a href="#cb250-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the IoU score</span></span>
<span id="cb250-45"><a href="#cb250-45" aria-hidden="true" tabindex="-1"></a>    iou_score <span class="op">=</span> area_of_intersection <span class="op">/</span> area_of_union</span>
<span id="cb250-46"><a href="#cb250-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-47"><a href="#cb250-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> iou_score</span>
<span id="cb250-48"><a href="#cb250-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-49"><a href="#cb250-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-50"><a href="#cb250-50" aria-hidden="true" tabindex="-1"></a>iou_score_test_pred_boxes <span class="op">=</span> intersection_over_union_score(box_1<span class="op">=</span>random_test_sample_pred_boxes[<span class="dv">4</span>],</span>
<span id="cb250-51"><a href="#cb250-51" aria-hidden="true" tabindex="-1"></a>                                                          box_2<span class="op">=</span>random_test_sample_pred_boxes[<span class="dv">3</span>])</span>
<span id="cb250-52"><a href="#cb250-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-53"><a href="#cb250-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] IoU Score: </span><span class="sc">{</span>iou_score_test_pred_boxes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb250-54"><a href="#cb250-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-55"><a href="#cb250-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-56"><a href="#cb250-56" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_boxes[<span class="dv">0</span>], random_test_sample_pred_boxes[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] IoU Score: 0.7790185809135437</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>(tensor([  10.7812,  393.1250,  950.1562, 1160.6250], device='cuda:0',
        grad_fn=&lt;SelectBackward0&gt;),
 tensor([ 149.8828,  667.9688,  471.6797, 1018.2812], device='cuda:0',
        grad_fn=&lt;SelectBackward0&gt;))</code></pre>
</div>
</div>
<div id="cell-288" class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TK - for visualization purposes, write code to highlight the intersecting points on a box and print the IoU score in the middle of the box</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="co"># IoU logic</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. General IoU threshold (removing boxes at a global level, regardless of label)</span></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -&gt; for box pairs with IoU &gt; 0.9, keep the higher scoring box </span></span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Label specific IoU threshold (only concern is comparing boxes with the same label)</span></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -&gt; for box pairs with same label and IoU &gt; 0.5, keep the higher scoring box</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-289" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>keep_boxes <span class="op">=</span> []</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>keep_scores <span class="op">=</span> []</span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>keep_labels <span class="op">=</span> []</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_scores <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"scores"</span>]</span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_labels <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"labels"</span>]</span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>random_test_sample_pred_boxes <span class="op">=</span> random_test_sample_outputs_post_processed[<span class="dv">0</span>][<span class="st">"boxes"</span>]</span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>keep_indexes <span class="op">=</span> torch.ones(<span class="bu">len</span>(random_test_sample_pred_boxes), dtype<span class="op">=</span>torch.<span class="bu">bool</span>)</span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>iou_general_threshold <span class="op">=</span> <span class="fl">0.9</span> <span class="co"># general threshold = remove the lower scoring box in box pairs with over iou_general_threshold regardless of the label</span></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a>iou_class_level_threshold <span class="op">=</span> <span class="fl">0.5</span> <span class="co"># remove overlapping similar classes</span></span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add a clause here to include if class labels are the same, then filter based on the class-specifc IoU threshold</span></span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>filter_global <span class="op">=</span> <span class="va">True</span></span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a>filter_same_label <span class="op">=</span> <span class="va">True</span></span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-18"><a href="#cb254-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the total loops</span></span>
<span id="cb254-19"><a href="#cb254-19" aria-hidden="true" tabindex="-1"></a>total_loops <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb254-20"><a href="#cb254-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-21"><a href="#cb254-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, box_A <span class="kw">in</span> <span class="bu">enumerate</span>(random_test_sample_pred_boxes):</span>
<span id="cb254-22"><a href="#cb254-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> keep_indexes[i]: <span class="co"># insert clause to prevent calculating on already filtered labels</span></span>
<span id="cb254-23"><a href="#cb254-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span> </span>
<span id="cb254-24"><a href="#cb254-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-25"><a href="#cb254-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j, box_B <span class="kw">in</span> <span class="bu">enumerate</span>(random_test_sample_pred_boxes):</span>
<span id="cb254-26"><a href="#cb254-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> keep_indexes[i]:</span>
<span id="cb254-27"><a href="#cb254-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb254-28"><a href="#cb254-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-29"><a href="#cb254-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only calculate IoU score if indexes aren't the same (saves comparing the same index boxes for unwanted calculations)</span></span>
<span id="cb254-30"><a href="#cb254-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i <span class="op">!=</span> j): </span>
<span id="cb254-31"><a href="#cb254-31" aria-hidden="true" tabindex="-1"></a>            iou_score <span class="op">=</span> intersection_over_union_score(box_1<span class="op">=</span>box_A, box_2<span class="op">=</span>box_B)</span>
<span id="cb254-32"><a href="#cb254-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"[INFO] IoU Score for box </span><span class="sc">{</span>(i, j)<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>iou_score<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb254-33"><a href="#cb254-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-34"><a href="#cb254-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> filter_global:</span>
<span id="cb254-35"><a href="#cb254-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> iou_score <span class="op">&gt;</span> iou_general_threshold:</span>
<span id="cb254-36"><a href="#cb254-36" aria-hidden="true" tabindex="-1"></a>                    score_A, score_B <span class="op">=</span> random_test_sample_pred_scores[i], random_test_sample_pred_scores[j]</span>
<span id="cb254-37"><a href="#cb254-37" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> score_A <span class="op">&gt;</span> score_B:</span>
<span id="cb254-38"><a href="#cb254-38" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"[INFO] Box to keep index: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>box_A<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb254-39"><a href="#cb254-39" aria-hidden="true" tabindex="-1"></a>                        keep_indexes[j] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb254-40"><a href="#cb254-40" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb254-41"><a href="#cb254-41" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"[INFO] Box to keep index: </span><span class="sc">{</span>j<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>box_B<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb254-42"><a href="#cb254-42" aria-hidden="true" tabindex="-1"></a>                        keep_indexes[i] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb254-43"><a href="#cb254-43" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb254-44"><a href="#cb254-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> filter_same_label:</span>
<span id="cb254-45"><a href="#cb254-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> iou_score <span class="op">&gt;</span> iou_class_level_threshold:</span>
<span id="cb254-46"><a href="#cb254-46" aria-hidden="true" tabindex="-1"></a>                    i_label <span class="op">=</span> random_test_sample_pred_labels[i]</span>
<span id="cb254-47"><a href="#cb254-47" aria-hidden="true" tabindex="-1"></a>                    j_label <span class="op">=</span> random_test_sample_pred_labels[j]</span>
<span id="cb254-48"><a href="#cb254-48" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> i_label <span class="op">==</span> j_label:</span>
<span id="cb254-49"><a href="#cb254-49" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"Labels are equal: </span><span class="sc">{</span>i_label<span class="sc">,</span> j_label<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb254-50"><a href="#cb254-50" aria-hidden="true" tabindex="-1"></a>                        score_A, score_B <span class="op">=</span> random_test_sample_pred_scores[i], random_test_sample_pred_scores[j]</span>
<span id="cb254-51"><a href="#cb254-51" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> score_A <span class="op">&gt;</span> score_B:</span>
<span id="cb254-52"><a href="#cb254-52" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">print</span>(<span class="ss">f"[INFO] Box to keep index: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>box_A<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb254-53"><a href="#cb254-53" aria-hidden="true" tabindex="-1"></a>                            keep_indexes[j] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb254-54"><a href="#cb254-54" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb254-55"><a href="#cb254-55" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">print</span>(<span class="ss">f"[INFO] Box to keep index: </span><span class="sc">{</span>j<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>box_B<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb254-56"><a href="#cb254-56" aria-hidden="true" tabindex="-1"></a>                            keep_indexes[i] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb254-57"><a href="#cb254-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-58"><a href="#cb254-58" aria-hidden="true" tabindex="-1"></a>        total_loops <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb254-59"><a href="#cb254-59" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb254-60"><a href="#cb254-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(keep_indexes)</span>
<span id="cb254-61"><a href="#cb254-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-62"><a href="#cb254-62" aria-hidden="true" tabindex="-1"></a>keep_scores <span class="op">=</span> random_test_sample_pred_scores[keep_indexes]</span>
<span id="cb254-63"><a href="#cb254-63" aria-hidden="true" tabindex="-1"></a>keep_labels <span class="op">=</span> random_test_sample_pred_labels[keep_indexes]</span>
<span id="cb254-64"><a href="#cb254-64" aria-hidden="true" tabindex="-1"></a>keep_boxes <span class="op">=</span> random_test_sample_pred_boxes[keep_indexes]</span>
<span id="cb254-65"><a href="#cb254-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-66"><a href="#cb254-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(random_test_sample_pred_boxes), <span class="bu">len</span>(random_test_sample_pred_labels), <span class="bu">len</span>(random_test_sample_pred_boxes))</span>
<span id="cb254-67"><a href="#cb254-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(keep_scores), <span class="bu">len</span>(keep_labels), <span class="bu">len</span>(keep_boxes), <span class="bu">sum</span>(keep_indexes))</span>
<span id="cb254-68"><a href="#cb254-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-69"><a href="#cb254-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Number of total loops: </span><span class="sc">{</span>total_loops<span class="sc">}</span><span class="ss">, max possible loops: </span><span class="sc">{</span><span class="bu">len</span>(random_test_sample_pred_boxes)<span class="op">**</span><span class="dv">2</span><span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] IoU Score for box (0, 1): 0.156358003616333
[INFO] IoU Score for box (0, 2): 0.10704872757196426
[INFO] IoU Score for box (0, 3): 0.3096315264701843
[INFO] IoU Score for box (0, 4): 0.3974636495113373
[INFO] IoU Score for box (0, 5): 0.06380129605531693
[INFO] IoU Score for box (0, 6): 0.2954297661781311
[INFO] IoU Score for box (1, 0): 0.156358003616333
[INFO] IoU Score for box (1, 2): 0.11466032266616821
[INFO] IoU Score for box (1, 3): 0.2778415083885193
[INFO] IoU Score for box (1, 4): 0.36936208605766296
[INFO] IoU Score for box (1, 5): 0.08170551061630249
[INFO] IoU Score for box (1, 6): 0.4092644155025482
[INFO] IoU Score for box (2, 0): 0.10704872757196426
[INFO] IoU Score for box (2, 1): 0.11466032266616821
[INFO] IoU Score for box (2, 3): 0.34572935104370117
[INFO] IoU Score for box (2, 4): 0.26932957768440247
[INFO] IoU Score for box (2, 5): 0.17588727176189423
[INFO] IoU Score for box (2, 6): 0.058975815773010254
[INFO] IoU Score for box (3, 0): 0.3096315264701843
[INFO] IoU Score for box (3, 1): 0.2778415083885193
[INFO] IoU Score for box (3, 2): 0.34572935104370117
[INFO] IoU Score for box (3, 4): 0.7790185809135437
Labels are equal: (tensor(5, device='cuda:0'), tensor(5, device='cuda:0'))
[INFO] Box to keep index: 3 -&gt; tensor([248.2031, 472.6562, 675.7031, 994.8438], device='cuda:0',
       grad_fn=&lt;UnbindBackward0&gt;)
[INFO] IoU Score for box (3, 5): 0.11186295002698898
[INFO] IoU Score for box (3, 6): 0.1719416379928589
[INFO] IoU Score for box (5, 0): 0.06380129605531693
[INFO] IoU Score for box (5, 1): 0.08170551061630249
[INFO] IoU Score for box (5, 2): 0.17588727176189423
[INFO] IoU Score for box (5, 3): 0.11186295002698898
[INFO] IoU Score for box (5, 4): 0.0963958203792572
[INFO] IoU Score for box (5, 6): 0.05411146208643913
[INFO] IoU Score for box (6, 0): 0.2954297661781311
[INFO] IoU Score for box (6, 1): 0.4092644155025482
[INFO] IoU Score for box (6, 2): 0.058975815773010254
[INFO] IoU Score for box (6, 3): 0.1719416379928589
[INFO] IoU Score for box (6, 4): 0.24588997662067413
[INFO] IoU Score for box (6, 5): 0.05411146208643913
tensor([ True,  True,  True,  True, False,  True,  True])
7 7 7
6 6 6 tensor(6)
[INFO] Number of total loops: 42, max possible loops: 49</code></pre>
</div>
</div>
<div id="cell-290" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tensor([ True,  True,  True,  True,  True, False,  True, False])</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tensor([ True,  True,  True,  True,  True, False,  True, False])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-291" class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of labels to plot on the boxes </span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>random_test_sample_labels_to_plot <span class="op">=</span> [<span class="ss">f"Pred: </span><span class="sc">{</span>id2label[label_pred.item()]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score_pred.item(), <span class="dv">4</span>)<span class="sc">}</span><span class="ss">)"</span> </span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> label_pred, score_pred <span class="kw">in</span> <span class="bu">zip</span>(random_test_sample_pred_labels, random_test_sample_pred_scores)]</span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Labels with scores: </span><span class="sc">{</span>random_test_sample_labels_to_plot<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted boxes on the random test image </span></span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>test_image_with_preds_original <span class="op">=</span> to_pil_image(</span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>dataset[<span class="st">"test"</span>][random_test_pred_index][<span class="st">"image"</span>]),</span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>random_test_sample_pred_boxes,</span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_test_sample_labels_to_plot,</span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">3</span></span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a><span class="co">### Create image with filtered boxes</span></span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-19"><a href="#cb257-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of labels to plot on the boxes </span></span>
<span id="cb257-20"><a href="#cb257-20" aria-hidden="true" tabindex="-1"></a>random_test_sample_labels_to_plot_filtered <span class="op">=</span> [<span class="ss">f"Pred: </span><span class="sc">{</span>id2label[label_pred.item()]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score_pred.item(), <span class="dv">4</span>)<span class="sc">}</span><span class="ss">)"</span> </span>
<span id="cb257-21"><a href="#cb257-21" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> label_pred, score_pred <span class="kw">in</span> <span class="bu">zip</span>(keep_labels, keep_scores)]</span>
<span id="cb257-22"><a href="#cb257-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-23"><a href="#cb257-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Labels with scores: </span><span class="sc">{</span>random_test_sample_labels_to_plot_filtered<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb257-24"><a href="#cb257-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-25"><a href="#cb257-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predicted boxes on the random test image </span></span>
<span id="cb257-26"><a href="#cb257-26" aria-hidden="true" tabindex="-1"></a>test_image_with_preds_filtered <span class="op">=</span> to_pil_image(</span>
<span id="cb257-27"><a href="#cb257-27" aria-hidden="true" tabindex="-1"></a>    pic<span class="op">=</span>draw_bounding_boxes(</span>
<span id="cb257-28"><a href="#cb257-28" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>pil_to_tensor(pic<span class="op">=</span>dataset[<span class="st">"test"</span>][random_test_pred_index][<span class="st">"image"</span>]),</span>
<span id="cb257-29"><a href="#cb257-29" aria-hidden="true" tabindex="-1"></a>        boxes<span class="op">=</span>keep_boxes,</span>
<span id="cb257-30"><a href="#cb257-30" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>random_test_sample_labels_to_plot_filtered,</span>
<span id="cb257-31"><a href="#cb257-31" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">3</span></span>
<span id="cb257-32"><a href="#cb257-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb257-33"><a href="#cb257-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb257-34"><a href="#cb257-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-35"><a href="#cb257-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the transformed image </span></span>
<span id="cb257-36"><a href="#cb257-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb257-37"><a href="#cb257-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-38"><a href="#cb257-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a figure with two subplots</span></span>
<span id="cb257-39"><a href="#cb257-39" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>))</span>
<span id="cb257-40"><a href="#cb257-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-41"><a href="#cb257-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Display image 1</span></span>
<span id="cb257-42"><a href="#cb257-42" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].imshow(test_image_with_preds_original)</span>
<span id="cb257-43"><a href="#cb257-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axis(<span class="st">"off"</span>)  <span class="co"># Hide axes</span></span>
<span id="cb257-44"><a href="#cb257-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="ss">f"Original Image Preds (total: </span><span class="sc">{</span><span class="bu">len</span>(random_test_sample_pred_boxes)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb257-45"><a href="#cb257-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-46"><a href="#cb257-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Display image 2</span></span>
<span id="cb257-47"><a href="#cb257-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].imshow(test_image_with_preds_filtered)</span>
<span id="cb257-48"><a href="#cb257-48" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axis(<span class="st">"off"</span>)  <span class="co"># Hide axes</span></span>
<span id="cb257-49"><a href="#cb257-49" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="ss">f"Filtered Image Preds (total: </span><span class="sc">{</span><span class="bu">len</span>(keep_boxes)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb257-50"><a href="#cb257-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-51"><a href="#cb257-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb257-52"><a href="#cb257-52" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="ss">f"Greedy IoU Filtering (General) - For boxes with IoU &gt; </span><span class="sc">{</span>iou_general_threshold<span class="sc">}</span><span class="ss">, keep the higher scoring box"</span>)</span>
<span id="cb257-53"><a href="#cb257-53" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb257-54"><a href="#cb257-54" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Labels with scores: ['Pred: bin (0.6625)', 'Pred: hand (0.5412)', 'Pred: trash (0.5007)', 'Pred: trash (0.4147)', 'Pred: trash (0.396)', 'Pred: not_trash (0.3237)', 'Pred: hand (0.2799)']
[INFO] Labels with scores: ['Pred: bin (0.6625)', 'Pred: hand (0.5412)', 'Pred: trash (0.5007)', 'Pred: trash (0.4147)', 'Pred: not_trash (0.3237)', 'Pred: hand (0.2799)']</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hugging_face_object_detection_tutorial_files/figure-html/cell-140-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-292" class="cell">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TK - more NMS logic:</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a><span class="co"># If there are more than two hands, keep the one with the higher score...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tk---create-a-demo-with-simple-nms-filtering-only-keep-the-highest-scoring-boxes-per-image" class="level2" data-number="23">
<h2 data-number="23" class="anchored" data-anchor-id="tk---create-a-demo-with-simple-nms-filtering-only-keep-the-highest-scoring-boxes-per-image"><span class="header-section-number">23</span> TK - Create a Demo with Simple NMS Filtering (only keep the highest scoring boxes per image)</h2>
<p>UPTOHERE:</p>
<ul>
<li>upload the demo to Hugging Face Spaces as Trashify V3</li>
<li>Make sure the demo works</li>
<li>Go back through the code and start tidying up/explaining things
<ul>
<li>Create a blog post to discuss different box formats in object detection</li>
<li>Create a blog post for NMS + IoU filtering (can create an IoU function that colours in the intersection parts)</li>
<li>Create an extension for longer training + synthetic data + evaluation metrics + deploying on transformers.js</li>
</ul></li>
</ul>
<div id="cell-294" class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make directory for demo</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>trashify_data_aug_model_dir <span class="op">=</span> Path(<span class="st">"demos/trashify_object_detector_data_aug_model_with_nms/"</span>)</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>trashify_data_aug_model_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-295" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector_data_aug_model_with_nms<span class="op">/</span>requirements.txt</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>timm</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>gradio</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>torch</span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>transformers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector_data_aug_model_with_nms/requirements.txt</code></pre>
</div>
</div>
<div id="cell-296" class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector_data_aug_model_with_nms<span class="op">/</span>README.md</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>title: Trashify Demo V3 ðŸš®</span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a>emoji: ðŸ—‘ï¸</span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a>colorFrom: purple</span>
<span id="cb263-6"><a href="#cb263-6" aria-hidden="true" tabindex="-1"></a>colorTo: blue</span>
<span id="cb263-7"><a href="#cb263-7" aria-hidden="true" tabindex="-1"></a>sdk: gradio</span>
<span id="cb263-8"><a href="#cb263-8" aria-hidden="true" tabindex="-1"></a>sdk_version: <span class="fl">4.40.0</span></span>
<span id="cb263-9"><a href="#cb263-9" aria-hidden="true" tabindex="-1"></a>app_file: app.py</span>
<span id="cb263-10"><a href="#cb263-10" aria-hidden="true" tabindex="-1"></a>pinned: false</span>
<span id="cb263-11"><a href="#cb263-11" aria-hidden="true" tabindex="-1"></a>license: apache<span class="op">-</span><span class="fl">2.0</span></span>
<span id="cb263-12"><a href="#cb263-12" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb263-13"><a href="#cb263-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-14"><a href="#cb263-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ðŸš® Trashify Object Detector Demo V3</span></span>
<span id="cb263-15"><a href="#cb263-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-16"><a href="#cb263-16" aria-hidden="true" tabindex="-1"></a>Object detection demo to detect `trash`, `bin`, `hand`, `trash_arm`, `not_trash`, `not_bin`, `not_hand`. </span>
<span id="cb263-17"><a href="#cb263-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-18"><a href="#cb263-18" aria-hidden="true" tabindex="-1"></a>Used <span class="im">as</span> example <span class="cf">for</span> encouraging people to cleanup their local area.</span>
<span id="cb263-19"><a href="#cb263-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-20"><a href="#cb263-20" aria-hidden="true" tabindex="-1"></a>If `trash`, `hand`, `bin` <span class="bu">all</span> detected <span class="op">=</span> <span class="op">+</span><span class="dv">1</span> point.</span>
<span id="cb263-21"><a href="#cb263-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-22"><a href="#cb263-22" aria-hidden="true" tabindex="-1"></a><span class="co">## Dataset</span></span>
<span id="cb263-23"><a href="#cb263-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-24"><a href="#cb263-24" aria-hidden="true" tabindex="-1"></a>All Trashify models are trained on a custom hand<span class="op">-</span>labelled dataset of people picking up trash <span class="kw">and</span> placing it <span class="kw">in</span> a <span class="bu">bin</span>.</span>
<span id="cb263-25"><a href="#cb263-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-26"><a href="#cb263-26" aria-hidden="true" tabindex="-1"></a>The dataset can be found on Hugging Face <span class="im">as</span> [`mrdbourke<span class="op">/</span>trashify_manual_labelled_images`](https:<span class="op">//</span>huggingface.co<span class="op">/</span>datasets<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_manual_labelled_images).</span>
<span id="cb263-27"><a href="#cb263-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-28"><a href="#cb263-28" aria-hidden="true" tabindex="-1"></a><span class="co">## Demos</span></span>
<span id="cb263-29"><a href="#cb263-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-30"><a href="#cb263-30" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V1](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v1) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span>without<span class="op">*</span> data augmentation.</span>
<span id="cb263-31"><a href="#cb263-31" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V2](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v2) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span><span class="cf">with</span><span class="op">*</span> data augmentation.</span>
<span id="cb263-32"><a href="#cb263-32" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> [V3](https:<span class="op">//</span>huggingface.co<span class="op">/</span>spaces<span class="op">/</span>mrdbourke<span class="op">/</span>trashify_demo_v3) <span class="op">=</span> Fine<span class="op">-</span>tuned DETR model trained <span class="op">*</span><span class="cf">with</span><span class="op">*</span> data augmentation (same <span class="im">as</span> V2) <span class="cf">with</span> an NMS (Non Maximum Suppression) post<span class="op">-</span>processing step.</span>
<span id="cb263-33"><a href="#cb263-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-34"><a href="#cb263-34" aria-hidden="true" tabindex="-1"></a>TK <span class="op">-</span> finish the README.md <span class="op">+</span> update <span class="cf">with</span> links to materials</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector_data_aug_model_with_nms/README.md</code></pre>
</div>
</div>
<div id="cell-297" class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile demos<span class="op">/</span>trashify_object_detector_data_aug_model_with_nms<span class="op">/</span>app.py</span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gradio <span class="im">as</span> gr</span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image, ImageDraw, ImageFont</span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoImageProcessor</span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForObjectDetection</span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-9"><a href="#cb265-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Can load from Hugging Face or can load from local.</span></span>
<span id="cb265-10"><a href="#cb265-10" aria-hidden="true" tabindex="-1"></a><span class="co"># You will have to replace {mrdbourke} for your own username if the model is on your Hugging Face account.</span></span>
<span id="cb265-11"><a href="#cb265-11" aria-hidden="true" tabindex="-1"></a>model_save_path <span class="op">=</span> <span class="st">"mrdbourke/detr_finetuned_trashify_box_detector_with_data_aug"</span> </span>
<span id="cb265-12"><a href="#cb265-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-13"><a href="#cb265-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model and preprocessor</span></span>
<span id="cb265-14"><a href="#cb265-14" aria-hidden="true" tabindex="-1"></a>image_processor <span class="op">=</span> AutoImageProcessor.from_pretrained(model_save_path)</span>
<span id="cb265-15"><a href="#cb265-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForObjectDetection.from_pretrained(model_save_path)</span>
<span id="cb265-16"><a href="#cb265-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-17"><a href="#cb265-17" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb265-18"><a href="#cb265-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span>
<span id="cb265-19"><a href="#cb265-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-20"><a href="#cb265-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the id2label dictionary from the model</span></span>
<span id="cb265-21"><a href="#cb265-21" aria-hidden="true" tabindex="-1"></a>id2label <span class="op">=</span> model.config.id2label</span>
<span id="cb265-22"><a href="#cb265-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-23"><a href="#cb265-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a colour dictionary for plotting boxes with different colours</span></span>
<span id="cb265-24"><a href="#cb265-24" aria-hidden="true" tabindex="-1"></a>color_dict <span class="op">=</span> {   </span>
<span id="cb265-25"><a href="#cb265-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bin"</span>: <span class="st">"green"</span>,</span>
<span id="cb265-26"><a href="#cb265-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trash"</span>: <span class="st">"blue"</span>,</span>
<span id="cb265-27"><a href="#cb265-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hand"</span>: <span class="st">"purple"</span>,</span>
<span id="cb265-28"><a href="#cb265-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trash_arm"</span>: <span class="st">"yellow"</span>,</span>
<span id="cb265-29"><a href="#cb265-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_trash"</span>: <span class="st">"red"</span>,</span>
<span id="cb265-30"><a href="#cb265-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_bin"</span>: <span class="st">"red"</span>,</span>
<span id="cb265-31"><a href="#cb265-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"not_hand"</span>: <span class="st">"red"</span>,</span>
<span id="cb265-32"><a href="#cb265-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb265-33"><a href="#cb265-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-34"><a href="#cb265-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create helper functions for seeing if items from one list are in another </span></span>
<span id="cb265-35"><a href="#cb265-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> any_in_list(list_a, list_b):</span>
<span id="cb265-36"><a href="#cb265-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns True if any item from list_a is in list_b, otherwise False."</span></span>
<span id="cb265-37"><a href="#cb265-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">any</span>(item <span class="kw">in</span> list_b <span class="cf">for</span> item <span class="kw">in</span> list_a)</span>
<span id="cb265-38"><a href="#cb265-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-39"><a href="#cb265-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_in_list(list_a, list_b):</span>
<span id="cb265-40"><a href="#cb265-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns True if all items from list_a are in list_b, otherwise False."</span></span>
<span id="cb265-41"><a href="#cb265-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">all</span>(item <span class="kw">in</span> list_b <span class="cf">for</span> item <span class="kw">in</span> list_a)</span>
<span id="cb265-42"><a href="#cb265-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-43"><a href="#cb265-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_highest_scoring_box_per_class(boxes, labels, scores):</span>
<span id="cb265-44"><a href="#cb265-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb265-45"><a href="#cb265-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform NMS (Non-max Supression) to only keep the top scoring box per class.</span></span>
<span id="cb265-46"><a href="#cb265-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-47"><a href="#cb265-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb265-48"><a href="#cb265-48" aria-hidden="true" tabindex="-1"></a><span class="co">        boxes: tensor of shape (N, 4)</span></span>
<span id="cb265-49"><a href="#cb265-49" aria-hidden="true" tabindex="-1"></a><span class="co">        labels: tensor of shape (N,)</span></span>
<span id="cb265-50"><a href="#cb265-50" aria-hidden="true" tabindex="-1"></a><span class="co">        scores: tensor of shape (N,)</span></span>
<span id="cb265-51"><a href="#cb265-51" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb265-52"><a href="#cb265-52" aria-hidden="true" tabindex="-1"></a><span class="co">        boxes: tensor of shape (N, 4) filtered for max scoring item per class</span></span>
<span id="cb265-53"><a href="#cb265-53" aria-hidden="true" tabindex="-1"></a><span class="co">        labels: tensor of shape (N,) filtered for max scoring item per class</span></span>
<span id="cb265-54"><a href="#cb265-54" aria-hidden="true" tabindex="-1"></a><span class="co">        scores: tensor of shape (N,) filtered for max scoring item per class</span></span>
<span id="cb265-55"><a href="#cb265-55" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb265-56"><a href="#cb265-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start with a blank keep mask (e.g. all False and then update the boxes to keep with True)</span></span>
<span id="cb265-57"><a href="#cb265-57" aria-hidden="true" tabindex="-1"></a>    keep_mask <span class="op">=</span> torch.zeros(<span class="bu">len</span>(boxes), dtype<span class="op">=</span>torch.<span class="bu">bool</span>)</span>
<span id="cb265-58"><a href="#cb265-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-59"><a href="#cb265-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each unique class</span></span>
<span id="cb265-60"><a href="#cb265-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> class_id <span class="kw">in</span> labels.unique():</span>
<span id="cb265-61"><a href="#cb265-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the indicies for the target class</span></span>
<span id="cb265-62"><a href="#cb265-62" aria-hidden="true" tabindex="-1"></a>        class_mask <span class="op">=</span> labels <span class="op">==</span> class_id</span>
<span id="cb265-63"><a href="#cb265-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-64"><a href="#cb265-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If any of the labels match the current class_id</span></span>
<span id="cb265-65"><a href="#cb265-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> class_mask.<span class="bu">any</span>():</span>
<span id="cb265-66"><a href="#cb265-66" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Find the index of highest scoring box for this specific class</span></span>
<span id="cb265-67"><a href="#cb265-67" aria-hidden="true" tabindex="-1"></a>            class_scores <span class="op">=</span> scores[class_mask]</span>
<span id="cb265-68"><a href="#cb265-68" aria-hidden="true" tabindex="-1"></a>            highest_score_idx <span class="op">=</span> class_scores.argmax()</span>
<span id="cb265-69"><a href="#cb265-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-70"><a href="#cb265-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert back to the original index</span></span>
<span id="cb265-71"><a href="#cb265-71" aria-hidden="true" tabindex="-1"></a>            original_idx <span class="op">=</span> torch.where(class_mask)[<span class="dv">0</span>][highest_score_idx]</span>
<span id="cb265-72"><a href="#cb265-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-73"><a href="#cb265-73" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update the index in the keep mask to keep the highest scoring box </span></span>
<span id="cb265-74"><a href="#cb265-74" aria-hidden="true" tabindex="-1"></a>            keep_mask[original_idx] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb265-75"><a href="#cb265-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb265-76"><a href="#cb265-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> boxes[keep_mask], labels[keep_mask], scores[keep_mask]</span>
<span id="cb265-77"><a href="#cb265-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-78"><a href="#cb265-78" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_return_string(list_of_predicted_labels, target_items<span class="op">=</span>[<span class="st">"trash"</span>, <span class="st">"bin"</span>, <span class="st">"hand"</span>]):</span>
<span id="cb265-79"><a href="#cb265-79" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Setup blank string to print out</span></span>
<span id="cb265-80"><a href="#cb265-80" aria-hidden="true" tabindex="-1"></a>    return_string <span class="op">=</span> <span class="st">""</span></span>
<span id="cb265-81"><a href="#cb265-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-82"><a href="#cb265-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If no items detected or trash, bin, hand not in list, return notification </span></span>
<span id="cb265-83"><a href="#cb265-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">len</span>(list_of_predicted_labels) <span class="op">==</span> <span class="dv">0</span>) <span class="kw">or</span> <span class="kw">not</span> (any_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>list_of_predicted_labels)):</span>
<span id="cb265-84"><a href="#cb265-84" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"No trash, bin or hand detected at confidence threshold </span><span class="sc">{</span>conf_threshold<span class="sc">}</span><span class="ss">. Try another image or lowering the confidence threshold."</span></span>
<span id="cb265-85"><a href="#cb265-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> return_string</span>
<span id="cb265-86"><a href="#cb265-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-87"><a href="#cb265-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If there are some missing, print the ones which are missing</span></span>
<span id="cb265-88"><a href="#cb265-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="kw">not</span> all_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>list_of_predicted_labels):</span>
<span id="cb265-89"><a href="#cb265-89" aria-hidden="true" tabindex="-1"></a>        missing_items <span class="op">=</span> []</span>
<span id="cb265-90"><a href="#cb265-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> target_items:</span>
<span id="cb265-91"><a href="#cb265-91" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> item <span class="kw">not</span> <span class="kw">in</span> list_of_predicted_labels:</span>
<span id="cb265-92"><a href="#cb265-92" aria-hidden="true" tabindex="-1"></a>                missing_items.append(item)</span>
<span id="cb265-93"><a href="#cb265-93" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"Detected the following items: </span><span class="sc">{</span>list_of_predicted_labels<span class="sc">}</span><span class="ss"> (total: </span><span class="sc">{</span><span class="bu">len</span>(list_of_predicted_labels)<span class="sc">}</span><span class="ss">). But missing the following in order to get +1: </span><span class="sc">{</span>missing_items<span class="sc">}</span><span class="ss">. If this is an error, try another image or altering the confidence threshold. Otherwise, the model may need to be updated with better data."</span></span>
<span id="cb265-94"><a href="#cb265-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb265-95"><a href="#cb265-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If all 3 trash, bin, hand occur = + 1</span></span>
<span id="cb265-96"><a href="#cb265-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> all_in_list(list_a<span class="op">=</span>target_items, list_b<span class="op">=</span>list_of_predicted_labels):</span>
<span id="cb265-97"><a href="#cb265-97" aria-hidden="true" tabindex="-1"></a>        return_string <span class="op">=</span> <span class="ss">f"+1! Found the following items: </span><span class="sc">{</span>list_of_predicted_labels<span class="sc">}</span><span class="ss"> (total: </span><span class="sc">{</span><span class="bu">len</span>(list_of_predicted_labels)<span class="sc">}</span><span class="ss">), thank you for cleaning up the area!"</span></span>
<span id="cb265-98"><a href="#cb265-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-99"><a href="#cb265-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(return_string)</span>
<span id="cb265-100"><a href="#cb265-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-101"><a href="#cb265-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> return_string</span>
<span id="cb265-102"><a href="#cb265-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-103"><a href="#cb265-103" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_on_image(image, conf_threshold):</span>
<span id="cb265-104"><a href="#cb265-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb265-105"><a href="#cb265-105" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> image_processor(images<span class="op">=</span>[image], return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb265-106"><a href="#cb265-106" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> model(<span class="op">**</span>inputs.to(device))</span>
<span id="cb265-107"><a href="#cb265-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-108"><a href="#cb265-108" aria-hidden="true" tabindex="-1"></a>        target_sizes <span class="op">=</span> torch.tensor([[image.size[<span class="dv">1</span>], image.size[<span class="dv">0</span>]]]) <span class="co"># height, width </span></span>
<span id="cb265-109"><a href="#cb265-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-110"><a href="#cb265-110" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> image_processor.post_process_object_detection(outputs,</span>
<span id="cb265-111"><a href="#cb265-111" aria-hidden="true" tabindex="-1"></a>                                                                threshold<span class="op">=</span>conf_threshold,</span>
<span id="cb265-112"><a href="#cb265-112" aria-hidden="true" tabindex="-1"></a>                                                                target_sizes<span class="op">=</span>target_sizes)[<span class="dv">0</span>]</span>
<span id="cb265-113"><a href="#cb265-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return all items in results to CPU</span></span>
<span id="cb265-114"><a href="#cb265-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> results.items():</span>
<span id="cb265-115"><a href="#cb265-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb265-116"><a href="#cb265-116" aria-hidden="true" tabindex="-1"></a>            results[key] <span class="op">=</span> value.item().cpu() <span class="co"># can't get scalar as .item() so add try/except block</span></span>
<span id="cb265-117"><a href="#cb265-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb265-118"><a href="#cb265-118" aria-hidden="true" tabindex="-1"></a>            results[key] <span class="op">=</span> value.cpu()</span>
<span id="cb265-119"><a href="#cb265-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-120"><a href="#cb265-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Can return results as plotted on a PIL image (then display the image)</span></span>
<span id="cb265-121"><a href="#cb265-121" aria-hidden="true" tabindex="-1"></a>    draw <span class="op">=</span> ImageDraw.Draw(image)</span>
<span id="cb265-122"><a href="#cb265-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-123"><a href="#cb265-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy of the image to draw on it for NMS</span></span>
<span id="cb265-124"><a href="#cb265-124" aria-hidden="true" tabindex="-1"></a>    image_nms <span class="op">=</span> image.copy()</span>
<span id="cb265-125"><a href="#cb265-125" aria-hidden="true" tabindex="-1"></a>    draw_nms <span class="op">=</span> ImageDraw.Draw(image_nms)</span>
<span id="cb265-126"><a href="#cb265-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-127"><a href="#cb265-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a font from ImageFont</span></span>
<span id="cb265-128"><a href="#cb265-128" aria-hidden="true" tabindex="-1"></a>    font <span class="op">=</span> ImageFont.load_default(size<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb265-129"><a href="#cb265-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-130"><a href="#cb265-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get class names as text for print out</span></span>
<span id="cb265-131"><a href="#cb265-131" aria-hidden="true" tabindex="-1"></a>    class_name_text_labels <span class="op">=</span> []</span>
<span id="cb265-132"><a href="#cb265-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-133"><a href="#cb265-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TK - update this for NMS</span></span>
<span id="cb265-134"><a href="#cb265-134" aria-hidden="true" tabindex="-1"></a>    class_name_text_labels_nms <span class="op">=</span> []</span>
<span id="cb265-135"><a href="#cb265-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-136"><a href="#cb265-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get original boxes, scores, labels</span></span>
<span id="cb265-137"><a href="#cb265-137" aria-hidden="true" tabindex="-1"></a>    original_boxes <span class="op">=</span> results[<span class="st">"boxes"</span>]</span>
<span id="cb265-138"><a href="#cb265-138" aria-hidden="true" tabindex="-1"></a>    original_labels <span class="op">=</span> results[<span class="st">"labels"</span>]</span>
<span id="cb265-139"><a href="#cb265-139" aria-hidden="true" tabindex="-1"></a>    original_scores <span class="op">=</span> results[<span class="st">"scores"</span>]</span>
<span id="cb265-140"><a href="#cb265-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-141"><a href="#cb265-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter boxes and only keep 1x of each label with highest score</span></span>
<span id="cb265-142"><a href="#cb265-142" aria-hidden="true" tabindex="-1"></a>    filtered_boxes, filtered_labels, filtered_scores <span class="op">=</span> filter_highest_scoring_box_per_class(boxes<span class="op">=</span>original_boxes,</span>
<span id="cb265-143"><a href="#cb265-143" aria-hidden="true" tabindex="-1"></a>                                                                                            labels<span class="op">=</span>original_labels,</span>
<span id="cb265-144"><a href="#cb265-144" aria-hidden="true" tabindex="-1"></a>                                                                                            scores<span class="op">=</span>original_scores)</span>
<span id="cb265-145"><a href="#cb265-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: turn this into a function so it's cleaner?</span></span>
<span id="cb265-146"><a href="#cb265-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> box, label, score <span class="kw">in</span> <span class="bu">zip</span>(original_boxes, original_labels, original_scores):</span>
<span id="cb265-147"><a href="#cb265-147" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create coordinates</span></span>
<span id="cb265-148"><a href="#cb265-148" aria-hidden="true" tabindex="-1"></a>        x, y, x2, y2 <span class="op">=</span> <span class="bu">tuple</span>(box.tolist())</span>
<span id="cb265-149"><a href="#cb265-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-150"><a href="#cb265-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get label_name</span></span>
<span id="cb265-151"><a href="#cb265-151" aria-hidden="true" tabindex="-1"></a>        label_name <span class="op">=</span> id2label[label.item()]</span>
<span id="cb265-152"><a href="#cb265-152" aria-hidden="true" tabindex="-1"></a>        targ_color <span class="op">=</span> color_dict[label_name]</span>
<span id="cb265-153"><a href="#cb265-153" aria-hidden="true" tabindex="-1"></a>        class_name_text_labels.append(label_name)</span>
<span id="cb265-154"><a href="#cb265-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-155"><a href="#cb265-155" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the rectangle</span></span>
<span id="cb265-156"><a href="#cb265-156" aria-hidden="true" tabindex="-1"></a>        draw.rectangle(xy<span class="op">=</span>(x, y, x2, y2), </span>
<span id="cb265-157"><a href="#cb265-157" aria-hidden="true" tabindex="-1"></a>                       outline<span class="op">=</span>targ_color,</span>
<span id="cb265-158"><a href="#cb265-158" aria-hidden="true" tabindex="-1"></a>                       width<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb265-159"><a href="#cb265-159" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb265-160"><a href="#cb265-160" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a text string to display</span></span>
<span id="cb265-161"><a href="#cb265-161" aria-hidden="true" tabindex="-1"></a>        text_string_to_show <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>label_name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score.item(), <span class="dv">3</span>)<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb265-162"><a href="#cb265-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-163"><a href="#cb265-163" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the text on the image</span></span>
<span id="cb265-164"><a href="#cb265-164" aria-hidden="true" tabindex="-1"></a>        draw.text(xy<span class="op">=</span>(x, y),</span>
<span id="cb265-165"><a href="#cb265-165" aria-hidden="true" tabindex="-1"></a>                  text<span class="op">=</span>text_string_to_show,</span>
<span id="cb265-166"><a href="#cb265-166" aria-hidden="true" tabindex="-1"></a>                  fill<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb265-167"><a href="#cb265-167" aria-hidden="true" tabindex="-1"></a>                  font<span class="op">=</span>font)</span>
<span id="cb265-168"><a href="#cb265-168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb265-169"><a href="#cb265-169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: turn this into a function so it's cleaner?</span></span>
<span id="cb265-170"><a href="#cb265-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> box, label, score <span class="kw">in</span> <span class="bu">zip</span>(filtered_boxes, filtered_labels, filtered_scores):</span>
<span id="cb265-171"><a href="#cb265-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create coordinates</span></span>
<span id="cb265-172"><a href="#cb265-172" aria-hidden="true" tabindex="-1"></a>        x, y, x2, y2 <span class="op">=</span> <span class="bu">tuple</span>(box.tolist())</span>
<span id="cb265-173"><a href="#cb265-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-174"><a href="#cb265-174" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get label_name</span></span>
<span id="cb265-175"><a href="#cb265-175" aria-hidden="true" tabindex="-1"></a>        label_name <span class="op">=</span> id2label[label.item()]</span>
<span id="cb265-176"><a href="#cb265-176" aria-hidden="true" tabindex="-1"></a>        targ_color <span class="op">=</span> color_dict[label_name]</span>
<span id="cb265-177"><a href="#cb265-177" aria-hidden="true" tabindex="-1"></a>        class_name_text_labels_nms.append(label_name)</span>
<span id="cb265-178"><a href="#cb265-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-179"><a href="#cb265-179" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the rectangle</span></span>
<span id="cb265-180"><a href="#cb265-180" aria-hidden="true" tabindex="-1"></a>        draw_nms.rectangle(xy<span class="op">=</span>(x, y, x2, y2), </span>
<span id="cb265-181"><a href="#cb265-181" aria-hidden="true" tabindex="-1"></a>                       outline<span class="op">=</span>targ_color,</span>
<span id="cb265-182"><a href="#cb265-182" aria-hidden="true" tabindex="-1"></a>                       width<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb265-183"><a href="#cb265-183" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb265-184"><a href="#cb265-184" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a text string to display</span></span>
<span id="cb265-185"><a href="#cb265-185" aria-hidden="true" tabindex="-1"></a>        text_string_to_show <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>label_name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">round</span>(score.item(), <span class="dv">3</span>)<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb265-186"><a href="#cb265-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-187"><a href="#cb265-187" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the text on the image</span></span>
<span id="cb265-188"><a href="#cb265-188" aria-hidden="true" tabindex="-1"></a>        draw_nms.text(xy<span class="op">=</span>(x, y),</span>
<span id="cb265-189"><a href="#cb265-189" aria-hidden="true" tabindex="-1"></a>                  text<span class="op">=</span>text_string_to_show,</span>
<span id="cb265-190"><a href="#cb265-190" aria-hidden="true" tabindex="-1"></a>                  fill<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb265-191"><a href="#cb265-191" aria-hidden="true" tabindex="-1"></a>                  font<span class="op">=</span>font)</span>
<span id="cb265-192"><a href="#cb265-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb265-193"><a href="#cb265-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb265-194"><a href="#cb265-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the draw each time</span></span>
<span id="cb265-195"><a href="#cb265-195" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> draw</span>
<span id="cb265-196"><a href="#cb265-196" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> draw_nms</span>
<span id="cb265-197"><a href="#cb265-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-198"><a href="#cb265-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the return string</span></span>
<span id="cb265-199"><a href="#cb265-199" aria-hidden="true" tabindex="-1"></a>    return_string <span class="op">=</span> create_return_string(list_of_predicted_labels<span class="op">=</span>class_name_text_labels)</span>
<span id="cb265-200"><a href="#cb265-200" aria-hidden="true" tabindex="-1"></a>    return_string_nms <span class="op">=</span> create_return_string(list_of_predicted_labels<span class="op">=</span>class_name_text_labels_nms)</span>
<span id="cb265-201"><a href="#cb265-201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb265-202"><a href="#cb265-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image, return_string, image_nms, return_string_nms</span>
<span id="cb265-203"><a href="#cb265-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-204"><a href="#cb265-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the interface</span></span>
<span id="cb265-205"><a href="#cb265-205" aria-hidden="true" tabindex="-1"></a>demo <span class="op">=</span> gr.Interface(</span>
<span id="cb265-206"><a href="#cb265-206" aria-hidden="true" tabindex="-1"></a>    fn<span class="op">=</span>predict_on_image,</span>
<span id="cb265-207"><a href="#cb265-207" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span>[</span>
<span id="cb265-208"><a href="#cb265-208" aria-hidden="true" tabindex="-1"></a>        gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">"pil"</span>, label<span class="op">=</span><span class="st">"Target Image"</span>),</span>
<span id="cb265-209"><a href="#cb265-209" aria-hidden="true" tabindex="-1"></a>        gr.Slider(minimum<span class="op">=</span><span class="dv">0</span>, maximum<span class="op">=</span><span class="dv">1</span>, value<span class="op">=</span><span class="fl">0.25</span>, label<span class="op">=</span><span class="st">"Confidence Threshold"</span>)</span>
<span id="cb265-210"><a href="#cb265-210" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb265-211"><a href="#cb265-211" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>[</span>
<span id="cb265-212"><a href="#cb265-212" aria-hidden="true" tabindex="-1"></a>        gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">"pil"</span>, label<span class="op">=</span><span class="st">"Image Output (no filtering)"</span>),</span>
<span id="cb265-213"><a href="#cb265-213" aria-hidden="true" tabindex="-1"></a>        gr.Text(label<span class="op">=</span><span class="st">"Text Output (no filtering)"</span>),</span>
<span id="cb265-214"><a href="#cb265-214" aria-hidden="true" tabindex="-1"></a>        gr.Image(<span class="bu">type</span><span class="op">=</span><span class="st">"pil"</span>, label<span class="op">=</span><span class="st">"Image Output (with max score per class box filtering)"</span>),</span>
<span id="cb265-215"><a href="#cb265-215" aria-hidden="true" tabindex="-1"></a>        gr.Text(label<span class="op">=</span><span class="st">"Text Output (with max score per class box filtering)"</span>)</span>
<span id="cb265-216"><a href="#cb265-216" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb265-217"><a href="#cb265-217" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb265-218"><a href="#cb265-218" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"ðŸš® Trashify Object Detection Demo V3"</span>,</span>
<span id="cb265-219"><a href="#cb265-219" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"""Help clean up your local area! Upload an image and get +1 if there is all of the following items detected: trash, bin, hand.</span></span>
<span id="cb265-220"><a href="#cb265-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-221"><a href="#cb265-221" aria-hidden="true" tabindex="-1"></a><span class="st">    The model in V3 is [same model](https://huggingface.co/mrdbourke/detr_finetuned_trashify_box_detector_with_data_aug) as in [V2](https://huggingface.co/spaces/mrdbourke/trashify_demo_v2) (trained with data augmentation) but has an additional post-processing step (NMS or [Non Maximum Suppression](https://paperswithcode.com/method/non-maximum-suppression)) to filter classes for only the highest scoring box of each class. </span></span>
<span id="cb265-222"><a href="#cb265-222" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb265-223"><a href="#cb265-223" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Examples come in the form of a list of lists, where each inner list contains elements to prefill the `inputs` parameter with</span></span>
<span id="cb265-224"><a href="#cb265-224" aria-hidden="true" tabindex="-1"></a>    examples<span class="op">=</span>[</span>
<span id="cb265-225"><a href="#cb265-225" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_1.jpeg"</span>, <span class="fl">0.25</span>],</span>
<span id="cb265-226"><a href="#cb265-226" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_2.jpeg"</span>, <span class="fl">0.25</span>],</span>
<span id="cb265-227"><a href="#cb265-227" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"examples/trashify_example_3.jpeg"</span>, <span class="fl">0.25</span>]</span>
<span id="cb265-228"><a href="#cb265-228" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb265-229"><a href="#cb265-229" aria-hidden="true" tabindex="-1"></a>    cache_examples<span class="op">=</span><span class="va">True</span></span>
<span id="cb265-230"><a href="#cb265-230" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb265-231"><a href="#cb265-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-232"><a href="#cb265-232" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch the demo</span></span>
<span id="cb265-233"><a href="#cb265-233" aria-hidden="true" tabindex="-1"></a>demo.launch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting demos/trashify_object_detector_data_aug_model_with_nms/app.py</code></pre>
</div>
</div>
<section id="tk---upload-our-demo-to-the-hugging-face-hub" class="level3" data-number="23.1">
<h3 data-number="23.1" class="anchored" data-anchor-id="tk---upload-our-demo-to-the-hugging-face-hub"><span class="header-section-number">23.1</span> TK - Upload our demo to the Hugging Face Hub</h3>
<div id="cell-299" class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Import the required methods for uploading to the Hugging Face Hub</span></span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> huggingface_hub <span class="im">import</span> (</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>    create_repo,</span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>    get_full_repo_name,</span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>    upload_file, <span class="co"># for uploading a single file (if necessary)</span></span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a>    upload_folder <span class="co"># for uploading multiple files (in a folder)</span></span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Define the parameters we'd like to use for the upload</span></span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD <span class="op">=</span> <span class="st">"demos/trashify_object_detector_data_aug_model_with_nms"</span> <span class="co"># TK - update this path </span></span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>HF_TARGET_SPACE_NAME <span class="op">=</span> <span class="st">"trashify_demo_v3"</span></span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a>HF_REPO_TYPE <span class="op">=</span> <span class="st">"space"</span> <span class="co"># we're creating a Hugging Face Space</span></span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>HF_SPACE_SDK <span class="op">=</span> <span class="st">"gradio"</span></span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>HF_TOKEN <span class="op">=</span> <span class="st">""</span> <span class="co"># optional: set to your Hugging Face token (but I'd advise storing this as an environment variable as previously discussed)</span></span>
<span id="cb267-15"><a href="#cb267-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-16"><a href="#cb267-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Create a Space repository on Hugging Face Hub </span></span>
<span id="cb267-17"><a href="#cb267-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Creating repo on Hugging Face Hub with name: </span><span class="sc">{</span>HF_TARGET_SPACE_NAME<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb267-18"><a href="#cb267-18" aria-hidden="true" tabindex="-1"></a>create_repo(</span>
<span id="cb267-19"><a href="#cb267-19" aria-hidden="true" tabindex="-1"></a>    repo_id<span class="op">=</span>HF_TARGET_SPACE_NAME,</span>
<span id="cb267-20"><a href="#cb267-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># token=HF_TOKEN, # optional: set token manually (though it will be automatically recognized if it's available as an environment variable)</span></span>
<span id="cb267-21"><a href="#cb267-21" aria-hidden="true" tabindex="-1"></a>    repo_type<span class="op">=</span>HF_REPO_TYPE,</span>
<span id="cb267-22"><a href="#cb267-22" aria-hidden="true" tabindex="-1"></a>    private<span class="op">=</span><span class="va">False</span>, <span class="co"># set to True if you don't want your Space to be accessible to others</span></span>
<span id="cb267-23"><a href="#cb267-23" aria-hidden="true" tabindex="-1"></a>    space_sdk<span class="op">=</span>HF_SPACE_SDK,</span>
<span id="cb267-24"><a href="#cb267-24" aria-hidden="true" tabindex="-1"></a>    exist_ok<span class="op">=</span><span class="va">True</span>, <span class="co"># set to False if you want an error to raise if the repo_id already exists </span></span>
<span id="cb267-25"><a href="#cb267-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb267-26"><a href="#cb267-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-27"><a href="#cb267-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Get the full repository name (e.g. {username}/{model_id} or {username}/{space_name})</span></span>
<span id="cb267-28"><a href="#cb267-28" aria-hidden="true" tabindex="-1"></a>full_hf_repo_name <span class="op">=</span> get_full_repo_name(model_id<span class="op">=</span>HF_TARGET_SPACE_NAME)</span>
<span id="cb267-29"><a href="#cb267-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Full Hugging Face Hub repo name: </span><span class="sc">{</span>full_hf_repo_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb267-30"><a href="#cb267-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-31"><a href="#cb267-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Upload our demo folder</span></span>
<span id="cb267-32"><a href="#cb267-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Uploading </span><span class="sc">{</span>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD<span class="sc">}</span><span class="ss"> to repo: </span><span class="sc">{</span>full_hf_repo_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb267-33"><a href="#cb267-33" aria-hidden="true" tabindex="-1"></a>folder_upload_url <span class="op">=</span> upload_folder(</span>
<span id="cb267-34"><a href="#cb267-34" aria-hidden="true" tabindex="-1"></a>    repo_id<span class="op">=</span>full_hf_repo_name,</span>
<span id="cb267-35"><a href="#cb267-35" aria-hidden="true" tabindex="-1"></a>    folder_path<span class="op">=</span>LOCAL_DEMO_FOLDER_PATH_TO_UPLOAD,</span>
<span id="cb267-36"><a href="#cb267-36" aria-hidden="true" tabindex="-1"></a>    path_in_repo<span class="op">=</span><span class="st">"."</span>, <span class="co"># upload our folder to the root directory ("." means "base" or "root", this is the default)</span></span>
<span id="cb267-37"><a href="#cb267-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># token=HF_TOKEN, # optional: set token manually</span></span>
<span id="cb267-38"><a href="#cb267-38" aria-hidden="true" tabindex="-1"></a>    repo_type<span class="op">=</span>HF_REPO_TYPE,</span>
<span id="cb267-39"><a href="#cb267-39" aria-hidden="true" tabindex="-1"></a>    commit_message<span class="op">=</span><span class="st">"Uploading Trashify box detection model v3 app.py with NMS post processing"</span></span>
<span id="cb267-40"><a href="#cb267-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb267-41"><a href="#cb267-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[INFO] Demo folder successfully uploaded with commit URL: </span><span class="sc">{</span>folder_upload_url<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[INFO] Creating repo on Hugging Face Hub with name: trashify_demo_v3
[INFO] Full Hugging Face Hub repo name: mrdbourke/trashify_demo_v3
[INFO] Uploading demos/trashify_object_detector_data_aug_model_with_nms to repo: mrdbourke/trashify_demo_v3
[INFO] Demo folder successfully uploaded with commit URL: https://huggingface.co/spaces/mrdbourke/trashify_demo_v3/tree/main/.</code></pre>
</div>
</div>
</section>
<section id="tk---embed-the-space-to-test-the-model" class="level3" data-number="23.2">
<h3 data-number="23.2" class="anchored" data-anchor-id="tk---embed-the-space-to-test-the-model"><span class="header-section-number">23.2</span> tK - Embed the Space to Test the Model</h3>
<div id="cell-301" class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML</span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a><span class="co"># You can get embeddable HTML code for your demo by clicking the "Embed" button on the demo page</span></span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>HTML(data<span class="op">=</span><span class="st">'''</span></span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;iframe</span></span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a><span class="st">    src="https://mrdbourke-trashify-demo-v3.hf.space"</span></span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a><span class="st">    frameborder="0"</span></span>
<span id="cb269-9"><a href="#cb269-9" aria-hidden="true" tabindex="-1"></a><span class="st">    width="1000"</span></span>
<span id="cb269-10"><a href="#cb269-10" aria-hidden="true" tabindex="-1"></a><span class="st">    height="1600"</span></span>
<span id="cb269-11"><a href="#cb269-11" aria-hidden="true" tabindex="-1"></a><span class="st">&gt;&lt;/iframe&gt;     </span></span>
<span id="cb269-12"><a href="#cb269-12" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="158">

<iframe src="https://mrdbourke-trashify-demo-v3.hf.space" frameborder="0" width="1000" height="1600"></iframe>     
</div>
</div>
<div id="cell-303" class="cell">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="co"># UPTOHERE</span></span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Next, focus on a single input -&gt; output âœ…</span></span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Show case what an output from the model looks like untrained (e.g. plot the next boxes on it) âœ…</span></span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a><span class="co"># After showcasing 1x prediction, move onto training a model and seeing if we can get it to improve âœ…</span></span>
<span id="cb270-5"><a href="#cb270-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Continually focus on 1 input, 1 output until we can scale up âœ…</span></span>
<span id="cb270-6"><a href="#cb270-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a demo of our model and upload it to Hugging Face âœ…</span></span>
<span id="cb270-7"><a href="#cb270-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add examples to test the demo âœ…</span></span>
<span id="cb270-8"><a href="#cb270-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write code to upload the demo to Hugging Face âœ…</span></span>
<span id="cb270-9"><a href="#cb270-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create visualization of input and output of data augmentation âœ…</span></span>
<span id="cb270-10"><a href="#cb270-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create demo of model with data augmentation âœ…</span></span>
<span id="cb270-11"><a href="#cb270-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2: Try improve our model with data augmentation âœ…</span></span>
<span id="cb270-12"><a href="#cb270-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualize data augmentation examples in and out of the model </span></span>
<span id="cb270-13"><a href="#cb270-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: looks like augmentation may hurt our results... ðŸ¤”, this is because our data is so similar, potentially could help with more diverse data, e.g. synthetic data </span></span>
<span id="cb270-14"><a href="#cb270-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try in a demo and see how it works -&gt; Trashify Demo V2 âœ… </span></span>
<span id="cb270-15"><a href="#cb270-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extension: Also try a model training for longer </span></span>
<span id="cb270-16"><a href="#cb270-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 3 (just improve with NMS): Create NMS option so only highest quality boxes are kept for each class âœ…</span></span>
<span id="cb270-17"><a href="#cb270-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-18"><a href="#cb270-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Next:</span></span>
<span id="cb270-19"><a href="#cb270-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-20"><a href="#cb270-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Go through notebook and clean it up for </span></span>
<span id="cb270-21"><a href="#cb270-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Once we've got a better performing model, introduce evaluation metrics</span></span>
<span id="cb270-22"><a href="#cb270-22" aria-hidden="true" tabindex="-1"></a><span class="co"># End: three models, three demos, one without data augmentation, one with it, one with NMS (post-processing) + can have as an extension to train the model for longer and see what happens</span></span>
<span id="cb270-23"><a href="#cb270-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-24"><a href="#cb270-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Extensions:</span></span>
<span id="cb270-25"><a href="#cb270-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a model for longer and see if it improves (e.g. 72 epochs) </span></span>
<span id="cb270-26"><a href="#cb270-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-27"><a href="#cb270-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflow:</span></span>
<span id="cb270-28"><a href="#cb270-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Untrained model -&gt; input/output -&gt; poor results (always visualize, visualize, visualize!)</span></span>
<span id="cb270-29"><a href="#cb270-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Trained model -&gt; input/output -&gt; better results (always visualize, visualize, visualize!)</span></span>
<span id="cb270-30"><a href="#cb270-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-31"><a href="#cb270-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Outline:</span></span>
<span id="cb270-32"><a href="#cb270-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Single input/output with untrained model (bad output)</span></span>
<span id="cb270-33"><a href="#cb270-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Train model to improve on single input/output</span></span>
<span id="cb270-34"><a href="#cb270-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduce evaluation metric</span></span>
<span id="cb270-35"><a href="#cb270-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduce data augmentation, see D-FINE paper for data augmentation options (we can keep it simple)</span></span>
<span id="cb270-36"><a href="#cb270-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># See: https://arxiv.org/pdf/2410.13842 </span></span>
<span id="cb270-37"><a href="#cb270-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "The total batch size is 32 across all variants. Training schedules include 72 epochs with advanced augmentation (RandomPhotometricDistort, RandomZoomOut, RandomIoUCrop, and RMultiScaleInput)</span></span>
<span id="cb270-38"><a href="#cb270-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># followed by 2 epochs without advanced augmentation for D-FINE-X and D-FINE-L, and 120 epochs with advanced augmentation followed by 4</span></span>
<span id="cb270-39"><a href="#cb270-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># epochs without advanced augmentation for D-FINE-M and D-FINE-S (RT-DETRv2 Training Strategy (Lv et al., 2024) in Table 3)"</span></span>
<span id="cb270-40"><a href="#cb270-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Read RT-DETRv2 training strategy from paper mentioned above</span></span>
<span id="cb270-41"><a href="#cb270-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Read PP-YOLO data augmentation paper (keep it simple to begin with, can increase when needed)</span></span>
<span id="cb270-42"><a href="#cb270-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Create demo with Gradio</span></span>
<span id="cb270-43"><a href="#cb270-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Create demo with Transformers.js, see: https://huggingface.co/docs/transformers.js/en/tutorials/vanilla-js</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="extensions-extra-curriculum" class="level2" data-number="24">
<h2 data-number="24" class="anchored" data-anchor-id="extensions-extra-curriculum"><span class="header-section-number">24</span> Extensions + Extra-Curriculum</h2>
<ul>
<li>Extension: possibly improve the model with synthetic data? e.g.&nbsp;on classes/bins not visible in the model</li>
<li>Extension: train the model for longer and see how it improves, this could be model v4
<ul>
<li>Baselines:
<ul>
<li>V1 = model no data augmentaiton</li>
<li>V2 = model with data augmentation</li>
<li>V3 = model with NMS (post processing)</li>
</ul></li>
<li>Extensions:
<ul>
<li>V4 = model trained for longer with NMS</li>
<li>V5 = synthetic data scaled upâ€¦?</li>
</ul></li>
</ul></li>
<li>Extension: Zero-shot object detection - but what if I donâ€™t have labels?
<ul>
<li>This could discuss the use of zero-shot object detection models such as GroundingDINO and OmDet</li>
<li>See OmDet - https://huggingface.co/omlab/omdet-turbo-swin-tiny-hf</li>
<li>See GroundingDINO - https://huggingface.co/docs/transformers/en/model_doc/grounding-dino</li>
</ul></li>
<li>Extension: Try to repeat the workflow weâ€™ve gone through with another model such as https://huggingface.co/IDEA-Research/dab-detr-resnet-50-dc5-pat3 (apparently it is slightly better performing on COCO too)</li>
</ul>
</section>
<section id="summary" class="level2" data-number="25">
<h2 data-number="25" class="anchored" data-anchor-id="summary"><span class="header-section-number">25</span> Summary</h2>
<ul>
<li>Bounding box formats: An important step in any object detection project is to figure out what format your bounding boxes are in.</li>
</ul>
</section>
<section id="extra-resources" class="level2" data-number="26">
<h2 data-number="26" class="anchored" data-anchor-id="extra-resources"><span class="header-section-number">26</span> Extra resources</h2>
<ul>
<li><a href="https://www.learnml.io/posts/a-guide-to-bounding-box-formats/">A Guide to Bounding Box Formats and How to Draw Them</a> by Daniel Bourke.</li>
</ul>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.learnhuggingface\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mrdbourke/learn-huggingface/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.mrdbourke.com">
      <i class="bi bi-globe" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mrdbourke/learn-huggingface">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/channel/UCr8O8l5cCX85Oem1d18EezQ">
      <i class="bi bi-youtube" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mrdbourke">
      <i class="bi bi-twitter-x" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/mrdbourke/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>